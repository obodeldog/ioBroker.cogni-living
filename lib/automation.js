const a1_0x1292bc=a1_0x11fa;(function(_0x2a508a,_0x3e6680){const _0x5eb821=a1_0x11fa,_0xee8e7b=_0x2a508a();while(!![]){try{const _0x4e72f7=parseInt(_0x5eb821(0x127))/0x1+-parseInt(_0x5eb821(0x122))/0x2*(-parseInt(_0x5eb821(0xa8))/0x3)+-parseInt(_0x5eb821(0x111))/0x4*(-parseInt(_0x5eb821(0xe6))/0x5)+-parseInt(_0x5eb821(0x101))/0x6+-parseInt(_0x5eb821(0xfc))/0x7+parseInt(_0x5eb821(0xbf))/0x8*(parseInt(_0x5eb821(0xb5))/0x9)+-parseInt(_0x5eb821(0xfe))/0xa*(-parseInt(_0x5eb821(0x11d))/0xb);if(_0x4e72f7===_0x3e6680)break;else _0xee8e7b['push'](_0xee8e7b['shift']());}catch(_0x64ead1){_0xee8e7b['push'](_0xee8e7b['shift']());}}}(a1_0x122d,0xbd72e));const a1_0x1bad33=(function(){let _0x27598c=!![];return function(_0x29b38e,_0x3a79b5){const _0x3837af=_0x27598c?function(){if(_0x3a79b5){const _0x2a53f2=_0x3a79b5['apply'](_0x29b38e,arguments);return _0x3a79b5=null,_0x2a53f2;}}:function(){};return _0x27598c=![],_0x3837af;};}()),a1_0x3c8d0a=a1_0x1bad33(this,function(){const _0x36a7d9=a1_0x11fa;return a1_0x3c8d0a[_0x36a7d9(0xb9)]()[_0x36a7d9(0xc7)](_0x36a7d9(0x11a))['toString']()[_0x36a7d9(0x10b)](a1_0x3c8d0a)['search'](_0x36a7d9(0x11a));});a1_0x3c8d0a();function a1_0x122d(){const _0x12a1f0=['calendarInstance','temp','Nicht\x20gefunden','approved','value.valve','search','switch','\x20min).','.1.ACTUAL_TEMPERATURE','toUpperCase','getForeignObjectsAsync','name','push','set','active','localeCompare','thermostat','event','score','ankunft','setForeignStateAsync','stellwert','valve_position','ist','.1.TEMPERATURE','\x27\x20erkannt\x20(','useCalendar',')\x20auf\x20','temperature','filter','off','ACTUAL','openknx','sort','eventStart','room','33725jkfMAj','message','analysis.automation.lastAction','setpoint','info','sensor',':\x20Absenkung\x20auf\x20','parse','valve','length','string','thermostatMapping',').\x20Heize\x20auf\x2021¬∞C\x20(Vorlauf:\x20','debug','includes','actual','analysis.automation.confidenceThreshold','.4.VALVE_STATE','target','valveMapping','[CAL]\x20','analysis.energy.warmupTimes','6449093npgJLy','Unknown','2860oemcnx',')\x20wieder\x20auf\x20','location','6944712PGunym','Calendar\x20Check\x20Error:\x20','type','getTime','[MPC]\x20','consultButler','¬∞C\x20(Puffer:\x20','.4.SET_TEMPERATURE','wert','\x20->\x2021¬∞C','constructor','unit','find','config','getStateAsync','_calName','152sIaKUC','level.temperature','role','level.valve','system.mode','r√ºckkehr','write','getForeignObjectAsync','.data.table','(((.+)+)+)+$','now','üî•\x20MPC\x20Autonomy:\x20Heize\x20','10285NngNsA','slice','getForeignStateAsync','val','replace','2Ubvppk','level','setStateAsync','common','hm-rpc','602110TNrGlP','\x20min)','exports','log',':\x20Aufheizen\x20auf\x20','current_heating_setpoint','urlaub\x20ende','soll','2119635OrZYgu','messwert','ACTUAL_TEMPERATURE','local_temperature','light','Pr√§diktion:\x20','split','summary','trim','SET_POINT_TEMPERATURE','PERFECT','toLowerCase','number','9201222iamuqR','Fehlt','position','Manuelles\x20Mapping','toString','forEach','devices','reason','.1.LEVEL','entries','8CkndGj','join','values'];a1_0x122d=function(){return _0x12a1f0;};return a1_0x122d();}'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x12c8d6){const _0x33fda3=a1_0x11fa;if(!_0x12c8d6)return'';return _0x12c8d6[_0x33fda3(0xb3)]()[_0x33fda3(0x121)](/\s+/g,'')[_0x33fda3(0xb0)]();}function a1_0x11fa(_0x2da9e8,_0xad8990){const _0x48a804=a1_0x122d();return a1_0x11fa=function(_0x3c8d0a,_0x1bad33){_0x3c8d0a=_0x3c8d0a-0xa6;let _0x122ddf=_0x48a804[_0x3c8d0a];return _0x122ddf;},a1_0x11fa(_0x2da9e8,_0xad8990);}async function handlePrediction(_0x5245ab,_0x1a1463,_0x4653a4){const _0x3e0409=a1_0x11fa;if(!_0x1a1463||_0x1a1463===_0x3e0409(0xfd))return;let _0x338db6='off',_0x443a44=0.6;try{const _0x441116=await _0x5245ab[_0x3e0409(0x10f)]('analysis.automation.mode');if(_0x441116&&_0x441116[_0x3e0409(0x120)])_0x338db6=_0x441116[_0x3e0409(0x120)];const _0x573d7b=await _0x5245ab[_0x3e0409(0x10f)](_0x3e0409(0xf6));if(_0x573d7b&&_0x573d7b['val'])_0x443a44=_0x573d7b[_0x3e0409(0x120)];}catch(_0x20eaad){}if(_0x338db6===_0x3e0409(0xe0)||_0x4653a4<_0x443a44)return;const _0x3fd3d7=Date[_0x3e0409(0x11b)]();if(lastActions[_0x1a1463]&&_0x3fd3d7-lastActions[_0x1a1463]<COOLDOWN_MS)return;const _0x49d1ec=_0x5245ab['config'][_0x3e0409(0xbb)]||[],_0x4b9eb5=normalize(_0x1a1463),_0x4c9b74=_0x49d1ec[_0x3e0409(0x10d)](_0xd9064f=>normalize(_0xd9064f['location'])===_0x4b9eb5&&(_0xd9064f[_0x3e0409(0x103)]===_0x3e0409(0xac)||_0xd9064f['type']==='dimmer'||_0xd9064f['type']===_0x3e0409(0xc8)));if(!_0x4c9b74){_0x5245ab['log'][_0x3e0409(0xf3)]('üîç\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27'+_0x1a1463+'\x27.');return;}const _0x3c5fd8=await aiAgent[_0x3e0409(0x106)](_0x5245ab,_0x1a1463,_0x4c9b74['name'],_0x4653a4);if(!_0x3c5fd8[_0x3e0409(0xc5)])return;const _0x53a861=_0x3e0409(0xad)+_0x1a1463+'\x20->\x20Schalte\x20'+_0x4c9b74['name']+'\x20('+_0x3c5fd8[_0x3e0409(0xbc)]+')';await _0x5245ab[_0x3e0409(0x124)](_0x3e0409(0xe8),{'val':'['+_0x338db6[_0x3e0409(0xcb)]()+']\x20'+_0x53a861,'ack':!![]});if(_0x338db6===_0x3e0409(0xd0)){const _0x12d66a=await _0x5245ab['getForeignStateAsync'](_0x4c9b74['id']);(!_0x12d66a||!_0x12d66a[_0x3e0409(0x120)]&&_0x12d66a['val']!==!![])&&await _0x5245ab[_0x3e0409(0xd6)](_0x4c9b74['id'],!![]),lastActions[_0x1a1463]=_0x3fd3d7;}}async function findRelatedId(_0x19c33f,_0x3ff910,_0x406e65=a1_0x1292bc(0xe9)){const _0xa144be=a1_0x1292bc;if(_0x406e65===_0xa144be(0xe9)&&_0x19c33f[_0xa144be(0x10e)][_0xa144be(0xf1)]){let _0x1354ea=_0x19c33f['config'][_0xa144be(0xf1)];if(typeof _0x1354ea===_0xa144be(0xf0))try{_0x1354ea=JSON[_0xa144be(0xed)](_0x1354ea);}catch(_0x320f62){}if(_0x1354ea&&_0x1354ea[_0x3ff910])return _0x1354ea[_0x3ff910];}if(_0x406e65===_0xa144be(0xee)&&_0x19c33f['config'][_0xa144be(0xf9)]){let _0x3298e4=_0x19c33f[_0xa144be(0x10e)][_0xa144be(0xf9)];if(typeof _0x3298e4==='string')try{_0x3298e4=JSON[_0xa144be(0xed)](_0x3298e4);}catch(_0x48343d){}if(_0x3298e4&&_0x3298e4[_0x3ff910])return _0x3298e4[_0x3ff910];}let _0x1a8ab3=[];if(_0x406e65===_0xa144be(0xe9))_0x1a8ab3=[{'s':_0xa144be(0xca),'t':'.1.SET_POINT_TEMPERATURE'},{'s':_0xa144be(0xda),'t':'.1.SET_POINT_TEMPERATURE'},{'s':'.1.TEMPERATURE','t':_0xa144be(0x108)},{'s':_0xa144be(0xaa),'t':_0xa144be(0xb1)},{'s':_0xa144be(0xab),'t':'occupied_heating_setpoint'},{'s':_0xa144be(0xab),'t':_0xa144be(0x12c)},{'s':_0xa144be(0xde),'t':'target_temperature'},{'s':_0xa144be(0xe1),'t':'SET'},{'s':'Ist','t':'Soll'},{'s':_0xa144be(0xde),'t':_0xa144be(0xe9)}];else _0x406e65===_0xa144be(0xee)&&(_0x1a8ab3=[{'s':_0xa144be(0xca),'t':_0xa144be(0xbd)},{'s':'.1.TEMPERATURE','t':'.1.LEVEL'},{'s':_0xa144be(0xda),'t':_0xa144be(0xf7)},{'s':_0xa144be(0xab),'t':'pi_heating_demand'},{'s':'temperature','t':_0xa144be(0xd8)},{'s':'temperature','t':_0xa144be(0x123)}]);for(const _0x325335 of _0x1a8ab3){if(_0x3ff910['includes'](_0x325335['s'])){const _0x2de47a=_0x3ff910['replace'](_0x325335['s'],_0x325335['t']),_0xf4ff83=await _0x19c33f[_0xa144be(0x118)](_0x2de47a);if(_0xf4ff83)return _0x2de47a;}}try{const _0x34db86=_0x3ff910[_0xa144be(0xae)]('.');if(_0x34db86[_0xa144be(0xef)]>0x2){const _0x5dedb5=_0x34db86[_0xa144be(0x11e)](0x0,-0x1)[_0xa144be(0xc0)]('.'),_0x4e39b2=await _0x19c33f[_0xa144be(0xcc)](_0x5dedb5+'.*'),_0x3eefcc=[],_0x472c2a=_0x3ff910['split'](/[._]+/)[_0xa144be(0xdf)](_0x526f80=>![_0xa144be(0xe2),'0',_0xa144be(0x126),_0xa144be(0xd9),_0xa144be(0x109),'temperature',_0xa144be(0xf5),_0xa144be(0xeb),_0xa144be(0xa9),'state']['includes'](_0x526f80[_0xa144be(0xb3)]()));for(const [_0x30df6b,_0x40b34d]of Object[_0xa144be(0xbe)](_0x4e39b2)){if(_0x30df6b===_0x3ff910)continue;if(_0x40b34d&&_0x40b34d['common']){const _0x4847b7=_0x30df6b['toLowerCase'](),_0x177a17=(_0x40b34d[_0xa144be(0x125)][_0xa144be(0x113)]||'')['toLowerCase'](),_0x15b6a3=(_0x40b34d['common'][_0xa144be(0x10c)]||'')[_0xa144be(0xb3)]();let _0x34486a=![];if(_0x406e65==='setpoint'&&_0x40b34d['common'][_0xa144be(0x117)]===!![])_0x34486a=_0x4847b7[_0xa144be(0xf4)](_0xa144be(0xcf))||_0x4847b7['includes'](_0xa144be(0xa7))||_0x4847b7['includes'](_0xa144be(0xf8))||_0x177a17['includes'](_0xa144be(0x112))||_0x177a17[_0xa144be(0xf4)]('thermostat.setpoint');else _0x406e65===_0xa144be(0xee)&&(_0x34486a=_0x4847b7[_0xa144be(0xf4)](_0xa144be(0x123))||_0x4847b7['includes'](_0xa144be(0xee))||_0x4847b7[_0xa144be(0xf4)](_0xa144be(0xd7))||_0x4847b7['includes'](_0xa144be(0xb7))||_0x177a17[_0xa144be(0xf4)](_0xa144be(0x114))||_0x177a17[_0xa144be(0xf4)](_0xa144be(0xc6))||_0x15b6a3[_0xa144be(0xf4)]('%'));if(_0x34486a){const _0x2ac143=_0x30df6b['split'](/[._]+/)['map'](_0x3c61d7=>_0x3c61d7[_0xa144be(0xb3)]());let _0x3f0ffb=0x0;_0x472c2a['forEach'](_0x15af21=>{const _0x4b9a45=_0xa144be;if(_0x2ac143['includes'](_0x15af21[_0x4b9a45(0xb3)]()))_0x3f0ffb++;}),_0x3eefcc[_0xa144be(0xce)]({'id':_0x30df6b,'score':_0x3f0ffb});}}}if(_0x3eefcc['length']>0x0){_0x3eefcc['sort']((_0x49cb8b,_0x17d952)=>_0x17d952[_0xa144be(0xd4)]-_0x49cb8b[_0xa144be(0xd4)]);if(_0x3eefcc[0x0]['score']>0x0)return _0x3eefcc[0x0]['id'];}}}catch(_0x439577){}return null;}async function scanThermostats(_0x317a2b){const _0x3f1f07=a1_0x1292bc,_0x4d33d9=_0x317a2b['config'][_0x3f1f07(0xbb)]||[],_0x12e550=[],_0x51c1bb=_0x4d33d9[_0x3f1f07(0xdf)](_0x340ad1=>_0x340ad1['id']&&_0x340ad1['id'][_0x3f1f07(0xf4)](_0x3f1f07(0xde))||_0x340ad1['type']&&[_0x3f1f07(0xde),_0x3f1f07(0xd2),_0x3f1f07(0xeb)][_0x3f1f07(0xf4)](_0x340ad1[_0x3f1f07(0x103)])||_0x340ad1[_0x3f1f07(0xcd)]&&_0x340ad1[_0x3f1f07(0xcd)][_0x3f1f07(0xb3)]()[_0x3f1f07(0xf4)](_0x3f1f07(0xc3)));for(const _0x5775e3 of _0x51c1bb){const _0xa84ba7=await findRelatedId(_0x317a2b,_0x5775e3['id'],'setpoint'),_0x47c137=await findRelatedId(_0x317a2b,_0x5775e3['id'],'valve');let _0x2b310e=_0x3f1f07(0xc4),_0x11b5fc=![],_0x54369c=_0x317a2b['config']['thermostatMapping']||{};if(typeof _0x54369c===_0x3f1f07(0xf0))try{_0x54369c=JSON[_0x3f1f07(0xed)](_0x54369c);}catch(_0x472ade){}let _0x4f18da=_0x317a2b[_0x3f1f07(0x10e)][_0x3f1f07(0xf9)]||{};if(typeof _0x4f18da===_0x3f1f07(0xf0))try{_0x4f18da=JSON[_0x3f1f07(0xed)](_0x4f18da);}catch(_0x3c160d){}if(_0x54369c[_0x5775e3['id']]&&_0x54369c[_0x5775e3['id']]===_0xa84ba7||_0x4f18da[_0x5775e3['id']]&&_0x4f18da[_0x5775e3['id']]===_0x47c137)_0x2b310e=_0x3f1f07(0xb8),_0x11b5fc=!![];else(_0xa84ba7||_0x47c137)&&(_0x2b310e='Auto-Erkennung');_0x12e550[_0x3f1f07(0xce)]({'room':_0x5775e3[_0x3f1f07(0x100)]||'Unbekannt','sensorId':_0x5775e3['id'],'setpointId':_0xa84ba7||'-','valveId':_0x47c137||'-','source':_0x2b310e,'isManual':_0x11b5fc,'status':_0xa84ba7&&_0x47c137?_0x3f1f07(0xb2):_0xa84ba7?'OK':_0x3f1f07(0xb6)});}return _0x12e550[_0x3f1f07(0xe3)]((_0x1d2199,_0x4cfdba)=>_0x1d2199['room'][_0x3f1f07(0xd1)](_0x4cfdba[_0x3f1f07(0xe5)]));}async function checkCalendarTriggers(_0x161aeb){const _0x49c82d=a1_0x1292bc;if(!_0x161aeb[_0x49c82d(0x10e)][_0x49c82d(0xdc)]||!_0x161aeb['config']['calendarInstance'])return;let _0xf55162={};try{const _0x5cd967=await _0x161aeb['getStateAsync'](_0x49c82d(0xfb));if(_0x5cd967&&_0x5cd967[_0x49c82d(0x120)])_0xf55162=JSON[_0x49c82d(0xed)](_0x5cd967[_0x49c82d(0x120)]);}catch(_0x5821c3){}try{const _0x2e3337=await _0x161aeb[_0x49c82d(0x11f)](_0x161aeb[_0x49c82d(0x10e)][_0x49c82d(0xc2)]+_0x49c82d(0x119));if(!_0x2e3337||!_0x2e3337['val'])return;const _0x20a3bf=JSON[_0x49c82d(0xed)](_0x2e3337[_0x49c82d(0x120)]),_0x62c597=new Date(),_0x22c49a=_0x161aeb[_0x49c82d(0x10e)]['devices']||[],_0x31bbe0=_0x161aeb[_0x49c82d(0x10e)]['calendarSelection']||[];for(const _0x5626b8 of _0x20a3bf){if(_0x5626b8[_0x49c82d(0x110)]&&_0x31bbe0[_0x49c82d(0xef)]>0x0&&!_0x31bbe0[_0x49c82d(0xf4)](_0x5626b8[_0x49c82d(0x110)]))continue;const _0x333d73=new Date(_0x5626b8[_0x49c82d(0xe4)]),_0x43a2b5=(_0x5626b8[_0x49c82d(0xd3)]||_0x5626b8[_0x49c82d(0xaf)]||'')[_0x49c82d(0xb3)]();if(_0x43a2b5[_0x49c82d(0xf4)](_0x49c82d(0xa6))||_0x43a2b5[_0x49c82d(0xf4)](_0x49c82d(0x116))||_0x43a2b5['includes'](_0x49c82d(0xd5))){let _0x5608de=0x0;Object[_0x49c82d(0xc1)](_0xf55162)[_0x49c82d(0xba)](_0x220294=>{if(_0x220294>_0x5608de)_0x5608de=_0x220294;});if(_0x5608de===0x0)_0x5608de=0x78;const _0x322c53=new Date(_0x333d73[_0x49c82d(0x104)]()-_0x5608de*0xea60),_0x218b0b=_0x62c597[_0x49c82d(0x104)]()-_0x322c53['getTime']();_0x218b0b>=0x0&&_0x218b0b<0xf*0xea60&&(_0x161aeb[_0x49c82d(0x12a)]['info']('üìÖ\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20('+_0x5626b8[_0x49c82d(0xd3)]+').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20'+_0x5608de+_0x49c82d(0xc9)),await _0x161aeb[_0x49c82d(0x124)](_0x49c82d(0x115),{'val':'normal','ack':![]}));}for(const _0x2c8946 of _0x22c49a){if(_0x2c8946[_0x49c82d(0x100)]){const _0x95a154=_0x2c8946['location'][_0x49c82d(0xb3)]();if(_0x43a2b5['includes'](_0x95a154)){const _0x20cce1=_0xf55162[_0x2c8946[_0x49c82d(0x100)]]||0x3c,_0xf42a48=new Date(_0x333d73['getTime']()-_0x20cce1*0xea60),_0x49601e=_0x62c597[_0x49c82d(0x104)]()-_0xf42a48[_0x49c82d(0x104)]();if(_0x49601e>=0x0&&_0x49601e<0xf*0xea60){const _0x56f058=await findRelatedId(_0x161aeb,_0x2c8946['id'],_0x49c82d(0xe9));_0x56f058&&(_0x161aeb[_0x49c82d(0x12a)][_0x49c82d(0xea)]('üìÖ\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27'+_0x2c8946[_0x49c82d(0x100)]+_0x49c82d(0xdb)+_0x5626b8[_0x49c82d(0xd3)]+_0x49c82d(0xf2)+_0x20cce1+_0x49c82d(0xc9)),await _0x161aeb[_0x49c82d(0xd6)](_0x56f058,0x15),await _0x161aeb[_0x49c82d(0x124)](_0x49c82d(0xe8),{'val':_0x49c82d(0xfa)+_0x2c8946['location']+_0x49c82d(0x10a),'ack':!![]}));}}}}}}catch(_0x22535a){_0x161aeb[_0x49c82d(0x12a)]['warn'](_0x49c82d(0x102)+_0x22535a[_0x49c82d(0xe7)]);}}async function applyEnergySavings(_0x1d818b,_0x2ac206){const _0x25da74=a1_0x1292bc,_0x1f6411=_0x1d818b[_0x25da74(0x10e)][_0x25da74(0xbb)]||[];for(const _0x2a4360 of _0x2ac206){const _0x5e27cd=_0x2a4360['room'],_0x15c08b=_0x2a4360['minutes_safe'],_0x22222a=_0x2a4360[_0x25da74(0xf8)]||0x15,_0x5638da=_0x1f6411[_0x25da74(0x10d)](_0x26c2e4=>normalize(_0x26c2e4[_0x25da74(0x100)])===normalize(_0x5e27cd)&&(_0x26c2e4['type']==='temperature'||_0x26c2e4[_0x25da74(0x103)]===_0x25da74(0xd2)));if(!_0x5638da)continue;const _0x2f7212=await findRelatedId(_0x1d818b,_0x5638da['id'],_0x25da74(0xe9));if(_0x2f7212){const _0x2ffff0=await _0x1d818b[_0x25da74(0x11f)](_0x2f7212);if(_0x2ffff0&&typeof _0x2ffff0[_0x25da74(0x120)]===_0x25da74(0xb4)){const _0x5677f6=_0x2ffff0[_0x25da74(0x120)];if(_0x15c08b>0x1e)_0x5677f6>ECO_TEMP+0.5&&(_0x1d818b['log'][_0x25da74(0xea)]('üçÉ\x20MPC\x20Autonomy:\x20Senke\x20'+_0x5e27cd+'\x20('+_0x2f7212+_0x25da74(0xdd)+ECO_TEMP+_0x25da74(0x107)+_0x15c08b+_0x25da74(0x128)),await _0x1d818b['setForeignStateAsync'](_0x2f7212,ECO_TEMP),await _0x1d818b[_0x25da74(0x124)](_0x25da74(0xe8),{'val':_0x25da74(0x105)+_0x5e27cd+_0x25da74(0xec)+ECO_TEMP+'¬∞C','ack':!![]}));else _0x15c08b<=0xf&&(_0x5677f6<_0x22222a&&(_0x1d818b[_0x25da74(0x12a)]['info'](_0x25da74(0x11c)+_0x5e27cd+'\x20('+_0x2f7212+_0x25da74(0xff)+_0x22222a+'¬∞C\x20(Puffer\x20leer).'),await _0x1d818b[_0x25da74(0xd6)](_0x2f7212,_0x22222a),await _0x1d818b[_0x25da74(0x124)](_0x25da74(0xe8),{'val':'[MPC]\x20'+_0x5e27cd+_0x25da74(0x12b)+_0x22222a+'¬∞C','ack':!![]})));}}}}module[a1_0x1292bc(0x129)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};