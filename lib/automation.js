const a1_0x1c96b9=a1_0x4bdf;(function(_0x5b349a,_0x23d593){const _0x403542=a1_0x4bdf,_0x22b804=_0x5b349a();while(!![]){try{const _0x4044bd=parseInt(_0x403542(0x226))/0x1*(-parseInt(_0x403542(0x1ec))/0x2)+parseInt(_0x403542(0x1da))/0x3*(parseInt(_0x403542(0x21d))/0x4)+parseInt(_0x403542(0x214))/0x5+parseInt(_0x403542(0x21c))/0x6*(-parseInt(_0x403542(0x1f2))/0x7)+-parseInt(_0x403542(0x1c6))/0x8+parseInt(_0x403542(0x1f1))/0x9*(parseInt(_0x403542(0x211))/0xa)+parseInt(_0x403542(0x200))/0xb;if(_0x4044bd===_0x23d593)break;else _0x22b804['push'](_0x22b804['shift']());}catch(_0x300568){_0x22b804['push'](_0x22b804['shift']());}}}(a1_0xb4b3,0x87889));const a1_0x16e624=(function(){let _0x4e34e9=!![];return function(_0x5dbe1a,_0x3987f0){const _0x3fa5d0=_0x4e34e9?function(){if(_0x3987f0){const _0x414ae9=_0x3987f0['apply'](_0x5dbe1a,arguments);return _0x3987f0=null,_0x414ae9;}}:function(){};return _0x4e34e9=![],_0x3fa5d0;};}()),a1_0x1ce6c7=a1_0x16e624(this,function(){const _0x3aa0b6=a1_0x4bdf;return a1_0x1ce6c7[_0x3aa0b6(0x218)]()['search']('(((.+)+)+)+$')[_0x3aa0b6(0x218)]()[_0x3aa0b6(0x235)](a1_0x1ce6c7)[_0x3aa0b6(0x242)]('(((.+)+)+)+$');});a1_0x1ce6c7();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x44d2a8){const _0x801964=a1_0x4bdf;if(!_0x44d2a8)return'';return _0x44d2a8['toLowerCase']()[_0x801964(0x21f)](/\s+/g,'')[_0x801964(0x236)]();}function a1_0x4bdf(_0x57eae8,_0xa8fa31){const _0x5785a0=a1_0xb4b3();return a1_0x4bdf=function(_0x1ce6c7,_0x16e624){_0x1ce6c7=_0x1ce6c7-0x1c6;let _0xb4b327=_0x5785a0[_0x1ce6c7];return _0xb4b327;},a1_0x4bdf(_0x57eae8,_0xa8fa31);}async function handlePrediction(_0x40b8fe,_0xccd8e5,_0x3ba87d){const _0x2d0546=a1_0x4bdf;if(!_0xccd8e5||_0xccd8e5===_0x2d0546(0x233))return;let _0x36b841=_0x2d0546(0x240),_0x1f605a=0.6;try{const _0x1ac44c=await _0x40b8fe[_0x2d0546(0x23b)]('analysis.automation.mode');if(_0x1ac44c&&_0x1ac44c[_0x2d0546(0x234)])_0x36b841=_0x1ac44c[_0x2d0546(0x234)];const _0x50cbc4=await _0x40b8fe['getStateAsync'](_0x2d0546(0x1d9));if(_0x50cbc4&&_0x50cbc4[_0x2d0546(0x234)])_0x1f605a=_0x50cbc4[_0x2d0546(0x234)];}catch(_0x310fe3){}if(_0x36b841===_0x2d0546(0x240)||_0x3ba87d<_0x1f605a)return;const _0x114f8f=Date[_0x2d0546(0x202)]();if(lastActions[_0xccd8e5]&&_0x114f8f-lastActions[_0xccd8e5]<COOLDOWN_MS)return;const _0x1ef7a6=_0x40b8fe['config']['devices']||[],_0x738e01=normalize(_0xccd8e5),_0x13c2d9=_0x1ef7a6[_0x2d0546(0x223)](_0x23e8a6=>normalize(_0x23e8a6[_0x2d0546(0x20d)])===_0x738e01&&(_0x23e8a6[_0x2d0546(0x1c8)]===_0x2d0546(0x208)||_0x23e8a6[_0x2d0546(0x1c8)]===_0x2d0546(0x1cc)||_0x23e8a6[_0x2d0546(0x1c8)]===_0x2d0546(0x219)));if(!_0x13c2d9){_0x40b8fe[_0x2d0546(0x23a)][_0x2d0546(0x1f0)](_0x2d0546(0x1fc)+_0xccd8e5+'\x27.');return;}const _0x136fd4=await aiAgent[_0x2d0546(0x21e)](_0x40b8fe,_0xccd8e5,_0x13c2d9['name'],_0x3ba87d);if(!_0x136fd4[_0x2d0546(0x1e8)])return;const _0x4b536a=_0x2d0546(0x1e0)+_0xccd8e5+'\x20->\x20Schalte\x20'+_0x13c2d9[_0x2d0546(0x241)]+'\x20('+_0x136fd4['reason']+')';await _0x40b8fe[_0x2d0546(0x1d7)](_0x2d0546(0x1fb),{'val':'['+_0x36b841[_0x2d0546(0x1e4)]()+']\x20'+_0x4b536a,'ack':!![]});if(_0x36b841===_0x2d0546(0x22c)){const _0x2e5bca=await _0x40b8fe[_0x2d0546(0x1d8)](_0x13c2d9['id']);(!_0x2e5bca||!_0x2e5bca['val']&&_0x2e5bca[_0x2d0546(0x234)]!==!![])&&await _0x40b8fe[_0x2d0546(0x1f6)](_0x13c2d9['id'],!![]),lastActions[_0xccd8e5]=_0x114f8f;}}function a1_0xb4b3(){const _0x275154=['calendarInstance','toString','switch','¬∞C\x20(Coasting\x20m√∂glich:\x20','thermostatMapping','10092chcVlK','4KlWBWV','consultButler','replace','mpc_','values','setpoint','find','.1.LEVEL','valve','947kqeNqN','thermostat','wert','position','exports','info','active','config','local_temperature','state','_calName','.4.VALVE_STATE','.1.SET_POINT_TEMPERATURE','Unknown','val','constructor','trim','eventStart','[MPC]\x20',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','log','getStateAsync','.1.TEMPERATURE','hm-rpc','Ist','calendarSelection','off','name','search','parse','messwert','level','includes','map','level.valve','Fehlt','1883096HJdysO','temperature','type','\x27\x20erkannt\x20(','string','Soll','dimmer','current_heating_setpoint','role','Manuelles\x20Mapping','\x20min)','ACTUAL_TEMPERATURE','set',':\x20-1¬∞C\x20(Sparpotenzial\x20genutzt)','[CAL]\x20','.1.ACTUAL_TEMPERATURE','normal','setStateAsync','getForeignStateAsync','analysis.automation.confidenceThreshold','1713717CviIhP','toLowerCase','split','score',').\x20Heize\x20auf\x2021¬∞C\x20(Vorlauf:\x20','warn','Pr√§diktion:\x20','getForeignObjectsAsync','Unbekannt','pi_heating_demand','toUpperCase','occupied_heating_setpoint','devices','length','approved','Auto-Erkennung','temp','sensor','2076EEMKds','number','push','\x20min).','debug','378nNYhfW','2779AvptfS','common','localeCompare','useCalendar','setForeignStateAsync','üìÖ\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','urlaub\x20ende','SET','target','analysis.automation.lastAction','üîç\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27','soll','forEach','minutes_safe','5935369kxmpxM','room','now','PERFECT','sort','üìÖ\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27','value.valve','getTime','light','SET_POINT_TEMPERATURE','join','entries','valveMapping','location','level.temperature','target_temperature','.data.table','257340fZVdXK','Calendar\x20Check\x20Error:\x20','r√ºckkehr','1248130lmRzdP','\x20->\x2021¬∞C','event'];a1_0xb4b3=function(){return _0x275154;};return a1_0xb4b3();}async function findRelatedId(_0x27b696,_0x5c159b,_0x4aac69=a1_0x1c96b9(0x222)){const _0x15335f=a1_0x1c96b9;if(_0x4aac69===_0x15335f(0x222)&&_0x27b696[_0x15335f(0x22d)][_0x15335f(0x21b)]){let _0x40d7d4=_0x27b696[_0x15335f(0x22d)][_0x15335f(0x21b)];if(typeof _0x40d7d4===_0x15335f(0x1ca))try{_0x40d7d4=JSON[_0x15335f(0x243)](_0x40d7d4);}catch(_0x5886aa){}if(_0x40d7d4&&_0x40d7d4[_0x5c159b])return _0x40d7d4[_0x5c159b];}if(_0x4aac69===_0x15335f(0x225)&&_0x27b696[_0x15335f(0x22d)][_0x15335f(0x20c)]){let _0x218435=_0x27b696[_0x15335f(0x22d)][_0x15335f(0x20c)];if(typeof _0x218435===_0x15335f(0x1ca))try{_0x218435=JSON['parse'](_0x218435);}catch(_0x18b1aa){}if(_0x218435&&_0x218435[_0x5c159b])return _0x218435[_0x5c159b];}let _0x538859=[];if(_0x4aac69===_0x15335f(0x222))_0x538859=[{'s':_0x15335f(0x1d5),'t':_0x15335f(0x232)},{'s':'.1.TEMPERATURE','t':_0x15335f(0x232)},{'s':'.1.TEMPERATURE','t':'.4.SET_TEMPERATURE'},{'s':_0x15335f(0x1d1),'t':_0x15335f(0x209)},{'s':_0x15335f(0x22e),'t':_0x15335f(0x1e5)},{'s':_0x15335f(0x22e),'t':_0x15335f(0x1cd)},{'s':'temperature','t':_0x15335f(0x20f)},{'s':'ACTUAL','t':_0x15335f(0x1f9)},{'s':_0x15335f(0x23e),'t':_0x15335f(0x1cb)},{'s':_0x15335f(0x1c7),'t':'setpoint'}];else _0x4aac69===_0x15335f(0x225)&&(_0x538859=[{'s':_0x15335f(0x1d5),'t':_0x15335f(0x224)},{'s':_0x15335f(0x23c),'t':_0x15335f(0x224)},{'s':_0x15335f(0x23c),'t':_0x15335f(0x231)},{'s':'local_temperature','t':_0x15335f(0x1e3)},{'s':_0x15335f(0x1c7),'t':'valve_position'},{'s':'temperature','t':'level'}]);for(const _0x2d05a7 of _0x538859){if(_0x5c159b[_0x15335f(0x246)](_0x2d05a7['s'])){const _0x4d8a70=_0x5c159b[_0x15335f(0x21f)](_0x2d05a7['s'],_0x2d05a7['t']),_0x1cea3a=await _0x27b696['getForeignObjectAsync'](_0x4d8a70);if(_0x1cea3a)return _0x4d8a70;}}try{const _0x1ee333=_0x5c159b[_0x15335f(0x1dc)]('.');if(_0x1ee333[_0x15335f(0x1e7)]>0x2){const _0x500b56=_0x1ee333['slice'](0x0,-0x1)[_0x15335f(0x20a)]('.'),_0x56a912=await _0x27b696[_0x15335f(0x1e1)](_0x500b56+'.*'),_0xaf0863=[],_0x10c62b=_0x5c159b['split'](/[._]+/)['filter'](_0x493223=>!['openknx','0',_0x15335f(0x23d),'ist',_0x15335f(0x228),_0x15335f(0x1c7),'actual',_0x15335f(0x1eb),_0x15335f(0x244),_0x15335f(0x22f)][_0x15335f(0x246)](_0x493223[_0x15335f(0x1db)]()));for(const [_0x1d305b,_0x5c2541]of Object[_0x15335f(0x20b)](_0x56a912)){if(_0x1d305b===_0x5c159b)continue;if(_0x5c2541&&_0x5c2541[_0x15335f(0x1f3)]){const _0x32da1f=_0x1d305b[_0x15335f(0x1db)](),_0x156695=(_0x5c2541[_0x15335f(0x1f3)][_0x15335f(0x1ce)]||'')[_0x15335f(0x1db)](),_0x15a890=(_0x5c2541[_0x15335f(0x1f3)]['unit']||'')[_0x15335f(0x1db)]();let _0x3e67b9=![];if(_0x4aac69===_0x15335f(0x222)&&_0x5c2541[_0x15335f(0x1f3)]['write']===!![])_0x3e67b9=_0x32da1f[_0x15335f(0x246)](_0x15335f(0x1d2))||_0x32da1f['includes'](_0x15335f(0x1fd))||_0x32da1f[_0x15335f(0x246)](_0x15335f(0x1fa))||_0x156695[_0x15335f(0x246)](_0x15335f(0x20e))||_0x156695[_0x15335f(0x246)]('thermostat.setpoint');else _0x4aac69===_0x15335f(0x225)&&(_0x3e67b9=_0x32da1f[_0x15335f(0x246)](_0x15335f(0x245))||_0x32da1f[_0x15335f(0x246)](_0x15335f(0x225))||_0x32da1f[_0x15335f(0x246)]('stellwert')||_0x32da1f[_0x15335f(0x246)](_0x15335f(0x229))||_0x156695[_0x15335f(0x246)](_0x15335f(0x248))||_0x156695[_0x15335f(0x246)](_0x15335f(0x206))||_0x15a890[_0x15335f(0x246)]('%'));if(_0x3e67b9){const _0x2cb209=_0x1d305b['split'](/[._]+/)[_0x15335f(0x247)](_0x3473aa=>_0x3473aa[_0x15335f(0x1db)]());let _0xaade6d=0x0;_0x10c62b[_0x15335f(0x1fe)](_0x30ab67=>{const _0x40890d=_0x15335f;if(_0x2cb209[_0x40890d(0x246)](_0x30ab67[_0x40890d(0x1db)]()))_0xaade6d++;}),_0xaf0863['push']({'id':_0x1d305b,'score':_0xaade6d});}}}if(_0xaf0863[_0x15335f(0x1e7)]>0x0){_0xaf0863['sort']((_0x2b36e6,_0x5ef316)=>_0x5ef316[_0x15335f(0x1dd)]-_0x2b36e6['score']);if(_0xaf0863[0x0][_0x15335f(0x1dd)]>0x0)return _0xaf0863[0x0]['id'];}}}catch(_0x34dd4f){}return null;}async function scanThermostats(_0x580df8){const _0xf290a0=a1_0x1c96b9,_0x390979=_0x580df8[_0xf290a0(0x22d)][_0xf290a0(0x1e6)]||[],_0x4d8834=[],_0x4ab87e=_0x390979['filter'](_0x5ace86=>_0x5ace86['id']&&_0x5ace86['id'][_0xf290a0(0x246)](_0xf290a0(0x1c7))||_0x5ace86[_0xf290a0(0x1c8)]&&[_0xf290a0(0x1c7),_0xf290a0(0x227),_0xf290a0(0x1eb)]['includes'](_0x5ace86[_0xf290a0(0x1c8)])||_0x5ace86[_0xf290a0(0x241)]&&_0x5ace86[_0xf290a0(0x241)][_0xf290a0(0x1db)]()[_0xf290a0(0x246)](_0xf290a0(0x1ea)));for(const _0x42e80d of _0x4ab87e){const _0x14ab4c=await findRelatedId(_0x580df8,_0x42e80d['id'],_0xf290a0(0x222)),_0x5106a5=await findRelatedId(_0x580df8,_0x42e80d['id'],_0xf290a0(0x225));let _0x88f547='Nicht\x20gefunden',_0x4fe2a8=![],_0x3708b0=_0x580df8[_0xf290a0(0x22d)][_0xf290a0(0x21b)]||{};if(typeof _0x3708b0===_0xf290a0(0x1ca))try{_0x3708b0=JSON['parse'](_0x3708b0);}catch(_0x5e7802){}let _0x5d8fd8=_0x580df8['config'][_0xf290a0(0x20c)]||{};if(typeof _0x5d8fd8===_0xf290a0(0x1ca))try{_0x5d8fd8=JSON[_0xf290a0(0x243)](_0x5d8fd8);}catch(_0x445aea){}if(_0x3708b0[_0x42e80d['id']]&&_0x3708b0[_0x42e80d['id']]===_0x14ab4c||_0x5d8fd8[_0x42e80d['id']]&&_0x5d8fd8[_0x42e80d['id']]===_0x5106a5)_0x88f547=_0xf290a0(0x1cf),_0x4fe2a8=!![];else(_0x14ab4c||_0x5106a5)&&(_0x88f547=_0xf290a0(0x1e9));_0x4d8834[_0xf290a0(0x1ee)]({'room':_0x42e80d['location']||_0xf290a0(0x1e2),'sensorId':_0x42e80d['id'],'setpointId':_0x14ab4c||'-','valveId':_0x5106a5||'-','source':_0x88f547,'isManual':_0x4fe2a8,'status':_0x14ab4c&&_0x5106a5?_0xf290a0(0x203):_0x14ab4c?'OK':_0xf290a0(0x249)});}return _0x4d8834[_0xf290a0(0x204)]((_0x8bd3b5,_0x16c011)=>_0x8bd3b5[_0xf290a0(0x201)][_0xf290a0(0x1f4)](_0x16c011[_0xf290a0(0x201)]));}async function checkCalendarTriggers(_0x5d9837){const _0x4e709e=a1_0x1c96b9;if(!_0x5d9837['config'][_0x4e709e(0x1f5)]||!_0x5d9837[_0x4e709e(0x22d)]['calendarInstance'])return;let _0x1c3b3f={};try{const _0x311686=await _0x5d9837[_0x4e709e(0x23b)]('analysis.energy.warmupTimes');if(_0x311686&&_0x311686[_0x4e709e(0x234)])_0x1c3b3f=JSON[_0x4e709e(0x243)](_0x311686[_0x4e709e(0x234)]);}catch(_0x1544ff){}try{const _0x4a2cdd=await _0x5d9837[_0x4e709e(0x1d8)](_0x5d9837['config'][_0x4e709e(0x217)]+_0x4e709e(0x210));if(!_0x4a2cdd||!_0x4a2cdd['val'])return;const _0x4fa4a3=JSON[_0x4e709e(0x243)](_0x4a2cdd['val']),_0x25da97=new Date(),_0x231032=_0x5d9837[_0x4e709e(0x22d)][_0x4e709e(0x1e6)]||[],_0x1d32ce=_0x5d9837[_0x4e709e(0x22d)][_0x4e709e(0x23f)]||[];for(const _0x2abbf1 of _0x4fa4a3){if(_0x2abbf1[_0x4e709e(0x230)]&&_0x1d32ce[_0x4e709e(0x1e7)]>0x0&&!_0x1d32ce[_0x4e709e(0x246)](_0x2abbf1[_0x4e709e(0x230)]))continue;const _0x115d3d=new Date(_0x2abbf1[_0x4e709e(0x237)]),_0x2d8eed=(_0x2abbf1[_0x4e709e(0x216)]||_0x2abbf1['summary']||'')[_0x4e709e(0x1db)]();if(_0x2d8eed[_0x4e709e(0x246)](_0x4e709e(0x1f8))||_0x2d8eed[_0x4e709e(0x246)](_0x4e709e(0x213))||_0x2d8eed['includes']('ankunft')){let _0x43466d=0x0;Object[_0x4e709e(0x221)](_0x1c3b3f)[_0x4e709e(0x1fe)](_0x342443=>{if(_0x342443>_0x43466d)_0x43466d=_0x342443;});if(_0x43466d===0x0)_0x43466d=0x78;const _0x16698f=new Date(_0x115d3d[_0x4e709e(0x207)]()-_0x43466d*0xea60),_0x5e97ec=_0x25da97[_0x4e709e(0x207)]()-_0x16698f[_0x4e709e(0x207)]();_0x5e97ec>=0x0&&_0x5e97ec<0xf*0xea60&&(_0x5d9837['log'][_0x4e709e(0x22b)](_0x4e709e(0x1f7)+_0x2abbf1[_0x4e709e(0x216)]+_0x4e709e(0x239)+_0x43466d+_0x4e709e(0x1ef)),await _0x5d9837[_0x4e709e(0x1d7)]('system.mode',{'val':_0x4e709e(0x1d6),'ack':![]}));}for(const _0x30d747 of _0x231032){if(_0x30d747[_0x4e709e(0x20d)]){const _0x31e782=_0x30d747[_0x4e709e(0x20d)][_0x4e709e(0x1db)]();if(_0x2d8eed[_0x4e709e(0x246)](_0x31e782)){const _0x38c1cf=_0x1c3b3f[_0x30d747['location']]||0x3c,_0x24dbf6=new Date(_0x115d3d[_0x4e709e(0x207)]()-_0x38c1cf*0xea60),_0x5c5c7c=_0x25da97[_0x4e709e(0x207)]()-_0x24dbf6[_0x4e709e(0x207)]();if(_0x5c5c7c>=0x0&&_0x5c5c7c<0xf*0xea60){const _0x31621a=await findRelatedId(_0x5d9837,_0x30d747['id'],'setpoint');_0x31621a&&(_0x5d9837['log'][_0x4e709e(0x22b)](_0x4e709e(0x205)+_0x30d747['location']+_0x4e709e(0x1c9)+_0x2abbf1[_0x4e709e(0x216)]+_0x4e709e(0x1de)+_0x38c1cf+_0x4e709e(0x1ef)),await _0x5d9837[_0x4e709e(0x1f6)](_0x31621a,0x15),await _0x5d9837[_0x4e709e(0x1d7)](_0x4e709e(0x1fb),{'val':_0x4e709e(0x1d4)+_0x30d747[_0x4e709e(0x20d)]+_0x4e709e(0x215),'ack':!![]}));}}}}}}catch(_0x157f60){_0x5d9837[_0x4e709e(0x23a)][_0x4e709e(0x1df)](_0x4e709e(0x212)+_0x157f60['message']);}}async function applyEnergySavings(_0x1942f8,_0x183308){const _0x45b283=a1_0x1c96b9,_0x8e8435=_0x1942f8[_0x45b283(0x22d)][_0x45b283(0x1e6)]||[];for(const _0x116b76 of _0x183308){const _0x329759=_0x116b76[_0x45b283(0x201)],_0x1d2c76=_0x116b76[_0x45b283(0x1ff)],_0x41699e=Date['now']();if(lastActions[_0x45b283(0x220)+_0x329759]&&_0x41699e-lastActions[_0x45b283(0x220)+_0x329759]<0x1e*0x3c*0x3e8)continue;const _0x2451b7=_0x8e8435['find'](_0x213f33=>normalize(_0x213f33[_0x45b283(0x20d)])===normalize(_0x329759));if(!_0x2451b7)continue;const _0x565566=await findRelatedId(_0x1942f8,_0x2451b7['id'],_0x45b283(0x222));if(_0x565566){const _0x56b1d7=await _0x1942f8[_0x45b283(0x1d8)](_0x565566);if(_0x56b1d7&&typeof _0x56b1d7[_0x45b283(0x234)]===_0x45b283(0x1ed)){const _0x2a9e76=_0x56b1d7['val'];if(_0x1d2c76>0x1e&&_0x2a9e76>0x11){const _0x3a5064=_0x2a9e76-0x1;_0x1942f8[_0x45b283(0x23a)][_0x45b283(0x22b)]('üçÉ\x20MPC\x20Autonomy:\x20Senke\x20'+_0x329759+'\x20('+_0x565566+')\x20auf\x20'+_0x3a5064+_0x45b283(0x21a)+_0x1d2c76+_0x45b283(0x1d0)),await _0x1942f8['setForeignStateAsync'](_0x565566,_0x3a5064),lastActions['mpc_'+_0x329759]=_0x41699e,await _0x1942f8[_0x45b283(0x1d7)](_0x45b283(0x1fb),{'val':_0x45b283(0x238)+_0x329759+_0x45b283(0x1d3),'ack':!![]});}}}}}module[a1_0x1c96b9(0x22a)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};