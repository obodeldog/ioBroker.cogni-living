const a1_0x51865c=a1_0x2c4b;(function(_0x1b0970,_0x12a170){const _0x3568a4=a1_0x2c4b,_0x50770b=_0x1b0970();while(!![]){try{const _0x22d7dd=parseInt(_0x3568a4(0x140))/0x1*(parseInt(_0x3568a4(0x19b))/0x2)+parseInt(_0x3568a4(0x151))/0x3*(parseInt(_0x3568a4(0x17b))/0x4)+-parseInt(_0x3568a4(0x19d))/0x5+-parseInt(_0x3568a4(0x1d9))/0x6+parseInt(_0x3568a4(0x17a))/0x7*(parseInt(_0x3568a4(0x13e))/0x8)+parseInt(_0x3568a4(0x17c))/0x9+-parseInt(_0x3568a4(0x1d6))/0xa;if(_0x22d7dd===_0x12a170)break;else _0x50770b['push'](_0x50770b['shift']());}catch(_0x124f68){_0x50770b['push'](_0x50770b['shift']());}}}(a1_0x37f6,0xa1948));const a1_0x1a14de=(function(){let _0x2120ef=!![];return function(_0x34cb8e,_0x3acd6f){const _0x5e268f=_0x2120ef?function(){const _0x4b0dfe=a1_0x2c4b;if(_0x3acd6f){const _0x1e2ae7=_0x3acd6f[_0x4b0dfe(0x1bb)](_0x34cb8e,arguments);return _0x3acd6f=null,_0x1e2ae7;}}:function(){};return _0x2120ef=![],_0x5e268f;};}()),a1_0x179e22=a1_0x1a14de(this,function(){const _0x31c5d2=a1_0x2c4b;return a1_0x179e22[_0x31c5d2(0x19c)]()[_0x31c5d2(0x189)](_0x31c5d2(0x1d0))[_0x31c5d2(0x19c)]()['constructor'](a1_0x179e22)[_0x31c5d2(0x189)](_0x31c5d2(0x1d0));});a1_0x179e22();'use strict';const aiAgent=require(a1_0x51865c(0x14f)),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x5c1e4c){const _0xa4d7df=a1_0x51865c;if(!_0x5c1e4c)return'';return _0x5c1e4c[_0xa4d7df(0x1b1)]()[_0xa4d7df(0x18c)](/\s+/g,'')['trim']();}async function logAutomationAction(_0x41ec6b,_0xcb0870){const _0x5cef5a=a1_0x51865c;await _0x41ec6b[_0x5cef5a(0x1b6)](_0x5cef5a(0x182),{'val':_0xcb0870,'ack':!![]});try{const _0x295a81=_0x5cef5a(0x16b),_0x4750c4=await _0x41ec6b['getStateAsync'](_0x295a81);let _0x2038f6=[];if(_0x4750c4&&_0x4750c4['val'])try{_0x2038f6=JSON['parse'](_0x4750c4[_0x5cef5a(0x158)]);}catch(_0x54121a){}_0x2038f6[_0x5cef5a(0x1be)]({'ts':Date[_0x5cef5a(0x185)](),'msg':_0xcb0870});if(_0x2038f6[_0x5cef5a(0x199)]>0x32)_0x2038f6=_0x2038f6[_0x5cef5a(0x1b7)](0x0,0x32);await _0x41ec6b[_0x5cef5a(0x1b6)](_0x295a81,{'val':JSON['stringify'](_0x2038f6),'ack':!![]});}catch(_0x2dd4a2){}}async function handlePrediction(_0x4e37e2,_0x4e2208,_0x14111c){const _0xd91054=a1_0x51865c;if(!_0x4e2208||_0x4e2208==='Unknown')return;let _0x221def=_0xd91054(0x1b0),_0x2d2e9e=0.6;try{const _0x1de497=await _0x4e37e2['getStateAsync'](_0xd91054(0x1cb));if(_0x1de497&&_0x1de497[_0xd91054(0x158)])_0x221def=_0x1de497[_0xd91054(0x158)];const _0x2bf774=await _0x4e37e2[_0xd91054(0x1ca)](_0xd91054(0x1ce));if(_0x2bf774&&_0x2bf774[_0xd91054(0x158)])_0x2d2e9e=_0x2bf774[_0xd91054(0x158)];}catch(_0x3c6104){}if(_0x221def===_0xd91054(0x1b0)||_0x14111c<_0x2d2e9e)return;const _0x27893a=Date[_0xd91054(0x185)]();if(lastActions[_0x4e2208]&&_0x27893a-lastActions[_0x4e2208]<COOLDOWN_MS)return;const _0x2c1ea0=_0x4e37e2[_0xd91054(0x167)][_0xd91054(0x1bf)]||[],_0x38ca66=normalize(_0x4e2208),_0x3bd20d=_0x2c1ea0['find'](_0x504a78=>normalize(_0x504a78[_0xd91054(0x1c7)])===_0x38ca66&&(_0x504a78[_0xd91054(0x1bc)]===_0xd91054(0x1da)||_0x504a78[_0xd91054(0x1bc)]==='dimmer'||_0x504a78[_0xd91054(0x1bc)]===_0xd91054(0x1af)));if(!_0x3bd20d)return;const _0x2a441d=await aiAgent[_0xd91054(0x1e2)](_0x4e37e2,_0x4e2208,_0x3bd20d[_0xd91054(0x156)],_0x14111c);if(!_0x2a441d['approved'])return;const _0x3d4710=_0xd91054(0x154)+_0x4e2208+_0xd91054(0x170)+_0x3bd20d[_0xd91054(0x156)]+'\x20('+_0x2a441d['reason']+')';await logAutomationAction(_0x4e37e2,'['+_0x221def[_0xd91054(0x169)]()+']\x20'+_0x3d4710);if(_0x221def===_0xd91054(0x14b)){const _0x9567d4=await _0x4e37e2[_0xd91054(0x1c6)](_0x3bd20d['id']);(!_0x9567d4||!_0x9567d4[_0xd91054(0x158)]&&_0x9567d4[_0xd91054(0x158)]!==!![])&&await _0x4e37e2[_0xd91054(0x1a5)](_0x3bd20d['id'],!![]),lastActions[_0x4e2208]=_0x27893a;}}function a1_0x37f6(){const _0x42d6c8=['\x20min).','summary','DEBUG:\x20','Soll','splice','analysis.energy.mpcActiveInterventions','getTime','\x20auf\x20','room','config','occupied_heating_setpoint','toUpperCase','useCalendar','analysis.automation.actionLog','level.temperature','actual',']:\x20Raum-Trigger\x20\x27','Â°C!\x20(Puffer:\x20','\x20->\x20Schalte\x20','filter','add','from','abs','\x27\x20gefunden!\x20PrÃ¼fe\x20Schreibweise.','includes','DEBUG:\x20Setpoint-ID\x20fÃ¼r\x20\x27','.data.table','stringify','7IAVkMt','2542336kctCfd','9943785zSXyEu','PERFECT','string','state','\x20gefunden!','[MPC]\x20','analysis.automation.lastAction','Ist','thermostatMapping','now','event','.4.SET_TEMPERATURE','Unbekannt','search','Â°C\x20(nicht\x20','ist','replace','getForeignObjectsAsync','.1.TEMPERATURE','ðŸ“…\x20SMART\x20SCHEDULE\x20[','position','target','write','urlaub\x20ende','set','cal_','ACTUAL_TEMPERATURE','[CAL]\x20','isArray','length','map','212GkMgEL','toString','64320XauttU','info','split','join','[MPC\x20WARNING]\x20Kein\x20Setpoint\x20fÃ¼r\x20','exports','mpc_','currentSystemMode','setForeignStateAsync','valveMapping',':\x20Aufheizen\x20auf\x20','Manuelles\x20Mapping','sensor','message','openknx','number','.1.ACTUAL_TEMPERATURE','date','switch','off','toLowerCase','stellwert','.1.SET_POINT_TEMPERATURE','common','triggerTime','setStateAsync','slice','temp','system.mode','\x20ist\x20auf\x20','apply','type','ankunft','unshift','devices','role','parse','setpoint','calendarSelection','eventStart','debug','getForeignStateAsync','location','valve_position','null','getStateAsync','analysis.automation.mode','Â°C!\x20(Puffer\x20leer).','local_temperature','analysis.automation.confidenceThreshold','.4.VALVE_STATE','(((.+)+)+)+$','thermostat.setpoint','Â°C\x20um\x20diese\x20Zeit.','ACTUAL','Nicht\x20gefunden','localeCompare','4607090yOgrgo','DEBUG:\x20PrÃ¼fe\x20Liste:\x20','soll','5782362jeBlJP','light','\x20->\x20','analysis.energy.schedulePreview','wert','pi_heating_demand','score','_date','value.valve','consultButler','rÃ¼ckkehr','forEach','remove','ðŸƒ\x20[MPC\x20ACTION]\x20Senke\x20','warn','\x27\x20gefunden.\x20Typ:\x20','\x27\x20(Sensor:\x20','valve','hm-rpc','768968KptxNf','Â°C).\x20Entferne\x20Status.','2477xtUKvh','unit','Â°C\x20(Vorlauf:\x20','find','sort','push','ðŸ§¹\x20[MPC\x20CLEANUP]\x20','_calName','\x27\x20aktiv.\x20Heize\x20auf\x20','entries','Auto-Erkennung','active','indexOf','sendToPythonWrapper','thermostat','./ai_agent','current_heating_setpoint','3GffIcl',':\x20Absenkung\x20auf\x20','\x20->\x20Setpoint\x20ID:\x20','PrÃ¤diktion:\x20','temperature','name','messwert','val','calendarInstance','log','.1.LEVEL','analysis.energy.warmupTimes','Fehlt'];a1_0x37f6=function(){return _0x42d6c8;};return a1_0x37f6();}async function findRelatedId(_0x819a31,_0x389253,_0x55f1af=a1_0x51865c(0x1c2)){const _0x1166c1=a1_0x51865c;if(_0x55f1af===_0x1166c1(0x1c2)&&_0x819a31[_0x1166c1(0x167)][_0x1166c1(0x184)]){let _0x2e4497=_0x819a31[_0x1166c1(0x167)]['thermostatMapping'];if(typeof _0x2e4497===_0x1166c1(0x17e))try{_0x2e4497=JSON['parse'](_0x2e4497);}catch(_0x4f16d5){}if(_0x2e4497&&_0x2e4497[_0x389253])return _0x2e4497[_0x389253];}if(_0x55f1af==='valve'&&_0x819a31[_0x1166c1(0x167)]['valveMapping']){let _0x230c6d=_0x819a31[_0x1166c1(0x167)][_0x1166c1(0x1a6)];if(typeof _0x230c6d==='string')try{_0x230c6d=JSON[_0x1166c1(0x1c1)](_0x230c6d);}catch(_0xe6668b){}if(_0x230c6d&&_0x230c6d[_0x389253])return _0x230c6d[_0x389253];}let _0x430194=[];if(_0x55f1af==='setpoint')_0x430194=[{'s':_0x1166c1(0x1ad),'t':_0x1166c1(0x1b3)},{'s':_0x1166c1(0x18e),'t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x1166c1(0x18e),'t':_0x1166c1(0x187)},{'s':_0x1166c1(0x196),'t':'SET_POINT_TEMPERATURE'},{'s':_0x1166c1(0x1cd),'t':_0x1166c1(0x168)},{'s':_0x1166c1(0x1cd),'t':_0x1166c1(0x150)},{'s':'temperature','t':'target_temperature'},{'s':_0x1166c1(0x1d3),'t':'SET'},{'s':_0x1166c1(0x183),'t':_0x1166c1(0x161)},{'s':'temperature','t':_0x1166c1(0x1c2)}];else _0x55f1af===_0x1166c1(0x13c)&&(_0x430194=[{'s':_0x1166c1(0x1ad),'t':_0x1166c1(0x15b)},{'s':_0x1166c1(0x18e),'t':_0x1166c1(0x15b)},{'s':'.1.TEMPERATURE','t':_0x1166c1(0x1cf)},{'s':_0x1166c1(0x1cd),'t':_0x1166c1(0x1de)},{'s':_0x1166c1(0x155),'t':_0x1166c1(0x1c8)},{'s':'temperature','t':'level'}]);for(const _0x256aa1 of _0x430194){if(_0x389253[_0x1166c1(0x176)](_0x256aa1['s'])){const _0x5ced45=_0x389253[_0x1166c1(0x18c)](_0x256aa1['s'],_0x256aa1['t']),_0x4abdad=await _0x819a31['getForeignObjectAsync'](_0x5ced45);if(_0x4abdad)return _0x5ced45;}}try{const _0x5f3378=_0x389253['split']('.');if(_0x5f3378['length']>0x2){const _0x18fffe=_0x5f3378[_0x1166c1(0x1b7)](0x0,-0x1)[_0x1166c1(0x1a0)]('.'),_0x53dc5e=await _0x819a31[_0x1166c1(0x18d)](_0x18fffe+'.*'),_0x1f4bb9=[],_0x8af7f1=_0x389253[_0x1166c1(0x19f)](/[._]+/)[_0x1166c1(0x171)](_0x23ad37=>![_0x1166c1(0x1ab),'0',_0x1166c1(0x13d),_0x1166c1(0x18b),_0x1166c1(0x1dd),'temperature',_0x1166c1(0x16d),_0x1166c1(0x1a9),_0x1166c1(0x157),_0x1166c1(0x17f)][_0x1166c1(0x176)](_0x23ad37[_0x1166c1(0x1b1)]()));for(const [_0x549af3,_0x45e04d]of Object[_0x1166c1(0x149)](_0x53dc5e)){if(_0x549af3===_0x389253)continue;if(_0x45e04d&&_0x45e04d['common']){const _0x1b9efb=_0x549af3['toLowerCase'](),_0x284ff4=(_0x45e04d[_0x1166c1(0x1b4)][_0x1166c1(0x1c0)]||'')['toLowerCase'](),_0x5270f5=(_0x45e04d['common'][_0x1166c1(0x141)]||'')['toLowerCase']();let _0x409c07=![];if(_0x55f1af===_0x1166c1(0x1c2)&&_0x45e04d['common'][_0x1166c1(0x192)]===!![])_0x409c07=_0x1b9efb[_0x1166c1(0x176)](_0x1166c1(0x194))||_0x1b9efb[_0x1166c1(0x176)](_0x1166c1(0x1d8))||_0x1b9efb[_0x1166c1(0x176)](_0x1166c1(0x191))||_0x284ff4[_0x1166c1(0x176)](_0x1166c1(0x16c))||_0x284ff4[_0x1166c1(0x176)](_0x1166c1(0x1d1));else _0x55f1af===_0x1166c1(0x13c)&&(_0x409c07=_0x1b9efb[_0x1166c1(0x176)]('level')||_0x1b9efb[_0x1166c1(0x176)](_0x1166c1(0x13c))||_0x1b9efb['includes'](_0x1166c1(0x1b2))||_0x1b9efb[_0x1166c1(0x176)](_0x1166c1(0x190))||_0x284ff4[_0x1166c1(0x176)]('level.valve')||_0x284ff4[_0x1166c1(0x176)](_0x1166c1(0x1e1))||_0x5270f5[_0x1166c1(0x176)]('%'));if(_0x409c07){const _0x25f5a0=_0x549af3[_0x1166c1(0x19f)](/[._]+/)[_0x1166c1(0x19a)](_0x575668=>_0x575668[_0x1166c1(0x1b1)]());let _0x13d993=0x0;_0x8af7f1[_0x1166c1(0x1e4)](_0x8fe8c4=>{const _0x2342f9=_0x1166c1;if(_0x25f5a0['includes'](_0x8fe8c4[_0x2342f9(0x1b1)]()))_0x13d993++;}),_0x1f4bb9['push']({'id':_0x549af3,'score':_0x13d993});}}}if(_0x1f4bb9[_0x1166c1(0x199)]>0x0){_0x1f4bb9[_0x1166c1(0x144)]((_0x3bb9ba,_0x1fe800)=>_0x1fe800[_0x1166c1(0x1df)]-_0x3bb9ba[_0x1166c1(0x1df)]);if(_0x1f4bb9[0x0][_0x1166c1(0x1df)]>0x0)return _0x1f4bb9[0x0]['id'];}}}catch(_0x2c27ad){}return null;}async function scanThermostats(_0xad55e){const _0x2dc8f5=a1_0x51865c,_0x49ac7a=_0xad55e[_0x2dc8f5(0x167)][_0x2dc8f5(0x1bf)]||[],_0x25e337=[],_0x5e8c92=_0x49ac7a['filter'](_0x3b41f9=>_0x3b41f9['id']&&_0x3b41f9['id'][_0x2dc8f5(0x176)](_0x2dc8f5(0x155))||_0x3b41f9[_0x2dc8f5(0x1bc)]&&['temperature','thermostat',_0x2dc8f5(0x1a9)][_0x2dc8f5(0x176)](_0x3b41f9[_0x2dc8f5(0x1bc)])||_0x3b41f9[_0x2dc8f5(0x156)]&&_0x3b41f9[_0x2dc8f5(0x156)]['toLowerCase']()[_0x2dc8f5(0x176)](_0x2dc8f5(0x1b8)));for(const _0x581cc of _0x5e8c92){const _0x3e524a=await findRelatedId(_0xad55e,_0x581cc['id'],_0x2dc8f5(0x1c2)),_0x5ba834=await findRelatedId(_0xad55e,_0x581cc['id'],_0x2dc8f5(0x13c));let _0x14cfa4=_0x2dc8f5(0x1d4),_0x25a0be=![],_0x29969f=_0xad55e[_0x2dc8f5(0x167)][_0x2dc8f5(0x184)]||{};if(typeof _0x29969f===_0x2dc8f5(0x17e))try{_0x29969f=JSON[_0x2dc8f5(0x1c1)](_0x29969f);}catch(_0x3611b0){}let _0x23b183=_0xad55e[_0x2dc8f5(0x167)][_0x2dc8f5(0x1a6)]||{};if(typeof _0x23b183===_0x2dc8f5(0x17e))try{_0x23b183=JSON[_0x2dc8f5(0x1c1)](_0x23b183);}catch(_0x5c0421){}if(_0x29969f[_0x581cc['id']]&&_0x29969f[_0x581cc['id']]===_0x3e524a||_0x23b183[_0x581cc['id']]&&_0x23b183[_0x581cc['id']]===_0x5ba834)_0x14cfa4=_0x2dc8f5(0x1a8),_0x25a0be=!![];else(_0x3e524a||_0x5ba834)&&(_0x14cfa4=_0x2dc8f5(0x14a));_0x25e337[_0x2dc8f5(0x145)]({'room':_0x581cc[_0x2dc8f5(0x1c7)]||_0x2dc8f5(0x188),'sensorId':_0x581cc['id'],'setpointId':_0x3e524a||'-','valveId':_0x5ba834||'-','source':_0x14cfa4,'isManual':_0x25a0be,'status':_0x3e524a&&_0x5ba834?_0x2dc8f5(0x17d):_0x3e524a?'OK':_0x2dc8f5(0x15d)});}return _0x25e337[_0x2dc8f5(0x144)]((_0x3bca8f,_0x6f106f)=>_0x3bca8f[_0x2dc8f5(0x166)][_0x2dc8f5(0x1d5)](_0x6f106f['room']));}async function updateSchedulePreview(_0x3af6c6){const _0x33654f=a1_0x51865c;if(!_0x3af6c6['config'][_0x33654f(0x16a)]||!_0x3af6c6[_0x33654f(0x167)][_0x33654f(0x159)])return;let _0x3aee37={};try{const _0x7bbd9a=await _0x3af6c6[_0x33654f(0x1ca)]('analysis.energy.warmupTimes');if(_0x7bbd9a&&_0x7bbd9a['val'])_0x3aee37=JSON[_0x33654f(0x1c1)](_0x7bbd9a[_0x33654f(0x158)]);}catch(_0x3acfbf){}const _0x168601=[],_0x45e453=Date['now'](),_0x12e438=0x30*0x3c*0x3c*0x3e8;try{const _0x196b61=await _0x3af6c6[_0x33654f(0x1c6)](_0x3af6c6[_0x33654f(0x167)][_0x33654f(0x159)]+'.data.table');if(!_0x196b61||!_0x196b61[_0x33654f(0x158)])return;const _0x3f8f7b=JSON['parse'](_0x196b61[_0x33654f(0x158)]),_0x3f06c8=_0x3af6c6[_0x33654f(0x167)]['calendarSelection']||[],_0x1ffec4=_0x3af6c6['config'][_0x33654f(0x1bf)]||[],_0x457921=new Set();_0x1ffec4[_0x33654f(0x1e4)](_0x115823=>{const _0x2b847a=_0x33654f;if(_0x115823[_0x2b847a(0x1c7)])_0x457921[_0x2b847a(0x172)](_0x115823[_0x2b847a(0x1c7)]);});for(const _0x3703b5 of _0x3f8f7b){if(_0x3703b5[_0x33654f(0x147)]&&_0x3f06c8[_0x33654f(0x199)]>0x0&&!_0x3f06c8[_0x33654f(0x176)](_0x3703b5[_0x33654f(0x147)]))continue;const _0x577922=_0x3703b5['_date']||_0x3703b5[_0x33654f(0x1c4)]||_0x3703b5[_0x33654f(0x1ae)];if(!_0x577922)continue;const _0x2b1eee=new Date(_0x577922),_0x59e127=_0x2b1eee[_0x33654f(0x164)]();if(isNaN(_0x59e127))continue;if(_0x59e127<_0x45e453)continue;if(_0x59e127>_0x45e453+_0x12e438)continue;const _0x304379=(_0x3703b5['event']||_0x3703b5[_0x33654f(0x15f)]||'')[_0x33654f(0x1b1)]();let _0x57e5a8=![],_0x8784e2=[],_0x347c7c=_0x3703b5[_0x33654f(0x186)]||_0x3703b5[_0x33654f(0x15f)]||'Unbekannt';if(_0x304379[_0x33654f(0x176)](_0x33654f(0x193))||_0x304379['includes'](_0x33654f(0x1e3))||_0x304379[_0x33654f(0x176)](_0x33654f(0x1bd)))_0x57e5a8=!![],_0x8784e2=Array[_0x33654f(0x173)](_0x457921);else for(const _0x522a9f of _0x457921){if(_0x304379[_0x33654f(0x176)](_0x522a9f[_0x33654f(0x1b1)]()))_0x8784e2['push'](_0x522a9f);}_0x8784e2[_0x33654f(0x199)]>0x0&&_0x8784e2[_0x33654f(0x1e4)](_0x5b44c2=>{const _0x3f0184=_0x33654f;let _0x13e895=0x3c;if(_0x57e5a8){let _0x5cb990=0x0;Object['values'](_0x3aee37)['forEach'](_0x4fb92d=>{if(_0x4fb92d>_0x5cb990)_0x5cb990=_0x4fb92d;}),_0x13e895=_0x5cb990>0x0?_0x5cb990:0x78;}else _0x13e895=_0x3aee37[_0x5b44c2]||0x3c;const _0x3c2da6=new Date(_0x59e127-_0x13e895*0xea60);_0x168601[_0x3f0184(0x145)]({'eventTime':_0x59e127,'triggerTime':_0x3c2da6[_0x3f0184(0x164)](),'room':_0x5b44c2,'minutes':_0x13e895,'reason':_0x347c7c,'isGlobal':_0x57e5a8});});}}catch(_0x16c7b5){}_0x168601['sort']((_0x3af71a,_0x9587ba)=>_0x3af71a[_0x33654f(0x1b5)]-_0x9587ba[_0x33654f(0x1b5)]);const _0x4eb884=_0x168601[_0x33654f(0x1b7)](0x0,0x5);await _0x3af6c6[_0x33654f(0x1b6)](_0x33654f(0x1dc),{'val':JSON[_0x33654f(0x179)](_0x4eb884),'ack':!![]});}function a1_0x2c4b(_0x4bb643,_0x223eb2){const _0x36dae9=a1_0x37f6();return a1_0x2c4b=function(_0x179e22,_0x1a14de){_0x179e22=_0x179e22-0x137;let _0x37f66f=_0x36dae9[_0x179e22];return _0x37f66f;},a1_0x2c4b(_0x4bb643,_0x223eb2);}async function checkCalendarTriggers(_0x2f02c1){const _0x2faaa1=a1_0x51865c;if(!_0x2f02c1['config'][_0x2faaa1(0x16a)]||!_0x2f02c1[_0x2faaa1(0x167)]['calendarInstance'])return;await updateSchedulePreview(_0x2f02c1);let _0x4a32ef={},_0x5752f7={};try{const _0x1d1727=await _0x2f02c1[_0x2faaa1(0x1ca)](_0x2faaa1(0x15c));if(_0x1d1727&&_0x1d1727['val'])_0x4a32ef=JSON[_0x2faaa1(0x1c1)](_0x1d1727[_0x2faaa1(0x158)]);const _0x54557c=await _0x2f02c1[_0x2faaa1(0x1ca)]('analysis.energy.warmupSources');if(_0x54557c&&_0x54557c['val'])_0x5752f7=JSON[_0x2faaa1(0x1c1)](_0x54557c[_0x2faaa1(0x158)]);}catch(_0x491ebc){}let _0x2cdc98={'default':0x15};try{const _0x9bb1e7=await _0x2f02c1[_0x2faaa1(0x1ca)]('analysis.energy.warmupTargets');if(_0x9bb1e7&&_0x9bb1e7[_0x2faaa1(0x158)])_0x2cdc98=JSON['parse'](_0x9bb1e7['val']);}catch(_0x3ca79a){}try{const _0x287192=await _0x2f02c1['getForeignStateAsync'](_0x2f02c1['config'][_0x2faaa1(0x159)]+_0x2faaa1(0x178));if(!_0x287192||!_0x287192[_0x2faaa1(0x158)])return;const _0x38fc83=JSON[_0x2faaa1(0x1c1)](_0x287192['val']),_0x3321fe=Date[_0x2faaa1(0x185)](),_0x539f04=_0x2f02c1[_0x2faaa1(0x167)]['devices']||[],_0x3e68c0=_0x2f02c1[_0x2faaa1(0x167)][_0x2faaa1(0x1c3)]||[];for(const _0x567daf of _0x38fc83){if(_0x567daf['_calName']&&_0x3e68c0['length']>0x0&&!_0x3e68c0[_0x2faaa1(0x176)](_0x567daf[_0x2faaa1(0x147)]))continue;const _0x3992fa=_0x567daf[_0x2faaa1(0x1e0)]||_0x567daf[_0x2faaa1(0x1c4)]||_0x567daf[_0x2faaa1(0x1ae)];if(!_0x3992fa)continue;const _0x3929b5=new Date(_0x3992fa);if(isNaN(_0x3929b5[_0x2faaa1(0x164)]()))continue;const _0x12d5ab=(_0x567daf[_0x2faaa1(0x186)]||_0x567daf[_0x2faaa1(0x15f)]||'')[_0x2faaa1(0x1b1)]();if(_0x12d5ab['includes'](_0x2faaa1(0x193))||_0x12d5ab[_0x2faaa1(0x176)](_0x2faaa1(0x1e3))||_0x12d5ab[_0x2faaa1(0x176)](_0x2faaa1(0x1bd))){let _0x4bcc75=0x0;Object['values'](_0x4a32ef)[_0x2faaa1(0x1e4)](_0x92f4c9=>{if(_0x92f4c9>_0x4bcc75)_0x4bcc75=_0x92f4c9;});if(_0x4bcc75===0x0)_0x4bcc75=0x78;const _0x321cd0=_0x3929b5[_0x2faaa1(0x164)]()-_0x4bcc75*0xea60;_0x3321fe>=_0x321cd0&&_0x3321fe<_0x3929b5[_0x2faaa1(0x164)]()&&(_0x2f02c1[_0x2faaa1(0x1a4)]!=='normal'&&(_0x2f02c1[_0x2faaa1(0x15a)][_0x2faaa1(0x19e)]('ðŸ“…\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20'+_0x4bcc75+_0x2faaa1(0x15e)),await _0x2f02c1[_0x2faaa1(0x1b6)](_0x2faaa1(0x1b9),{'val':'normal','ack':![]})));}for(const _0x5825bb of _0x539f04){if(_0x5825bb['location']){const _0x1da6ca=_0x5825bb[_0x2faaa1(0x1c7)][_0x2faaa1(0x1b1)]();if(_0x12d5ab[_0x2faaa1(0x176)](_0x1da6ca)){const _0x25cf36=_0x4a32ef[_0x5825bb[_0x2faaa1(0x1c7)]]||0x3c,_0x3dab89=_0x5752f7[_0x5825bb[_0x2faaa1(0x1c7)]]||'Classic',_0xe6e37=_0x3929b5[_0x2faaa1(0x164)]()-_0x25cf36*0xea60;if(_0x3321fe>=_0xe6e37&&_0x3321fe<_0x3929b5[_0x2faaa1(0x164)]()){const _0xcdb703=lastActions['cal_'+_0x5825bb['location']];if(_0xcdb703&&_0x3321fe-_0xcdb703<CAL_COOLDOWN_MS)continue;const _0x8f709c=await findRelatedId(_0x2f02c1,_0x5825bb['id'],'setpoint');if(_0x8f709c){let _0x5b8b77=_0x2cdc98[_0x5825bb['location']];if(_0x5b8b77===undefined)_0x5b8b77=_0x2cdc98['default'];if(_0x5b8b77===undefined)_0x5b8b77=0x15;const _0xebb635=await _0x2f02c1['getForeignStateAsync'](_0x8f709c);_0xebb635&&typeof _0xebb635[_0x2faaa1(0x158)]===_0x2faaa1(0x1ac)&&_0xebb635[_0x2faaa1(0x158)]<_0x5b8b77-0.5&&(_0x2f02c1[_0x2faaa1(0x15a)][_0x2faaa1(0x19e)](_0x2faaa1(0x18f)+_0x3dab89+_0x2faaa1(0x16e)+_0x5825bb[_0x2faaa1(0x1c7)]+_0x2faaa1(0x148)+_0x5b8b77+_0x2faaa1(0x142)+_0x25cf36+'\x20min).'),await _0x2f02c1[_0x2faaa1(0x1a5)](_0x8f709c,_0x5b8b77),await logAutomationAction(_0x2f02c1,_0x2faaa1(0x197)+_0x5825bb[_0x2faaa1(0x1c7)]+_0x2faaa1(0x1db)+_0x5b8b77+'Â°C\x20(via\x20'+_0x3dab89+')'),lastActions[_0x2faaa1(0x195)+_0x5825bb[_0x2faaa1(0x1c7)]]=_0x3321fe);}}}}}}}catch(_0xe2e4db){_0x2f02c1[_0x2faaa1(0x15a)]['warn']('Calendar\x20Check\x20Error:\x20'+_0xe2e4db[_0x2faaa1(0x1aa)]);}}async function manageMpcIntervention(_0x4acdd0,_0x2ecbaa,_0x52ba90){const _0x162f5e=a1_0x51865c;try{const _0x41cfe5=_0x162f5e(0x163),_0x36b2a0=await _0x4acdd0[_0x162f5e(0x1ca)](_0x41cfe5);let _0x5c1350=[];if(_0x36b2a0&&_0x36b2a0[_0x162f5e(0x158)])try{_0x5c1350=JSON[_0x162f5e(0x1c1)](_0x36b2a0[_0x162f5e(0x158)]);}catch(_0x16eb3e){}const _0xca7035=_0x5c1350[_0x162f5e(0x14c)](_0x2ecbaa);if(_0x52ba90===_0x162f5e(0x172))_0xca7035===-0x1&&(_0x5c1350[_0x162f5e(0x145)](_0x2ecbaa),await _0x4acdd0[_0x162f5e(0x1b6)](_0x41cfe5,{'val':JSON['stringify'](_0x5c1350),'ack':!![]}));else _0x52ba90===_0x162f5e(0x137)&&(_0xca7035!==-0x1&&(_0x5c1350[_0x162f5e(0x162)](_0xca7035,0x1),await _0x4acdd0[_0x162f5e(0x1b6)](_0x41cfe5,{'val':JSON[_0x162f5e(0x179)](_0x5c1350),'ack':!![]})));}catch(_0x490cbe){}}async function cleanupGhostInterventions(_0x4e8ecc){const _0x40d6f3=a1_0x51865c;try{const _0xd11bd6='analysis.energy.mpcActiveInterventions',_0x13dd9b=await _0x4e8ecc['getStateAsync'](_0xd11bd6);if(!_0x13dd9b||!_0x13dd9b[_0x40d6f3(0x158)])return;const _0x1bc0d3=JSON['parse'](_0x13dd9b[_0x40d6f3(0x158)]);if(!Array[_0x40d6f3(0x198)](_0x1bc0d3)||_0x1bc0d3[_0x40d6f3(0x199)]===0x0)return;const _0x365715=_0x4e8ecc[_0x40d6f3(0x167)][_0x40d6f3(0x1bf)]||[];let _0x59330f=![];for(let _0x4e9c65=_0x1bc0d3['length']-0x1;_0x4e9c65>=0x0;_0x4e9c65--){const _0xd5d58a=_0x1bc0d3[_0x4e9c65],_0x5ac270=_0x365715[_0x40d6f3(0x143)](_0x7cafb3=>normalize(_0x7cafb3[_0x40d6f3(0x1c7)])===normalize(_0xd5d58a)&&(_0x7cafb3[_0x40d6f3(0x1bc)]===_0x40d6f3(0x155)||_0x7cafb3['type']===_0x40d6f3(0x14e)));if(_0x5ac270){const _0x1f4db7=await findRelatedId(_0x4e8ecc,_0x5ac270['id'],'setpoint');if(_0x1f4db7){const _0x4de618=await _0x4e8ecc[_0x40d6f3(0x1c6)](_0x1f4db7);_0x4de618&&typeof _0x4de618[_0x40d6f3(0x158)]===_0x40d6f3(0x1ac)&&(Math[_0x40d6f3(0x174)](_0x4de618[_0x40d6f3(0x158)]-ECO_TEMP)>0.5&&(_0x4e8ecc[_0x40d6f3(0x15a)][_0x40d6f3(0x19e)](_0x40d6f3(0x146)+_0xd5d58a+_0x40d6f3(0x1ba)+_0x4de618[_0x40d6f3(0x158)]+_0x40d6f3(0x18a)+ECO_TEMP+_0x40d6f3(0x13f)),_0x4e8ecc[_0x40d6f3(0x14d)]&&(_0x4e8ecc[_0x40d6f3(0x15a)][_0x40d6f3(0x19e)]('ðŸŽ“\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20'+_0xd5d58a+'\x20mag\x20keine\x20'+ECO_TEMP+_0x40d6f3(0x1d2)),_0x4e8ecc[_0x40d6f3(0x14d)]('TRAIN_RL_PENALTY',{'room':_0xd5d58a})),_0x1bc0d3[_0x40d6f3(0x162)](_0x4e9c65,0x1),_0x59330f=!![]));}}}_0x59330f&&await _0x4e8ecc[_0x40d6f3(0x1b6)](_0xd11bd6,{'val':JSON[_0x40d6f3(0x179)](_0x1bc0d3),'ack':!![]});}catch(_0x5ed3cc){}}async function applyEnergySavings(_0x39dd77,_0x3a3dc8){const _0x4e86fb=a1_0x51865c;await debugMpcCleanup(_0x39dd77),await cleanupGhostInterventions(_0x39dd77);if(!_0x3a3dc8||_0x3a3dc8['length']===0x0)return;const _0x353322=_0x39dd77[_0x4e86fb(0x167)][_0x4e86fb(0x1bf)]||[],_0x5bb4ec=Date[_0x4e86fb(0x185)]();for(const _0x47a81d of _0x3a3dc8){const _0x419847=_0x47a81d[_0x4e86fb(0x166)],_0x1efa4e=_0x47a81d['minutes_safe'],_0x149c39=_0x47a81d[_0x4e86fb(0x191)]||0x15,_0x58918f=_0x353322[_0x4e86fb(0x143)](_0x37da90=>normalize(_0x37da90[_0x4e86fb(0x1c7)])===normalize(_0x419847)&&(_0x37da90[_0x4e86fb(0x1bc)]===_0x4e86fb(0x155)||_0x37da90[_0x4e86fb(0x1bc)]===_0x4e86fb(0x14e)));if(!_0x58918f)continue;const _0x1d7d1a=await findRelatedId(_0x39dd77,_0x58918f['id'],'setpoint');if(_0x1d7d1a){if(lastActions[_0x4e86fb(0x1a3)+_0x419847]&&_0x5bb4ec-lastActions[_0x4e86fb(0x1a3)+_0x419847]<0x1e*0x3c*0x3e8)continue;const _0xa855f1=await _0x39dd77['getForeignStateAsync'](_0x1d7d1a);if(_0xa855f1&&typeof _0xa855f1[_0x4e86fb(0x158)]==='number'){const _0x2ba7f7=_0xa855f1['val'];_0x2ba7f7!==ECO_TEMP&&await manageMpcIntervention(_0x39dd77,_0x419847,_0x4e86fb(0x137));if(_0x1efa4e>0x1e)_0x2ba7f7>ECO_TEMP+0.5&&(_0x39dd77[_0x4e86fb(0x15a)][_0x4e86fb(0x19e)](_0x4e86fb(0x138)+_0x419847+_0x4e86fb(0x165)+ECO_TEMP+_0x4e86fb(0x16f)+_0x1efa4e+'\x20min)'),await _0x39dd77[_0x4e86fb(0x1a5)](_0x1d7d1a,ECO_TEMP),await manageMpcIntervention(_0x39dd77,_0x419847,'add'),lastActions['mpc_'+_0x419847]=_0x5bb4ec,await logAutomationAction(_0x39dd77,_0x4e86fb(0x181)+_0x419847+_0x4e86fb(0x152)+ECO_TEMP+'Â°C'));else _0x1efa4e<=0xf&&(_0x2ba7f7<_0x149c39&&(_0x39dd77[_0x4e86fb(0x15a)]['info']('ðŸ”¥\x20[MPC\x20ACTION]\x20Heize\x20'+_0x419847+'\x20wieder\x20auf\x20'+_0x149c39+_0x4e86fb(0x1cc)),await _0x39dd77[_0x4e86fb(0x1a5)](_0x1d7d1a,_0x149c39),await manageMpcIntervention(_0x39dd77,_0x419847,_0x4e86fb(0x137)),lastActions[_0x4e86fb(0x1a3)+_0x419847]=_0x5bb4ec,await logAutomationAction(_0x39dd77,_0x4e86fb(0x181)+_0x419847+_0x4e86fb(0x1a7)+_0x149c39+'Â°C')));}}else _0x39dd77[_0x4e86fb(0x15a)]['warn'](_0x4e86fb(0x1a1)+_0x419847+_0x4e86fb(0x180));}}async function debugMpcCleanup(_0x16c2da){const _0x107910=a1_0x51865c,_0x59bb74=_0x107910(0x163),_0x2a8acc=await _0x16c2da[_0x107910(0x1ca)](_0x59bb74);if(!_0x2a8acc||!_0x2a8acc['val']){_0x16c2da[_0x107910(0x15a)][_0x107910(0x139)]('DEBUG:\x20State\x20leer');return;}const _0x211c85=JSON[_0x107910(0x1c1)](_0x2a8acc[_0x107910(0x158)]);_0x16c2da[_0x107910(0x15a)]['warn'](_0x107910(0x1d7)+JSON[_0x107910(0x179)](_0x211c85));const _0x2daa86=_0x16c2da['config'][_0x107910(0x1bf)]||[];for(const _0x1400fc of _0x211c85){const _0x48eeef=_0x2daa86[_0x107910(0x143)](_0x2c8f26=>{const _0x3014c1=_0x107910,_0x40fef7=normalize(_0x2c8f26['location'])===normalize(_0x1400fc)&&(_0x2c8f26[_0x3014c1(0x1bc)]===_0x3014c1(0x155)||_0x2c8f26[_0x3014c1(0x1bc)]===_0x3014c1(0x14e));if(normalize(_0x2c8f26[_0x3014c1(0x1c7)])===normalize(_0x1400fc))_0x16c2da[_0x3014c1(0x15a)][_0x3014c1(0x1c5)]('DEBUG:\x20Raum-Match\x20\x27'+_0x1400fc+_0x3014c1(0x13a)+_0x2c8f26['type']);return _0x40fef7;});if(!_0x48eeef){_0x16c2da[_0x107910(0x15a)]['warn']('DEBUG:\x20Kein\x20Thermostat\x20fÃ¼r\x20Raum\x20\x27'+_0x1400fc+_0x107910(0x175));continue;}const _0x26ba39=await findRelatedId(_0x16c2da,_0x48eeef['id'],'setpoint');if(!_0x26ba39){_0x16c2da[_0x107910(0x15a)][_0x107910(0x139)](_0x107910(0x177)+_0x1400fc+_0x107910(0x13b)+_0x48eeef['id']+')\x20nicht\x20gefunden.');continue;}const _0x126056=await _0x16c2da[_0x107910(0x1c6)](_0x26ba39);_0x16c2da['log'][_0x107910(0x139)](_0x107910(0x160)+_0x1400fc+_0x107910(0x153)+_0x26ba39+',\x20Wert:\x20'+(_0x126056?_0x126056['val']:_0x107910(0x1c9)));}}module[a1_0x51865c(0x1a2)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'updateSchedulePreview':updateSchedulePreview};