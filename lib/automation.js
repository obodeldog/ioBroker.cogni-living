const a1_0x40d897=a1_0x17c5;(function(_0x174c1c,_0x422b03){const _0x2d6c77=a1_0x17c5,_0x50e4e3=_0x174c1c();while(!![]){try{const _0x291230=parseInt(_0x2d6c77(0x112))/0x1+parseInt(_0x2d6c77(0xcf))/0x2*(-parseInt(_0x2d6c77(0xb6))/0x3)+-parseInt(_0x2d6c77(0x92))/0x4+parseInt(_0x2d6c77(0x108))/0x5*(-parseInt(_0x2d6c77(0xdc))/0x6)+-parseInt(_0x2d6c77(0xf0))/0x7+parseInt(_0x2d6c77(0xfb))/0x8*(-parseInt(_0x2d6c77(0xb0))/0x9)+parseInt(_0x2d6c77(0xbc))/0xa*(parseInt(_0x2d6c77(0xdb))/0xb);if(_0x291230===_0x422b03)break;else _0x50e4e3['push'](_0x50e4e3['shift']());}catch(_0x2a16c4){_0x50e4e3['push'](_0x50e4e3['shift']());}}}(a1_0x5f14,0xe85cd));function a1_0x5f14(){const _0x4d55d1=['approved','normal','search','Soll','event','setStateAsync','toLowerCase','valveMapping','22LBWSGC','2146218xnQtqt','\x20auf\x20','off','local_temperature','analysis.energy.warmupTargets','ðŸ“…\x20SMART\x20SCHEDULE\x20[','now','level.valve','mpc_',':\x20Puffer\x20leer\x20->\x20Heizen\x20auf\x20','Â°C\x20<\x20','Â°C!\x20(Puffer\x20leer).','ankunft','slice','manual','analysis.energy.schedulePreview','map','.1.TEMPERATURE','info','currentSystemMode','10810044pEAaUu','.1.SET_POINT_TEMPERATURE','Â°C\x20->\x20','Unknown','includes','Â°C\x20(nicht\x20','sort','calendarInstance','Unbekannt',']:\x20Raum-Trigger\x20\x27','switch','120xnUzaH','default','light','ðŸš¨\x20[ENFORCEMENT]\x20Hardware-Profil\x20hat\x20','log','from','room','split','\x20min).','urlaub\x20ende','system.mode','Â°C\x20(Vorlauf:\x20','rescue_','5ncSblF','unshift','state','analysis.energy.ventilationAlerts','\x20ist\x20auf\x20','indexOf','Â°C).\x20Entferne\x20Status.','val','parse','reason','1248401eDcjys','thermostat','valve_position','ACTUAL','constructor','localeCompare','Calendar\x20Check\x20Error:\x20','location','eventStart','wert','contact','cal_','stellwert','target_temperature',':\x20Aufheizen\x20auf\x20','abs','sendToPythonWrapper','actual','occupied_heating_setpoint','current_heating_setpoint','name','ist','Manuelles\x20Mapping','warn','setpoint','ðŸ§¹\x20[MPC\x20CLEANUP]\x20Raum\x20\x27','ðŸ§¹\x20[MPC\x20CLEANUP]\x20','minutes_safe','ðŸŽ“\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20','.data.table','join','number','analysis.energy.warmupTimes','score','analysis.automation.mode','window','valve','PERFECT','message','getStateAsync','Â°C\x20(via\x20','SET_POINT_TEMPERATURE','Enforcement\x20Monitor\x20Error:\x20','active','TRAIN_RL_PENALTY','(((.+)+)+)+$','toString','ðŸŒ¬ï¸\x20[MPC\x20WATCHDOG]\x20','getTime','getForeignStateAsync','toUpperCase','calendarSelection','target','useCalendar','add','write','set','replace','isArray','push','ðŸ”¥\x20[MPC\x20ACTION]\x20Heize\x20','date','ðŸƒ\x20[MPC\x20ACTION]\x20Senke\x20','setForeignStateAsync','temp','type','.1.LEVEL','openknx','3926400BMQGHS','\x27\x20(Match:\x20','analysis.energy.activeEnforcements','length','filter','trim','temperature','.1.ACTUAL_TEMPERATURE','ðŸ“…\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20','[MPC\x20WARNING]\x20Kein\x20Setpoint\x20fÃ¼r\x20','analysis.automation.confidenceThreshold','splice','\x20erreicht\x20Limit\x20(','remove','messwert','until','apply','thermostatMapping','devices','Â°C!\x20(Puffer:\x20','analysis.automation.actionLog','\x20wurde\x20manuell\x20erhÃ¶ht.',')\x20aktiv.\x20Heize\x20auf\x20','level.temperature','error','Fehlt','config','level','getForeignObjectsAsync','too_cold','185337msDXnd','\x20gefunden!','forEach','stringify','\x20->\x20','SET','11853jMpolq','_date','values','exports','triggerTime','sensor','22578780jqCuVQ','value.valve','common','analysis.energy.mpcActiveInterventions','string','findIndex','_calName','Classic','Â°C.','\x20->\x20Schalte\x20','thermostat.setpoint','\x20durch\x20Kalender\x20geÃ¤ndert.\x20Keine\x20RL-Strafe.','ðŸ“…\x20[ENFORCEMENT]\x20Kalender-Event\x20in\x20','\x20min)','\x20wieder\x20auf\x20','ðŸš¨\x20[MPC\x20WATCHDOG]\x20','analysis.energy.warmupSources','summary','[MPC]\x20','820cdDXjG','ðŸ“…\x20[MPC\x20INFO]\x20','.4.SET_TEMPERATURE','[WATCHDOG]\x20'];a1_0x5f14=function(){return _0x4d55d1;};return a1_0x5f14();}const a1_0x298647=(function(){let _0xc2cfab=!![];return function(_0x1e257d,_0x4523ca){const _0x2720cd=_0xc2cfab?function(){const _0x2b70c0=a1_0x17c5;if(_0x4523ca){const _0x1ebbac=_0x4523ca[_0x2b70c0(0xa2)](_0x1e257d,arguments);return _0x4523ca=null,_0x1ebbac;}}:function(){};return _0xc2cfab=![],_0x2720cd;};}()),a1_0x5ed2e1=a1_0x298647(this,function(){const _0xba3d42=a1_0x17c5;return a1_0x5ed2e1['toString']()['search'](_0xba3d42(0x7b))[_0xba3d42(0x7c)]()[_0xba3d42(0x116)](a1_0x5ed2e1)[_0xba3d42(0xd5)](_0xba3d42(0x7b));});a1_0x5ed2e1();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,RESCUE_LOCK_MS=0x78*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x4404b3){const _0x2d2011=a1_0x17c5;if(!_0x4404b3)return'';return _0x4404b3[_0x2d2011(0xd9)]()[_0x2d2011(0x87)](/\s+/g,'')[_0x2d2011(0x97)]();}async function logAutomationAction(_0x538f16,_0x7c5d52){const _0x45c303=a1_0x17c5;await _0x538f16[_0x45c303(0xd8)]('analysis.automation.lastAction',{'val':_0x7c5d52,'ack':!![]});try{const _0x1998bc=_0x45c303(0xa6),_0x1d8c4b=await _0x538f16['getStateAsync'](_0x1998bc);let _0x2b0274=[];if(_0x1d8c4b&&_0x1d8c4b[_0x45c303(0x10f)])try{_0x2b0274=JSON[_0x45c303(0x110)](_0x1d8c4b[_0x45c303(0x10f)]);}catch(_0x245de9){}_0x2b0274[_0x45c303(0x109)]({'ts':Date['now'](),'msg':_0x7c5d52});if(_0x2b0274['length']>0x32)_0x2b0274=_0x2b0274[_0x45c303(0xe9)](0x0,0x32);await _0x538f16['setStateAsync'](_0x1998bc,{'val':JSON[_0x45c303(0xb3)](_0x2b0274),'ack':!![]});}catch(_0x59ca10){}}async function handlePrediction(_0xd68a77,_0x3c6360,_0x417011){const _0x9fe48=a1_0x17c5;if(!_0x3c6360||_0x3c6360===_0x9fe48(0xf3))return;let _0x40d437='off',_0x31dbda=0.6;try{const _0x60d86d=await _0xd68a77[_0x9fe48(0x75)](_0x9fe48(0x70));if(_0x60d86d&&_0x60d86d['val'])_0x40d437=_0x60d86d[_0x9fe48(0x10f)];const _0x526b6c=await _0xd68a77[_0x9fe48(0x75)](_0x9fe48(0x9c));if(_0x526b6c&&_0x526b6c[_0x9fe48(0x10f)])_0x31dbda=_0x526b6c[_0x9fe48(0x10f)];}catch(_0x3a46bb){}if(_0x40d437===_0x9fe48(0xde)||_0x417011<_0x31dbda)return;const _0x18e825=Date[_0x9fe48(0xe2)]();if(lastActions[_0x3c6360]&&_0x18e825-lastActions[_0x3c6360]<COOLDOWN_MS)return;const _0x3676a8=_0xd68a77[_0x9fe48(0xac)][_0x9fe48(0xa4)]||[],_0x476ee2=normalize(_0x3c6360),_0xc80b29=_0x3676a8['find'](_0x1725ed=>normalize(_0x1725ed[_0x9fe48(0x119)])===_0x476ee2&&(_0x1725ed[_0x9fe48(0x8f)]===_0x9fe48(0xfd)||_0x1725ed['type']==='dimmer'||_0x1725ed[_0x9fe48(0x8f)]===_0x9fe48(0xfa)));if(!_0xc80b29)return;const _0x5a0927=await aiAgent['consultButler'](_0xd68a77,_0x3c6360,_0xc80b29[_0x9fe48(0x126)],_0x417011);if(!_0x5a0927[_0x9fe48(0xd3)])return;const _0x513c76='PrÃ¤diktion:\x20'+_0x3c6360+_0x9fe48(0xc5)+_0xc80b29['name']+'\x20('+_0x5a0927[_0x9fe48(0x111)]+')';await logAutomationAction(_0xd68a77,'['+_0x40d437[_0x9fe48(0x80)]()+']\x20'+_0x513c76);if(_0x40d437===_0x9fe48(0x79)){const _0x52e2d3=await _0xd68a77[_0x9fe48(0x7f)](_0xc80b29['id']);(!_0x52e2d3||!_0x52e2d3[_0x9fe48(0x10f)]&&_0x52e2d3[_0x9fe48(0x10f)]!==!![])&&await _0xd68a77['setForeignStateAsync'](_0xc80b29['id'],!![]),lastActions[_0x3c6360]=_0x18e825;}}async function findRelatedId(_0x42228b,_0x24b0d0,_0x2d4c8f=a1_0x40d897(0x66)){const _0x236b64=a1_0x40d897;if(_0x2d4c8f==='setpoint'&&_0x42228b[_0x236b64(0xac)][_0x236b64(0xa3)]){let _0x2436ca=_0x42228b[_0x236b64(0xac)][_0x236b64(0xa3)];if(typeof _0x2436ca===_0x236b64(0xc0))try{_0x2436ca=JSON['parse'](_0x2436ca);}catch(_0x42882c){}if(_0x2436ca&&_0x2436ca[_0x24b0d0])return _0x2436ca[_0x24b0d0];}if(_0x2d4c8f===_0x236b64(0x72)&&_0x42228b[_0x236b64(0xac)][_0x236b64(0xda)]){let _0x2a3b8a=_0x42228b['config'][_0x236b64(0xda)];if(typeof _0x2a3b8a==='string')try{_0x2a3b8a=JSON[_0x236b64(0x110)](_0x2a3b8a);}catch(_0x11d70c){}if(_0x2a3b8a&&_0x2a3b8a[_0x24b0d0])return _0x2a3b8a[_0x24b0d0];}let _0x59ac2f=[];if(_0x2d4c8f===_0x236b64(0x66))_0x59ac2f=[{'s':_0x236b64(0x99),'t':_0x236b64(0xf1)},{'s':_0x236b64(0xed),'t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x236b64(0xed),'t':_0x236b64(0xd1)},{'s':'ACTUAL_TEMPERATURE','t':_0x236b64(0x77)},{'s':_0x236b64(0xdf),'t':_0x236b64(0x124)},{'s':_0x236b64(0xdf),'t':_0x236b64(0x125)},{'s':_0x236b64(0x98),'t':_0x236b64(0x11f)},{'s':_0x236b64(0x115),'t':_0x236b64(0xb5)},{'s':'Ist','t':_0x236b64(0xd6)},{'s':'temperature','t':_0x236b64(0x66)}];else _0x2d4c8f===_0x236b64(0x72)&&(_0x59ac2f=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x236b64(0x90)},{'s':_0x236b64(0xed),'t':_0x236b64(0x90)},{'s':_0x236b64(0xed),'t':'.4.VALVE_STATE'},{'s':_0x236b64(0xdf),'t':'pi_heating_demand'},{'s':_0x236b64(0x98),'t':_0x236b64(0x114)},{'s':'temperature','t':_0x236b64(0xad)}]);for(const _0x45590e of _0x59ac2f){if(_0x24b0d0[_0x236b64(0xf4)](_0x45590e['s'])){const _0x4449ab=_0x24b0d0[_0x236b64(0x87)](_0x45590e['s'],_0x45590e['t']),_0x363174=await _0x42228b['getForeignObjectAsync'](_0x4449ab);if(_0x363174)return _0x4449ab;}}try{const _0x708010=_0x24b0d0[_0x236b64(0x102)]('.');if(_0x708010['length']>0x2){const _0x3b3c99=_0x708010[_0x236b64(0xe9)](0x0,-0x1)[_0x236b64(0x6c)]('.'),_0x21c910=await _0x42228b[_0x236b64(0xae)](_0x3b3c99+'.*'),_0x4900a3=[],_0x4286b6=_0x24b0d0['split'](/[._]+/)[_0x236b64(0x96)](_0x5e81de=>![_0x236b64(0x91),'0','hm-rpc',_0x236b64(0x127),_0x236b64(0x11b),_0x236b64(0x98),_0x236b64(0x123),'sensor',_0x236b64(0xa0),_0x236b64(0x10a)]['includes'](_0x5e81de['toLowerCase']()));for(const [_0xe6aebf,_0xe07cc3]of Object['entries'](_0x21c910)){if(_0xe6aebf===_0x24b0d0)continue;if(_0xe07cc3&&_0xe07cc3[_0x236b64(0xbe)]){const _0xfc374d=_0xe6aebf[_0x236b64(0xd9)](),_0x1fb9ec=(_0xe07cc3[_0x236b64(0xbe)]['role']||'')[_0x236b64(0xd9)](),_0x483fe2=(_0xe07cc3[_0x236b64(0xbe)]['unit']||'')['toLowerCase']();let _0x13c634=![];if(_0x2d4c8f==='setpoint'&&_0xe07cc3[_0x236b64(0xbe)][_0x236b64(0x85)]===!![])_0x13c634=_0xfc374d[_0x236b64(0xf4)](_0x236b64(0x86))||_0xfc374d[_0x236b64(0xf4)]('soll')||_0xfc374d[_0x236b64(0xf4)](_0x236b64(0x82))||_0x1fb9ec[_0x236b64(0xf4)](_0x236b64(0xa9))||_0x1fb9ec[_0x236b64(0xf4)](_0x236b64(0xc6));else _0x2d4c8f===_0x236b64(0x72)&&(_0x13c634=_0xfc374d['includes'](_0x236b64(0xad))||_0xfc374d[_0x236b64(0xf4)](_0x236b64(0x72))||_0xfc374d[_0x236b64(0xf4)](_0x236b64(0x11e))||_0xfc374d[_0x236b64(0xf4)]('position')||_0x1fb9ec[_0x236b64(0xf4)](_0x236b64(0xe3))||_0x1fb9ec[_0x236b64(0xf4)](_0x236b64(0xbd))||_0x483fe2[_0x236b64(0xf4)]('%'));if(_0x13c634){const _0x43dfa1=_0xe6aebf[_0x236b64(0x102)](/[._]+/)[_0x236b64(0xec)](_0x4aa571=>_0x4aa571['toLowerCase']());let _0x11d5e8=0x0;_0x4286b6[_0x236b64(0xb2)](_0x1c94de=>{if(_0x43dfa1['includes'](_0x1c94de['toLowerCase']()))_0x11d5e8++;}),_0x4900a3[_0x236b64(0x89)]({'id':_0xe6aebf,'score':_0x11d5e8});}}}if(_0x4900a3[_0x236b64(0x95)]>0x0){_0x4900a3['sort']((_0x1b12f7,_0x2548ed)=>_0x2548ed[_0x236b64(0x6f)]-_0x1b12f7['score']);if(_0x4900a3[0x0][_0x236b64(0x6f)]>0x0)return _0x4900a3[0x0]['id'];}}}catch(_0x409fa9){}return null;}async function scanThermostats(_0x374ee){const _0x4047e1=a1_0x40d897,_0x289bc0=_0x374ee[_0x4047e1(0xac)]['devices']||[],_0x413950=[],_0x5199b5=_0x289bc0[_0x4047e1(0x96)](_0x26e080=>_0x26e080['id']&&_0x26e080['id']['includes'](_0x4047e1(0x98))||_0x26e080[_0x4047e1(0x8f)]&&[_0x4047e1(0x98),_0x4047e1(0x113),_0x4047e1(0xbb)]['includes'](_0x26e080[_0x4047e1(0x8f)])||_0x26e080[_0x4047e1(0x126)]&&_0x26e080[_0x4047e1(0x126)]['toLowerCase']()[_0x4047e1(0xf4)](_0x4047e1(0x8e)));for(const _0xce083 of _0x5199b5){const _0x22f687=await findRelatedId(_0x374ee,_0xce083['id'],'setpoint'),_0x2e3639=await findRelatedId(_0x374ee,_0xce083['id'],_0x4047e1(0x72));let _0x2b2ca7='Nicht\x20gefunden',_0x5810c5=![],_0x5a1c5e=_0x374ee[_0x4047e1(0xac)][_0x4047e1(0xa3)]||{};if(typeof _0x5a1c5e==='string')try{_0x5a1c5e=JSON[_0x4047e1(0x110)](_0x5a1c5e);}catch(_0x5b16e0){}let _0x562037=_0x374ee[_0x4047e1(0xac)][_0x4047e1(0xda)]||{};if(typeof _0x562037===_0x4047e1(0xc0))try{_0x562037=JSON['parse'](_0x562037);}catch(_0x477559){}if(_0x5a1c5e[_0xce083['id']]&&_0x5a1c5e[_0xce083['id']]===_0x22f687||_0x562037[_0xce083['id']]&&_0x562037[_0xce083['id']]===_0x2e3639)_0x2b2ca7=_0x4047e1(0x128),_0x5810c5=!![];else(_0x22f687||_0x2e3639)&&(_0x2b2ca7='Auto-Erkennung');_0x413950['push']({'room':_0xce083[_0x4047e1(0x119)]||_0x4047e1(0xf8),'sensorId':_0xce083['id'],'setpointId':_0x22f687||'-','valveId':_0x2e3639||'-','source':_0x2b2ca7,'isManual':_0x5810c5,'status':_0x22f687&&_0x2e3639?_0x4047e1(0x73):_0x22f687?'OK':_0x4047e1(0xab)});}return _0x413950[_0x4047e1(0xf6)]((_0x35ea74,_0x1219ef)=>_0x35ea74[_0x4047e1(0x101)][_0x4047e1(0x117)](_0x1219ef['room']));}async function updateSchedulePreview(_0x1d88cb){const _0x300d5f=a1_0x40d897;if(!_0x1d88cb[_0x300d5f(0xac)][_0x300d5f(0x83)]||!_0x1d88cb[_0x300d5f(0xac)][_0x300d5f(0xf7)])return;let _0x122398={};try{const _0x434d3a=await _0x1d88cb['getStateAsync'](_0x300d5f(0x6e));if(_0x434d3a&&_0x434d3a[_0x300d5f(0x10f)])_0x122398=JSON[_0x300d5f(0x110)](_0x434d3a[_0x300d5f(0x10f)]);}catch(_0x2ad99a){}const _0x2fca00=[],_0x291bc2=Date[_0x300d5f(0xe2)](),_0x3d73ff=0x30*0x3c*0x3c*0x3e8;try{const _0x3eb016=await _0x1d88cb[_0x300d5f(0x7f)](_0x1d88cb[_0x300d5f(0xac)]['calendarInstance']+_0x300d5f(0x6b));if(!_0x3eb016||!_0x3eb016[_0x300d5f(0x10f)])return;const _0x442571=JSON[_0x300d5f(0x110)](_0x3eb016['val']),_0x2bb82c=_0x1d88cb[_0x300d5f(0xac)][_0x300d5f(0x81)]||[],_0x138889=_0x1d88cb['config'][_0x300d5f(0xa4)]||[],_0x22ccd3=new Set();_0x138889['forEach'](_0x7a1e4b=>{const _0x532b9d=_0x300d5f;if(_0x7a1e4b[_0x532b9d(0x119)])_0x22ccd3[_0x532b9d(0x84)](_0x7a1e4b[_0x532b9d(0x119)]);});for(const _0x5035c0 of _0x442571){if(_0x5035c0['_calName']&&_0x2bb82c[_0x300d5f(0x95)]>0x0&&!_0x2bb82c[_0x300d5f(0xf4)](_0x5035c0[_0x300d5f(0xc2)]))continue;const _0x52b266=_0x5035c0['_date']||_0x5035c0[_0x300d5f(0x11a)]||_0x5035c0[_0x300d5f(0x8b)];if(!_0x52b266)continue;const _0xc25c1c=new Date(_0x52b266),_0x22de8b=_0xc25c1c[_0x300d5f(0x7e)]();if(isNaN(_0x22de8b))continue;if(_0x22de8b<_0x291bc2)continue;if(_0x22de8b>_0x291bc2+_0x3d73ff)continue;const _0x1db5fa=(_0x5035c0['event']||_0x5035c0[_0x300d5f(0xcd)]||'')[_0x300d5f(0xd9)]();let _0x24090e=![],_0x104663=[],_0x107da6=_0x5035c0[_0x300d5f(0xd7)]||_0x5035c0[_0x300d5f(0xcd)]||_0x300d5f(0xf8);if(_0x1db5fa['includes'](_0x300d5f(0x104))||_0x1db5fa[_0x300d5f(0xf4)]('rÃ¼ckkehr')||_0x1db5fa[_0x300d5f(0xf4)]('ankunft'))_0x24090e=!![],_0x104663=Array[_0x300d5f(0x100)](_0x22ccd3);else for(const _0x5c051a of _0x22ccd3){if(_0x1db5fa[_0x300d5f(0xf4)](_0x5c051a['toLowerCase']()))_0x104663[_0x300d5f(0x89)](_0x5c051a);}_0x104663['length']>0x0&&_0x104663[_0x300d5f(0xb2)](_0xf461f4=>{const _0x18adab=_0x300d5f;let _0x2565a0=0x3c;if(_0x24090e){let _0x311320=0x0;Object[_0x18adab(0xb8)](_0x122398)[_0x18adab(0xb2)](_0x2f2a09=>{if(_0x2f2a09>_0x311320)_0x311320=_0x2f2a09;}),_0x2565a0=_0x311320>0x0?_0x311320:0x78;}else _0x2565a0=_0x122398[_0xf461f4]||0x3c;const _0x19ea49=new Date(_0x22de8b-_0x2565a0*0xea60);_0x2fca00[_0x18adab(0x89)]({'eventTime':_0x22de8b,'triggerTime':_0x19ea49[_0x18adab(0x7e)](),'room':_0xf461f4,'minutes':_0x2565a0,'reason':_0x107da6,'isGlobal':_0x24090e});});}}catch(_0x338edb){}_0x2fca00[_0x300d5f(0xf6)]((_0x325a79,_0x50a59e)=>_0x325a79[_0x300d5f(0xba)]-_0x50a59e[_0x300d5f(0xba)]);const _0x422b1a=_0x2fca00[_0x300d5f(0xe9)](0x0,0x5);await _0x1d88cb[_0x300d5f(0xd8)](_0x300d5f(0xeb),{'val':JSON[_0x300d5f(0xb3)](_0x422b1a),'ack':!![]});}async function monitorEnforcements(_0x116c36){const _0x17d674=a1_0x40d897;try{const _0x4f4553='analysis.energy.activeEnforcements',_0x1cfd85=await _0x116c36['getStateAsync'](_0x4f4553);if(!_0x1cfd85||!_0x1cfd85[_0x17d674(0x10f)])return;let _0x2f5dcf=[];try{_0x2f5dcf=JSON[_0x17d674(0x110)](_0x1cfd85[_0x17d674(0x10f)]);}catch(_0x248858){return;}if(!Array[_0x17d674(0x88)](_0x2f5dcf)||_0x2f5dcf['length']===0x0)return;const _0x426c7f=Date[_0x17d674(0xe2)](),_0x5c6c53=_0x116c36[_0x17d674(0xac)][_0x17d674(0xa4)]||[];let _0x189de0=![];for(let _0x152f4b=_0x2f5dcf[_0x17d674(0x95)]-0x1;_0x152f4b>=0x0;_0x152f4b--){const _0xce0cfc=_0x2f5dcf[_0x152f4b];if(_0x426c7f>=_0xce0cfc[_0x17d674(0xa1)]){_0x116c36['log'][_0x17d674(0xee)](_0x17d674(0xc8)+_0xce0cfc[_0x17d674(0x101)]+'\x20gestartet/vorbei.\x20Gebe\x20Raum\x20frei.'),_0x2f5dcf[_0x17d674(0x9d)](_0x152f4b,0x1),_0x189de0=!![];continue;}const _0x3ae27b=_0x5c6c53['find'](_0x43fc75=>normalize(_0x43fc75[_0x17d674(0x119)])===normalize(_0xce0cfc[_0x17d674(0x101)])&&(_0x43fc75[_0x17d674(0x8f)]===_0x17d674(0x98)||_0x43fc75[_0x17d674(0x8f)]===_0x17d674(0x113)));if(_0x3ae27b){const _0xc7cbeb=await findRelatedId(_0x116c36,_0x3ae27b['id'],'setpoint');if(_0xc7cbeb){const _0x4eb180=await _0x116c36[_0x17d674(0x7f)](_0xc7cbeb);_0x4eb180&&typeof _0x4eb180['val']===_0x17d674(0x6d)&&(_0x4eb180['val']<0xf&&(_0x116c36['log']['warn'](_0x17d674(0xfe)+_0xce0cfc[_0x17d674(0x101)]+_0x17d674(0xdd)+_0x4eb180[_0x17d674(0x10f)]+'Â°C\x20abgesenkt!\x20Zwinge\x20zurÃ¼ck\x20auf\x20'+_0xce0cfc[_0x17d674(0x82)]+_0x17d674(0xc4)),await _0x116c36['setForeignStateAsync'](_0xc7cbeb,_0xce0cfc['target']),await logAutomationAction(_0x116c36,'[FORCE]\x20'+_0xce0cfc[_0x17d674(0x101)]+':\x20'+_0x4eb180['val']+_0x17d674(0xf2)+_0xce0cfc[_0x17d674(0x82)]+'Â°C\x20(Kalender-Schutz)')));}}}_0x189de0&&await _0x116c36[_0x17d674(0xd8)](_0x4f4553,{'val':JSON[_0x17d674(0xb3)](_0x2f5dcf),'ack':!![]});}catch(_0x713275){_0x116c36[_0x17d674(0xff)][_0x17d674(0xaa)](_0x17d674(0x78)+_0x713275[_0x17d674(0x74)]);}}async function checkCalendarTriggers(_0x77645c){const _0x2e75d4=a1_0x40d897;if(!_0x77645c[_0x2e75d4(0xac)]['useCalendar']||!_0x77645c[_0x2e75d4(0xac)]['calendarInstance'])return;await updateSchedulePreview(_0x77645c);let _0x4a9235={},_0x5d8a17={};try{const _0x2e92d4=await _0x77645c[_0x2e75d4(0x75)](_0x2e75d4(0x6e));if(_0x2e92d4&&_0x2e92d4[_0x2e75d4(0x10f)])_0x4a9235=JSON[_0x2e75d4(0x110)](_0x2e92d4[_0x2e75d4(0x10f)]);const _0x88b466=await _0x77645c['getStateAsync'](_0x2e75d4(0xcc));if(_0x88b466&&_0x88b466[_0x2e75d4(0x10f)])_0x5d8a17=JSON[_0x2e75d4(0x110)](_0x88b466[_0x2e75d4(0x10f)]);}catch(_0x5b0b48){}let _0x5aed6c={'default':0x15};try{const _0x299f48=await _0x77645c[_0x2e75d4(0x75)](_0x2e75d4(0xe0));if(_0x299f48&&_0x299f48[_0x2e75d4(0x10f)])_0x5aed6c=JSON['parse'](_0x299f48[_0x2e75d4(0x10f)]);}catch(_0x2b8b15){}let _0x4c3b68=[];try{const _0x515c1e=await _0x77645c[_0x2e75d4(0x75)]('analysis.energy.activeEnforcements');if(_0x515c1e&&_0x515c1e['val'])_0x4c3b68=JSON[_0x2e75d4(0x110)](_0x515c1e['val']);}catch(_0x4620d1){}try{const _0xe0c05c=await _0x77645c[_0x2e75d4(0x7f)](_0x77645c[_0x2e75d4(0xac)][_0x2e75d4(0xf7)]+_0x2e75d4(0x6b));if(!_0xe0c05c||!_0xe0c05c[_0x2e75d4(0x10f)])return;const _0x43ab00=JSON[_0x2e75d4(0x110)](_0xe0c05c[_0x2e75d4(0x10f)]),_0x144098=Date['now'](),_0x55dfed=_0x77645c['config']['devices']||[],_0x4e5a41=_0x77645c[_0x2e75d4(0xac)][_0x2e75d4(0x81)]||[];let _0x4a0625=![];for(const _0x429b3d of _0x43ab00){if(_0x429b3d[_0x2e75d4(0xc2)]&&_0x4e5a41[_0x2e75d4(0x95)]>0x0&&!_0x4e5a41[_0x2e75d4(0xf4)](_0x429b3d[_0x2e75d4(0xc2)]))continue;const _0x107fe9=_0x429b3d[_0x2e75d4(0xb7)]||_0x429b3d[_0x2e75d4(0x11a)]||_0x429b3d['date'];if(!_0x107fe9)continue;const _0x3af0b8=new Date(_0x107fe9);if(isNaN(_0x3af0b8[_0x2e75d4(0x7e)]()))continue;const _0x24817d=(_0x429b3d[_0x2e75d4(0xd7)]||_0x429b3d[_0x2e75d4(0xcd)]||'')[_0x2e75d4(0xd9)]();if(_0x24817d[_0x2e75d4(0xf4)]('urlaub\x20ende')||_0x24817d['includes']('rÃ¼ckkehr')||_0x24817d['includes'](_0x2e75d4(0xe8))){let _0x10acb8=0x0;Object[_0x2e75d4(0xb8)](_0x4a9235)['forEach'](_0x56c839=>{if(_0x56c839>_0x10acb8)_0x10acb8=_0x56c839;});if(_0x10acb8===0x0)_0x10acb8=0x78;const _0x495685=_0x3af0b8['getTime']()-_0x10acb8*0xea60;_0x144098>=_0x495685&&_0x144098<_0x3af0b8['getTime']()&&(_0x77645c[_0x2e75d4(0xef)]!==_0x2e75d4(0xd4)&&(_0x77645c[_0x2e75d4(0xff)]['info'](_0x2e75d4(0x9a)+_0x10acb8+_0x2e75d4(0x103)),await _0x77645c[_0x2e75d4(0xd8)](_0x2e75d4(0x105),{'val':_0x2e75d4(0xd4),'ack':![]})));}for(const _0x22d1be of _0x55dfed){if(_0x22d1be['location']){const _0x2008a1=_0x22d1be[_0x2e75d4(0x119)][_0x2e75d4(0xd9)](),_0xfd79c1=(_0x22d1be['name']||'')['toLowerCase']();let _0x5a1632=_0x24817d['includes'](_0x2008a1);!_0x5a1632&&_0xfd79c1[_0x2e75d4(0x95)]>0x3&&_0x24817d[_0x2e75d4(0xf4)](_0xfd79c1)&&(_0x5a1632=!![]);if(_0x5a1632){const _0x48b69d=_0x4a9235[_0x22d1be['location']]||0x3c,_0x2e79a0=_0x5d8a17[_0x22d1be['location']]||_0x2e75d4(0xc3),_0x5dc9ef=_0x3af0b8[_0x2e75d4(0x7e)]()-_0x48b69d*0xea60;if(_0x144098>=_0x5dc9ef&&_0x144098<_0x3af0b8[_0x2e75d4(0x7e)]()){const _0x7e4b8a=lastActions[_0x2e75d4(0x11d)+_0x22d1be[_0x2e75d4(0x119)]];if(_0x7e4b8a&&_0x144098-_0x7e4b8a<CAL_COOLDOWN_MS)continue;const _0x2abacf=await findRelatedId(_0x77645c,_0x22d1be['id'],_0x2e75d4(0x66));if(_0x2abacf){let _0x5d7dc2=_0x5aed6c[_0x22d1be[_0x2e75d4(0x119)]];if(_0x5d7dc2===undefined)_0x5d7dc2=_0x5aed6c[_0x2e75d4(0xfc)];if(_0x5d7dc2===undefined)_0x5d7dc2=0x15;const _0x353fb3=await _0x77645c[_0x2e75d4(0x7f)](_0x2abacf);if(_0x353fb3&&typeof _0x353fb3[_0x2e75d4(0x10f)]===_0x2e75d4(0x6d)&&_0x353fb3[_0x2e75d4(0x10f)]<_0x5d7dc2-0.5){_0x77645c[_0x2e75d4(0xff)][_0x2e75d4(0xee)](_0x2e75d4(0xe1)+_0x2e79a0+_0x2e75d4(0xf9)+_0x22d1be[_0x2e75d4(0x119)]+_0x2e75d4(0x93)+_0x24817d+_0x2e75d4(0xa8)+_0x5d7dc2+_0x2e75d4(0x106)+_0x48b69d+_0x2e75d4(0x103)),await _0x77645c[_0x2e75d4(0x8d)](_0x2abacf,_0x5d7dc2),await logAutomationAction(_0x77645c,'[CAL]\x20'+_0x22d1be[_0x2e75d4(0x119)]+_0x2e75d4(0xb4)+_0x5d7dc2+_0x2e75d4(0x76)+_0x2e79a0+')'),lastActions['cal_'+_0x22d1be[_0x2e75d4(0x119)]]=_0x144098;const _0xe2bf8b=_0x4c3b68[_0x2e75d4(0xc1)](_0x3b7c9f=>_0x3b7c9f[_0x2e75d4(0x101)]===_0x22d1be[_0x2e75d4(0x119)]);if(_0xe2bf8b!==-0x1)_0x4c3b68[_0x2e75d4(0x9d)](_0xe2bf8b,0x1);_0x4c3b68[_0x2e75d4(0x89)]({'room':_0x22d1be[_0x2e75d4(0x119)],'target':_0x5d7dc2,'until':_0x3af0b8[_0x2e75d4(0x7e)]()}),_0x4a0625=!![];}}}}}}}_0x4a0625&&await _0x77645c['setStateAsync'](_0x2e75d4(0x94),{'val':JSON[_0x2e75d4(0xb3)](_0x4c3b68),'ack':!![]});}catch(_0x4f2124){_0x77645c[_0x2e75d4(0xff)]['warn'](_0x2e75d4(0x118)+_0x4f2124[_0x2e75d4(0x74)]);}}async function manageMpcIntervention(_0x551fd2,_0x5cd1fe,_0x3c9ddf){const _0x2646c0=a1_0x40d897;try{const _0x3a9a6a=_0x2646c0(0xbf),_0x48c986=await _0x551fd2[_0x2646c0(0x75)](_0x3a9a6a);let _0x1b7b96=[];if(_0x48c986&&_0x48c986[_0x2646c0(0x10f)])try{_0x1b7b96=JSON[_0x2646c0(0x110)](_0x48c986[_0x2646c0(0x10f)]);}catch(_0x2b380d){}const _0x4464b8=_0x1b7b96[_0x2646c0(0x10d)](_0x5cd1fe);if(_0x3c9ddf===_0x2646c0(0x84))_0x4464b8===-0x1&&(_0x1b7b96[_0x2646c0(0x89)](_0x5cd1fe),await _0x551fd2['setStateAsync'](_0x3a9a6a,{'val':JSON[_0x2646c0(0xb3)](_0x1b7b96),'ack':!![]}));else _0x3c9ddf===_0x2646c0(0x9f)&&(_0x4464b8!==-0x1&&(_0x1b7b96[_0x2646c0(0x9d)](_0x4464b8,0x1),await _0x551fd2[_0x2646c0(0xd8)](_0x3a9a6a,{'val':JSON[_0x2646c0(0xb3)](_0x1b7b96),'ack':!![]})));}catch(_0x5910ff){}}function a1_0x17c5(_0x17d6b4,_0x4c9258){const _0x3a4f0c=a1_0x5f14();return a1_0x17c5=function(_0x5ed2e1,_0x298647){_0x5ed2e1=_0x5ed2e1-0x65;let _0x5f1418=_0x3a4f0c[_0x5ed2e1];return _0x5f1418;},a1_0x17c5(_0x17d6b4,_0x4c9258);}async function cleanupGhostInterventions(_0x19e63d){const _0x5c02c5=a1_0x40d897;try{const _0x5d83b0='analysis.energy.mpcActiveInterventions',_0x1165fa=await _0x19e63d['getStateAsync'](_0x5d83b0);if(!_0x1165fa||!_0x1165fa['val'])return;const _0x53a63e=JSON[_0x5c02c5(0x110)](_0x1165fa['val']);if(!Array[_0x5c02c5(0x88)](_0x53a63e)||_0x53a63e[_0x5c02c5(0x95)]===0x0)return;let _0x124911={'default':0x15};try{const _0x1b0674=await _0x19e63d[_0x5c02c5(0x75)](_0x5c02c5(0xe0));if(_0x1b0674&&_0x1b0674[_0x5c02c5(0x10f)])_0x124911=JSON['parse'](_0x1b0674[_0x5c02c5(0x10f)]);}catch(_0x2e01fc){}let _0x55d6f3=[];try{const _0x5b496b=await _0x19e63d[_0x5c02c5(0x75)](_0x5c02c5(0x10b));if(_0x5b496b&&_0x5b496b[_0x5c02c5(0x10f)])_0x55d6f3=JSON[_0x5c02c5(0x110)](_0x5b496b['val']);}catch(_0x539f55){}const _0x47790a=_0x19e63d[_0x5c02c5(0xac)][_0x5c02c5(0xa4)]||[];let _0x48aff5=![];for(let _0x5b1bed=_0x53a63e['length']-0x1;_0x5b1bed>=0x0;_0x5b1bed--){const _0x293e86=_0x53a63e[_0x5b1bed],_0x46eeec=_0x47790a['find'](_0x145f30=>normalize(_0x145f30[_0x5c02c5(0x119)])===normalize(_0x293e86)&&(_0x145f30[_0x5c02c5(0x8f)]===_0x5c02c5(0x98)||_0x145f30[_0x5c02c5(0x8f)]==='thermostat'));if(!_0x46eeec){_0x19e63d[_0x5c02c5(0xff)]['warn'](_0x5c02c5(0x67)+_0x293e86+'\x27\x20hat\x20kein\x20GerÃ¤t\x20mehr.\x20LÃ¶sche\x20Eintrag.'),_0x53a63e[_0x5c02c5(0x9d)](_0x5b1bed,0x1),_0x48aff5=!![];continue;}if(_0x46eeec){const _0x32727a=await findRelatedId(_0x19e63d,_0x46eeec['id'],_0x5c02c5(0x66)),_0x8fb58e=await _0x19e63d[_0x5c02c5(0x7f)](_0x46eeec['id']);if(_0x32727a){const _0x4bc2f9=await _0x19e63d[_0x5c02c5(0x7f)](_0x32727a);if(_0x4bc2f9&&typeof _0x4bc2f9[_0x5c02c5(0x10f)]===_0x5c02c5(0x6d)){let _0xc87aaf=![],_0x277312='';Math[_0x5c02c5(0x121)](_0x4bc2f9['val']-ECO_TEMP)>0.5&&(_0xc87aaf=!![],_0x277312='manual');if(!_0xc87aaf&&_0x8fb58e&&typeof _0x8fb58e[_0x5c02c5(0x10f)]===_0x5c02c5(0x6d)){const _0x47d71b=_0x124911[_0x293e86]||_0x124911[_0x5c02c5(0xfc)]||0x15;_0x8fb58e[_0x5c02c5(0x10f)]<_0x47d71b+0.2&&(_0xc87aaf=!![],_0x277312=_0x5c02c5(0xaf));}if(_0xc87aaf){if(_0x277312===_0x5c02c5(0xea)){_0x19e63d[_0x5c02c5(0xff)]['info'](_0x5c02c5(0x68)+_0x293e86+_0x5c02c5(0x10c)+_0x4bc2f9['val']+_0x5c02c5(0xf5)+ECO_TEMP+_0x5c02c5(0x10e));const _0x42111d=lastActions[_0x5c02c5(0x11d)+_0x293e86],_0x3cb924=_0x42111d&&Date[_0x5c02c5(0xe2)]()-_0x42111d<0x2*0x3c*0x3e8;if(!_0x3cb924&&_0x4bc2f9['val']>ECO_TEMP+0.5)_0x19e63d[_0x5c02c5(0x122)]&&(_0x19e63d[_0x5c02c5(0xff)][_0x5c02c5(0xee)](_0x5c02c5(0x6a)+_0x293e86+_0x5c02c5(0xa7)),_0x19e63d[_0x5c02c5(0x122)](_0x5c02c5(0x7a),{'room':_0x293e86}));else _0x3cb924&&_0x19e63d[_0x5c02c5(0xff)]['info'](_0x5c02c5(0xd0)+_0x293e86+_0x5c02c5(0xc7));}else{if(_0x277312===_0x5c02c5(0xaf)){let _0x3c484b=![];if(_0x55d6f3['find'](_0x3acb03=>_0x3acb03[_0x5c02c5(0x101)]===_0x293e86))_0x3c484b=!![];const _0x527e57=_0x47790a[_0x5c02c5(0x96)](_0x5a934b=>normalize(_0x5a934b[_0x5c02c5(0x119)])===normalize(_0x293e86)&&(_0x5a934b[_0x5c02c5(0x8f)]===_0x5c02c5(0x71)||_0x5a934b[_0x5c02c5(0x8f)]===_0x5c02c5(0xbb)||_0x5a934b[_0x5c02c5(0x8f)]===_0x5c02c5(0x11c)));for(const _0x3be925 of _0x527e57){try{const _0x3a5f83=await _0x19e63d['getForeignStateAsync'](_0x3be925['id']);if(_0x3a5f83&&(_0x3a5f83[_0x5c02c5(0x10f)]===!![]||_0x3a5f83[_0x5c02c5(0x10f)]===0x1||String(_0x3a5f83[_0x5c02c5(0x10f)])['toLowerCase']()==='open'))_0x3c484b=!![];}catch(_0x5a8b24){}}if(_0x3c484b)_0x19e63d['log']['info'](_0x5c02c5(0x7d)+_0x293e86+'\x20ist\x20zu\x20kalt,\x20ABER\x20Fenster\x20offen/LÃ¼ftung\x20erkannt.\x20Heize\x20NICHT,\x20entferne\x20nur\x20Status.');else{const _0x3b2137=_0x124911[_0x293e86]||_0x124911['default']||0x15;_0x19e63d[_0x5c02c5(0xff)]['info'](_0x5c02c5(0xcb)+_0x293e86+_0x5c02c5(0x9e)+_0x8fb58e[_0x5c02c5(0x10f)]+_0x5c02c5(0xe6)+(_0x3b2137+0.2)+'Â°C).\x20Sparmodus\x20beendet!'),await _0x19e63d[_0x5c02c5(0x8d)](_0x32727a,_0x3b2137),await logAutomationAction(_0x19e63d,_0x5c02c5(0xd2)+_0x293e86+_0x5c02c5(0xe5)+_0x3b2137+'Â°C'),lastActions[_0x5c02c5(0x107)+_0x293e86]=Date[_0x5c02c5(0xe2)]();}}}_0x53a63e[_0x5c02c5(0x9d)](_0x5b1bed,0x1),_0x48aff5=!![];}}}}}_0x48aff5&&await _0x19e63d[_0x5c02c5(0xd8)](_0x5d83b0,{'val':JSON[_0x5c02c5(0xb3)](_0x53a63e),'ack':!![]});}catch(_0x12641b){}}async function applyEnergySavings(_0x9a9c06,_0x379c8e){const _0x5297be=a1_0x40d897;await cleanupGhostInterventions(_0x9a9c06);if(!_0x379c8e||_0x379c8e[_0x5297be(0x95)]===0x0)return;const _0x410b4f=_0x9a9c06['config']['devices']||[],_0x31d811=Date[_0x5297be(0xe2)]();for(const _0x3b389c of _0x379c8e){const _0x476d0c=_0x3b389c[_0x5297be(0x101)],_0x4081e2=_0x3b389c[_0x5297be(0x69)],_0x51d708=_0x3b389c[_0x5297be(0x82)]||0x15;if(lastActions[_0x5297be(0x107)+_0x476d0c]&&_0x31d811-lastActions[_0x5297be(0x107)+_0x476d0c]<RESCUE_LOCK_MS)continue;const _0x50185c=_0x410b4f['find'](_0x1ffd1f=>normalize(_0x1ffd1f['location'])===normalize(_0x476d0c)&&(_0x1ffd1f[_0x5297be(0x8f)]===_0x5297be(0x98)||_0x1ffd1f[_0x5297be(0x8f)]===_0x5297be(0x113)));if(!_0x50185c)continue;const _0x3baacc=await findRelatedId(_0x9a9c06,_0x50185c['id'],_0x5297be(0x66));if(_0x3baacc){if(lastActions[_0x5297be(0xe4)+_0x476d0c]&&_0x31d811-lastActions['mpc_'+_0x476d0c]<0x1e*0x3c*0x3e8)continue;const _0x2d9b9d=await _0x9a9c06[_0x5297be(0x7f)](_0x3baacc);if(_0x2d9b9d&&typeof _0x2d9b9d[_0x5297be(0x10f)]===_0x5297be(0x6d)){const _0x25bf54=_0x2d9b9d[_0x5297be(0x10f)];_0x25bf54!==ECO_TEMP&&await manageMpcIntervention(_0x9a9c06,_0x476d0c,_0x5297be(0x9f));if(_0x4081e2>0x1e)_0x25bf54>ECO_TEMP+0.5&&(_0x9a9c06['log'][_0x5297be(0xee)](_0x5297be(0x8c)+_0x476d0c+_0x5297be(0xdd)+ECO_TEMP+_0x5297be(0xa5)+_0x4081e2+_0x5297be(0xc9)),await _0x9a9c06['setForeignStateAsync'](_0x3baacc,ECO_TEMP),await manageMpcIntervention(_0x9a9c06,_0x476d0c,'add'),lastActions['mpc_'+_0x476d0c]=_0x31d811,await logAutomationAction(_0x9a9c06,_0x5297be(0xce)+_0x476d0c+':\x20Absenkung\x20auf\x20'+ECO_TEMP+'Â°C'));else _0x4081e2<=0xf&&(_0x25bf54<_0x51d708&&(_0x9a9c06[_0x5297be(0xff)][_0x5297be(0xee)](_0x5297be(0x8a)+_0x476d0c+_0x5297be(0xca)+_0x51d708+_0x5297be(0xe7)),await _0x9a9c06['setForeignStateAsync'](_0x3baacc,_0x51d708),await manageMpcIntervention(_0x9a9c06,_0x476d0c,_0x5297be(0x9f)),lastActions['mpc_'+_0x476d0c]=_0x31d811,await logAutomationAction(_0x9a9c06,_0x5297be(0xce)+_0x476d0c+_0x5297be(0x120)+_0x51d708+'Â°C')));}}else _0x9a9c06[_0x5297be(0xff)][_0x5297be(0x65)](_0x5297be(0x9b)+_0x476d0c+_0x5297be(0xb1));}}module[a1_0x40d897(0xb9)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'monitorEnforcements':monitorEnforcements,'updateSchedulePreview':updateSchedulePreview,'cleanupGhostInterventions':cleanupGhostInterventions};