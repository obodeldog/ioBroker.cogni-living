const a1_0x1259cd=a1_0xde03;(function(_0x2a34b1,_0x5974bc){const _0x38c283=a1_0xde03,_0x47828d=_0x2a34b1();while(!![]){try{const _0x17bb63=parseInt(_0x38c283(0x1cc))/0x1*(parseInt(_0x38c283(0x1e7))/0x2)+parseInt(_0x38c283(0x215))/0x3*(parseInt(_0x38c283(0x230))/0x4)+parseInt(_0x38c283(0x1db))/0x5+-parseInt(_0x38c283(0x236))/0x6*(-parseInt(_0x38c283(0x1c6))/0x7)+-parseInt(_0x38c283(0x20a))/0x8+-parseInt(_0x38c283(0x22e))/0x9*(parseInt(_0x38c283(0x235))/0xa)+-parseInt(_0x38c283(0x1f5))/0xb;if(_0x17bb63===_0x5974bc)break;else _0x47828d['push'](_0x47828d['shift']());}catch(_0x563622){_0x47828d['push'](_0x47828d['shift']());}}}(a1_0x4520,0xc0625));const a1_0x3e096b=(function(){let _0x496635=!![];return function(_0x45f1d2,_0x12950c){const _0x4ad06c=_0x496635?function(){if(_0x12950c){const _0x478e82=_0x12950c['apply'](_0x45f1d2,arguments);return _0x12950c=null,_0x478e82;}}:function(){};return _0x496635=![],_0x4ad06c;};}()),a1_0x3a214f=a1_0x3e096b(this,function(){const _0x467d7c=a1_0xde03;return a1_0x3a214f['toString']()[_0x467d7c(0x1ea)](_0x467d7c(0x1fc))[_0x467d7c(0x1ef)]()[_0x467d7c(0x22a)](a1_0x3a214f)[_0x467d7c(0x1ea)](_0x467d7c(0x1fc));});function a1_0x4520(){const _0x3faed4=['common','sort','ist','114360igaHcV','\x27\x20erkannt\x20(','trim','setStateAsync','.1.TEMPERATURE','getForeignObjectAsync','calendarSelection','state','.4.VALVE_STATE','.1.ACTUAL_TEMPERATURE','sensor','üìÖ\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27','setpoint','parse','analysis.energy.warmupTimes','level','light','[CAL]\x20','length','getForeignObjectsAsync','r√ºckkehr','constructor','ACTUAL','toLowerCase','slice','5697009MwOjWu','\x20->\x20Schalte\x20','56OwFutn','log','üîç\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27','mpc_','local_temperature','10wtVLtN','31794uBHVUH',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','pi_heating_demand','getStateAsync','string','üìÖ\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','room','wert','val','setForeignStateAsync','getTime','name','1253ZbuqlI','hm-rpc','.1.SET_POINT_TEMPERATURE','temp','location','includes','464861TeSTJH','soll','actual','debug','event','useCalendar','.1.LEVEL','active','type','Fehlt','target','valveMapping','getForeignStateAsync','consultButler','map','6391230ixboSr','analysis.automation.lastAction','\x20->\x2021¬∞C','current_heating_setpoint','approved','.data.table','system.mode','target_temperature','replace','_calName','analysis.automation.mode','\x20min)','2mNefwp','minutes_safe','role','search','stellwert',')\x20auf\x20','openknx','ankunft','toString','switch',':\x20-1¬∞C\x20(Sparpotenzial\x20genutzt)','SET_POINT_TEMPERATURE','valve','split','12182874XChjdS','number','values','set','devices','level.valve','Nicht\x20gefunden','(((.+)+)+)+$','score','\x20min).','push','info','temperature','warn','find','Unknown','config','dimmer','Ist','PERFECT','exports','5574144cGxprg','join','Unbekannt','Manuelles\x20Mapping','messwert','.4.SET_TEMPERATURE','thermostatMapping','calendarInstance'];a1_0x4520=function(){return _0x3faed4;};return a1_0x4520();}function a1_0xde03(_0x55cfee,_0x3d34ff){const _0x420dbd=a1_0x4520();return a1_0xde03=function(_0x3a214f,_0x3e096b){_0x3a214f=_0x3a214f-0x1bb;let _0x4520d8=_0x420dbd[_0x3a214f];return _0x4520d8;},a1_0xde03(_0x55cfee,_0x3d34ff);}a1_0x3a214f();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x3a85d7){const _0x43ccec=a1_0xde03;if(!_0x3a85d7)return'';return _0x3a85d7[_0x43ccec(0x22c)]()[_0x43ccec(0x1e3)](/\s+/g,'')[_0x43ccec(0x217)]();}async function handlePrediction(_0x12a71f,_0x25b6a5,_0x5acc21){const _0x74e53c=a1_0xde03;if(!_0x25b6a5||_0x25b6a5===_0x74e53c(0x204))return;let _0x3e532e='off',_0xb3ac38=0.6;try{const _0x33d5e7=await _0x12a71f[_0x74e53c(0x1bd)](_0x74e53c(0x1e5));if(_0x33d5e7&&_0x33d5e7[_0x74e53c(0x1c2)])_0x3e532e=_0x33d5e7['val'];const _0x200014=await _0x12a71f[_0x74e53c(0x1bd)]('analysis.automation.confidenceThreshold');if(_0x200014&&_0x200014[_0x74e53c(0x1c2)])_0xb3ac38=_0x200014['val'];}catch(_0x319bfb){}if(_0x3e532e==='off'||_0x5acc21<_0xb3ac38)return;const _0x4dd47c=Date['now']();if(lastActions[_0x25b6a5]&&_0x4dd47c-lastActions[_0x25b6a5]<COOLDOWN_MS)return;const _0x1ad05a=_0x12a71f[_0x74e53c(0x205)][_0x74e53c(0x1f9)]||[],_0x4ef55b=normalize(_0x25b6a5),_0x115137=_0x1ad05a[_0x74e53c(0x203)](_0x242435=>normalize(_0x242435[_0x74e53c(0x1ca)])===_0x4ef55b&&(_0x242435[_0x74e53c(0x1d4)]===_0x74e53c(0x225)||_0x242435['type']===_0x74e53c(0x206)||_0x242435['type']===_0x74e53c(0x1f0)));if(!_0x115137){_0x12a71f[_0x74e53c(0x231)][_0x74e53c(0x1cf)](_0x74e53c(0x232)+_0x25b6a5+'\x27.');return;}const _0x1ef7bc=await aiAgent[_0x74e53c(0x1d9)](_0x12a71f,_0x25b6a5,_0x115137['name'],_0x5acc21);if(!_0x1ef7bc[_0x74e53c(0x1df)])return;const _0x1e7393='Pr√§diktion:\x20'+_0x25b6a5+_0x74e53c(0x22f)+_0x115137['name']+'\x20('+_0x1ef7bc['reason']+')';await _0x12a71f[_0x74e53c(0x218)](_0x74e53c(0x1dc),{'val':'['+_0x3e532e['toUpperCase']()+']\x20'+_0x1e7393,'ack':!![]});if(_0x3e532e===_0x74e53c(0x1d3)){const _0x3bc7b6=await _0x12a71f[_0x74e53c(0x1d8)](_0x115137['id']);(!_0x3bc7b6||!_0x3bc7b6[_0x74e53c(0x1c2)]&&_0x3bc7b6['val']!==!![])&&await _0x12a71f[_0x74e53c(0x1c3)](_0x115137['id'],!![]),lastActions[_0x25b6a5]=_0x4dd47c;}}async function findRelatedId(_0x1355bb,_0x5a9d09,_0xb22f0f='setpoint'){const _0x466d70=a1_0xde03;if(_0xb22f0f===_0x466d70(0x221)&&_0x1355bb[_0x466d70(0x205)]['thermostatMapping']){let _0xa92cad=_0x1355bb[_0x466d70(0x205)][_0x466d70(0x210)];if(typeof _0xa92cad===_0x466d70(0x1be))try{_0xa92cad=JSON[_0x466d70(0x222)](_0xa92cad);}catch(_0x138ed0){}if(_0xa92cad&&_0xa92cad[_0x5a9d09])return _0xa92cad[_0x5a9d09];}if(_0xb22f0f===_0x466d70(0x1f3)&&_0x1355bb[_0x466d70(0x205)]['valveMapping']){let _0x235fe0=_0x1355bb[_0x466d70(0x205)]['valveMapping'];if(typeof _0x235fe0===_0x466d70(0x1be))try{_0x235fe0=JSON['parse'](_0x235fe0);}catch(_0x566a8){}if(_0x235fe0&&_0x235fe0[_0x5a9d09])return _0x235fe0[_0x5a9d09];}let _0x2caf39=[];if(_0xb22f0f==='setpoint')_0x2caf39=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x466d70(0x1c8)},{'s':_0x466d70(0x219),'t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x466d70(0x219),'t':_0x466d70(0x20f)},{'s':'ACTUAL_TEMPERATURE','t':_0x466d70(0x1f2)},{'s':_0x466d70(0x234),'t':'occupied_heating_setpoint'},{'s':_0x466d70(0x234),'t':_0x466d70(0x1de)},{'s':_0x466d70(0x201),'t':_0x466d70(0x1e2)},{'s':_0x466d70(0x22b),'t':'SET'},{'s':_0x466d70(0x207),'t':'Soll'},{'s':_0x466d70(0x201),'t':_0x466d70(0x221)}];else _0xb22f0f===_0x466d70(0x1f3)&&(_0x2caf39=[{'s':_0x466d70(0x21e),'t':_0x466d70(0x1d2)},{'s':_0x466d70(0x219),'t':_0x466d70(0x1d2)},{'s':_0x466d70(0x219),'t':_0x466d70(0x21d)},{'s':'local_temperature','t':_0x466d70(0x1bc)},{'s':_0x466d70(0x201),'t':'valve_position'},{'s':_0x466d70(0x201),'t':_0x466d70(0x224)}]);for(const _0xc4e575 of _0x2caf39){if(_0x5a9d09[_0x466d70(0x1cb)](_0xc4e575['s'])){const _0x5e3f1e=_0x5a9d09['replace'](_0xc4e575['s'],_0xc4e575['t']),_0x3ec8ac=await _0x1355bb[_0x466d70(0x21a)](_0x5e3f1e);if(_0x3ec8ac)return _0x5e3f1e;}}try{const _0x1b9aed=_0x5a9d09['split']('.');if(_0x1b9aed['length']>0x2){const _0x12152a=_0x1b9aed[_0x466d70(0x22d)](0x0,-0x1)[_0x466d70(0x20b)]('.'),_0x28e92d=await _0x1355bb[_0x466d70(0x228)](_0x12152a+'.*'),_0x8ba1e0=[],_0x56cb67=_0x5a9d09['split'](/[._]+/)['filter'](_0x45b24f=>![_0x466d70(0x1ed),'0',_0x466d70(0x1c7),_0x466d70(0x214),_0x466d70(0x1c1),_0x466d70(0x201),_0x466d70(0x1ce),_0x466d70(0x21f),_0x466d70(0x20e),_0x466d70(0x21c)][_0x466d70(0x1cb)](_0x45b24f[_0x466d70(0x22c)]()));for(const [_0x406660,_0x200b76]of Object['entries'](_0x28e92d)){if(_0x406660===_0x5a9d09)continue;if(_0x200b76&&_0x200b76[_0x466d70(0x212)]){const _0x405870=_0x406660['toLowerCase'](),_0x305b27=(_0x200b76[_0x466d70(0x212)][_0x466d70(0x1e9)]||'')['toLowerCase'](),_0xaa4f7=(_0x200b76[_0x466d70(0x212)]['unit']||'')['toLowerCase']();let _0x164dbc=![];if(_0xb22f0f==='setpoint'&&_0x200b76[_0x466d70(0x212)]['write']===!![])_0x164dbc=_0x405870['includes'](_0x466d70(0x1f8))||_0x405870['includes'](_0x466d70(0x1cd))||_0x405870[_0x466d70(0x1cb)](_0x466d70(0x1d6))||_0x305b27[_0x466d70(0x1cb)]('level.temperature')||_0x305b27[_0x466d70(0x1cb)]('thermostat.setpoint');else _0xb22f0f==='valve'&&(_0x164dbc=_0x405870['includes'](_0x466d70(0x224))||_0x405870[_0x466d70(0x1cb)](_0x466d70(0x1f3))||_0x405870[_0x466d70(0x1cb)](_0x466d70(0x1eb))||_0x405870[_0x466d70(0x1cb)]('position')||_0x305b27[_0x466d70(0x1cb)](_0x466d70(0x1fa))||_0x305b27['includes']('value.valve')||_0xaa4f7[_0x466d70(0x1cb)]('%'));if(_0x164dbc){const _0x495cc6=_0x406660[_0x466d70(0x1f4)](/[._]+/)[_0x466d70(0x1da)](_0xf83696=>_0xf83696[_0x466d70(0x22c)]());let _0x51f96e=0x0;_0x56cb67['forEach'](_0x5a46de=>{const _0x586f67=_0x466d70;if(_0x495cc6[_0x586f67(0x1cb)](_0x5a46de[_0x586f67(0x22c)]()))_0x51f96e++;}),_0x8ba1e0[_0x466d70(0x1ff)]({'id':_0x406660,'score':_0x51f96e});}}}if(_0x8ba1e0[_0x466d70(0x227)]>0x0){_0x8ba1e0[_0x466d70(0x213)]((_0x1f0e2c,_0x34cac9)=>_0x34cac9['score']-_0x1f0e2c[_0x466d70(0x1fd)]);if(_0x8ba1e0[0x0][_0x466d70(0x1fd)]>0x0)return _0x8ba1e0[0x0]['id'];}}}catch(_0x18edf0){}return null;}async function scanThermostats(_0x584530){const _0x590f0f=a1_0xde03,_0x33f9d9=_0x584530[_0x590f0f(0x205)][_0x590f0f(0x1f9)]||[],_0xbf7cfa=[],_0x52fdac=_0x33f9d9['filter'](_0x26e98a=>_0x26e98a['id']&&_0x26e98a['id'][_0x590f0f(0x1cb)](_0x590f0f(0x201))||_0x26e98a[_0x590f0f(0x1d4)]&&[_0x590f0f(0x201),'thermostat',_0x590f0f(0x21f)]['includes'](_0x26e98a[_0x590f0f(0x1d4)])||_0x26e98a[_0x590f0f(0x1c5)]&&_0x26e98a['name']['toLowerCase']()[_0x590f0f(0x1cb)](_0x590f0f(0x1c9)));for(const _0x10a1de of _0x52fdac){const _0x515a85=await findRelatedId(_0x584530,_0x10a1de['id'],_0x590f0f(0x221)),_0x2673e0=await findRelatedId(_0x584530,_0x10a1de['id'],_0x590f0f(0x1f3));let _0x2ead51=_0x590f0f(0x1fb),_0x4db639=![],_0x6b8075=_0x584530[_0x590f0f(0x205)]['thermostatMapping']||{};if(typeof _0x6b8075===_0x590f0f(0x1be))try{_0x6b8075=JSON[_0x590f0f(0x222)](_0x6b8075);}catch(_0x434e2b){}let _0x258829=_0x584530[_0x590f0f(0x205)][_0x590f0f(0x1d7)]||{};if(typeof _0x258829===_0x590f0f(0x1be))try{_0x258829=JSON[_0x590f0f(0x222)](_0x258829);}catch(_0x20becc){}if(_0x6b8075[_0x10a1de['id']]&&_0x6b8075[_0x10a1de['id']]===_0x515a85||_0x258829[_0x10a1de['id']]&&_0x258829[_0x10a1de['id']]===_0x2673e0)_0x2ead51=_0x590f0f(0x20d),_0x4db639=!![];else(_0x515a85||_0x2673e0)&&(_0x2ead51='Auto-Erkennung');_0xbf7cfa['push']({'room':_0x10a1de[_0x590f0f(0x1ca)]||_0x590f0f(0x20c),'sensorId':_0x10a1de['id'],'setpointId':_0x515a85||'-','valveId':_0x2673e0||'-','source':_0x2ead51,'isManual':_0x4db639,'status':_0x515a85&&_0x2673e0?_0x590f0f(0x208):_0x515a85?'OK':_0x590f0f(0x1d5)});}return _0xbf7cfa[_0x590f0f(0x213)]((_0x88ab3f,_0x4159ee)=>_0x88ab3f[_0x590f0f(0x1c0)]['localeCompare'](_0x4159ee[_0x590f0f(0x1c0)]));}async function checkCalendarTriggers(_0x3b9732){const _0x352c78=a1_0xde03;if(!_0x3b9732[_0x352c78(0x205)][_0x352c78(0x1d1)]||!_0x3b9732['config'][_0x352c78(0x211)])return;let _0x5060a4={};try{const _0x2b05d1=await _0x3b9732[_0x352c78(0x1bd)](_0x352c78(0x223));if(_0x2b05d1&&_0x2b05d1[_0x352c78(0x1c2)])_0x5060a4=JSON['parse'](_0x2b05d1[_0x352c78(0x1c2)]);}catch(_0x4c62db){}try{const _0x3fdd4c=await _0x3b9732['getForeignStateAsync'](_0x3b9732['config'][_0x352c78(0x211)]+_0x352c78(0x1e0));if(!_0x3fdd4c||!_0x3fdd4c[_0x352c78(0x1c2)])return;const _0x71789=JSON['parse'](_0x3fdd4c[_0x352c78(0x1c2)]),_0x3210d2=new Date(),_0x32985e=_0x3b9732['config'][_0x352c78(0x1f9)]||[],_0x147162=_0x3b9732['config'][_0x352c78(0x21b)]||[];for(const _0x3bf7f5 of _0x71789){if(_0x3bf7f5['_calName']&&_0x147162[_0x352c78(0x227)]>0x0&&!_0x147162[_0x352c78(0x1cb)](_0x3bf7f5[_0x352c78(0x1e4)]))continue;const _0x158e60=new Date(_0x3bf7f5['eventStart']),_0xb33a38=(_0x3bf7f5[_0x352c78(0x1d0)]||_0x3bf7f5['summary']||'')[_0x352c78(0x22c)]();if(_0xb33a38[_0x352c78(0x1cb)]('urlaub\x20ende')||_0xb33a38[_0x352c78(0x1cb)](_0x352c78(0x229))||_0xb33a38[_0x352c78(0x1cb)](_0x352c78(0x1ee))){let _0x16a320=0x0;Object[_0x352c78(0x1f7)](_0x5060a4)['forEach'](_0x5d8289=>{if(_0x5d8289>_0x16a320)_0x16a320=_0x5d8289;});if(_0x16a320===0x0)_0x16a320=0x78;const _0x1690e7=new Date(_0x158e60[_0x352c78(0x1c4)]()-_0x16a320*0xea60),_0x1c6394=_0x3210d2[_0x352c78(0x1c4)]()-_0x1690e7['getTime']();_0x1c6394>=0x0&&_0x1c6394<0xf*0xea60&&(_0x3b9732[_0x352c78(0x231)]['info'](_0x352c78(0x1bf)+_0x3bf7f5[_0x352c78(0x1d0)]+_0x352c78(0x1bb)+_0x16a320+_0x352c78(0x1fe)),await _0x3b9732[_0x352c78(0x218)](_0x352c78(0x1e1),{'val':'normal','ack':![]}));}for(const _0x4bfdb5 of _0x32985e){if(_0x4bfdb5['location']){const _0x3c5273=_0x4bfdb5[_0x352c78(0x1ca)]['toLowerCase']();if(_0xb33a38[_0x352c78(0x1cb)](_0x3c5273)){const _0x28fdf1=_0x5060a4[_0x4bfdb5[_0x352c78(0x1ca)]]||0x3c,_0x41da66=new Date(_0x158e60[_0x352c78(0x1c4)]()-_0x28fdf1*0xea60),_0x59aea6=_0x3210d2[_0x352c78(0x1c4)]()-_0x41da66[_0x352c78(0x1c4)]();if(_0x59aea6>=0x0&&_0x59aea6<0xf*0xea60){const _0xbc827d=await findRelatedId(_0x3b9732,_0x4bfdb5['id'],_0x352c78(0x221));_0xbc827d&&(_0x3b9732[_0x352c78(0x231)][_0x352c78(0x200)](_0x352c78(0x220)+_0x4bfdb5[_0x352c78(0x1ca)]+_0x352c78(0x216)+_0x3bf7f5[_0x352c78(0x1d0)]+').\x20Heize\x20auf\x2021¬∞C\x20(Vorlauf:\x20'+_0x28fdf1+_0x352c78(0x1fe)),await _0x3b9732['setForeignStateAsync'](_0xbc827d,0x15),await _0x3b9732['setStateAsync'](_0x352c78(0x1dc),{'val':_0x352c78(0x226)+_0x4bfdb5['location']+_0x352c78(0x1dd),'ack':!![]}));}}}}}}catch(_0xac1eb8){_0x3b9732[_0x352c78(0x231)][_0x352c78(0x202)]('Calendar\x20Check\x20Error:\x20'+_0xac1eb8['message']);}}async function applyEnergySavings(_0x34122f,_0xa779c3){const _0x341a69=a1_0xde03,_0x55432a=_0x34122f[_0x341a69(0x205)][_0x341a69(0x1f9)]||[];for(const _0x2ce99c of _0xa779c3){const _0x2ef518=_0x2ce99c[_0x341a69(0x1c0)],_0x17f807=_0x2ce99c[_0x341a69(0x1e8)],_0x456cd7=Date['now']();if(lastActions[_0x341a69(0x233)+_0x2ef518]&&_0x456cd7-lastActions['mpc_'+_0x2ef518]<0x1e*0x3c*0x3e8)continue;const _0xb32ca9=_0x55432a[_0x341a69(0x203)](_0x4113e4=>normalize(_0x4113e4[_0x341a69(0x1ca)])===normalize(_0x2ef518));if(!_0xb32ca9)continue;const _0x225e6a=await findRelatedId(_0x34122f,_0xb32ca9['id'],_0x341a69(0x221));if(_0x225e6a){const _0x13d98f=await _0x34122f[_0x341a69(0x1d8)](_0x225e6a);if(_0x13d98f&&typeof _0x13d98f[_0x341a69(0x1c2)]===_0x341a69(0x1f6)){const _0x4489f4=_0x13d98f[_0x341a69(0x1c2)];if(_0x17f807>0x1e&&_0x4489f4>0x11){const _0x175d85=_0x4489f4-0x1;_0x34122f['log'][_0x341a69(0x200)]('üçÉ\x20MPC\x20Autonomy:\x20Senke\x20'+_0x2ef518+'\x20('+_0x225e6a+_0x341a69(0x1ec)+_0x175d85+'¬∞C\x20(Coasting\x20m√∂glich:\x20'+_0x17f807+_0x341a69(0x1e6)),await _0x34122f[_0x341a69(0x1c3)](_0x225e6a,_0x175d85),lastActions[_0x341a69(0x233)+_0x2ef518]=_0x456cd7,await _0x34122f[_0x341a69(0x218)]('analysis.automation.lastAction',{'val':'[MPC]\x20'+_0x2ef518+_0x341a69(0x1f1),'ack':!![]});}}}}}module[a1_0x1259cd(0x209)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};