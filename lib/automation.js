const a1_0x4b8b97=a1_0xee75;(function(_0x5cab9a,_0x3af0cf){const _0x2ed0cb=a1_0xee75,_0x67f8b5=_0x5cab9a();while(!![]){try{const _0x3ac50f=parseInt(_0x2ed0cb(0x1a5))/0x1*(-parseInt(_0x2ed0cb(0x15e))/0x2)+parseInt(_0x2ed0cb(0x127))/0x3+-parseInt(_0x2ed0cb(0x167))/0x4+-parseInt(_0x2ed0cb(0x18b))/0x5*(parseInt(_0x2ed0cb(0x137))/0x6)+-parseInt(_0x2ed0cb(0x182))/0x7+-parseInt(_0x2ed0cb(0x15d))/0x8*(parseInt(_0x2ed0cb(0x162))/0x9)+-parseInt(_0x2ed0cb(0x1a0))/0xa*(-parseInt(_0x2ed0cb(0x12c))/0xb);if(_0x3ac50f===_0x3af0cf)break;else _0x67f8b5['push'](_0x67f8b5['shift']());}catch(_0x2e32f1){_0x67f8b5['push'](_0x67f8b5['shift']());}}}(a1_0x1bde,0x715c0));const a1_0x1434a7=(function(){let _0x47a6c5=!![];return function(_0x521851,_0x43ad91){const _0x5ae599=_0x47a6c5?function(){if(_0x43ad91){const _0x1a0c3c=_0x43ad91['apply'](_0x521851,arguments);return _0x43ad91=null,_0x1a0c3c;}}:function(){};return _0x47a6c5=![],_0x5ae599;};}()),a1_0x4858f9=a1_0x1434a7(this,function(){const _0x5b2915=a1_0xee75;return a1_0x4858f9[_0x5b2915(0x115)]()[_0x5b2915(0x156)](_0x5b2915(0x17e))[_0x5b2915(0x115)]()[_0x5b2915(0x190)](a1_0x4858f9)['search'](_0x5b2915(0x17e));});a1_0x4858f9();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function a1_0x1bde(){const _0x4c77a5=['normal','soll','ACTUAL','DEBUG:\x20State\x20leer','analysis.automation.confidenceThreshold','entries','triggerTime','.4.VALVE_STATE','.1.SET_POINT_TEMPERATURE','SET_POINT_TEMPERATURE','.4.SET_TEMPERATURE','getForeignStateAsync','10zgXKSd','\x27\x20gefunden!\x20PrÃ¼fe\x20Schreibweise.','config','position','DEBUG:\x20Kein\x20Thermostat\x20fÃ¼r\x20Raum\x20\x27','26987QZWRen',',\x20Wert:\x20','info','approved','Calendar\x20Check\x20Error:\x20','.1.TEMPERATURE','location','TRAIN_RL_PENALTY','slice','replace','sendToPythonWrapper','sensor','getForeignObjectsAsync','_date','system.mode','devices','ðŸ”¥\x20[MPC\x20ACTION]\x20Heize\x20','off','occupied_heating_setpoint','setpoint','\x20auf\x20','_calName','ðŸ§¹\x20[MPC\x20CLEANUP]\x20','toString','rÃ¼ckkehr','temp','ist','thermostatMapping','level.valve','local_temperature','forEach','trim','ACTUAL_TEMPERATURE','target','Â°C\x20(via\x20','getTime','messwert','now',':\x20Absenkung\x20auf\x20','warn','ðŸƒ\x20[MPC\x20ACTION]\x20Senke\x20','716775zvTugu','indexOf','join','DEBUG:\x20PrÃ¼fe\x20Liste:\x20','date','31455974DTxAbu','room','current_heating_setpoint','Â°C!\x20(Puffer:\x20','\x20gefunden!','switch','find','calendarInstance','\x20->\x20Setpoint\x20ID:\x20','\x20wieder\x20auf\x20','Â°C\x20(Vorlauf:\x20','38838pMcQLd','string','debug','analysis.energy.warmupTargets','name','event','abs','analysis.energy.warmupSources','unshift','stellwert','calendarSelection','active','unit','level.temperature','Â°C\x20um\x20diese\x20Zeit.','Nicht\x20gefunden',':\x20Aufheizen\x20auf\x20','openknx','val','push','\x20min).','[MPC]\x20','Auto-Erkennung','valve_position','DEBUG:\x20','valveMapping','ðŸŽ“\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20','cal_','useCalendar','analysis.energy.warmupTimes','Â°C\x20(nicht\x20','search',']:\x20Raum-Trigger\x20\x27','valve','currentSystemMode','mpc_','score','summary','1912BXULQD','20UFEpvP','number','\x20mag\x20keine\x20','level','4833ZxJJEb','ankunft','toLowerCase','log','stringify','2264048VZRUEG','analysis.energy.mpcActiveInterventions','[MPC\x20WARNING]\x20Kein\x20Setpoint\x20fÃ¼r\x20','splice','parse','length','includes','eventStart','ðŸ“…\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20','state','add','\x27\x20(Sensor:\x20','analysis.automation.mode','common','split','.1.ACTUAL_TEMPERATURE','dimmer','thermostat.setpoint','Unbekannt','SET','\x20min)','values','temperature','(((.+)+)+)+$','setForeignStateAsync','isArray','urlaub\x20ende','5935601ZXlWhK','PrÃ¤diktion:\x20','setStateAsync','role','DEBUG:\x20Raum-Match\x20\x27','value.valve','remove','exports','message','635RlodtD','\x27\x20gefunden.\x20Typ:\x20','Fehlt','getStateAsync','type','constructor','set','Unknown','\x20->\x20'];a1_0x1bde=function(){return _0x4c77a5;};return a1_0x1bde();}function normalize(_0x193cbc){const _0x504b77=a1_0xee75;if(!_0x193cbc)return'';return _0x193cbc[_0x504b77(0x164)]()[_0x504b77(0x1ae)](/\s+/g,'')[_0x504b77(0x11d)]();}async function logAutomationAction(_0x31525c,_0xf1a11f){const _0x348392=a1_0xee75;await _0x31525c[_0x348392(0x184)]('analysis.automation.lastAction',{'val':_0xf1a11f,'ack':!![]});try{const _0x65ad16='analysis.automation.actionLog',_0x36f349=await _0x31525c[_0x348392(0x18e)](_0x65ad16);let _0x35c472=[];if(_0x36f349&&_0x36f349['val'])try{_0x35c472=JSON['parse'](_0x36f349[_0x348392(0x149)]);}catch(_0x51829c){}_0x35c472[_0x348392(0x13f)]({'ts':Date['now'](),'msg':_0xf1a11f});if(_0x35c472[_0x348392(0x16c)]>0x32)_0x35c472=_0x35c472[_0x348392(0x1ad)](0x0,0x32);await _0x31525c['setStateAsync'](_0x65ad16,{'val':JSON[_0x348392(0x166)](_0x35c472),'ack':!![]});}catch(_0x4b6dd7){}}async function handlePrediction(_0x56aaca,_0x67cbce,_0x1e4526){const _0x307b4e=a1_0xee75;if(!_0x67cbce||_0x67cbce===_0x307b4e(0x192))return;let _0x384d58='off',_0x15264c=0.6;try{const _0x2eab58=await _0x56aaca['getStateAsync'](_0x307b4e(0x173));if(_0x2eab58&&_0x2eab58['val'])_0x384d58=_0x2eab58[_0x307b4e(0x149)];const _0x30cde1=await _0x56aaca[_0x307b4e(0x18e)](_0x307b4e(0x198));if(_0x30cde1&&_0x30cde1[_0x307b4e(0x149)])_0x15264c=_0x30cde1[_0x307b4e(0x149)];}catch(_0xdb1e28){}if(_0x384d58===_0x307b4e(0x10f)||_0x1e4526<_0x15264c)return;const _0xb4da20=Date[_0x307b4e(0x123)]();if(lastActions[_0x67cbce]&&_0xb4da20-lastActions[_0x67cbce]<COOLDOWN_MS)return;const _0x22acc4=_0x56aaca[_0x307b4e(0x1a2)][_0x307b4e(0x10d)]||[],_0x3c01ff=normalize(_0x67cbce),_0xbe7763=_0x22acc4[_0x307b4e(0x132)](_0x26cc45=>normalize(_0x26cc45[_0x307b4e(0x1ab)])===_0x3c01ff&&(_0x26cc45[_0x307b4e(0x18f)]==='light'||_0x26cc45[_0x307b4e(0x18f)]===_0x307b4e(0x177)||_0x26cc45[_0x307b4e(0x18f)]===_0x307b4e(0x131)));if(!_0xbe7763)return;const _0x18021f=await aiAgent['consultButler'](_0x56aaca,_0x67cbce,_0xbe7763[_0x307b4e(0x13b)],_0x1e4526);if(!_0x18021f[_0x307b4e(0x1a8)])return;const _0x34417c=_0x307b4e(0x183)+_0x67cbce+'\x20->\x20Schalte\x20'+_0xbe7763[_0x307b4e(0x13b)]+'\x20('+_0x18021f['reason']+')';await logAutomationAction(_0x56aaca,'['+_0x384d58['toUpperCase']()+']\x20'+_0x34417c);if(_0x384d58===_0x307b4e(0x142)){const _0x5658ef=await _0x56aaca[_0x307b4e(0x19f)](_0xbe7763['id']);(!_0x5658ef||!_0x5658ef[_0x307b4e(0x149)]&&_0x5658ef[_0x307b4e(0x149)]!==!![])&&await _0x56aaca[_0x307b4e(0x17f)](_0xbe7763['id'],!![]),lastActions[_0x67cbce]=_0xb4da20;}}async function findRelatedId(_0x43aeb5,_0x3d54b0,_0x3d3119=a1_0x4b8b97(0x111)){const _0x1f32fd=a1_0x4b8b97;if(_0x3d3119===_0x1f32fd(0x111)&&_0x43aeb5[_0x1f32fd(0x1a2)]['thermostatMapping']){let _0x4972e5=_0x43aeb5[_0x1f32fd(0x1a2)][_0x1f32fd(0x119)];if(typeof _0x4972e5===_0x1f32fd(0x138))try{_0x4972e5=JSON[_0x1f32fd(0x16b)](_0x4972e5);}catch(_0x37c86f){}if(_0x4972e5&&_0x4972e5[_0x3d54b0])return _0x4972e5[_0x3d54b0];}if(_0x3d3119==='valve'&&_0x43aeb5['config'][_0x1f32fd(0x150)]){let _0xa58e41=_0x43aeb5[_0x1f32fd(0x1a2)][_0x1f32fd(0x150)];if(typeof _0xa58e41===_0x1f32fd(0x138))try{_0xa58e41=JSON[_0x1f32fd(0x16b)](_0xa58e41);}catch(_0x1e1abd){}if(_0xa58e41&&_0xa58e41[_0x3d54b0])return _0xa58e41[_0x3d54b0];}let _0x158ed9=[];if(_0x3d3119===_0x1f32fd(0x111))_0x158ed9=[{'s':_0x1f32fd(0x176),'t':_0x1f32fd(0x19c)},{'s':'.1.TEMPERATURE','t':_0x1f32fd(0x19c)},{'s':_0x1f32fd(0x1aa),'t':_0x1f32fd(0x19e)},{'s':_0x1f32fd(0x11e),'t':_0x1f32fd(0x19d)},{'s':_0x1f32fd(0x11b),'t':_0x1f32fd(0x110)},{'s':'local_temperature','t':_0x1f32fd(0x12e)},{'s':_0x1f32fd(0x17d),'t':'target_temperature'},{'s':_0x1f32fd(0x196),'t':_0x1f32fd(0x17a)},{'s':'Ist','t':'Soll'},{'s':_0x1f32fd(0x17d),'t':'setpoint'}];else _0x3d3119==='valve'&&(_0x158ed9=[{'s':'.1.ACTUAL_TEMPERATURE','t':'.1.LEVEL'},{'s':_0x1f32fd(0x1aa),'t':'.1.LEVEL'},{'s':'.1.TEMPERATURE','t':_0x1f32fd(0x19b)},{'s':_0x1f32fd(0x11b),'t':'pi_heating_demand'},{'s':_0x1f32fd(0x17d),'t':_0x1f32fd(0x14e)},{'s':'temperature','t':'level'}]);for(const _0x4793b6 of _0x158ed9){if(_0x3d54b0['includes'](_0x4793b6['s'])){const _0x4ddad5=_0x3d54b0[_0x1f32fd(0x1ae)](_0x4793b6['s'],_0x4793b6['t']),_0x260db4=await _0x43aeb5['getForeignObjectAsync'](_0x4ddad5);if(_0x260db4)return _0x4ddad5;}}try{const _0xa564a1=_0x3d54b0['split']('.');if(_0xa564a1[_0x1f32fd(0x16c)]>0x2){const _0x2e5e8a=_0xa564a1[_0x1f32fd(0x1ad)](0x0,-0x1)[_0x1f32fd(0x129)]('.'),_0x46fab0=await _0x43aeb5[_0x1f32fd(0x1b1)](_0x2e5e8a+'.*'),_0x44ed5d=[],_0x329df7=_0x3d54b0['split'](/[._]+/)['filter'](_0xb8306d=>![_0x1f32fd(0x148),'0','hm-rpc',_0x1f32fd(0x118),'wert',_0x1f32fd(0x17d),'actual',_0x1f32fd(0x1b0),_0x1f32fd(0x122),_0x1f32fd(0x170)][_0x1f32fd(0x16d)](_0xb8306d[_0x1f32fd(0x164)]()));for(const [_0x318b02,_0x56bfe2]of Object[_0x1f32fd(0x199)](_0x46fab0)){if(_0x318b02===_0x3d54b0)continue;if(_0x56bfe2&&_0x56bfe2['common']){const _0x196e72=_0x318b02['toLowerCase'](),_0x102622=(_0x56bfe2[_0x1f32fd(0x174)][_0x1f32fd(0x185)]||'')[_0x1f32fd(0x164)](),_0x3f2b70=(_0x56bfe2[_0x1f32fd(0x174)][_0x1f32fd(0x143)]||'')[_0x1f32fd(0x164)]();let _0x51f685=![];if(_0x3d3119===_0x1f32fd(0x111)&&_0x56bfe2[_0x1f32fd(0x174)]['write']===!![])_0x51f685=_0x196e72[_0x1f32fd(0x16d)](_0x1f32fd(0x191))||_0x196e72[_0x1f32fd(0x16d)](_0x1f32fd(0x195))||_0x196e72['includes'](_0x1f32fd(0x11f))||_0x102622[_0x1f32fd(0x16d)](_0x1f32fd(0x144))||_0x102622[_0x1f32fd(0x16d)](_0x1f32fd(0x178));else _0x3d3119===_0x1f32fd(0x158)&&(_0x51f685=_0x196e72['includes'](_0x1f32fd(0x161))||_0x196e72[_0x1f32fd(0x16d)]('valve')||_0x196e72[_0x1f32fd(0x16d)](_0x1f32fd(0x140))||_0x196e72[_0x1f32fd(0x16d)](_0x1f32fd(0x1a3))||_0x102622[_0x1f32fd(0x16d)](_0x1f32fd(0x11a))||_0x102622[_0x1f32fd(0x16d)](_0x1f32fd(0x187))||_0x3f2b70[_0x1f32fd(0x16d)]('%'));if(_0x51f685){const _0x24005c=_0x318b02[_0x1f32fd(0x175)](/[._]+/)['map'](_0x516328=>_0x516328[_0x1f32fd(0x164)]());let _0x49ce3a=0x0;_0x329df7['forEach'](_0x23953c=>{const _0x527a46=_0x1f32fd;if(_0x24005c['includes'](_0x23953c[_0x527a46(0x164)]()))_0x49ce3a++;}),_0x44ed5d[_0x1f32fd(0x14a)]({'id':_0x318b02,'score':_0x49ce3a});}}}if(_0x44ed5d['length']>0x0){_0x44ed5d['sort']((_0x483407,_0x430ee4)=>_0x430ee4['score']-_0x483407['score']);if(_0x44ed5d[0x0][_0x1f32fd(0x15b)]>0x0)return _0x44ed5d[0x0]['id'];}}}catch(_0x292c18){}return null;}async function scanThermostats(_0x1823c6){const _0x1be103=a1_0x4b8b97,_0x50e2fc=_0x1823c6[_0x1be103(0x1a2)][_0x1be103(0x10d)]||[],_0x58be72=[],_0x3e21bb=_0x50e2fc['filter'](_0x533d2a=>_0x533d2a['id']&&_0x533d2a['id'][_0x1be103(0x16d)]('temperature')||_0x533d2a[_0x1be103(0x18f)]&&[_0x1be103(0x17d),'thermostat',_0x1be103(0x1b0)][_0x1be103(0x16d)](_0x533d2a['type'])||_0x533d2a[_0x1be103(0x13b)]&&_0x533d2a[_0x1be103(0x13b)][_0x1be103(0x164)]()[_0x1be103(0x16d)](_0x1be103(0x117)));for(const _0x323b17 of _0x3e21bb){const _0x23e6e3=await findRelatedId(_0x1823c6,_0x323b17['id'],_0x1be103(0x111)),_0x5d5f92=await findRelatedId(_0x1823c6,_0x323b17['id'],_0x1be103(0x158));let _0x456d6b=_0x1be103(0x146),_0x1fd8dd=![],_0x23af04=_0x1823c6[_0x1be103(0x1a2)][_0x1be103(0x119)]||{};if(typeof _0x23af04===_0x1be103(0x138))try{_0x23af04=JSON['parse'](_0x23af04);}catch(_0x35a185){}let _0x1a671e=_0x1823c6[_0x1be103(0x1a2)][_0x1be103(0x150)]||{};if(typeof _0x1a671e===_0x1be103(0x138))try{_0x1a671e=JSON[_0x1be103(0x16b)](_0x1a671e);}catch(_0x6e97){}if(_0x23af04[_0x323b17['id']]&&_0x23af04[_0x323b17['id']]===_0x23e6e3||_0x1a671e[_0x323b17['id']]&&_0x1a671e[_0x323b17['id']]===_0x5d5f92)_0x456d6b='Manuelles\x20Mapping',_0x1fd8dd=!![];else(_0x23e6e3||_0x5d5f92)&&(_0x456d6b=_0x1be103(0x14d));_0x58be72['push']({'room':_0x323b17[_0x1be103(0x1ab)]||_0x1be103(0x179),'sensorId':_0x323b17['id'],'setpointId':_0x23e6e3||'-','valveId':_0x5d5f92||'-','source':_0x456d6b,'isManual':_0x1fd8dd,'status':_0x23e6e3&&_0x5d5f92?'PERFECT':_0x23e6e3?'OK':_0x1be103(0x18d)});}return _0x58be72['sort']((_0xfb1e1e,_0x331b3d)=>_0xfb1e1e[_0x1be103(0x12d)]['localeCompare'](_0x331b3d[_0x1be103(0x12d)]));}async function updateSchedulePreview(_0x329bcd){const _0x36c2d9=a1_0x4b8b97;if(!_0x329bcd['config']['useCalendar']||!_0x329bcd['config'][_0x36c2d9(0x133)])return;let _0x25730c={};try{const _0x38c8f8=await _0x329bcd[_0x36c2d9(0x18e)]('analysis.energy.warmupTimes');if(_0x38c8f8&&_0x38c8f8[_0x36c2d9(0x149)])_0x25730c=JSON[_0x36c2d9(0x16b)](_0x38c8f8[_0x36c2d9(0x149)]);}catch(_0x35427e){}const _0x331cc2=[],_0x25d959=Date[_0x36c2d9(0x123)](),_0x35af77=0x30*0x3c*0x3c*0x3e8;try{const _0x14bd32=await _0x329bcd['getForeignStateAsync'](_0x329bcd[_0x36c2d9(0x1a2)]['calendarInstance']+'.data.table');if(!_0x14bd32||!_0x14bd32['val'])return;const _0x1fb315=JSON[_0x36c2d9(0x16b)](_0x14bd32[_0x36c2d9(0x149)]),_0x2f7f40=_0x329bcd[_0x36c2d9(0x1a2)][_0x36c2d9(0x141)]||[],_0x1dbf59=_0x329bcd['config']['devices']||[],_0x18115c=new Set();_0x1dbf59[_0x36c2d9(0x11c)](_0x23ea3c=>{const _0xd945f1=_0x36c2d9;if(_0x23ea3c[_0xd945f1(0x1ab)])_0x18115c[_0xd945f1(0x171)](_0x23ea3c[_0xd945f1(0x1ab)]);});for(const _0x452817 of _0x1fb315){if(_0x452817[_0x36c2d9(0x113)]&&_0x2f7f40[_0x36c2d9(0x16c)]>0x0&&!_0x2f7f40[_0x36c2d9(0x16d)](_0x452817[_0x36c2d9(0x113)]))continue;const _0x45e4fc=_0x452817[_0x36c2d9(0x1b2)]||_0x452817[_0x36c2d9(0x16e)]||_0x452817[_0x36c2d9(0x12b)];if(!_0x45e4fc)continue;const _0x14d55b=new Date(_0x45e4fc),_0x5966ec=_0x14d55b[_0x36c2d9(0x121)]();if(isNaN(_0x5966ec))continue;if(_0x5966ec<_0x25d959)continue;if(_0x5966ec>_0x25d959+_0x35af77)continue;const _0x4ed9df=(_0x452817[_0x36c2d9(0x13c)]||_0x452817[_0x36c2d9(0x15c)]||'')[_0x36c2d9(0x164)]();let _0x2ddfdf=![],_0x3357e2=[],_0x385a4a=_0x452817['event']||_0x452817[_0x36c2d9(0x15c)]||_0x36c2d9(0x179);if(_0x4ed9df[_0x36c2d9(0x16d)](_0x36c2d9(0x181))||_0x4ed9df[_0x36c2d9(0x16d)](_0x36c2d9(0x116))||_0x4ed9df[_0x36c2d9(0x16d)](_0x36c2d9(0x163)))_0x2ddfdf=!![],_0x3357e2=Array['from'](_0x18115c);else for(const _0x59fb90 of _0x18115c){if(_0x4ed9df[_0x36c2d9(0x16d)](_0x59fb90[_0x36c2d9(0x164)]()))_0x3357e2[_0x36c2d9(0x14a)](_0x59fb90);}_0x3357e2['length']>0x0&&_0x3357e2[_0x36c2d9(0x11c)](_0x3c5804=>{const _0x220671=_0x36c2d9;let _0x2970bf=0x3c;if(_0x2ddfdf){let _0x188f7f=0x0;Object[_0x220671(0x17c)](_0x25730c)[_0x220671(0x11c)](_0x315d9a=>{if(_0x315d9a>_0x188f7f)_0x188f7f=_0x315d9a;}),_0x2970bf=_0x188f7f>0x0?_0x188f7f:0x78;}else _0x2970bf=_0x25730c[_0x3c5804]||0x3c;const _0x549a99=new Date(_0x5966ec-_0x2970bf*0xea60);_0x331cc2[_0x220671(0x14a)]({'eventTime':_0x5966ec,'triggerTime':_0x549a99['getTime'](),'room':_0x3c5804,'minutes':_0x2970bf,'reason':_0x385a4a,'isGlobal':_0x2ddfdf});});}}catch(_0x2b1a24){}_0x331cc2['sort']((_0x10f560,_0x4107ee)=>_0x10f560['triggerTime']-_0x4107ee[_0x36c2d9(0x19a)]);const _0x5e2d2d=_0x331cc2['slice'](0x0,0x5);await _0x329bcd[_0x36c2d9(0x184)]('analysis.energy.schedulePreview',{'val':JSON[_0x36c2d9(0x166)](_0x5e2d2d),'ack':!![]});}async function checkCalendarTriggers(_0x51bd47){const _0x43e235=a1_0x4b8b97;if(!_0x51bd47[_0x43e235(0x1a2)][_0x43e235(0x153)]||!_0x51bd47['config'][_0x43e235(0x133)])return;await updateSchedulePreview(_0x51bd47);let _0x120e77={},_0x184a6b={};try{const _0x53ba08=await _0x51bd47[_0x43e235(0x18e)](_0x43e235(0x154));if(_0x53ba08&&_0x53ba08[_0x43e235(0x149)])_0x120e77=JSON[_0x43e235(0x16b)](_0x53ba08[_0x43e235(0x149)]);const _0x23fd7b=await _0x51bd47['getStateAsync'](_0x43e235(0x13e));if(_0x23fd7b&&_0x23fd7b[_0x43e235(0x149)])_0x184a6b=JSON[_0x43e235(0x16b)](_0x23fd7b['val']);}catch(_0x418063){}let _0x2e38e8={'default':0x15};try{const _0x40588d=await _0x51bd47['getStateAsync'](_0x43e235(0x13a));if(_0x40588d&&_0x40588d[_0x43e235(0x149)])_0x2e38e8=JSON[_0x43e235(0x16b)](_0x40588d[_0x43e235(0x149)]);}catch(_0x3f823){}try{const _0x1d5828=await _0x51bd47[_0x43e235(0x19f)](_0x51bd47['config'][_0x43e235(0x133)]+'.data.table');if(!_0x1d5828||!_0x1d5828[_0x43e235(0x149)])return;const _0x469a5b=JSON['parse'](_0x1d5828['val']),_0xc06028=Date[_0x43e235(0x123)](),_0x4c1d71=_0x51bd47[_0x43e235(0x1a2)]['devices']||[],_0x338ce5=_0x51bd47[_0x43e235(0x1a2)][_0x43e235(0x141)]||[];for(const _0x52cdbf of _0x469a5b){if(_0x52cdbf[_0x43e235(0x113)]&&_0x338ce5[_0x43e235(0x16c)]>0x0&&!_0x338ce5['includes'](_0x52cdbf['_calName']))continue;const _0x299303=_0x52cdbf['_date']||_0x52cdbf[_0x43e235(0x16e)]||_0x52cdbf[_0x43e235(0x12b)];if(!_0x299303)continue;const _0x30ec86=new Date(_0x299303);if(isNaN(_0x30ec86[_0x43e235(0x121)]()))continue;const _0x2c495c=(_0x52cdbf['event']||_0x52cdbf[_0x43e235(0x15c)]||'')[_0x43e235(0x164)]();if(_0x2c495c[_0x43e235(0x16d)](_0x43e235(0x181))||_0x2c495c[_0x43e235(0x16d)]('rÃ¼ckkehr')||_0x2c495c[_0x43e235(0x16d)](_0x43e235(0x163))){let _0x47a557=0x0;Object[_0x43e235(0x17c)](_0x120e77)[_0x43e235(0x11c)](_0x2d3b32=>{if(_0x2d3b32>_0x47a557)_0x47a557=_0x2d3b32;});if(_0x47a557===0x0)_0x47a557=0x78;const _0x369b05=_0x30ec86[_0x43e235(0x121)]()-_0x47a557*0xea60;_0xc06028>=_0x369b05&&_0xc06028<_0x30ec86[_0x43e235(0x121)]()&&(_0x51bd47[_0x43e235(0x159)]!==_0x43e235(0x194)&&(_0x51bd47[_0x43e235(0x165)][_0x43e235(0x1a7)](_0x43e235(0x16f)+_0x47a557+_0x43e235(0x14b)),await _0x51bd47[_0x43e235(0x184)](_0x43e235(0x1b3),{'val':'normal','ack':![]})));}for(const _0x378ed7 of _0x4c1d71){if(_0x378ed7['location']){const _0x58ff11=_0x378ed7[_0x43e235(0x1ab)][_0x43e235(0x164)]();if(_0x2c495c[_0x43e235(0x16d)](_0x58ff11)){const _0x1ad4df=_0x120e77[_0x378ed7['location']]||0x3c,_0x159d06=_0x184a6b[_0x378ed7[_0x43e235(0x1ab)]]||'Classic',_0x2fc8b0=_0x30ec86[_0x43e235(0x121)]()-_0x1ad4df*0xea60;if(_0xc06028>=_0x2fc8b0&&_0xc06028<_0x30ec86[_0x43e235(0x121)]()){const _0x753aad=lastActions[_0x43e235(0x152)+_0x378ed7[_0x43e235(0x1ab)]];if(_0x753aad&&_0xc06028-_0x753aad<CAL_COOLDOWN_MS)continue;const _0x2cf08e=await findRelatedId(_0x51bd47,_0x378ed7['id'],_0x43e235(0x111));if(_0x2cf08e){let _0x1160f0=_0x2e38e8[_0x378ed7[_0x43e235(0x1ab)]];if(_0x1160f0===undefined)_0x1160f0=_0x2e38e8['default'];if(_0x1160f0===undefined)_0x1160f0=0x15;const _0x147f8c=await _0x51bd47['getForeignStateAsync'](_0x2cf08e);_0x147f8c&&typeof _0x147f8c[_0x43e235(0x149)]===_0x43e235(0x15f)&&_0x147f8c[_0x43e235(0x149)]<_0x1160f0-0.5&&(_0x51bd47[_0x43e235(0x165)][_0x43e235(0x1a7)]('ðŸ“…\x20SMART\x20SCHEDULE\x20['+_0x159d06+_0x43e235(0x157)+_0x378ed7[_0x43e235(0x1ab)]+'\x27\x20aktiv.\x20Heize\x20auf\x20'+_0x1160f0+_0x43e235(0x136)+_0x1ad4df+_0x43e235(0x14b)),await _0x51bd47[_0x43e235(0x17f)](_0x2cf08e,_0x1160f0),await logAutomationAction(_0x51bd47,'[CAL]\x20'+_0x378ed7[_0x43e235(0x1ab)]+_0x43e235(0x193)+_0x1160f0+_0x43e235(0x120)+_0x159d06+')'),lastActions[_0x43e235(0x152)+_0x378ed7[_0x43e235(0x1ab)]]=_0xc06028);}}}}}}}catch(_0x596a90){_0x51bd47[_0x43e235(0x165)][_0x43e235(0x125)](_0x43e235(0x1a9)+_0x596a90[_0x43e235(0x18a)]);}}async function manageMpcIntervention(_0x54ec38,_0x43817e,_0x5b2223){const _0x13ce77=a1_0x4b8b97;try{const _0x167de1=_0x13ce77(0x168),_0x72c409=await _0x54ec38[_0x13ce77(0x18e)](_0x167de1);let _0x55b25a=[];if(_0x72c409&&_0x72c409[_0x13ce77(0x149)])try{_0x55b25a=JSON['parse'](_0x72c409['val']);}catch(_0x13f982){}const _0x48f710=_0x55b25a[_0x13ce77(0x128)](_0x43817e);if(_0x5b2223===_0x13ce77(0x171))_0x48f710===-0x1&&(_0x55b25a[_0x13ce77(0x14a)](_0x43817e),await _0x54ec38[_0x13ce77(0x184)](_0x167de1,{'val':JSON['stringify'](_0x55b25a),'ack':!![]}));else _0x5b2223===_0x13ce77(0x188)&&(_0x48f710!==-0x1&&(_0x55b25a[_0x13ce77(0x16a)](_0x48f710,0x1),await _0x54ec38['setStateAsync'](_0x167de1,{'val':JSON[_0x13ce77(0x166)](_0x55b25a),'ack':!![]})));}catch(_0xc65d88){}}async function cleanupGhostInterventions(_0x4749a1){const _0x53e800=a1_0x4b8b97;try{const _0x5aca15=_0x53e800(0x168),_0x3a0ef9=await _0x4749a1['getStateAsync'](_0x5aca15);if(!_0x3a0ef9||!_0x3a0ef9[_0x53e800(0x149)])return;const _0x39ee7f=JSON[_0x53e800(0x16b)](_0x3a0ef9['val']);if(!Array[_0x53e800(0x180)](_0x39ee7f)||_0x39ee7f[_0x53e800(0x16c)]===0x0)return;const _0x17ee4b=_0x4749a1[_0x53e800(0x1a2)][_0x53e800(0x10d)]||[];let _0x4486be=![];for(let _0x588b54=_0x39ee7f['length']-0x1;_0x588b54>=0x0;_0x588b54--){const _0x320818=_0x39ee7f[_0x588b54],_0xf0af86=_0x17ee4b[_0x53e800(0x132)](_0x37e17c=>normalize(_0x37e17c[_0x53e800(0x1ab)])===normalize(_0x320818)&&(_0x37e17c[_0x53e800(0x18f)]===_0x53e800(0x17d)||_0x37e17c[_0x53e800(0x18f)]==='thermostat'));if(_0xf0af86){const _0x2d7428=await findRelatedId(_0x4749a1,_0xf0af86['id'],_0x53e800(0x111));if(_0x2d7428){const _0x2ea9a7=await _0x4749a1[_0x53e800(0x19f)](_0x2d7428);_0x2ea9a7&&typeof _0x2ea9a7[_0x53e800(0x149)]===_0x53e800(0x15f)&&(Math[_0x53e800(0x13d)](_0x2ea9a7[_0x53e800(0x149)]-ECO_TEMP)>0.5&&(_0x4749a1[_0x53e800(0x165)][_0x53e800(0x1a7)](_0x53e800(0x114)+_0x320818+'\x20ist\x20auf\x20'+_0x2ea9a7[_0x53e800(0x149)]+_0x53e800(0x155)+ECO_TEMP+'Â°C).\x20Entferne\x20Status.'),_0x4749a1[_0x53e800(0x1af)]&&(_0x4749a1[_0x53e800(0x165)][_0x53e800(0x1a7)](_0x53e800(0x151)+_0x320818+_0x53e800(0x160)+ECO_TEMP+_0x53e800(0x145)),_0x4749a1[_0x53e800(0x1af)](_0x53e800(0x1ac),{'room':_0x320818})),_0x39ee7f[_0x53e800(0x16a)](_0x588b54,0x1),_0x4486be=!![]));}}}_0x4486be&&await _0x4749a1['setStateAsync'](_0x5aca15,{'val':JSON['stringify'](_0x39ee7f),'ack':!![]});}catch(_0x2437e1){}}async function applyEnergySavings(_0x3a4615,_0x3ab928){const _0xae4e1c=a1_0x4b8b97;await debugMpcCleanup(_0x3a4615),await cleanupGhostInterventions(_0x3a4615);if(!_0x3ab928||_0x3ab928[_0xae4e1c(0x16c)]===0x0)return;const _0x2fd9e7=_0x3a4615[_0xae4e1c(0x1a2)][_0xae4e1c(0x10d)]||[],_0x4d3218=Date[_0xae4e1c(0x123)]();for(const _0x2ba6f2 of _0x3ab928){const _0xc15419=_0x2ba6f2[_0xae4e1c(0x12d)],_0x28ec1a=_0x2ba6f2['minutes_safe'],_0x42a6c2=_0x2ba6f2[_0xae4e1c(0x11f)]||0x15,_0x3aeb1b=_0x2fd9e7[_0xae4e1c(0x132)](_0x28140e=>normalize(_0x28140e[_0xae4e1c(0x1ab)])===normalize(_0xc15419)&&(_0x28140e[_0xae4e1c(0x18f)]===_0xae4e1c(0x17d)||_0x28140e[_0xae4e1c(0x18f)]==='thermostat'));if(!_0x3aeb1b)continue;const _0xeac804=await findRelatedId(_0x3a4615,_0x3aeb1b['id'],'setpoint');if(_0xeac804){if(lastActions['mpc_'+_0xc15419]&&_0x4d3218-lastActions[_0xae4e1c(0x15a)+_0xc15419]<0x1e*0x3c*0x3e8)continue;const _0xea0c84=await _0x3a4615['getForeignStateAsync'](_0xeac804);if(_0xea0c84&&typeof _0xea0c84['val']===_0xae4e1c(0x15f)){const _0x1fd8be=_0xea0c84[_0xae4e1c(0x149)];_0x1fd8be!==ECO_TEMP&&await manageMpcIntervention(_0x3a4615,_0xc15419,'remove');if(_0x28ec1a>0x1e)_0x1fd8be>ECO_TEMP+0.5&&(_0x3a4615[_0xae4e1c(0x165)][_0xae4e1c(0x1a7)](_0xae4e1c(0x126)+_0xc15419+_0xae4e1c(0x112)+ECO_TEMP+_0xae4e1c(0x12f)+_0x28ec1a+_0xae4e1c(0x17b)),await _0x3a4615[_0xae4e1c(0x17f)](_0xeac804,ECO_TEMP),await manageMpcIntervention(_0x3a4615,_0xc15419,_0xae4e1c(0x171)),lastActions[_0xae4e1c(0x15a)+_0xc15419]=_0x4d3218,await logAutomationAction(_0x3a4615,'[MPC]\x20'+_0xc15419+_0xae4e1c(0x124)+ECO_TEMP+'Â°C'));else _0x28ec1a<=0xf&&(_0x1fd8be<_0x42a6c2&&(_0x3a4615[_0xae4e1c(0x165)]['info'](_0xae4e1c(0x10e)+_0xc15419+_0xae4e1c(0x135)+_0x42a6c2+'Â°C!\x20(Puffer\x20leer).'),await _0x3a4615['setForeignStateAsync'](_0xeac804,_0x42a6c2),await manageMpcIntervention(_0x3a4615,_0xc15419,'remove'),lastActions[_0xae4e1c(0x15a)+_0xc15419]=_0x4d3218,await logAutomationAction(_0x3a4615,_0xae4e1c(0x14c)+_0xc15419+_0xae4e1c(0x147)+_0x42a6c2+'Â°C')));}}else _0x3a4615['log']['warn'](_0xae4e1c(0x169)+_0xc15419+_0xae4e1c(0x130));}}function a1_0xee75(_0x1184d7,_0xf602d6){const _0x2fa7b3=a1_0x1bde();return a1_0xee75=function(_0x4858f9,_0x1434a7){_0x4858f9=_0x4858f9-0x10d;let _0x1bdee1=_0x2fa7b3[_0x4858f9];return _0x1bdee1;},a1_0xee75(_0x1184d7,_0xf602d6);}async function debugMpcCleanup(_0xd83702){const _0x39873a=a1_0x4b8b97,_0x12f10b='analysis.energy.mpcActiveInterventions',_0xb6111b=await _0xd83702[_0x39873a(0x18e)](_0x12f10b);if(!_0xb6111b||!_0xb6111b[_0x39873a(0x149)]){_0xd83702[_0x39873a(0x165)][_0x39873a(0x125)](_0x39873a(0x197));return;}const _0x3138d0=JSON[_0x39873a(0x16b)](_0xb6111b['val']);_0xd83702[_0x39873a(0x165)][_0x39873a(0x125)](_0x39873a(0x12a)+JSON[_0x39873a(0x166)](_0x3138d0));const _0x344924=_0xd83702[_0x39873a(0x1a2)]['devices']||[];for(const _0x502113 of _0x3138d0){const _0x280c61=_0x344924[_0x39873a(0x132)](_0x431d9c=>{const _0xabfb2c=_0x39873a,_0x3de43b=normalize(_0x431d9c[_0xabfb2c(0x1ab)])===normalize(_0x502113)&&(_0x431d9c[_0xabfb2c(0x18f)]===_0xabfb2c(0x17d)||_0x431d9c['type']==='thermostat');if(normalize(_0x431d9c['location'])===normalize(_0x502113))_0xd83702[_0xabfb2c(0x165)][_0xabfb2c(0x139)](_0xabfb2c(0x186)+_0x502113+_0xabfb2c(0x18c)+_0x431d9c['type']);return _0x3de43b;});if(!_0x280c61){_0xd83702[_0x39873a(0x165)][_0x39873a(0x125)](_0x39873a(0x1a4)+_0x502113+_0x39873a(0x1a1));continue;}const _0x401dcc=await findRelatedId(_0xd83702,_0x280c61['id'],_0x39873a(0x111));if(!_0x401dcc){_0xd83702[_0x39873a(0x165)][_0x39873a(0x125)]('DEBUG:\x20Setpoint-ID\x20fÃ¼r\x20\x27'+_0x502113+_0x39873a(0x172)+_0x280c61['id']+')\x20nicht\x20gefunden.');continue;}const _0x34024b=await _0xd83702['getForeignStateAsync'](_0x401dcc);_0xd83702['log'][_0x39873a(0x125)](_0x39873a(0x14f)+_0x502113+_0x39873a(0x134)+_0x401dcc+_0x39873a(0x1a6)+(_0x34024b?_0x34024b[_0x39873a(0x149)]:'null'));}}module[a1_0x4b8b97(0x189)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'updateSchedulePreview':updateSchedulePreview};