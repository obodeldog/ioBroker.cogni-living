const a1_0x26c5b8=a1_0x105c;(function(_0x36e672,_0x50eee7){const _0x176041=a1_0x105c,_0xd1ec51=_0x36e672();while(!![]){try{const _0x40000d=-parseInt(_0x176041(0xe6))/0x1*(parseInt(_0x176041(0xa4))/0x2)+parseInt(_0x176041(0xb0))/0x3+parseInt(_0x176041(0x120))/0x4+parseInt(_0x176041(0xb4))/0x5*(parseInt(_0x176041(0xb8))/0x6)+-parseInt(_0x176041(0xf8))/0x7*(parseInt(_0x176041(0xf6))/0x8)+-parseInt(_0x176041(0xda))/0x9*(parseInt(_0x176041(0xd6))/0xa)+parseInt(_0x176041(0xa1))/0xb;if(_0x40000d===_0x50eee7)break;else _0xd1ec51['push'](_0xd1ec51['shift']());}catch(_0x37defb){_0xd1ec51['push'](_0xd1ec51['shift']());}}}(a1_0x5618,0xdf332));function a1_0x5618(){const _0x165485=['state','setpoint','Soll','messwert','pi_heating_demand','type','push','getStateAsync','sensor','ðŸƒ\x20MPC\x20Autonomy:\x20Senke\x20','thermostatMapping','PERFECT','write',')\x20auf\x20','event','system.mode','1340dzgAxH','active','setForeignStateAsync','location','59733xhWWwx','now','level.temperature','urlaub\x20ende','temperature','rÃ¼ckkehr','find','exports','valve_position','ðŸ“…\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27','\x20min)','wert','289361usJXHx',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','\x20min).','local_temperature','setStateAsync','log','off','common','ðŸ”\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27','SET_POINT_TEMPERATURE','thermostat.setpoint','.1.LEVEL','string','Nicht\x20gefunden','ACTUAL_TEMPERATURE','\x20->\x2021Â°C','8uGwHkO','number','8934289tREavP','value.valve','analysis.automation.lastAction','getTime','entries','position','.data.table','PrÃ¤diktion:\x20','slice','score','name','config','filter','level.valve','message','room','useCalendar','analysis.automation.confidenceThreshold','toLowerCase','Auto-Erkennung','eventStart','localeCompare','parse','getForeignObjectsAsync','val','soll','warn','getForeignStateAsync','unit','approved','(((.+)+)+)+$','split',':\x20-1Â°C\x20(Sparpotenzial\x20genutzt)','.1.TEMPERATURE','set','values','hm-rpc','toString','occupied_heating_setpoint','switch','6670956cMXKSG','current_heating_setpoint','search','includes','Calendar\x20Check\x20Error:\x20','Â°C\x20(Coasting\x20mÃ¶glich:\x20','Fehlt','openknx','trim','13750605wSOith','role','.1.ACTUAL_TEMPERATURE','10EvYVXj','devices','ðŸ“…\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','toUpperCase','valveMapping','calendarSelection','valve','.1.SET_POINT_TEMPERATURE','SET','.4.VALVE_STATE','Unknown','\x27\x20erkannt\x20(','4723668xNKgPm','mpc_','summary','level','171830VPyaPK','thermostat','actual','target','6sjOTeg','sort','ankunft','replace','analysis.automation.mode','reason','calendarInstance','apply','temp','minutes_safe','forEach','length','_calName','\x20->\x20Schalte\x20'];a1_0x5618=function(){return _0x165485;};return a1_0x5618();}const a1_0x26fcfa=(function(){let _0x23075c=!![];return function(_0x512422,_0x39bf28){const _0x47eafb=_0x23075c?function(){const _0x195435=a1_0x105c;if(_0x39bf28){const _0x1d507f=_0x39bf28[_0x195435(0xbf)](_0x512422,arguments);return _0x39bf28=null,_0x1d507f;}}:function(){};return _0x23075c=![],_0x47eafb;};}()),a1_0x31d118=a1_0x26fcfa(this,function(){const _0x10074f=a1_0x105c;return a1_0x31d118[_0x10074f(0x11d)]()[_0x10074f(0x9a)]('(((.+)+)+)+$')['toString']()['constructor'](a1_0x31d118)['search'](_0x10074f(0x116));});a1_0x31d118();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x178d34){const _0xd78ff7=a1_0x105c;if(!_0x178d34)return'';return _0x178d34[_0xd78ff7(0x10a)]()[_0xd78ff7(0xbb)](/\s+/g,'')[_0xd78ff7(0xa0)]();}async function handlePrediction(_0x2ac9f2,_0x502aba,_0x8c9711){const _0x3164a7=a1_0x105c;if(!_0x502aba||_0x502aba===_0x3164a7(0xae))return;let _0x166dc1=_0x3164a7(0xec),_0x489a7c=0.6;try{const _0x2e2e20=await _0x2ac9f2[_0x3164a7(0xcd)](_0x3164a7(0xbc));if(_0x2e2e20&&_0x2e2e20['val'])_0x166dc1=_0x2e2e20[_0x3164a7(0x110)];const _0x2e523c=await _0x2ac9f2[_0x3164a7(0xcd)](_0x3164a7(0x109));if(_0x2e523c&&_0x2e523c['val'])_0x489a7c=_0x2e523c[_0x3164a7(0x110)];}catch(_0x191efa){}if(_0x166dc1===_0x3164a7(0xec)||_0x8c9711<_0x489a7c)return;const _0x2dc30f=Date[_0x3164a7(0xdb)]();if(lastActions[_0x502aba]&&_0x2dc30f-lastActions[_0x502aba]<COOLDOWN_MS)return;const _0xf46d1c=_0x2ac9f2[_0x3164a7(0x103)][_0x3164a7(0xa5)]||[],_0x1f0d1b=normalize(_0x502aba),_0x3551ce=_0xf46d1c[_0x3164a7(0xe0)](_0x596717=>normalize(_0x596717[_0x3164a7(0xd9)])===_0x1f0d1b&&(_0x596717[_0x3164a7(0xcb)]==='light'||_0x596717[_0x3164a7(0xcb)]==='dimmer'||_0x596717[_0x3164a7(0xcb)]===_0x3164a7(0x11f)));if(!_0x3551ce){_0x2ac9f2['log']['debug'](_0x3164a7(0xee)+_0x502aba+'\x27.');return;}const _0x5514da=await aiAgent['consultButler'](_0x2ac9f2,_0x502aba,_0x3551ce[_0x3164a7(0x102)],_0x8c9711);if(!_0x5514da[_0x3164a7(0x115)])return;const _0x223e3f=_0x3164a7(0xff)+_0x502aba+_0x3164a7(0xc5)+_0x3551ce['name']+'\x20('+_0x5514da[_0x3164a7(0xbd)]+')';await _0x2ac9f2[_0x3164a7(0xea)](_0x3164a7(0xfa),{'val':'['+_0x166dc1[_0x3164a7(0xa7)]()+']\x20'+_0x223e3f,'ack':!![]});if(_0x166dc1===_0x3164a7(0xd7)){const _0x34e1ff=await _0x2ac9f2[_0x3164a7(0x113)](_0x3551ce['id']);(!_0x34e1ff||!_0x34e1ff[_0x3164a7(0x110)]&&_0x34e1ff[_0x3164a7(0x110)]!==!![])&&await _0x2ac9f2[_0x3164a7(0xd8)](_0x3551ce['id'],!![]),lastActions[_0x502aba]=_0x2dc30f;}}async function findRelatedId(_0x46e358,_0x4166e1,_0x10526d='setpoint'){const _0x558635=a1_0x105c;if(_0x10526d===_0x558635(0xc7)&&_0x46e358[_0x558635(0x103)][_0x558635(0xd0)]){let _0x556ddb=_0x46e358[_0x558635(0x103)][_0x558635(0xd0)];if(typeof _0x556ddb===_0x558635(0xf2))try{_0x556ddb=JSON[_0x558635(0x10e)](_0x556ddb);}catch(_0x1949bf){}if(_0x556ddb&&_0x556ddb[_0x4166e1])return _0x556ddb[_0x4166e1];}if(_0x10526d===_0x558635(0xaa)&&_0x46e358[_0x558635(0x103)][_0x558635(0xa8)]){let _0xcb6338=_0x46e358['config'][_0x558635(0xa8)];if(typeof _0xcb6338===_0x558635(0xf2))try{_0xcb6338=JSON[_0x558635(0x10e)](_0xcb6338);}catch(_0x355b1f){}if(_0xcb6338&&_0xcb6338[_0x4166e1])return _0xcb6338[_0x4166e1];}let _0x4bdce0=[];if(_0x10526d===_0x558635(0xc7))_0x4bdce0=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x558635(0xab)},{'s':_0x558635(0x119),'t':_0x558635(0xab)},{'s':'.1.TEMPERATURE','t':'.4.SET_TEMPERATURE'},{'s':_0x558635(0xf4),'t':_0x558635(0xef)},{'s':_0x558635(0xe9),'t':_0x558635(0x11e)},{'s':_0x558635(0xe9),'t':_0x558635(0x99)},{'s':_0x558635(0xde),'t':'target_temperature'},{'s':'ACTUAL','t':_0x558635(0xac)},{'s':'Ist','t':_0x558635(0xc8)},{'s':_0x558635(0xde),'t':_0x558635(0xc7)}];else _0x10526d===_0x558635(0xaa)&&(_0x4bdce0=[{'s':_0x558635(0xa3),'t':'.1.LEVEL'},{'s':_0x558635(0x119),'t':_0x558635(0xf1)},{'s':_0x558635(0x119),'t':_0x558635(0xad)},{'s':_0x558635(0xe9),'t':_0x558635(0xca)},{'s':_0x558635(0xde),'t':_0x558635(0xe2)},{'s':_0x558635(0xde),'t':_0x558635(0xb3)}]);for(const _0x403b54 of _0x4bdce0){if(_0x4166e1[_0x558635(0x9b)](_0x403b54['s'])){const _0x58769b=_0x4166e1[_0x558635(0xbb)](_0x403b54['s'],_0x403b54['t']),_0x4952b1=await _0x46e358['getForeignObjectAsync'](_0x58769b);if(_0x4952b1)return _0x58769b;}}try{const _0x262662=_0x4166e1['split']('.');if(_0x262662['length']>0x2){const _0x42e54c=_0x262662[_0x558635(0x100)](0x0,-0x1)['join']('.'),_0x272e6d=await _0x46e358[_0x558635(0x10f)](_0x42e54c+'.*'),_0x43ceae=[],_0x1d2140=_0x4166e1['split'](/[._]+/)[_0x558635(0x104)](_0x59a663=>![_0x558635(0x9f),'0',_0x558635(0x11c),'ist',_0x558635(0xe5),'temperature',_0x558635(0xb6),_0x558635(0xce),_0x558635(0xc9),_0x558635(0xc6)]['includes'](_0x59a663[_0x558635(0x10a)]()));for(const [_0x4d79fa,_0x47371e]of Object[_0x558635(0xfc)](_0x272e6d)){if(_0x4d79fa===_0x4166e1)continue;if(_0x47371e&&_0x47371e['common']){const _0xce4470=_0x4d79fa['toLowerCase'](),_0x45258f=(_0x47371e[_0x558635(0xed)][_0x558635(0xa2)]||'')[_0x558635(0x10a)](),_0x5a8ced=(_0x47371e[_0x558635(0xed)][_0x558635(0x114)]||'')[_0x558635(0x10a)]();let _0x39ce08=![];if(_0x10526d===_0x558635(0xc7)&&_0x47371e[_0x558635(0xed)][_0x558635(0xd2)]===!![])_0x39ce08=_0xce4470[_0x558635(0x9b)](_0x558635(0x11a))||_0xce4470['includes'](_0x558635(0x111))||_0xce4470[_0x558635(0x9b)](_0x558635(0xb7))||_0x45258f[_0x558635(0x9b)](_0x558635(0xdc))||_0x45258f[_0x558635(0x9b)](_0x558635(0xf0));else _0x10526d===_0x558635(0xaa)&&(_0x39ce08=_0xce4470[_0x558635(0x9b)]('level')||_0xce4470['includes']('valve')||_0xce4470['includes']('stellwert')||_0xce4470[_0x558635(0x9b)](_0x558635(0xfd))||_0x45258f['includes'](_0x558635(0x105))||_0x45258f[_0x558635(0x9b)](_0x558635(0xf9))||_0x5a8ced[_0x558635(0x9b)]('%'));if(_0x39ce08){const _0x411867=_0x4d79fa[_0x558635(0x117)](/[._]+/)['map'](_0x302d1a=>_0x302d1a[_0x558635(0x10a)]());let _0x142bf=0x0;_0x1d2140[_0x558635(0xc2)](_0x1a0757=>{const _0x278d03=_0x558635;if(_0x411867['includes'](_0x1a0757[_0x278d03(0x10a)]()))_0x142bf++;}),_0x43ceae['push']({'id':_0x4d79fa,'score':_0x142bf});}}}if(_0x43ceae[_0x558635(0xc3)]>0x0){_0x43ceae[_0x558635(0xb9)]((_0xeceae6,_0x1df242)=>_0x1df242[_0x558635(0x101)]-_0xeceae6['score']);if(_0x43ceae[0x0]['score']>0x0)return _0x43ceae[0x0]['id'];}}}catch(_0x365077){}return null;}function a1_0x105c(_0xc122ae,_0x20b0ec){const _0x102d66=a1_0x5618();return a1_0x105c=function(_0x31d118,_0x26fcfa){_0x31d118=_0x31d118-0x99;let _0x5618dc=_0x102d66[_0x31d118];return _0x5618dc;},a1_0x105c(_0xc122ae,_0x20b0ec);}async function scanThermostats(_0x51b2fd){const _0x3023fd=a1_0x105c,_0x1a37a5=_0x51b2fd['config'][_0x3023fd(0xa5)]||[],_0x41e6be=[],_0x4ac9b5=_0x1a37a5['filter'](_0xc4d64c=>_0xc4d64c['id']&&_0xc4d64c['id']['includes'](_0x3023fd(0xde))||_0xc4d64c[_0x3023fd(0xcb)]&&[_0x3023fd(0xde),_0x3023fd(0xb5),'sensor'][_0x3023fd(0x9b)](_0xc4d64c['type'])||_0xc4d64c[_0x3023fd(0x102)]&&_0xc4d64c['name'][_0x3023fd(0x10a)]()[_0x3023fd(0x9b)](_0x3023fd(0xc0)));for(const _0x51502c of _0x4ac9b5){const _0x59569d=await findRelatedId(_0x51b2fd,_0x51502c['id'],_0x3023fd(0xc7)),_0x262ca9=await findRelatedId(_0x51b2fd,_0x51502c['id'],_0x3023fd(0xaa));let _0xd43945=_0x3023fd(0xf3),_0x4e5ea7=![],_0x5525a5=_0x51b2fd[_0x3023fd(0x103)][_0x3023fd(0xd0)]||{};if(typeof _0x5525a5===_0x3023fd(0xf2))try{_0x5525a5=JSON[_0x3023fd(0x10e)](_0x5525a5);}catch(_0x31f223){}let _0x48db15=_0x51b2fd[_0x3023fd(0x103)][_0x3023fd(0xa8)]||{};if(typeof _0x48db15==='string')try{_0x48db15=JSON[_0x3023fd(0x10e)](_0x48db15);}catch(_0x371a50){}if(_0x5525a5[_0x51502c['id']]&&_0x5525a5[_0x51502c['id']]===_0x59569d||_0x48db15[_0x51502c['id']]&&_0x48db15[_0x51502c['id']]===_0x262ca9)_0xd43945='Manuelles\x20Mapping',_0x4e5ea7=!![];else(_0x59569d||_0x262ca9)&&(_0xd43945=_0x3023fd(0x10b));_0x41e6be[_0x3023fd(0xcc)]({'room':_0x51502c[_0x3023fd(0xd9)]||'Unbekannt','sensorId':_0x51502c['id'],'setpointId':_0x59569d||'-','valveId':_0x262ca9||'-','source':_0xd43945,'isManual':_0x4e5ea7,'status':_0x59569d&&_0x262ca9?_0x3023fd(0xd1):_0x59569d?'OK':_0x3023fd(0x9e)});}return _0x41e6be[_0x3023fd(0xb9)]((_0x1627b1,_0x2fc344)=>_0x1627b1[_0x3023fd(0x107)][_0x3023fd(0x10d)](_0x2fc344[_0x3023fd(0x107)]));}async function checkCalendarTriggers(_0x93f4b6){const _0x3d2091=a1_0x105c;if(!_0x93f4b6[_0x3d2091(0x103)][_0x3d2091(0x108)]||!_0x93f4b6['config'][_0x3d2091(0xbe)])return;let _0x460d00={};try{const _0x1b4ccb=await _0x93f4b6[_0x3d2091(0xcd)]('analysis.energy.warmupTimes');if(_0x1b4ccb&&_0x1b4ccb[_0x3d2091(0x110)])_0x460d00=JSON[_0x3d2091(0x10e)](_0x1b4ccb[_0x3d2091(0x110)]);}catch(_0x154b60){}try{const _0x59bc65=await _0x93f4b6[_0x3d2091(0x113)](_0x93f4b6[_0x3d2091(0x103)]['calendarInstance']+_0x3d2091(0xfe));if(!_0x59bc65||!_0x59bc65[_0x3d2091(0x110)])return;const _0x54dcc9=JSON[_0x3d2091(0x10e)](_0x59bc65[_0x3d2091(0x110)]),_0x562f9a=new Date(),_0x2a5455=_0x93f4b6[_0x3d2091(0x103)][_0x3d2091(0xa5)]||[],_0x44f055=_0x93f4b6['config'][_0x3d2091(0xa9)]||[];for(const _0x3d30f6 of _0x54dcc9){if(_0x3d30f6[_0x3d2091(0xc4)]&&_0x44f055[_0x3d2091(0xc3)]>0x0&&!_0x44f055[_0x3d2091(0x9b)](_0x3d30f6[_0x3d2091(0xc4)]))continue;const _0x21792e=new Date(_0x3d30f6[_0x3d2091(0x10c)]),_0x1c9fdc=(_0x3d30f6[_0x3d2091(0xd4)]||_0x3d30f6[_0x3d2091(0xb2)]||'')['toLowerCase']();if(_0x1c9fdc[_0x3d2091(0x9b)](_0x3d2091(0xdd))||_0x1c9fdc[_0x3d2091(0x9b)](_0x3d2091(0xdf))||_0x1c9fdc[_0x3d2091(0x9b)](_0x3d2091(0xba))){let _0xf67cb4=0x0;Object[_0x3d2091(0x11b)](_0x460d00)[_0x3d2091(0xc2)](_0x49195e=>{if(_0x49195e>_0xf67cb4)_0xf67cb4=_0x49195e;});if(_0xf67cb4===0x0)_0xf67cb4=0x78;const _0x26851d=new Date(_0x21792e[_0x3d2091(0xfb)]()-_0xf67cb4*0xea60),_0x3d3762=_0x562f9a[_0x3d2091(0xfb)]()-_0x26851d[_0x3d2091(0xfb)]();_0x3d3762>=0x0&&_0x3d3762<0xf*0xea60&&(_0x93f4b6[_0x3d2091(0xeb)]['info'](_0x3d2091(0xa6)+_0x3d30f6[_0x3d2091(0xd4)]+_0x3d2091(0xe7)+_0xf67cb4+'\x20min).'),await _0x93f4b6['setStateAsync'](_0x3d2091(0xd5),{'val':'normal','ack':![]}));}for(const _0x1c4fc4 of _0x2a5455){if(_0x1c4fc4[_0x3d2091(0xd9)]){const _0xf84fd9=_0x1c4fc4[_0x3d2091(0xd9)]['toLowerCase']();if(_0x1c9fdc[_0x3d2091(0x9b)](_0xf84fd9)){const _0x58e53b=_0x460d00[_0x1c4fc4[_0x3d2091(0xd9)]]||0x3c,_0x2c4b8a=new Date(_0x21792e['getTime']()-_0x58e53b*0xea60),_0xd6c1f1=_0x562f9a[_0x3d2091(0xfb)]()-_0x2c4b8a[_0x3d2091(0xfb)]();if(_0xd6c1f1>=0x0&&_0xd6c1f1<0xf*0xea60){const _0x116fbb=await findRelatedId(_0x93f4b6,_0x1c4fc4['id'],_0x3d2091(0xc7));_0x116fbb&&(_0x93f4b6[_0x3d2091(0xeb)]['info'](_0x3d2091(0xe3)+_0x1c4fc4[_0x3d2091(0xd9)]+_0x3d2091(0xaf)+_0x3d30f6[_0x3d2091(0xd4)]+').\x20Heize\x20auf\x2021Â°C\x20(Vorlauf:\x20'+_0x58e53b+_0x3d2091(0xe8)),await _0x93f4b6[_0x3d2091(0xd8)](_0x116fbb,0x15),await _0x93f4b6[_0x3d2091(0xea)]('analysis.automation.lastAction',{'val':'[CAL]\x20'+_0x1c4fc4[_0x3d2091(0xd9)]+_0x3d2091(0xf5),'ack':!![]}));}}}}}}catch(_0x352c4c){_0x93f4b6[_0x3d2091(0xeb)][_0x3d2091(0x112)](_0x3d2091(0x9c)+_0x352c4c[_0x3d2091(0x106)]);}}async function applyEnergySavings(_0x4dc065,_0x20f1d8){const _0x5ec876=a1_0x105c,_0x522552=_0x4dc065[_0x5ec876(0x103)][_0x5ec876(0xa5)]||[];for(const _0x1258ce of _0x20f1d8){const _0xda60e0=_0x1258ce[_0x5ec876(0x107)],_0x210324=_0x1258ce[_0x5ec876(0xc1)],_0x490109=Date[_0x5ec876(0xdb)]();if(lastActions[_0x5ec876(0xb1)+_0xda60e0]&&_0x490109-lastActions['mpc_'+_0xda60e0]<0x1e*0x3c*0x3e8)continue;const _0x45389f=_0x522552['find'](_0x2fddf5=>normalize(_0x2fddf5[_0x5ec876(0xd9)])===normalize(_0xda60e0));if(!_0x45389f)continue;const _0x15e1cd=await findRelatedId(_0x4dc065,_0x45389f['id'],'setpoint');if(_0x15e1cd){const _0x127fd5=await _0x4dc065[_0x5ec876(0x113)](_0x15e1cd);if(_0x127fd5&&typeof _0x127fd5[_0x5ec876(0x110)]===_0x5ec876(0xf7)){const _0x29a400=_0x127fd5[_0x5ec876(0x110)];if(_0x210324>0x1e&&_0x29a400>0x11){const _0x384dcd=_0x29a400-0x1;_0x4dc065['log']['info'](_0x5ec876(0xcf)+_0xda60e0+'\x20('+_0x15e1cd+_0x5ec876(0xd3)+_0x384dcd+_0x5ec876(0x9d)+_0x210324+_0x5ec876(0xe4)),await _0x4dc065['setForeignStateAsync'](_0x15e1cd,_0x384dcd),lastActions[_0x5ec876(0xb1)+_0xda60e0]=_0x490109,await _0x4dc065['setStateAsync']('analysis.automation.lastAction',{'val':'[MPC]\x20'+_0xda60e0+_0x5ec876(0x118),'ack':!![]});}}}}}module[a1_0x26c5b8(0xe1)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};