const a1_0x2b1a52=a1_0x3819;(function(_0x262992,_0x5f34b9){const _0x279446=a1_0x3819,_0x2d773c=_0x262992();while(!![]){try{const _0x5c5984=-parseInt(_0x279446(0x12a))/0x1+parseInt(_0x279446(0x136))/0x2+-parseInt(_0x279446(0x157))/0x3+-parseInt(_0x279446(0x155))/0x4+parseInt(_0x279446(0xce))/0x5*(parseInt(_0x279446(0xbe))/0x6)+parseInt(_0x279446(0x130))/0x7+parseInt(_0x279446(0x107))/0x8;if(_0x5c5984===_0x5f34b9)break;else _0x2d773c['push'](_0x2d773c['shift']());}catch(_0x1671e4){_0x2d773c['push'](_0x2d773c['shift']());}}}(a1_0x38f1,0x9177b));const a1_0xc3fe78=(function(){let _0xd5a9cf=!![];return function(_0x17c846,_0x1fd0f5){const _0x451dd2=_0xd5a9cf?function(){const _0x563015=a1_0x3819;if(_0x1fd0f5){const _0xc1faaf=_0x1fd0f5[_0x563015(0xc3)](_0x17c846,arguments);return _0x1fd0f5=null,_0xc1faaf;}}:function(){};return _0xd5a9cf=![],_0x451dd2;};}()),a1_0x40e7c1=a1_0xc3fe78(this,function(){const _0x49d803=a1_0x3819;return a1_0x40e7c1[_0x49d803(0x13f)]()[_0x49d803(0x140)](_0x49d803(0xc8))['toString']()['constructor'](a1_0x40e7c1)[_0x49d803(0x140)](_0x49d803(0xc8));});function a1_0x3819(_0x45dbef,_0x50e403){const _0x485438=a1_0x38f1();return a1_0x3819=function(_0x40e7c1,_0xc3fe78){_0x40e7c1=_0x40e7c1-0xb6;let _0x38f198=_0x485438[_0x40e7c1];return _0x38f198;},a1_0x3819(_0x45dbef,_0x50e403);}a1_0x40e7c1();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,RESCUE_LOCK_MS=0x78*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x32603f){const _0x1bd31a=a1_0x3819;if(!_0x32603f)return'';return _0x32603f[_0x1bd31a(0xdf)]()[_0x1bd31a(0x101)](/\s+/g,'')[_0x1bd31a(0x11f)]();}async function logAutomationAction(_0x126884,_0x2a00d0){const _0x1252b1=a1_0x3819;await _0x126884['setStateAsync']('analysis.automation.lastAction',{'val':_0x2a00d0,'ack':!![]});try{const _0x3fa481=_0x1252b1(0x135),_0x3e6bd8=await _0x126884[_0x1252b1(0xbd)](_0x3fa481);let _0x228ee3=[];if(_0x3e6bd8&&_0x3e6bd8['val'])try{_0x228ee3=JSON[_0x1252b1(0xd7)](_0x3e6bd8[_0x1252b1(0x113)]);}catch(_0x17907e){}_0x228ee3['unshift']({'ts':Date[_0x1252b1(0xca)](),'msg':_0x2a00d0});if(_0x228ee3[_0x1252b1(0xfd)]>0x32)_0x228ee3=_0x228ee3[_0x1252b1(0x14c)](0x0,0x32);await _0x126884[_0x1252b1(0x103)](_0x3fa481,{'val':JSON[_0x1252b1(0x120)](_0x228ee3),'ack':!![]});}catch(_0x5146ec){}}async function handlePrediction(_0x1909c4,_0x33c742,_0x1c738c){const _0x2d4918=a1_0x3819;if(!_0x33c742||_0x33c742==='Unknown')return;let _0x258a82='off',_0x106c16=0.6;try{const _0x5c8479=await _0x1909c4[_0x2d4918(0xbd)](_0x2d4918(0x12c));if(_0x5c8479&&_0x5c8479[_0x2d4918(0x113)])_0x258a82=_0x5c8479[_0x2d4918(0x113)];const _0x59357d=await _0x1909c4[_0x2d4918(0xbd)](_0x2d4918(0xf5));if(_0x59357d&&_0x59357d[_0x2d4918(0x113)])_0x106c16=_0x59357d[_0x2d4918(0x113)];}catch(_0xb8a725){}if(_0x258a82===_0x2d4918(0x142)||_0x1c738c<_0x106c16)return;const _0x792c8f=Date[_0x2d4918(0xca)]();if(lastActions[_0x33c742]&&_0x792c8f-lastActions[_0x33c742]<COOLDOWN_MS)return;const _0x50421d=_0x1909c4[_0x2d4918(0xc0)][_0x2d4918(0x143)]||[],_0x191f93=normalize(_0x33c742),_0x4b4a58=_0x50421d['find'](_0x1efe3a=>normalize(_0x1efe3a[_0x2d4918(0x112)])===_0x191f93&&(_0x1efe3a[_0x2d4918(0xe7)]===_0x2d4918(0xb6)||_0x1efe3a['type']===_0x2d4918(0x119)||_0x1efe3a[_0x2d4918(0xe7)]===_0x2d4918(0xd8)));if(!_0x4b4a58)return;const _0x22c6b7=await aiAgent[_0x2d4918(0x131)](_0x1909c4,_0x33c742,_0x4b4a58['name'],_0x1c738c);if(!_0x22c6b7[_0x2d4918(0x14e)])return;const _0x2a583d=_0x2d4918(0x14b)+_0x33c742+'\x20->\x20Schalte\x20'+_0x4b4a58[_0x2d4918(0xf7)]+'\x20('+_0x22c6b7[_0x2d4918(0xb8)]+')';await logAutomationAction(_0x1909c4,'['+_0x258a82['toUpperCase']()+']\x20'+_0x2a583d);if(_0x258a82==='active'){const _0x4cc1b8=await _0x1909c4['getForeignStateAsync'](_0x4b4a58['id']);(!_0x4cc1b8||!_0x4cc1b8[_0x2d4918(0x113)]&&_0x4cc1b8[_0x2d4918(0x113)]!==!![])&&await _0x1909c4[_0x2d4918(0xbf)](_0x4b4a58['id'],!![]),lastActions[_0x33c742]=_0x792c8f;}}async function findRelatedId(_0x2aad24,_0x114722,_0x1c69fa=a1_0x2b1a52(0x12d)){const _0x2d3c23=a1_0x2b1a52;if(_0x1c69fa===_0x2d3c23(0x12d)&&_0x2aad24[_0x2d3c23(0xc0)][_0x2d3c23(0xed)]){let _0x1636b0=_0x2aad24[_0x2d3c23(0xc0)][_0x2d3c23(0xed)];if(typeof _0x1636b0==='string')try{_0x1636b0=JSON['parse'](_0x1636b0);}catch(_0x56e471){}if(_0x1636b0&&_0x1636b0[_0x114722])return _0x1636b0[_0x114722];}if(_0x1c69fa===_0x2d3c23(0xeb)&&_0x2aad24[_0x2d3c23(0xc0)]['valveMapping']){let _0x506073=_0x2aad24[_0x2d3c23(0xc0)][_0x2d3c23(0x15b)];if(typeof _0x506073===_0x2d3c23(0x146))try{_0x506073=JSON[_0x2d3c23(0xd7)](_0x506073);}catch(_0x38f3f2){}if(_0x506073&&_0x506073[_0x114722])return _0x506073[_0x114722];}let _0x310f0d=[];if(_0x1c69fa===_0x2d3c23(0x12d))_0x310f0d=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x2d3c23(0x125)},{'s':_0x2d3c23(0x149),'t':_0x2d3c23(0x125)},{'s':_0x2d3c23(0x149),'t':_0x2d3c23(0xf3)},{'s':_0x2d3c23(0xf1),'t':_0x2d3c23(0xe5)},{'s':_0x2d3c23(0x117),'t':_0x2d3c23(0xb7)},{'s':_0x2d3c23(0x117),'t':_0x2d3c23(0x104)},{'s':_0x2d3c23(0xd5),'t':'target_temperature'},{'s':'ACTUAL','t':_0x2d3c23(0x152)},{'s':'Ist','t':_0x2d3c23(0x11a)},{'s':'temperature','t':_0x2d3c23(0x12d)}];else _0x1c69fa===_0x2d3c23(0xeb)&&(_0x310f0d=[{'s':_0x2d3c23(0x141),'t':_0x2d3c23(0x111)},{'s':_0x2d3c23(0x149),'t':_0x2d3c23(0x111)},{'s':'.1.TEMPERATURE','t':_0x2d3c23(0xcf)},{'s':_0x2d3c23(0x117),'t':_0x2d3c23(0xf9)},{'s':_0x2d3c23(0xd5),'t':_0x2d3c23(0x10e)},{'s':'temperature','t':_0x2d3c23(0xff)}]);for(const _0x2af5cf of _0x310f0d){if(_0x114722[_0x2d3c23(0xda)](_0x2af5cf['s'])){const _0x35eda2=_0x114722['replace'](_0x2af5cf['s'],_0x2af5cf['t']),_0x39178d=await _0x2aad24['getForeignObjectAsync'](_0x35eda2);if(_0x39178d)return _0x35eda2;}}try{const _0x5da262=_0x114722[_0x2d3c23(0xef)]('.');if(_0x5da262[_0x2d3c23(0xfd)]>0x2){const _0x3ecc72=_0x5da262[_0x2d3c23(0x14c)](0x0,-0x1)[_0x2d3c23(0x122)]('.'),_0x2dabc7=await _0x2aad24[_0x2d3c23(0x144)](_0x3ecc72+'.*'),_0x435cd4=[],_0x3b266a=_0x114722[_0x2d3c23(0xef)](/[._]+/)[_0x2d3c23(0xfa)](_0x762ff0=>![_0x2d3c23(0x128),'0','hm-rpc',_0x2d3c23(0xf0),_0x2d3c23(0x14a),_0x2d3c23(0xd5),_0x2d3c23(0xd2),'sensor',_0x2d3c23(0xc4),_0x2d3c23(0x154)][_0x2d3c23(0xda)](_0x762ff0[_0x2d3c23(0xdf)]()));for(const [_0x23fe6f,_0x57102f]of Object[_0x2d3c23(0x126)](_0x2dabc7)){if(_0x23fe6f===_0x114722)continue;if(_0x57102f&&_0x57102f['common']){const _0x55ca2e=_0x23fe6f[_0x2d3c23(0xdf)](),_0x1f009b=(_0x57102f[_0x2d3c23(0xc1)][_0x2d3c23(0xe2)]||'')[_0x2d3c23(0xdf)](),_0xfe31b0=(_0x57102f['common'][_0x2d3c23(0x134)]||'')[_0x2d3c23(0xdf)]();let _0x25f2f1=![];if(_0x1c69fa===_0x2d3c23(0x12d)&&_0x57102f[_0x2d3c23(0xc1)][_0x2d3c23(0x116)]===!![])_0x25f2f1=_0x55ca2e[_0x2d3c23(0xda)]('set')||_0x55ca2e[_0x2d3c23(0xda)](_0x2d3c23(0xba))||_0x55ca2e[_0x2d3c23(0xda)](_0x2d3c23(0x15a))||_0x1f009b[_0x2d3c23(0xda)](_0x2d3c23(0xf6))||_0x1f009b[_0x2d3c23(0xda)]('thermostat.setpoint');else _0x1c69fa===_0x2d3c23(0xeb)&&(_0x25f2f1=_0x55ca2e[_0x2d3c23(0xda)](_0x2d3c23(0xff))||_0x55ca2e[_0x2d3c23(0xda)](_0x2d3c23(0xeb))||_0x55ca2e[_0x2d3c23(0xda)](_0x2d3c23(0x13c))||_0x55ca2e['includes'](_0x2d3c23(0xe1))||_0x1f009b[_0x2d3c23(0xda)]('level.valve')||_0x1f009b[_0x2d3c23(0xda)](_0x2d3c23(0xea))||_0xfe31b0['includes']('%'));if(_0x25f2f1){const _0x116df2=_0x23fe6f[_0x2d3c23(0xef)](/[._]+/)['map'](_0xd9cda1=>_0xd9cda1[_0x2d3c23(0xdf)]());let _0xd2a513=0x0;_0x3b266a['forEach'](_0xd355b3=>{const _0x495181=_0x2d3c23;if(_0x116df2[_0x495181(0xda)](_0xd355b3[_0x495181(0xdf)]()))_0xd2a513++;}),_0x435cd4[_0x2d3c23(0xe3)]({'id':_0x23fe6f,'score':_0xd2a513});}}}if(_0x435cd4[_0x2d3c23(0xfd)]>0x0){_0x435cd4[_0x2d3c23(0x10b)]((_0x4a746a,_0x1b9f49)=>_0x1b9f49['score']-_0x4a746a[_0x2d3c23(0x110)]);if(_0x435cd4[0x0][_0x2d3c23(0x110)]>0x0)return _0x435cd4[0x0]['id'];}}}catch(_0x53cf68){}return null;}async function scanThermostats(_0x5ad01d){const _0x4d4290=a1_0x2b1a52,_0x7e6ead=_0x5ad01d[_0x4d4290(0xc0)]['devices']||[],_0xe2836a=[],_0x28b063=_0x7e6ead[_0x4d4290(0xfa)](_0xd86692=>_0xd86692['id']&&_0xd86692['id'][_0x4d4290(0xda)](_0x4d4290(0xd5))||_0xd86692['type']&&['temperature',_0x4d4290(0x156),_0x4d4290(0xcd)][_0x4d4290(0xda)](_0xd86692[_0x4d4290(0xe7)])||_0xd86692[_0x4d4290(0xf7)]&&_0xd86692['name'][_0x4d4290(0xdf)]()[_0x4d4290(0xda)](_0x4d4290(0x10a)));for(const _0x2296a4 of _0x28b063){const _0x5c535c=await findRelatedId(_0x5ad01d,_0x2296a4['id'],'setpoint'),_0x4dd091=await findRelatedId(_0x5ad01d,_0x2296a4['id'],_0x4d4290(0xeb));let _0x10fb9c=_0x4d4290(0xbb),_0x2b7f38=![],_0x315a3d=_0x5ad01d[_0x4d4290(0xc0)][_0x4d4290(0xed)]||{};if(typeof _0x315a3d==='string')try{_0x315a3d=JSON[_0x4d4290(0xd7)](_0x315a3d);}catch(_0x5059cf){}let _0x5918eb=_0x5ad01d[_0x4d4290(0xc0)][_0x4d4290(0x15b)]||{};if(typeof _0x5918eb===_0x4d4290(0x146))try{_0x5918eb=JSON[_0x4d4290(0xd7)](_0x5918eb);}catch(_0x487205){}if(_0x315a3d[_0x2296a4['id']]&&_0x315a3d[_0x2296a4['id']]===_0x5c535c||_0x5918eb[_0x2296a4['id']]&&_0x5918eb[_0x2296a4['id']]===_0x4dd091)_0x10fb9c=_0x4d4290(0x153),_0x2b7f38=!![];else(_0x5c535c||_0x4dd091)&&(_0x10fb9c=_0x4d4290(0xe6));_0xe2836a['push']({'room':_0x2296a4[_0x4d4290(0x112)]||'Unbekannt','sensorId':_0x2296a4['id'],'setpointId':_0x5c535c||'-','valveId':_0x4dd091||'-','source':_0x10fb9c,'isManual':_0x2b7f38,'status':_0x5c535c&&_0x4dd091?'PERFECT':_0x5c535c?'OK':_0x4d4290(0x139)});}return _0xe2836a[_0x4d4290(0x10b)]((_0x14e299,_0xd4d40f)=>_0x14e299[_0x4d4290(0xd1)][_0x4d4290(0xf8)](_0xd4d40f[_0x4d4290(0xd1)]));}async function updateSchedulePreview(_0x428ccd){const _0x57d65a=a1_0x2b1a52;if(!_0x428ccd[_0x57d65a(0xc0)]['useCalendar']||!_0x428ccd['config']['calendarInstance'])return;let _0x335951={};try{const _0x26b052=await _0x428ccd[_0x57d65a(0xbd)](_0x57d65a(0x151));if(_0x26b052&&_0x26b052['val'])_0x335951=JSON[_0x57d65a(0xd7)](_0x26b052['val']);}catch(_0x8c3d5a){}const _0x5381d3=[],_0x2d9fc4=Date[_0x57d65a(0xca)](),_0x38a246=0x30*0x3c*0x3c*0x3e8;try{const _0x55bec5=await _0x428ccd[_0x57d65a(0xd9)](_0x428ccd['config']['calendarInstance']+_0x57d65a(0xc6));if(!_0x55bec5||!_0x55bec5[_0x57d65a(0x113)])return;const _0x431531=JSON['parse'](_0x55bec5[_0x57d65a(0x113)]),_0x377e86=_0x428ccd[_0x57d65a(0xc0)]['calendarSelection']||[],_0x357eae=_0x428ccd['config'][_0x57d65a(0x143)]||[],_0x510f0d=new Set();_0x357eae[_0x57d65a(0x12e)](_0x4ff2c7=>{const _0x433b96=_0x57d65a;if(_0x4ff2c7['location'])_0x510f0d['add'](_0x4ff2c7[_0x433b96(0x112)]);});for(const _0x17e11f of _0x431531){if(_0x17e11f[_0x57d65a(0xe8)]&&_0x377e86[_0x57d65a(0xfd)]>0x0&&!_0x377e86[_0x57d65a(0xda)](_0x17e11f[_0x57d65a(0xe8)]))continue;const _0xb2b3bd=_0x17e11f[_0x57d65a(0xcb)]||_0x17e11f['eventStart']||_0x17e11f['date'];if(!_0xb2b3bd)continue;const _0x5df405=new Date(_0xb2b3bd),_0x570103=_0x5df405['getTime']();if(isNaN(_0x570103))continue;if(_0x570103<_0x2d9fc4)continue;if(_0x570103>_0x2d9fc4+_0x38a246)continue;const _0x17c2a1=(_0x17e11f['event']||_0x17e11f[_0x57d65a(0x133)]||'')['toLowerCase']();let _0x31126f=![],_0x5eb9ff=[],_0x22c3a8=_0x17e11f[_0x57d65a(0x137)]||_0x17e11f[_0x57d65a(0x133)]||_0x57d65a(0x14d);if(_0x17c2a1['includes'](_0x57d65a(0xcc))||_0x17c2a1[_0x57d65a(0xda)]('r√ºckkehr')||_0x17c2a1[_0x57d65a(0xda)](_0x57d65a(0xe9)))_0x31126f=!![],_0x5eb9ff=Array['from'](_0x510f0d);else for(const _0x54c5be of _0x510f0d){if(_0x17c2a1[_0x57d65a(0xda)](_0x54c5be[_0x57d65a(0xdf)]()))_0x5eb9ff[_0x57d65a(0xe3)](_0x54c5be);}_0x5eb9ff[_0x57d65a(0xfd)]>0x0&&_0x5eb9ff[_0x57d65a(0x12e)](_0x145db3=>{const _0x57abac=_0x57d65a;let _0x1398f9=0x3c;if(_0x31126f){let _0x4ccc0f=0x0;Object[_0x57abac(0xfb)](_0x335951)[_0x57abac(0x12e)](_0x1ef8a4=>{if(_0x1ef8a4>_0x4ccc0f)_0x4ccc0f=_0x1ef8a4;}),_0x1398f9=_0x4ccc0f>0x0?_0x4ccc0f:0x78;}else _0x1398f9=_0x335951[_0x145db3]||0x3c;const _0x414dcb=new Date(_0x570103-_0x1398f9*0xea60);_0x5381d3[_0x57abac(0xe3)]({'eventTime':_0x570103,'triggerTime':_0x414dcb[_0x57abac(0xdd)](),'room':_0x145db3,'minutes':_0x1398f9,'reason':_0x22c3a8,'isGlobal':_0x31126f});});}}catch(_0x3d9cc4){}_0x5381d3[_0x57d65a(0x10b)]((_0x3ed03f,_0x4af3cf)=>_0x3ed03f[_0x57d65a(0x114)]-_0x4af3cf['triggerTime']);const _0xff3b2e=_0x5381d3['slice'](0x0,0x5);await _0x428ccd[_0x57d65a(0x103)](_0x57d65a(0x158),{'val':JSON[_0x57d65a(0x120)](_0xff3b2e),'ack':!![]});}async function checkCalendarTriggers(_0x5a5e2d){const _0x49f179=a1_0x2b1a52;if(!_0x5a5e2d['config'][_0x49f179(0x13e)]||!_0x5a5e2d['config'][_0x49f179(0x115)])return;await updateSchedulePreview(_0x5a5e2d);let _0x2c496c={},_0x379a97={};try{const _0xd7fb93=await _0x5a5e2d[_0x49f179(0xbd)](_0x49f179(0x151));if(_0xd7fb93&&_0xd7fb93[_0x49f179(0x113)])_0x2c496c=JSON[_0x49f179(0xd7)](_0xd7fb93[_0x49f179(0x113)]);const _0x50205b=await _0x5a5e2d['getStateAsync']('analysis.energy.warmupSources');if(_0x50205b&&_0x50205b[_0x49f179(0x113)])_0x379a97=JSON[_0x49f179(0xd7)](_0x50205b['val']);}catch(_0x17fdc7){}let _0x546665={'default':0x15};try{const _0x567b8f=await _0x5a5e2d[_0x49f179(0xbd)](_0x49f179(0x102));if(_0x567b8f&&_0x567b8f['val'])_0x546665=JSON['parse'](_0x567b8f[_0x49f179(0x113)]);}catch(_0x4de68a){}try{const _0x396fd9=await _0x5a5e2d[_0x49f179(0xd9)](_0x5a5e2d['config'][_0x49f179(0x115)]+'.data.table');if(!_0x396fd9||!_0x396fd9[_0x49f179(0x113)])return;const _0x3f8222=JSON[_0x49f179(0xd7)](_0x396fd9[_0x49f179(0x113)]),_0x41966a=Date[_0x49f179(0xca)](),_0x4173e4=_0x5a5e2d[_0x49f179(0xc0)][_0x49f179(0x143)]||[],_0x56183d=_0x5a5e2d[_0x49f179(0xc0)][_0x49f179(0x147)]||[];for(const _0x1d42e3 of _0x3f8222){if(_0x1d42e3['_calName']&&_0x56183d[_0x49f179(0xfd)]>0x0&&!_0x56183d[_0x49f179(0xda)](_0x1d42e3[_0x49f179(0xe8)]))continue;const _0x555b41=_0x1d42e3[_0x49f179(0xcb)]||_0x1d42e3[_0x49f179(0xb9)]||_0x1d42e3['date'];if(!_0x555b41)continue;const _0x391f7a=new Date(_0x555b41);if(isNaN(_0x391f7a[_0x49f179(0xdd)]()))continue;const _0x2aa2c0=(_0x1d42e3[_0x49f179(0x137)]||_0x1d42e3[_0x49f179(0x133)]||'')['toLowerCase']();if(_0x2aa2c0[_0x49f179(0xda)]('urlaub\x20ende')||_0x2aa2c0['includes'](_0x49f179(0x100))||_0x2aa2c0[_0x49f179(0xda)]('ankunft')){let _0x5a6616=0x0;Object[_0x49f179(0xfb)](_0x2c496c)[_0x49f179(0x12e)](_0x25e8ae=>{if(_0x25e8ae>_0x5a6616)_0x5a6616=_0x25e8ae;});if(_0x5a6616===0x0)_0x5a6616=0x78;const _0x6c11ce=_0x391f7a[_0x49f179(0xdd)]()-_0x5a6616*0xea60;_0x41966a>=_0x6c11ce&&_0x41966a<_0x391f7a[_0x49f179(0xdd)]()&&(_0x5a5e2d[_0x49f179(0x12f)]!==_0x49f179(0x124)&&(_0x5a5e2d[_0x49f179(0x10f)]['info']('üìÖ\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20'+_0x5a6616+_0x49f179(0x105)),await _0x5a5e2d['setStateAsync']('system.mode',{'val':_0x49f179(0x124),'ack':![]})));}for(const _0x19f972 of _0x4173e4){if(_0x19f972[_0x49f179(0x112)]){const _0x58f1fd=_0x19f972[_0x49f179(0x112)]['toLowerCase']();if(_0x2aa2c0[_0x49f179(0xda)](_0x58f1fd)){const _0x33516e=_0x2c496c[_0x19f972[_0x49f179(0x112)]]||0x3c,_0x418084=_0x379a97[_0x19f972[_0x49f179(0x112)]]||_0x49f179(0xc9),_0x2fd1a8=_0x391f7a[_0x49f179(0xdd)]()-_0x33516e*0xea60;if(_0x41966a>=_0x2fd1a8&&_0x41966a<_0x391f7a[_0x49f179(0xdd)]()){const _0x40d0e9=lastActions[_0x49f179(0x123)+_0x19f972['location']];if(_0x40d0e9&&_0x41966a-_0x40d0e9<CAL_COOLDOWN_MS)continue;const _0x1059c4=await findRelatedId(_0x5a5e2d,_0x19f972['id'],_0x49f179(0x12d));if(_0x1059c4){let _0x47c046=_0x546665[_0x19f972[_0x49f179(0x112)]];if(_0x47c046===undefined)_0x47c046=_0x546665[_0x49f179(0xfc)];if(_0x47c046===undefined)_0x47c046=0x15;const _0x46ae92=await _0x5a5e2d['getForeignStateAsync'](_0x1059c4);_0x46ae92&&typeof _0x46ae92['val']===_0x49f179(0x10d)&&_0x46ae92[_0x49f179(0x113)]<_0x47c046-0.5&&(_0x5a5e2d[_0x49f179(0x10f)]['info']('üìÖ\x20SMART\x20SCHEDULE\x20['+_0x418084+_0x49f179(0x11b)+_0x19f972[_0x49f179(0x112)]+_0x49f179(0x13b)+_0x47c046+_0x49f179(0xc2)+_0x33516e+'\x20min).'),await _0x5a5e2d[_0x49f179(0xbf)](_0x1059c4,_0x47c046),await logAutomationAction(_0x5a5e2d,_0x49f179(0xd3)+_0x19f972[_0x49f179(0x112)]+_0x49f179(0x121)+_0x47c046+'¬∞C\x20(via\x20'+_0x418084+')'),lastActions['cal_'+_0x19f972[_0x49f179(0x112)]]=_0x41966a);}}}}}}}catch(_0x4a4e14){_0x5a5e2d[_0x49f179(0x10f)]['warn'](_0x49f179(0x145)+_0x4a4e14['message']);}}async function manageMpcIntervention(_0x2aa44a,_0x1c4e51,_0x3c0688){const _0x105537=a1_0x2b1a52;try{const _0x49a025=_0x105537(0x15d),_0x56ac6a=await _0x2aa44a['getStateAsync'](_0x49a025);let _0x17ac45=[];if(_0x56ac6a&&_0x56ac6a[_0x105537(0x113)])try{_0x17ac45=JSON[_0x105537(0xd7)](_0x56ac6a[_0x105537(0x113)]);}catch(_0x346bad){}const _0x52f8c0=_0x17ac45[_0x105537(0xdb)](_0x1c4e51);if(_0x3c0688===_0x105537(0xf2))_0x52f8c0===-0x1&&(_0x17ac45[_0x105537(0xe3)](_0x1c4e51),await _0x2aa44a[_0x105537(0x103)](_0x49a025,{'val':JSON[_0x105537(0x120)](_0x17ac45),'ack':!![]}));else _0x3c0688===_0x105537(0x148)&&(_0x52f8c0!==-0x1&&(_0x17ac45['splice'](_0x52f8c0,0x1),await _0x2aa44a[_0x105537(0x103)](_0x49a025,{'val':JSON[_0x105537(0x120)](_0x17ac45),'ack':!![]})));}catch(_0x4f6aa0){}}async function cleanupGhostInterventions(_0x1a53dc){const _0xaa8716=a1_0x2b1a52;try{const _0x5e35fd=_0xaa8716(0x15d),_0x56e903=await _0x1a53dc[_0xaa8716(0xbd)](_0x5e35fd);if(!_0x56e903||!_0x56e903['val'])return;const _0x5eae7a=JSON[_0xaa8716(0xd7)](_0x56e903[_0xaa8716(0x113)]);if(!Array['isArray'](_0x5eae7a)||_0x5eae7a[_0xaa8716(0xfd)]===0x0)return;let _0x286848={'default':0x15};try{const _0x58fd7d=await _0x1a53dc[_0xaa8716(0xbd)](_0xaa8716(0x102));if(_0x58fd7d&&_0x58fd7d[_0xaa8716(0x113)])_0x286848=JSON['parse'](_0x58fd7d[_0xaa8716(0x113)]);}catch(_0x213729){}let _0x543754=[];try{const _0x2817ec=await _0x1a53dc['getStateAsync'](_0xaa8716(0x11d));if(_0x2817ec&&_0x2817ec[_0xaa8716(0x113)])_0x543754=JSON[_0xaa8716(0xd7)](_0x2817ec[_0xaa8716(0x113)]);}catch(_0x189a29){}const _0x37b7ed=_0x1a53dc['config'][_0xaa8716(0x143)]||[];let _0x430358=![];for(let _0xa41ef8=_0x5eae7a['length']-0x1;_0xa41ef8>=0x0;_0xa41ef8--){const _0x2424be=_0x5eae7a[_0xa41ef8],_0x40aaa5=_0x37b7ed[_0xaa8716(0xf4)](_0x51898a=>normalize(_0x51898a[_0xaa8716(0x112)])===normalize(_0x2424be)&&(_0x51898a[_0xaa8716(0xe7)]===_0xaa8716(0xd5)||_0x51898a[_0xaa8716(0xe7)]==='thermostat'));if(!_0x40aaa5){_0x1a53dc[_0xaa8716(0x10f)][_0xaa8716(0xe4)]('üßπ\x20[MPC\x20CLEANUP]\x20Raum\x20\x27'+_0x2424be+'\x27\x20hat\x20kein\x20Ger√§t\x20mehr.\x20L√∂sche\x20Eintrag.'),_0x5eae7a[_0xaa8716(0x159)](_0xa41ef8,0x1),_0x430358=!![];continue;}if(_0x40aaa5){const _0xff5ba1=await findRelatedId(_0x1a53dc,_0x40aaa5['id'],_0xaa8716(0x12d)),_0x2109cc=await _0x1a53dc[_0xaa8716(0xd9)](_0x40aaa5['id']);if(_0xff5ba1){const _0x435f5b=await _0x1a53dc['getForeignStateAsync'](_0xff5ba1);if(_0x435f5b&&typeof _0x435f5b[_0xaa8716(0x113)]===_0xaa8716(0x10d)){let _0x833bb0=![],_0x47e702='';Math['abs'](_0x435f5b[_0xaa8716(0x113)]-ECO_TEMP)>0.5&&(_0x833bb0=!![],_0x47e702=_0xaa8716(0xde));if(!_0x833bb0&&_0x2109cc&&typeof _0x2109cc[_0xaa8716(0x113)]===_0xaa8716(0x10d)){const _0x4f80e5=_0x286848[_0x2424be]||_0x286848[_0xaa8716(0xfc)]||0x15;_0x2109cc[_0xaa8716(0x113)]<_0x4f80e5+0.2&&(_0x833bb0=!![],_0x47e702=_0xaa8716(0x12b));}if(_0x833bb0){if(_0x47e702===_0xaa8716(0xde)){_0x1a53dc['log']['info']('üßπ\x20[MPC\x20CLEANUP]\x20'+_0x2424be+'\x20ist\x20auf\x20'+_0x435f5b['val']+_0xaa8716(0xbc)+ECO_TEMP+_0xaa8716(0x109));const _0x5058af=lastActions[_0xaa8716(0x123)+_0x2424be],_0x30e813=_0x5058af&&Date['now']()-_0x5058af<0x2*0x3c*0x3e8;if(!_0x30e813&&_0x435f5b[_0xaa8716(0x113)]>ECO_TEMP+0.5)_0x1a53dc[_0xaa8716(0x13a)]&&(_0x1a53dc[_0xaa8716(0x10f)][_0xaa8716(0x108)](_0xaa8716(0xd4)+_0x2424be+'\x20wurde\x20manuell\x20erh√∂ht.'),_0x1a53dc[_0xaa8716(0x13a)](_0xaa8716(0x11e),{'room':_0x2424be}));else _0x30e813&&_0x1a53dc[_0xaa8716(0x10f)][_0xaa8716(0x108)](_0xaa8716(0x13d)+_0x2424be+_0xaa8716(0x138));}else{if(_0x47e702===_0xaa8716(0x12b)){let _0x1d19b9=![];if(_0x543754['find'](_0x4f598=>_0x4f598[_0xaa8716(0xd1)]===_0x2424be))_0x1d19b9=!![];const _0x3d9f19=_0x37b7ed[_0xaa8716(0xfa)](_0x4e6b4c=>normalize(_0x4e6b4c['location'])===normalize(_0x2424be)&&(_0x4e6b4c[_0xaa8716(0xe7)]===_0xaa8716(0xd0)||_0x4e6b4c[_0xaa8716(0xe7)]===_0xaa8716(0xcd)||_0x4e6b4c[_0xaa8716(0xe7)]===_0xaa8716(0x10c)));for(const _0x3896e1 of _0x3d9f19){try{const _0x86a8ba=await _0x1a53dc[_0xaa8716(0xd9)](_0x3896e1['id']);if(_0x86a8ba&&(_0x86a8ba[_0xaa8716(0x113)]===!![]||_0x86a8ba['val']===0x1||String(_0x86a8ba[_0xaa8716(0x113)])[_0xaa8716(0xdf)]()==='open'))_0x1d19b9=!![];}catch(_0x55f7db){}}if(_0x1d19b9)_0x1a53dc[_0xaa8716(0x10f)]['info'](_0xaa8716(0xc5)+_0x2424be+_0xaa8716(0xec));else{const _0x5f526e=_0x286848[_0x2424be]||_0x286848[_0xaa8716(0xfc)]||0x15;_0x1a53dc['log']['info'](_0xaa8716(0xee)+_0x2424be+_0xaa8716(0x11c)+_0x2109cc[_0xaa8716(0x113)]+'¬∞C\x20<\x20'+(_0x5f526e+0.2)+_0xaa8716(0x15c)),await _0x1a53dc['setForeignStateAsync'](_0xff5ba1,_0x5f526e),await logAutomationAction(_0x1a53dc,_0xaa8716(0xe0)+_0x2424be+':\x20Puffer\x20leer\x20->\x20Heizen\x20auf\x20'+_0x5f526e+'¬∞C'),lastActions[_0xaa8716(0x14f)+_0x2424be]=Date[_0xaa8716(0xca)]();}}}_0x5eae7a['splice'](_0xa41ef8,0x1),_0x430358=!![];}}}}}_0x430358&&await _0x1a53dc['setStateAsync'](_0x5e35fd,{'val':JSON['stringify'](_0x5eae7a),'ack':!![]});}catch(_0x47e767){}}async function applyEnergySavings(_0x1249a6,_0x551279){const _0x437867=a1_0x2b1a52;await cleanupGhostInterventions(_0x1249a6);if(!_0x551279||_0x551279[_0x437867(0xfd)]===0x0)return;const _0x8e77eb=_0x1249a6['config'][_0x437867(0x143)]||[],_0x4edbe0=Date[_0x437867(0xca)]();for(const _0x38906c of _0x551279){const _0x20d233=_0x38906c[_0x437867(0xd1)],_0x29b334=_0x38906c['minutes_safe'],_0x89d962=_0x38906c[_0x437867(0x15a)]||0x15;if(lastActions[_0x437867(0x14f)+_0x20d233]&&_0x4edbe0-lastActions['rescue_'+_0x20d233]<RESCUE_LOCK_MS)continue;const _0x3a704d=_0x8e77eb['find'](_0x1f7dfc=>normalize(_0x1f7dfc[_0x437867(0x112)])===normalize(_0x20d233)&&(_0x1f7dfc['type']===_0x437867(0xd5)||_0x1f7dfc['type']===_0x437867(0x156)));if(!_0x3a704d)continue;const _0x569825=await findRelatedId(_0x1249a6,_0x3a704d['id'],_0x437867(0x12d));if(_0x569825){if(lastActions[_0x437867(0x106)+_0x20d233]&&_0x4edbe0-lastActions[_0x437867(0x106)+_0x20d233]<0x1e*0x3c*0x3e8)continue;const _0x5d91e5=await _0x1249a6['getForeignStateAsync'](_0x569825);if(_0x5d91e5&&typeof _0x5d91e5[_0x437867(0x113)]===_0x437867(0x10d)){const _0x27b39d=_0x5d91e5['val'];_0x27b39d!==ECO_TEMP&&await manageMpcIntervention(_0x1249a6,_0x20d233,_0x437867(0x148));if(_0x29b334>0x1e)_0x27b39d>ECO_TEMP+0.5&&(_0x1249a6[_0x437867(0x10f)]['info'](_0x437867(0x127)+_0x20d233+_0x437867(0xfe)+ECO_TEMP+'¬∞C!\x20(Puffer:\x20'+_0x29b334+_0x437867(0xdc)),await _0x1249a6[_0x437867(0xbf)](_0x569825,ECO_TEMP),await manageMpcIntervention(_0x1249a6,_0x20d233,'add'),lastActions['mpc_'+_0x20d233]=_0x4edbe0,await logAutomationAction(_0x1249a6,_0x437867(0x118)+_0x20d233+_0x437867(0x129)+ECO_TEMP+'¬∞C'));else _0x29b334<=0xf&&(_0x27b39d<_0x89d962&&(_0x1249a6[_0x437867(0x10f)][_0x437867(0x108)](_0x437867(0xd6)+_0x20d233+_0x437867(0xc7)+_0x89d962+'¬∞C!\x20(Puffer\x20leer).'),await _0x1249a6['setForeignStateAsync'](_0x569825,_0x89d962),await manageMpcIntervention(_0x1249a6,_0x20d233,_0x437867(0x148)),lastActions[_0x437867(0x106)+_0x20d233]=_0x4edbe0,await logAutomationAction(_0x1249a6,'[MPC]\x20'+_0x20d233+_0x437867(0x132)+_0x89d962+'¬∞C')));}}else _0x1249a6[_0x437867(0x10f)][_0x437867(0xe4)]('[MPC\x20WARNING]\x20Kein\x20Setpoint\x20f√ºr\x20'+_0x20d233+_0x437867(0x150));}}module['exports']={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'updateSchedulePreview':updateSchedulePreview,'cleanupGhostInterventions':cleanupGhostInterventions};function a1_0x38f1(){const _0xa4776e=['manual','toLowerCase','[WATCHDOG]\x20','position','role','push','warn','SET_POINT_TEMPERATURE','Auto-Erkennung','type','_calName','ankunft','value.valve','valve','\x20ist\x20zu\x20kalt,\x20ABER\x20Fenster\x20offen/L√ºftung\x20erkannt.\x20Heize\x20NICHT,\x20entferne\x20nur\x20Status.','thermostatMapping','üö®\x20[MPC\x20WATCHDOG]\x20','split','ist','ACTUAL_TEMPERATURE','add','.4.SET_TEMPERATURE','find','analysis.automation.confidenceThreshold','level.temperature','name','localeCompare','pi_heating_demand','filter','values','default','length','\x20auf\x20','level','r√ºckkehr','replace','analysis.energy.warmupTargets','setStateAsync','current_heating_setpoint','\x20min).','mpc_','1045504WbwiQn','info','¬∞C).\x20Entferne\x20Status.','temp','sort','contact','number','valve_position','log','score','.1.LEVEL','location','val','triggerTime','calendarInstance','write','local_temperature','[MPC]\x20','dimmer','Soll',']:\x20Raum-Trigger\x20\x27','\x20erreicht\x20Limit\x20(','analysis.energy.ventilationAlerts','TRAIN_RL_PENALTY','trim','stringify','\x20->\x20','join','cal_','normal','.1.SET_POINT_TEMPERATURE','entries','üçÉ\x20[MPC\x20ACTION]\x20Senke\x20','openknx',':\x20Absenkung\x20auf\x20','181638mPlxrx','too_cold','analysis.automation.mode','setpoint','forEach','currentSystemMode','6048427krRcRW','consultButler',':\x20Aufheizen\x20auf\x20','summary','unit','analysis.automation.actionLog','2253530LoqCzO','event','\x20durch\x20Kalender\x20ge√§ndert.\x20Keine\x20RL-Strafe.','Fehlt','sendToPythonWrapper','\x27\x20aktiv.\x20Heize\x20auf\x20','stellwert','üìÖ\x20[MPC\x20INFO]\x20','useCalendar','toString','search','.1.ACTUAL_TEMPERATURE','off','devices','getForeignObjectsAsync','Calendar\x20Check\x20Error:\x20','string','calendarSelection','remove','.1.TEMPERATURE','wert','Pr√§diktion:\x20','slice','Unbekannt','approved','rescue_','\x20gefunden!','analysis.energy.warmupTimes','SET','Manuelles\x20Mapping','state','3824408rsNgmm','thermostat','2080053SQmhNp','analysis.energy.schedulePreview','splice','target','valveMapping','¬∞C).\x20Sparmodus\x20beendet!','analysis.energy.mpcActiveInterventions','light','occupied_heating_setpoint','reason','eventStart','soll','Nicht\x20gefunden','¬∞C\x20(nicht\x20','getStateAsync','152706pRsJej','setForeignStateAsync','config','common','¬∞C\x20(Vorlauf:\x20','apply','messwert','üå¨Ô∏è\x20[MPC\x20WATCHDOG]\x20','.data.table','\x20wieder\x20auf\x20','(((.+)+)+)+$','Classic','now','_date','urlaub\x20ende','sensor','60uWNsDO','.4.VALVE_STATE','window','room','actual','[CAL]\x20','üéì\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20','temperature','üî•\x20[MPC\x20ACTION]\x20Heize\x20','parse','switch','getForeignStateAsync','includes','indexOf','\x20min)','getTime'];a1_0x38f1=function(){return _0xa4776e;};return a1_0x38f1();}