const a1_0x220e2a=a1_0x6891;(function(_0x2b0b40,_0x604f62){const _0x464038=a1_0x6891,_0x12a3d4=_0x2b0b40();while(!![]){try{const _0x45384c=parseInt(_0x464038(0x207))/0x1+-parseInt(_0x464038(0x20b))/0x2+-parseInt(_0x464038(0x1cb))/0x3+parseInt(_0x464038(0x1bd))/0x4+parseInt(_0x464038(0x21c))/0x5+-parseInt(_0x464038(0x205))/0x6+parseInt(_0x464038(0x1d7))/0x7;if(_0x45384c===_0x604f62)break;else _0x12a3d4['push'](_0x12a3d4['shift']());}catch(_0x5c39a2){_0x12a3d4['push'](_0x12a3d4['shift']());}}}(a1_0x3933,0x8bf8b));const a1_0x21705b=(function(){let _0xfa5b54=!![];return function(_0xa7962a,_0x2228c5){const _0x52b6a6=_0xfa5b54?function(){const _0x8b2b37=a1_0x6891;if(_0x2228c5){const _0x3114f3=_0x2228c5[_0x8b2b37(0x1c0)](_0xa7962a,arguments);return _0x2228c5=null,_0x3114f3;}}:function(){};return _0xfa5b54=![],_0x52b6a6;};}()),a1_0x460463=a1_0x21705b(this,function(){const _0x4d0618=a1_0x6891;return a1_0x460463[_0x4d0618(0x217)]()[_0x4d0618(0x22b)](_0x4d0618(0x1e6))[_0x4d0618(0x217)]()[_0x4d0618(0x1f7)](a1_0x460463)['search'](_0x4d0618(0x1e6));});a1_0x460463();'use strict';function a1_0x3933(){const _0x37fc42=['now','analysis.automation.confidenceThreshold','Pr√§diktion:\x20','info','analysis.automation.mode','length','üçÉ\x20MPC\x20Autonomy:\x20Senke\x20','[CAL]\x20','calendarSelection','system.mode','position','4423377mLVHnL','number','slice','valve_position','openknx','.data.table','getForeignObjectsAsync','level','type','forEach','thermostat.setpoint','level.valve','SET_POINT_TEMPERATURE','room','Auto-Erkennung','(((.+)+)+)+$','analysis.energy.warmupTimes','string','sort','minutes_safe','üìÖ\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','setpoint','log','actual','occupied_heating_setpoint','write','getTime',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','level.temperature','üìÖ\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27','debug','config','constructor','name','entries','\x20->\x20Schalte\x20','devices','consultButler',':\x20-1¬∞C\x20(Sparpotenzial\x20genutzt)','role','thermostatMapping','_calName',')\x20auf\x20','.4.VALVE_STATE','ankunft','find','6783672SlpFkx','wert','888628YYLFrp','local_temperature','map','val','1246366IafATn','\x20->\x2021¬∞C','üîç\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27','.1.LEVEL','getForeignObjectAsync','light','Ist','mpc_','\x20min)','common','valveMapping','.1.SET_POINT_TEMPERATURE','toString','.1.TEMPERATURE','summary','off','reason','4633490gIzSyK','target','setForeignStateAsync','temperature','replace','ACTUAL_TEMPERATURE','getStateAsync','hm-rpc','sensor','Unknown','current_heating_setpoint','PERFECT','location','switch','calendarInstance','search','ACTUAL','\x27\x20erkannt\x20(','unit','approved','temp','.4.SET_TEMPERATURE','split','analysis.automation.lastAction','getForeignStateAsync','\x20min).','parse','Soll','Unbekannt','useCalendar','valve','pi_heating_demand','dimmer','toLowerCase','.1.ACTUAL_TEMPERATURE','3088084EapRbb','setStateAsync','includes','apply','event','filter','Calendar\x20Check\x20Error:\x20',').\x20Heize\x20auf\x2021¬∞C\x20(Vorlauf:\x20','push','Fehlt','urlaub\x20ende','score','localeCompare','warn','2676420hNHAfK'];a1_0x3933=function(){return _0x37fc42;};return a1_0x3933();}const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x1f4749){const _0x1ffa72=a1_0x6891;if(!_0x1f4749)return'';return _0x1f4749[_0x1ffa72(0x1bb)]()[_0x1ffa72(0x220)](/\s+/g,'')['trim']();}async function handlePrediction(_0x594188,_0xccca0c,_0x27be83){const _0x99a43=a1_0x6891;if(!_0xccca0c||_0xccca0c===_0x99a43(0x225))return;let _0x393ad9=_0x99a43(0x21a),_0x51f9f1=0.6;try{const _0x3b233f=await _0x594188['getStateAsync'](_0x99a43(0x1d0));if(_0x3b233f&&_0x3b233f['val'])_0x393ad9=_0x3b233f[_0x99a43(0x20a)];const _0x36ccea=await _0x594188[_0x99a43(0x222)](_0x99a43(0x1cd));if(_0x36ccea&&_0x36ccea[_0x99a43(0x20a)])_0x51f9f1=_0x36ccea[_0x99a43(0x20a)];}catch(_0x41a6e6){}if(_0x393ad9==='off'||_0x27be83<_0x51f9f1)return;const _0x2b5b07=Date[_0x99a43(0x1cc)]();if(lastActions[_0xccca0c]&&_0x2b5b07-lastActions[_0xccca0c]<COOLDOWN_MS)return;const _0x13915d=_0x594188['config']['devices']||[],_0x3e791b=normalize(_0xccca0c),_0x1e461d=_0x13915d[_0x99a43(0x204)](_0x598f05=>normalize(_0x598f05[_0x99a43(0x228)])===_0x3e791b&&(_0x598f05[_0x99a43(0x1df)]===_0x99a43(0x210)||_0x598f05[_0x99a43(0x1df)]===_0x99a43(0x1ba)||_0x598f05[_0x99a43(0x1df)]===_0x99a43(0x229)));if(!_0x1e461d){_0x594188[_0x99a43(0x1ed)][_0x99a43(0x1f5)](_0x99a43(0x20d)+_0xccca0c+'\x27.');return;}const _0x4f87be=await aiAgent[_0x99a43(0x1fc)](_0x594188,_0xccca0c,_0x1e461d[_0x99a43(0x1f8)],_0x27be83);if(!_0x4f87be[_0x99a43(0x22f)])return;const _0x48a5c2=_0x99a43(0x1ce)+_0xccca0c+_0x99a43(0x1fa)+_0x1e461d[_0x99a43(0x1f8)]+'\x20('+_0x4f87be[_0x99a43(0x21b)]+')';await _0x594188[_0x99a43(0x1be)](_0x99a43(0x233),{'val':'['+_0x393ad9['toUpperCase']()+']\x20'+_0x48a5c2,'ack':!![]});if(_0x393ad9==='active'){const _0x4f8319=await _0x594188[_0x99a43(0x234)](_0x1e461d['id']);(!_0x4f8319||!_0x4f8319[_0x99a43(0x20a)]&&_0x4f8319[_0x99a43(0x20a)]!==!![])&&await _0x594188[_0x99a43(0x21e)](_0x1e461d['id'],!![]),lastActions[_0xccca0c]=_0x2b5b07;}}async function findRelatedId(_0x570e03,_0x108141,_0x42f5b4=a1_0x220e2a(0x1ec)){const _0x32e31c=a1_0x220e2a;if(_0x42f5b4===_0x32e31c(0x1ec)&&_0x570e03[_0x32e31c(0x1f6)]['thermostatMapping']){let _0x16d7c=_0x570e03['config'][_0x32e31c(0x1ff)];if(typeof _0x16d7c===_0x32e31c(0x1e8))try{_0x16d7c=JSON[_0x32e31c(0x236)](_0x16d7c);}catch(_0x271d81){}if(_0x16d7c&&_0x16d7c[_0x108141])return _0x16d7c[_0x108141];}if(_0x42f5b4==='valve'&&_0x570e03[_0x32e31c(0x1f6)][_0x32e31c(0x215)]){let _0x492b15=_0x570e03[_0x32e31c(0x1f6)]['valveMapping'];if(typeof _0x492b15==='string')try{_0x492b15=JSON['parse'](_0x492b15);}catch(_0xae4cf5){}if(_0x492b15&&_0x492b15[_0x108141])return _0x492b15[_0x108141];}let _0x53674b=[];if(_0x42f5b4===_0x32e31c(0x1ec))_0x53674b=[{'s':'.1.ACTUAL_TEMPERATURE','t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x32e31c(0x218),'t':_0x32e31c(0x216)},{'s':'.1.TEMPERATURE','t':_0x32e31c(0x231)},{'s':_0x32e31c(0x221),'t':_0x32e31c(0x1e3)},{'s':_0x32e31c(0x208),'t':_0x32e31c(0x1ef)},{'s':_0x32e31c(0x208),'t':_0x32e31c(0x226)},{'s':_0x32e31c(0x21f),'t':'target_temperature'},{'s':_0x32e31c(0x22c),'t':'SET'},{'s':_0x32e31c(0x211),'t':_0x32e31c(0x237)},{'s':_0x32e31c(0x21f),'t':'setpoint'}];else _0x42f5b4===_0x32e31c(0x1b8)&&(_0x53674b=[{'s':_0x32e31c(0x1bc),'t':_0x32e31c(0x20e)},{'s':_0x32e31c(0x218),'t':'.1.LEVEL'},{'s':'.1.TEMPERATURE','t':_0x32e31c(0x202)},{'s':_0x32e31c(0x208),'t':_0x32e31c(0x1b9)},{'s':_0x32e31c(0x21f),'t':_0x32e31c(0x1da)},{'s':_0x32e31c(0x21f),'t':_0x32e31c(0x1de)}]);for(const _0x3cfbe6 of _0x53674b){if(_0x108141[_0x32e31c(0x1bf)](_0x3cfbe6['s'])){const _0x1e2cf3=_0x108141['replace'](_0x3cfbe6['s'],_0x3cfbe6['t']),_0x113bc8=await _0x570e03[_0x32e31c(0x20f)](_0x1e2cf3);if(_0x113bc8)return _0x1e2cf3;}}try{const _0xf2ce4e=_0x108141[_0x32e31c(0x232)]('.');if(_0xf2ce4e[_0x32e31c(0x1d1)]>0x2){const _0x5d2aae=_0xf2ce4e[_0x32e31c(0x1d9)](0x0,-0x1)['join']('.'),_0x100fbd=await _0x570e03[_0x32e31c(0x1dd)](_0x5d2aae+'.*'),_0x508633=[],_0x451857=_0x108141[_0x32e31c(0x232)](/[._]+/)[_0x32e31c(0x1c2)](_0x7bfe91=>![_0x32e31c(0x1db),'0',_0x32e31c(0x223),'ist',_0x32e31c(0x206),_0x32e31c(0x21f),_0x32e31c(0x1ee),_0x32e31c(0x224),'messwert','state'][_0x32e31c(0x1bf)](_0x7bfe91['toLowerCase']()));for(const [_0xb54976,_0x492fb8]of Object[_0x32e31c(0x1f9)](_0x100fbd)){if(_0xb54976===_0x108141)continue;if(_0x492fb8&&_0x492fb8['common']){const _0x3dae0e=_0xb54976[_0x32e31c(0x1bb)](),_0x5bd981=(_0x492fb8['common'][_0x32e31c(0x1fe)]||'')[_0x32e31c(0x1bb)](),_0x201141=(_0x492fb8[_0x32e31c(0x214)][_0x32e31c(0x22e)]||'')[_0x32e31c(0x1bb)]();let _0x4c9b67=![];if(_0x42f5b4==='setpoint'&&_0x492fb8[_0x32e31c(0x214)][_0x32e31c(0x1f0)]===!![])_0x4c9b67=_0x3dae0e[_0x32e31c(0x1bf)]('set')||_0x3dae0e[_0x32e31c(0x1bf)]('soll')||_0x3dae0e['includes'](_0x32e31c(0x21d))||_0x5bd981[_0x32e31c(0x1bf)](_0x32e31c(0x1f3))||_0x5bd981['includes'](_0x32e31c(0x1e1));else _0x42f5b4===_0x32e31c(0x1b8)&&(_0x4c9b67=_0x3dae0e[_0x32e31c(0x1bf)]('level')||_0x3dae0e[_0x32e31c(0x1bf)](_0x32e31c(0x1b8))||_0x3dae0e[_0x32e31c(0x1bf)]('stellwert')||_0x3dae0e[_0x32e31c(0x1bf)](_0x32e31c(0x1d6))||_0x5bd981[_0x32e31c(0x1bf)](_0x32e31c(0x1e2))||_0x5bd981[_0x32e31c(0x1bf)]('value.valve')||_0x201141[_0x32e31c(0x1bf)]('%'));if(_0x4c9b67){const _0x4229cf=_0xb54976[_0x32e31c(0x232)](/[._]+/)[_0x32e31c(0x209)](_0x17b22a=>_0x17b22a[_0x32e31c(0x1bb)]());let _0x5a9d60=0x0;_0x451857[_0x32e31c(0x1e0)](_0x5ab5aa=>{const _0x1bc84c=_0x32e31c;if(_0x4229cf['includes'](_0x5ab5aa[_0x1bc84c(0x1bb)]()))_0x5a9d60++;}),_0x508633[_0x32e31c(0x1c5)]({'id':_0xb54976,'score':_0x5a9d60});}}}if(_0x508633[_0x32e31c(0x1d1)]>0x0){_0x508633[_0x32e31c(0x1e9)]((_0x3a0f89,_0xc16b88)=>_0xc16b88[_0x32e31c(0x1c8)]-_0x3a0f89['score']);if(_0x508633[0x0]['score']>0x0)return _0x508633[0x0]['id'];}}}catch(_0x1aaa3a){}return null;}function a1_0x6891(_0x24433f,_0x46b43b){const _0xd14cc9=a1_0x3933();return a1_0x6891=function(_0x460463,_0x21705b){_0x460463=_0x460463-0x1b7;let _0x3933a3=_0xd14cc9[_0x460463];return _0x3933a3;},a1_0x6891(_0x24433f,_0x46b43b);}async function scanThermostats(_0x4b6e25){const _0x39859d=a1_0x220e2a,_0x6fe015=_0x4b6e25[_0x39859d(0x1f6)][_0x39859d(0x1fb)]||[],_0x4721c3=[],_0x40befd=_0x6fe015[_0x39859d(0x1c2)](_0x3fb958=>_0x3fb958['id']&&_0x3fb958['id'][_0x39859d(0x1bf)](_0x39859d(0x21f))||_0x3fb958[_0x39859d(0x1df)]&&[_0x39859d(0x21f),'thermostat',_0x39859d(0x224)][_0x39859d(0x1bf)](_0x3fb958[_0x39859d(0x1df)])||_0x3fb958[_0x39859d(0x1f8)]&&_0x3fb958[_0x39859d(0x1f8)][_0x39859d(0x1bb)]()[_0x39859d(0x1bf)](_0x39859d(0x230)));for(const _0x24d232 of _0x40befd){const _0xae4596=await findRelatedId(_0x4b6e25,_0x24d232['id'],_0x39859d(0x1ec)),_0x4c776e=await findRelatedId(_0x4b6e25,_0x24d232['id'],_0x39859d(0x1b8));let _0xb8db17='Nicht\x20gefunden',_0x583088=![],_0x18a899=_0x4b6e25[_0x39859d(0x1f6)]['thermostatMapping']||{};if(typeof _0x18a899===_0x39859d(0x1e8))try{_0x18a899=JSON[_0x39859d(0x236)](_0x18a899);}catch(_0x3b0fd4){}let _0x429f5c=_0x4b6e25[_0x39859d(0x1f6)][_0x39859d(0x215)]||{};if(typeof _0x429f5c===_0x39859d(0x1e8))try{_0x429f5c=JSON[_0x39859d(0x236)](_0x429f5c);}catch(_0x40c20a){}if(_0x18a899[_0x24d232['id']]&&_0x18a899[_0x24d232['id']]===_0xae4596||_0x429f5c[_0x24d232['id']]&&_0x429f5c[_0x24d232['id']]===_0x4c776e)_0xb8db17='Manuelles\x20Mapping',_0x583088=!![];else(_0xae4596||_0x4c776e)&&(_0xb8db17=_0x39859d(0x1e5));_0x4721c3[_0x39859d(0x1c5)]({'room':_0x24d232[_0x39859d(0x228)]||_0x39859d(0x238),'sensorId':_0x24d232['id'],'setpointId':_0xae4596||'-','valveId':_0x4c776e||'-','source':_0xb8db17,'isManual':_0x583088,'status':_0xae4596&&_0x4c776e?_0x39859d(0x227):_0xae4596?'OK':_0x39859d(0x1c6)});}return _0x4721c3[_0x39859d(0x1e9)]((_0x34f6b7,_0x526544)=>_0x34f6b7[_0x39859d(0x1e4)][_0x39859d(0x1c9)](_0x526544['room']));}async function checkCalendarTriggers(_0x1400f2){const _0x1c95ea=a1_0x220e2a;if(!_0x1400f2['config'][_0x1c95ea(0x1b7)]||!_0x1400f2[_0x1c95ea(0x1f6)][_0x1c95ea(0x22a)])return;let _0xc4cb22={};try{const _0x3e2d55=await _0x1400f2['getStateAsync'](_0x1c95ea(0x1e7));if(_0x3e2d55&&_0x3e2d55[_0x1c95ea(0x20a)])_0xc4cb22=JSON[_0x1c95ea(0x236)](_0x3e2d55[_0x1c95ea(0x20a)]);}catch(_0xa03545){}try{const _0x54d181=await _0x1400f2[_0x1c95ea(0x234)](_0x1400f2[_0x1c95ea(0x1f6)][_0x1c95ea(0x22a)]+_0x1c95ea(0x1dc));if(!_0x54d181||!_0x54d181['val'])return;const _0x481e12=JSON[_0x1c95ea(0x236)](_0x54d181['val']),_0x4b2d0b=new Date(),_0x3b08b9=_0x1400f2[_0x1c95ea(0x1f6)][_0x1c95ea(0x1fb)]||[],_0x115917=_0x1400f2[_0x1c95ea(0x1f6)][_0x1c95ea(0x1d4)]||[];for(const _0x17d0d3 of _0x481e12){if(_0x17d0d3[_0x1c95ea(0x200)]&&_0x115917[_0x1c95ea(0x1d1)]>0x0&&!_0x115917[_0x1c95ea(0x1bf)](_0x17d0d3[_0x1c95ea(0x200)]))continue;const _0x43de8c=new Date(_0x17d0d3['eventStart']),_0x4d832b=(_0x17d0d3[_0x1c95ea(0x1c1)]||_0x17d0d3[_0x1c95ea(0x219)]||'')[_0x1c95ea(0x1bb)]();if(_0x4d832b[_0x1c95ea(0x1bf)](_0x1c95ea(0x1c7))||_0x4d832b[_0x1c95ea(0x1bf)]('r√ºckkehr')||_0x4d832b['includes'](_0x1c95ea(0x203))){let _0x34231d=0x0;Object['values'](_0xc4cb22)[_0x1c95ea(0x1e0)](_0x2f4004=>{if(_0x2f4004>_0x34231d)_0x34231d=_0x2f4004;});if(_0x34231d===0x0)_0x34231d=0x78;const _0x3d7375=new Date(_0x43de8c['getTime']()-_0x34231d*0xea60),_0x39b5f6=_0x4b2d0b['getTime']()-_0x3d7375[_0x1c95ea(0x1f1)]();_0x39b5f6>=0x0&&_0x39b5f6<0xf*0xea60&&(_0x1400f2['log'][_0x1c95ea(0x1cf)](_0x1c95ea(0x1eb)+_0x17d0d3[_0x1c95ea(0x1c1)]+_0x1c95ea(0x1f2)+_0x34231d+'\x20min).'),await _0x1400f2[_0x1c95ea(0x1be)](_0x1c95ea(0x1d5),{'val':'normal','ack':![]}));}for(const _0x1f9854 of _0x3b08b9){if(_0x1f9854[_0x1c95ea(0x228)]){const _0x1d90ab=_0x1f9854['location']['toLowerCase']();if(_0x4d832b[_0x1c95ea(0x1bf)](_0x1d90ab)){const _0x42f7d3=_0xc4cb22[_0x1f9854['location']]||0x3c,_0x1380f9=new Date(_0x43de8c['getTime']()-_0x42f7d3*0xea60),_0x2d104e=_0x4b2d0b[_0x1c95ea(0x1f1)]()-_0x1380f9['getTime']();if(_0x2d104e>=0x0&&_0x2d104e<0xf*0xea60){const _0x484442=await findRelatedId(_0x1400f2,_0x1f9854['id'],_0x1c95ea(0x1ec));_0x484442&&(_0x1400f2[_0x1c95ea(0x1ed)][_0x1c95ea(0x1cf)](_0x1c95ea(0x1f4)+_0x1f9854['location']+_0x1c95ea(0x22d)+_0x17d0d3[_0x1c95ea(0x1c1)]+_0x1c95ea(0x1c4)+_0x42f7d3+_0x1c95ea(0x235)),await _0x1400f2[_0x1c95ea(0x21e)](_0x484442,0x15),await _0x1400f2[_0x1c95ea(0x1be)](_0x1c95ea(0x233),{'val':_0x1c95ea(0x1d3)+_0x1f9854['location']+_0x1c95ea(0x20c),'ack':!![]}));}}}}}}catch(_0x33bd06){_0x1400f2['log'][_0x1c95ea(0x1ca)](_0x1c95ea(0x1c3)+_0x33bd06['message']);}}async function applyEnergySavings(_0x5a69f6,_0xa38211){const _0x43e351=a1_0x220e2a,_0x9702a1=_0x5a69f6[_0x43e351(0x1f6)]['devices']||[];for(const _0x234e42 of _0xa38211){const _0x33d948=_0x234e42[_0x43e351(0x1e4)],_0x2f1e0b=_0x234e42[_0x43e351(0x1ea)],_0x2f1b2a=Date[_0x43e351(0x1cc)]();if(lastActions[_0x43e351(0x212)+_0x33d948]&&_0x2f1b2a-lastActions[_0x43e351(0x212)+_0x33d948]<0x1e*0x3c*0x3e8)continue;const _0xc67892=_0x9702a1[_0x43e351(0x204)](_0x3836f3=>normalize(_0x3836f3[_0x43e351(0x228)])===normalize(_0x33d948));if(!_0xc67892)continue;const _0x5137f5=await findRelatedId(_0x5a69f6,_0xc67892['id'],_0x43e351(0x1ec));if(_0x5137f5){const _0x4d8210=await _0x5a69f6[_0x43e351(0x234)](_0x5137f5);if(_0x4d8210&&typeof _0x4d8210[_0x43e351(0x20a)]===_0x43e351(0x1d8)){const _0x4afce1=_0x4d8210[_0x43e351(0x20a)];if(_0x2f1e0b>0x1e&&_0x4afce1>0x11){const _0x5ea931=_0x4afce1-0x1;_0x5a69f6[_0x43e351(0x1ed)][_0x43e351(0x1cf)](_0x43e351(0x1d2)+_0x33d948+'\x20('+_0x5137f5+_0x43e351(0x201)+_0x5ea931+'¬∞C\x20(Coasting\x20m√∂glich:\x20'+_0x2f1e0b+_0x43e351(0x213)),await _0x5a69f6[_0x43e351(0x21e)](_0x5137f5,_0x5ea931),lastActions['mpc_'+_0x33d948]=_0x2f1b2a,await _0x5a69f6[_0x43e351(0x1be)](_0x43e351(0x233),{'val':'[MPC]\x20'+_0x33d948+_0x43e351(0x1fd),'ack':!![]});}}}}}module['exports']={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};