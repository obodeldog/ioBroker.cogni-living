const a1_0x22e72a=a1_0x5712;(function(_0x5b0807,_0x24861f){const _0x3267d7=a1_0x5712,_0x4e318c=_0x5b0807();while(!![]){try{const _0x2ad3a=-parseInt(_0x3267d7(0xa7))/0x1+-parseInt(_0x3267d7(0xd5))/0x2*(-parseInt(_0x3267d7(0xc4))/0x3)+parseInt(_0x3267d7(0xc3))/0x4*(parseInt(_0x3267d7(0xb4))/0x5)+-parseInt(_0x3267d7(0x112))/0x6*(parseInt(_0x3267d7(0xad))/0x7)+-parseInt(_0x3267d7(0xcc))/0x8*(-parseInt(_0x3267d7(0x95))/0x9)+parseInt(_0x3267d7(0xe8))/0xa+-parseInt(_0x3267d7(0xe3))/0xb*(-parseInt(_0x3267d7(0xaf))/0xc);if(_0x2ad3a===_0x24861f)break;else _0x4e318c['push'](_0x4e318c['shift']());}catch(_0x2c0981){_0x4e318c['push'](_0x4e318c['shift']());}}}(a1_0x8f25,0xb4ba8));const a1_0x12345b=(function(){let _0x48245e=!![];return function(_0x1b2cdc,_0x5f5ab5){const _0x697f43=_0x48245e?function(){const _0x26b82a=a1_0x5712;if(_0x5f5ab5){const _0x22e8fe=_0x5f5ab5[_0x26b82a(0xac)](_0x1b2cdc,arguments);return _0x5f5ab5=null,_0x22e8fe;}}:function(){};return _0x48245e=![],_0x697f43;};}()),a1_0x5d8152=a1_0x12345b(this,function(){const _0x456fae=a1_0x5712;return a1_0x5d8152[_0x456fae(0x10a)]()[_0x456fae(0xa5)]('(((.+)+)+)+$')[_0x456fae(0x10a)]()[_0x456fae(0xa4)](a1_0x5d8152)['search'](_0x456fae(0xa6));});a1_0x5d8152();'use strict';const aiAgent=require(a1_0x22e72a(0xb5)),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function a1_0x8f25(){const _0x45b9fc=['12szcrNz','temperature','Manuelles\x20Mapping','\x20min).','pi_heating_demand','1765ZoRbnc','./ai_agent','score','approved','level.temperature','messwert','target','valve_position','ðŸƒ\x20MPC\x20Autonomy:\x20Senke\x20','calendarInstance','calendarSelection','valveMapping','Fehlt','\x20min)','filter','4356hohBoM','99uUbvHr','unit','number','now','reason','role','trim','map','40lVVdCg','setpoint','analysis.energy.warmupTimes',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','join','temp','string','message','split','13956OTRsCv','find','.1.SET_POINT_TEMPERATURE','length','state','active','openknx','Soll','level.valve','getForeignObjectAsync','thermostatMapping','common','getTime','warn','14932533DcOxsO','dimmer','\x20->\x2021Â°C','consultButler','.1.ACTUAL_TEMPERATURE','2363310ZiHWXO','config','ACTUAL','_calName','log','ist','\x27\x20erkannt\x20(','minutes_safe','replace','off','toUpperCase','parse','setStateAsync','mpc_','level','.4.VALVE_STATE','.data.table','values','actual','slice','sort','getForeignObjectsAsync','SET','ðŸ“…\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','setForeignStateAsync','analysis.automation.lastAction','info','val','includes','SET_POINT_TEMPERATURE','getStateAsync','.1.TEMPERATURE','room','event','toString','push','Auto-Erkennung','type','location','Unknown','getForeignStateAsync','devices','2931132EIYqtA','valve','Nicht\x20gefunden','\x20->\x20Schalte\x20','1504161LVDFYM','.1.LEVEL','local_temperature','position','soll','wert','system.mode','sensor','Unbekannt','ðŸ“…\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27',')\x20auf\x20','normal','name','urlaub\x20ende','toLowerCase','constructor','search','(((.+)+)+)+$','1326862CdhEic','forEach','thermostat',':\x20-1Â°C\x20(Sparpotenzial\x20genutzt)',').\x20Heize\x20auf\x2021Â°C\x20(Vorlauf:\x20','apply','14bhxKvf','switch'];a1_0x8f25=function(){return _0x45b9fc;};return a1_0x8f25();}function normalize(_0x1b68f8){const _0x2a3f87=a1_0x22e72a;if(!_0x1b68f8)return'';return _0x1b68f8['toLowerCase']()[_0x2a3f87(0xf0)](/\s+/g,'')[_0x2a3f87(0xca)]();}async function handlePrediction(_0x49ddab,_0x583925,_0x53d44a){const _0x3b62ee=a1_0x22e72a;if(!_0x583925||_0x583925===_0x3b62ee(0x10f))return;let _0x31403b=_0x3b62ee(0xf1),_0x5780df=0.6;try{const _0x5b7cab=await _0x49ddab[_0x3b62ee(0x106)]('analysis.automation.mode');if(_0x5b7cab&&_0x5b7cab[_0x3b62ee(0x103)])_0x31403b=_0x5b7cab['val'];const _0x1e8f01=await _0x49ddab['getStateAsync']('analysis.automation.confidenceThreshold');if(_0x1e8f01&&_0x1e8f01[_0x3b62ee(0x103)])_0x5780df=_0x1e8f01[_0x3b62ee(0x103)];}catch(_0x3062e4){}if(_0x31403b===_0x3b62ee(0xf1)||_0x53d44a<_0x5780df)return;const _0x4009f9=Date['now']();if(lastActions[_0x583925]&&_0x4009f9-lastActions[_0x583925]<COOLDOWN_MS)return;const _0x49ac86=_0x49ddab['config'][_0x3b62ee(0x111)]||[],_0x41a793=normalize(_0x583925),_0x409de5=_0x49ac86[_0x3b62ee(0xd6)](_0x5f1f05=>normalize(_0x5f1f05[_0x3b62ee(0x10e)])===_0x41a793&&(_0x5f1f05['type']==='light'||_0x5f1f05[_0x3b62ee(0x10d)]===_0x3b62ee(0xe4)||_0x5f1f05[_0x3b62ee(0x10d)]===_0x3b62ee(0xae)));if(!_0x409de5){_0x49ddab[_0x3b62ee(0xec)]['debug']('ðŸ”\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27'+_0x583925+'\x27.');return;}const _0x2fe6e0=await aiAgent[_0x3b62ee(0xe6)](_0x49ddab,_0x583925,_0x409de5['name'],_0x53d44a);if(!_0x2fe6e0[_0x3b62ee(0xb7)])return;const _0x4ec553='PrÃ¤diktion:\x20'+_0x583925+_0x3b62ee(0x94)+_0x409de5[_0x3b62ee(0xa1)]+'\x20('+_0x2fe6e0[_0x3b62ee(0xc8)]+')';await _0x49ddab[_0x3b62ee(0xf4)](_0x3b62ee(0x101),{'val':'['+_0x31403b[_0x3b62ee(0xf2)]()+']\x20'+_0x4ec553,'ack':!![]});if(_0x31403b===_0x3b62ee(0xda)){const _0x4eaddf=await _0x49ddab[_0x3b62ee(0x110)](_0x409de5['id']);(!_0x4eaddf||!_0x4eaddf['val']&&_0x4eaddf['val']!==!![])&&await _0x49ddab[_0x3b62ee(0x100)](_0x409de5['id'],!![]),lastActions[_0x583925]=_0x4009f9;}}function a1_0x5712(_0x184377,_0x366b0d){const _0x5a5418=a1_0x8f25();return a1_0x5712=function(_0x5d8152,_0x12345b){_0x5d8152=_0x5d8152-0x94;let _0x8f25e0=_0x5a5418[_0x5d8152];return _0x8f25e0;},a1_0x5712(_0x184377,_0x366b0d);}async function findRelatedId(_0x1ee483,_0x5adc7f,_0x1990e0=a1_0x22e72a(0xcd)){const _0x349b6d=a1_0x22e72a;if(_0x1990e0==='setpoint'&&_0x1ee483['config'][_0x349b6d(0xdf)]){let _0x461440=_0x1ee483[_0x349b6d(0xe9)][_0x349b6d(0xdf)];if(typeof _0x461440===_0x349b6d(0xd2))try{_0x461440=JSON[_0x349b6d(0xf3)](_0x461440);}catch(_0x417f75){}if(_0x461440&&_0x461440[_0x5adc7f])return _0x461440[_0x5adc7f];}if(_0x1990e0===_0x349b6d(0x113)&&_0x1ee483['config']['valveMapping']){let _0x5099eb=_0x1ee483[_0x349b6d(0xe9)][_0x349b6d(0xbf)];if(typeof _0x5099eb===_0x349b6d(0xd2))try{_0x5099eb=JSON['parse'](_0x5099eb);}catch(_0x148906){}if(_0x5099eb&&_0x5099eb[_0x5adc7f])return _0x5099eb[_0x5adc7f];}let _0x58c3b1=[];if(_0x1990e0===_0x349b6d(0xcd))_0x58c3b1=[{'s':_0x349b6d(0xe7),'t':_0x349b6d(0xd7)},{'s':_0x349b6d(0x107),'t':_0x349b6d(0xd7)},{'s':_0x349b6d(0x107),'t':'.4.SET_TEMPERATURE'},{'s':'ACTUAL_TEMPERATURE','t':_0x349b6d(0x105)},{'s':'local_temperature','t':'occupied_heating_setpoint'},{'s':_0x349b6d(0x97),'t':'current_heating_setpoint'},{'s':_0x349b6d(0xb0),'t':'target_temperature'},{'s':_0x349b6d(0xea),'t':_0x349b6d(0xfe)},{'s':'Ist','t':_0x349b6d(0xdc)},{'s':_0x349b6d(0xb0),'t':_0x349b6d(0xcd)}];else _0x1990e0===_0x349b6d(0x113)&&(_0x58c3b1=[{'s':_0x349b6d(0xe7),'t':_0x349b6d(0x96)},{'s':_0x349b6d(0x107),'t':_0x349b6d(0x96)},{'s':'.1.TEMPERATURE','t':_0x349b6d(0xf7)},{'s':_0x349b6d(0x97),'t':_0x349b6d(0xb3)},{'s':'temperature','t':_0x349b6d(0xbb)},{'s':_0x349b6d(0xb0),'t':_0x349b6d(0xf6)}]);for(const _0x2e98e7 of _0x58c3b1){if(_0x5adc7f[_0x349b6d(0x104)](_0x2e98e7['s'])){const _0x253ea9=_0x5adc7f[_0x349b6d(0xf0)](_0x2e98e7['s'],_0x2e98e7['t']),_0x813e05=await _0x1ee483[_0x349b6d(0xde)](_0x253ea9);if(_0x813e05)return _0x253ea9;}}try{const _0x4fe0c1=_0x5adc7f[_0x349b6d(0xd4)]('.');if(_0x4fe0c1[_0x349b6d(0xd8)]>0x2){const _0x4c6ee6=_0x4fe0c1[_0x349b6d(0xfb)](0x0,-0x1)[_0x349b6d(0xd0)]('.'),_0x2f67d7=await _0x1ee483[_0x349b6d(0xfd)](_0x4c6ee6+'.*'),_0x2ecd68=[],_0x300465=_0x5adc7f[_0x349b6d(0xd4)](/[._]+/)[_0x349b6d(0xc2)](_0x4da47b=>![_0x349b6d(0xdb),'0','hm-rpc',_0x349b6d(0xed),_0x349b6d(0x9a),_0x349b6d(0xb0),_0x349b6d(0xfa),'sensor',_0x349b6d(0xb9),_0x349b6d(0xd9)][_0x349b6d(0x104)](_0x4da47b[_0x349b6d(0xa3)]()));for(const [_0x3be23f,_0x4bae22]of Object['entries'](_0x2f67d7)){if(_0x3be23f===_0x5adc7f)continue;if(_0x4bae22&&_0x4bae22[_0x349b6d(0xe0)]){const _0x10985e=_0x3be23f[_0x349b6d(0xa3)](),_0x2f71c2=(_0x4bae22['common'][_0x349b6d(0xc9)]||'')[_0x349b6d(0xa3)](),_0x958ed4=(_0x4bae22[_0x349b6d(0xe0)][_0x349b6d(0xc5)]||'')[_0x349b6d(0xa3)]();let _0x2dde7e=![];if(_0x1990e0==='setpoint'&&_0x4bae22[_0x349b6d(0xe0)]['write']===!![])_0x2dde7e=_0x10985e['includes']('set')||_0x10985e['includes'](_0x349b6d(0x99))||_0x10985e[_0x349b6d(0x104)](_0x349b6d(0xba))||_0x2f71c2['includes'](_0x349b6d(0xb8))||_0x2f71c2[_0x349b6d(0x104)]('thermostat.setpoint');else _0x1990e0===_0x349b6d(0x113)&&(_0x2dde7e=_0x10985e[_0x349b6d(0x104)]('level')||_0x10985e[_0x349b6d(0x104)]('valve')||_0x10985e['includes']('stellwert')||_0x10985e[_0x349b6d(0x104)](_0x349b6d(0x98))||_0x2f71c2['includes'](_0x349b6d(0xdd))||_0x2f71c2[_0x349b6d(0x104)]('value.valve')||_0x958ed4[_0x349b6d(0x104)]('%'));if(_0x2dde7e){const _0x166b7b=_0x3be23f[_0x349b6d(0xd4)](/[._]+/)[_0x349b6d(0xcb)](_0x3be1d7=>_0x3be1d7[_0x349b6d(0xa3)]());let _0x177546=0x0;_0x300465[_0x349b6d(0xa8)](_0x3b962b=>{const _0x9bea28=_0x349b6d;if(_0x166b7b['includes'](_0x3b962b[_0x9bea28(0xa3)]()))_0x177546++;}),_0x2ecd68[_0x349b6d(0x10b)]({'id':_0x3be23f,'score':_0x177546});}}}if(_0x2ecd68['length']>0x0){_0x2ecd68['sort']((_0x2c3a53,_0x538cda)=>_0x538cda[_0x349b6d(0xb6)]-_0x2c3a53['score']);if(_0x2ecd68[0x0][_0x349b6d(0xb6)]>0x0)return _0x2ecd68[0x0]['id'];}}}catch(_0x55a020){}return null;}async function scanThermostats(_0x4358ed){const _0x40277d=a1_0x22e72a,_0x18bbd6=_0x4358ed['config']['devices']||[],_0x5051c8=[],_0xae31=_0x18bbd6[_0x40277d(0xc2)](_0x1d27f2=>_0x1d27f2['id']&&_0x1d27f2['id'][_0x40277d(0x104)]('temperature')||_0x1d27f2[_0x40277d(0x10d)]&&[_0x40277d(0xb0),_0x40277d(0xa9),_0x40277d(0x9c)][_0x40277d(0x104)](_0x1d27f2[_0x40277d(0x10d)])||_0x1d27f2[_0x40277d(0xa1)]&&_0x1d27f2[_0x40277d(0xa1)][_0x40277d(0xa3)]()[_0x40277d(0x104)](_0x40277d(0xd1)));for(const _0x5ea1b8 of _0xae31){const _0x5f17c2=await findRelatedId(_0x4358ed,_0x5ea1b8['id'],'setpoint'),_0x4858e5=await findRelatedId(_0x4358ed,_0x5ea1b8['id'],'valve');let _0xb90ad8=_0x40277d(0x114),_0x158b1d=![],_0x350a49=_0x4358ed[_0x40277d(0xe9)][_0x40277d(0xdf)]||{};if(typeof _0x350a49==='string')try{_0x350a49=JSON[_0x40277d(0xf3)](_0x350a49);}catch(_0x167806){}let _0xa62a9b=_0x4358ed['config'][_0x40277d(0xbf)]||{};if(typeof _0xa62a9b===_0x40277d(0xd2))try{_0xa62a9b=JSON[_0x40277d(0xf3)](_0xa62a9b);}catch(_0x1a0acc){}if(_0x350a49[_0x5ea1b8['id']]&&_0x350a49[_0x5ea1b8['id']]===_0x5f17c2||_0xa62a9b[_0x5ea1b8['id']]&&_0xa62a9b[_0x5ea1b8['id']]===_0x4858e5)_0xb90ad8=_0x40277d(0xb1),_0x158b1d=!![];else(_0x5f17c2||_0x4858e5)&&(_0xb90ad8=_0x40277d(0x10c));_0x5051c8[_0x40277d(0x10b)]({'room':_0x5ea1b8[_0x40277d(0x10e)]||_0x40277d(0x9d),'sensorId':_0x5ea1b8['id'],'setpointId':_0x5f17c2||'-','valveId':_0x4858e5||'-','source':_0xb90ad8,'isManual':_0x158b1d,'status':_0x5f17c2&&_0x4858e5?'PERFECT':_0x5f17c2?'OK':_0x40277d(0xc0)});}return _0x5051c8[_0x40277d(0xfc)]((_0x2196fc,_0x4365ce)=>_0x2196fc[_0x40277d(0x108)]['localeCompare'](_0x4365ce[_0x40277d(0x108)]));}async function checkCalendarTriggers(_0x436f30){const _0x487fb9=a1_0x22e72a;if(!_0x436f30[_0x487fb9(0xe9)]['useCalendar']||!_0x436f30[_0x487fb9(0xe9)][_0x487fb9(0xbd)])return;let _0x493318={};try{const _0x22b59d=await _0x436f30['getStateAsync'](_0x487fb9(0xce));if(_0x22b59d&&_0x22b59d[_0x487fb9(0x103)])_0x493318=JSON[_0x487fb9(0xf3)](_0x22b59d[_0x487fb9(0x103)]);}catch(_0x4c69e9){}try{const _0x2d6075=await _0x436f30[_0x487fb9(0x110)](_0x436f30[_0x487fb9(0xe9)]['calendarInstance']+_0x487fb9(0xf8));if(!_0x2d6075||!_0x2d6075[_0x487fb9(0x103)])return;const _0x184d18=JSON[_0x487fb9(0xf3)](_0x2d6075[_0x487fb9(0x103)]),_0x4f9d19=new Date(),_0x4d2e2b=_0x436f30[_0x487fb9(0xe9)][_0x487fb9(0x111)]||[],_0x13416f=_0x436f30['config'][_0x487fb9(0xbe)]||[];for(const _0x493e42 of _0x184d18){if(_0x493e42[_0x487fb9(0xeb)]&&_0x13416f[_0x487fb9(0xd8)]>0x0&&!_0x13416f[_0x487fb9(0x104)](_0x493e42[_0x487fb9(0xeb)]))continue;const _0x58e297=new Date(_0x493e42['eventStart']),_0x21023e=(_0x493e42[_0x487fb9(0x109)]||_0x493e42['summary']||'')[_0x487fb9(0xa3)]();if(_0x21023e[_0x487fb9(0x104)](_0x487fb9(0xa2))||_0x21023e[_0x487fb9(0x104)]('rÃ¼ckkehr')||_0x21023e['includes']('ankunft')){let _0x3ed05f=0x0;Object[_0x487fb9(0xf9)](_0x493318)[_0x487fb9(0xa8)](_0xc73220=>{if(_0xc73220>_0x3ed05f)_0x3ed05f=_0xc73220;});if(_0x3ed05f===0x0)_0x3ed05f=0x78;const _0x40462a=new Date(_0x58e297[_0x487fb9(0xe1)]()-_0x3ed05f*0xea60),_0x12c535=_0x4f9d19[_0x487fb9(0xe1)]()-_0x40462a[_0x487fb9(0xe1)]();_0x12c535>=0x0&&_0x12c535<0xf*0xea60&&(_0x436f30[_0x487fb9(0xec)]['info'](_0x487fb9(0xff)+_0x493e42[_0x487fb9(0x109)]+_0x487fb9(0xcf)+_0x3ed05f+_0x487fb9(0xb2)),await _0x436f30[_0x487fb9(0xf4)](_0x487fb9(0x9b),{'val':_0x487fb9(0xa0),'ack':![]}));}for(const _0x139824 of _0x4d2e2b){if(_0x139824['location']){const _0x55e971=_0x139824[_0x487fb9(0x10e)][_0x487fb9(0xa3)]();if(_0x21023e['includes'](_0x55e971)){const _0x4e44cc=_0x493318[_0x139824['location']]||0x3c,_0x35eb37=new Date(_0x58e297[_0x487fb9(0xe1)]()-_0x4e44cc*0xea60),_0x315003=_0x4f9d19[_0x487fb9(0xe1)]()-_0x35eb37[_0x487fb9(0xe1)]();if(_0x315003>=0x0&&_0x315003<0xf*0xea60){const _0x49069e=await findRelatedId(_0x436f30,_0x139824['id'],'setpoint');_0x49069e&&(_0x436f30['log'][_0x487fb9(0x102)](_0x487fb9(0x9e)+_0x139824[_0x487fb9(0x10e)]+_0x487fb9(0xee)+_0x493e42[_0x487fb9(0x109)]+_0x487fb9(0xab)+_0x4e44cc+_0x487fb9(0xb2)),await _0x436f30['setForeignStateAsync'](_0x49069e,0x15),await _0x436f30['setStateAsync'](_0x487fb9(0x101),{'val':'[CAL]\x20'+_0x139824['location']+_0x487fb9(0xe5),'ack':!![]}));}}}}}}catch(_0x8c4edd){_0x436f30[_0x487fb9(0xec)][_0x487fb9(0xe2)]('Calendar\x20Check\x20Error:\x20'+_0x8c4edd[_0x487fb9(0xd3)]);}}async function applyEnergySavings(_0x51e781,_0x48bc71){const _0x28ff0f=a1_0x22e72a,_0x4d8192=_0x51e781[_0x28ff0f(0xe9)][_0x28ff0f(0x111)]||[];for(const _0x413023 of _0x48bc71){const _0x5acedb=_0x413023[_0x28ff0f(0x108)],_0x48d4f5=_0x413023[_0x28ff0f(0xef)],_0x3870d3=Date[_0x28ff0f(0xc7)]();if(lastActions['mpc_'+_0x5acedb]&&_0x3870d3-lastActions[_0x28ff0f(0xf5)+_0x5acedb]<0x1e*0x3c*0x3e8)continue;const _0x4776af=_0x4d8192[_0x28ff0f(0xd6)](_0x59aeab=>normalize(_0x59aeab[_0x28ff0f(0x10e)])===normalize(_0x5acedb));if(!_0x4776af)continue;const _0x245805=await findRelatedId(_0x51e781,_0x4776af['id'],_0x28ff0f(0xcd));if(_0x245805){const _0x3bdfb5=await _0x51e781[_0x28ff0f(0x110)](_0x245805);if(_0x3bdfb5&&typeof _0x3bdfb5['val']===_0x28ff0f(0xc6)){const _0x4826f7=_0x3bdfb5[_0x28ff0f(0x103)];if(_0x48d4f5>0x1e&&_0x4826f7>0x11){const _0x2173a0=_0x4826f7-0x1;_0x51e781['log'][_0x28ff0f(0x102)](_0x28ff0f(0xbc)+_0x5acedb+'\x20('+_0x245805+_0x28ff0f(0x9f)+_0x2173a0+'Â°C\x20(Coasting\x20mÃ¶glich:\x20'+_0x48d4f5+_0x28ff0f(0xc1)),await _0x51e781['setForeignStateAsync'](_0x245805,_0x2173a0),lastActions[_0x28ff0f(0xf5)+_0x5acedb]=_0x3870d3,await _0x51e781[_0x28ff0f(0xf4)](_0x28ff0f(0x101),{'val':'[MPC]\x20'+_0x5acedb+_0x28ff0f(0xaa),'ack':!![]});}}}}}module['exports']={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};