const a1_0x5e3925=a1_0x3337;(function(_0x2f7334,_0x36c8f6){const _0x2abd15=a1_0x3337,_0x429607=_0x2f7334();while(!![]){try{const _0xf13a6a=-parseInt(_0x2abd15(0x1b7))/0x1+-parseInt(_0x2abd15(0x201))/0x2*(-parseInt(_0x2abd15(0x229))/0x3)+-parseInt(_0x2abd15(0x236))/0x4*(-parseInt(_0x2abd15(0x1ac))/0x5)+-parseInt(_0x2abd15(0x209))/0x6+-parseInt(_0x2abd15(0x1c5))/0x7*(parseInt(_0x2abd15(0x20b))/0x8)+-parseInt(_0x2abd15(0x1ca))/0x9+parseInt(_0x2abd15(0x1ee))/0xa;if(_0xf13a6a===_0x36c8f6)break;else _0x429607['push'](_0x429607['shift']());}catch(_0x519637){_0x429607['push'](_0x429607['shift']());}}}(a1_0x8de5,0x6875f));const a1_0x5803e6=(function(){let _0x56bab9=!![];return function(_0x293495,_0xe9b7ef){const _0x487763=_0x56bab9?function(){const _0x59b0af=a1_0x3337;if(_0xe9b7ef){const _0x665418=_0xe9b7ef[_0x59b0af(0x1b8)](_0x293495,arguments);return _0xe9b7ef=null,_0x665418;}}:function(){};return _0x56bab9=![],_0x487763;};}()),a1_0x15378f=a1_0x5803e6(this,function(){const _0x297ee6=a1_0x3337;return a1_0x15378f['toString']()[_0x297ee6(0x1ec)]('(((.+)+)+)+$')[_0x297ee6(0x1c9)]()['constructor'](a1_0x15378f)[_0x297ee6(0x1ec)](_0x297ee6(0x1f2));});a1_0x15378f();'use strict';const aiAgent=require(a1_0x5e3925(0x1f5)),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function a1_0x8de5(){const _0x4f3675=['_calName','pi_heating_demand','analysis.energy.warmupTimes','replace','forEach','SET_POINT_TEMPERATURE','occupied_heating_setpoint','sendToPythonWrapper','PrÃ¤diktion:\x20','slice','DEBUG:\x20Setpoint-ID\x20fÃ¼r\x20\x27','approved','.1.SET_POINT_TEMPERATURE','Manuelles\x20Mapping','currentSystemMode','type','useCalendar','analysis.energy.mpcActiveInterventions','\x20min)','score','getForeignStateAsync','Â°C!\x20(Puffer\x20leer).','20937NYCala','role',':\x20Aufheizen\x20auf\x20','exports','triggerTime','location','analysis.automation.mode','debug','_date','position','\x20min).','ðŸƒ\x20[MPC\x20ACTION]\x20Senke\x20','join','58544HpQvcF','config','getForeignObjectAsync','map','log','Â°C\x20(via\x20','urlaub\x20ende','setStateAsync','level','switch','DEBUG:\x20State\x20leer','sensor','date','devices','openknx','target_temperature','analysis.energy.warmupTargets','Â°C\x20(nicht\x20','summary','.1.LEVEL','Nicht\x20gefunden','splice','Unknown','rÃ¼ckkehr','Unbekannt','\x20gefunden!','SET','filter','active','265sAhHEL','getTime','soll','parse','Â°C\x20(Vorlauf:\x20',']:\x20Raum-Trigger\x20\x27','temp','stringify','eventStart','message','analysis.automation.actionLog','290746edUYYN','apply','DEBUG:\x20Raum-Match\x20\x27','default','mpc_','state','thermostatMapping','calendarSelection','ðŸŽ“\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20','valve_position','val','number','string','\x27\x20(Sensor:\x20','217pGhKig','valveMapping','Fehlt','Ist','toString','3102930UdALxb','DEBUG:\x20PrÃ¼fe\x20Liste:\x20','valve','room','.1.TEMPERATURE','find','toLowerCase','entries','\x20mag\x20keine\x20','ðŸ“…\x20SMART\x20SCHEDULE\x20[','target','length','now','light','setpoint','.4.VALVE_STATE','[CAL]\x20','thermostat','getStateAsync','\x27\x20gefunden.\x20Typ:\x20','Calendar\x20Check\x20Error:\x20','sort','common','DEBUG:\x20','add','null','info','analysis.energy.warmupSources','normal','ankunft','.data.table','isArray','messwert','Soll','search','analysis.energy.schedulePreview','6919600LKFdmq','includes','name','minutes_safe','(((.+)+)+)+$','remove','\x20ist\x20auf\x20','./ai_agent','push','value.valve','dimmer','unit','Classic','.1.ACTUAL_TEMPERATURE','reason','values','ist','wert','level.valve','172MVJcYA','calendarInstance','current_heating_setpoint',')\x20nicht\x20gefunden.','event','\x27\x20gefunden!\x20PrÃ¼fe\x20Schreibweise.','off','split','2345352dSGUrG','temperature','158344ZaFJKC','[MPC]\x20','setForeignStateAsync','level.temperature','from','\x27\x20aktiv.\x20Heize\x20auf\x20','local_temperature','warn'];a1_0x8de5=function(){return _0x4f3675;};return a1_0x8de5();}function a1_0x3337(_0x53352a,_0xc7657){const _0x153ba6=a1_0x8de5();return a1_0x3337=function(_0x15378f,_0x5803e6){_0x15378f=_0x15378f-0x1a3;let _0x8de52c=_0x153ba6[_0x15378f];return _0x8de52c;},a1_0x3337(_0x53352a,_0xc7657);}function normalize(_0x266703){const _0x3ee80c=a1_0x5e3925;if(!_0x266703)return'';return _0x266703[_0x3ee80c(0x1d0)]()[_0x3ee80c(0x216)](/\s+/g,'')['trim']();}async function logAutomationAction(_0x3fc32a,_0x149c95){const _0x34c39b=a1_0x5e3925;await _0x3fc32a[_0x34c39b(0x23d)]('analysis.automation.lastAction',{'val':_0x149c95,'ack':!![]});try{const _0x114ccf=_0x34c39b(0x1b6),_0x3a8713=await _0x3fc32a[_0x34c39b(0x1dc)](_0x114ccf);let _0x420644=[];if(_0x3a8713&&_0x3a8713[_0x34c39b(0x1c1)])try{_0x420644=JSON[_0x34c39b(0x1af)](_0x3a8713[_0x34c39b(0x1c1)]);}catch(_0x46379c){}_0x420644['unshift']({'ts':Date[_0x34c39b(0x1d6)](),'msg':_0x149c95});if(_0x420644[_0x34c39b(0x1d5)]>0x32)_0x420644=_0x420644[_0x34c39b(0x21c)](0x0,0x32);await _0x3fc32a[_0x34c39b(0x23d)](_0x114ccf,{'val':JSON['stringify'](_0x420644),'ack':!![]});}catch(_0x2494cd){}}async function handlePrediction(_0x2faf60,_0x4173e6,_0xa15f81){const _0x4ecbd6=a1_0x5e3925;if(!_0x4173e6||_0x4173e6===_0x4ecbd6(0x1a5))return;let _0x2de5f2=_0x4ecbd6(0x207),_0x59ecf2=0.6;try{const _0x4ce065=await _0x2faf60['getStateAsync'](_0x4ecbd6(0x22f));if(_0x4ce065&&_0x4ce065[_0x4ecbd6(0x1c1)])_0x2de5f2=_0x4ce065['val'];const _0x10ccbe=await _0x2faf60[_0x4ecbd6(0x1dc)]('analysis.automation.confidenceThreshold');if(_0x10ccbe&&_0x10ccbe[_0x4ecbd6(0x1c1)])_0x59ecf2=_0x10ccbe[_0x4ecbd6(0x1c1)];}catch(_0x180d74){}if(_0x2de5f2==='off'||_0xa15f81<_0x59ecf2)return;const _0x3e3ed9=Date[_0x4ecbd6(0x1d6)]();if(lastActions[_0x4173e6]&&_0x3e3ed9-lastActions[_0x4173e6]<COOLDOWN_MS)return;const _0x2e654a=_0x2faf60[_0x4ecbd6(0x237)][_0x4ecbd6(0x243)]||[],_0x5a9a85=normalize(_0x4173e6),_0x2d3dfd=_0x2e654a[_0x4ecbd6(0x1cf)](_0x52b497=>normalize(_0x52b497[_0x4ecbd6(0x22e)])===_0x5a9a85&&(_0x52b497[_0x4ecbd6(0x222)]===_0x4ecbd6(0x1d7)||_0x52b497[_0x4ecbd6(0x222)]===_0x4ecbd6(0x1f8)||_0x52b497[_0x4ecbd6(0x222)]===_0x4ecbd6(0x23f)));if(!_0x2d3dfd)return;const _0x484f1c=await aiAgent['consultButler'](_0x2faf60,_0x4173e6,_0x2d3dfd[_0x4ecbd6(0x1f0)],_0xa15f81);if(!_0x484f1c[_0x4ecbd6(0x21e)])return;const _0x386d09=_0x4ecbd6(0x21b)+_0x4173e6+'\x20->\x20Schalte\x20'+_0x2d3dfd['name']+'\x20('+_0x484f1c[_0x4ecbd6(0x1fc)]+')';await logAutomationAction(_0x2faf60,'['+_0x2de5f2['toUpperCase']()+']\x20'+_0x386d09);if(_0x2de5f2===_0x4ecbd6(0x1ab)){const _0x430a6d=await _0x2faf60[_0x4ecbd6(0x227)](_0x2d3dfd['id']);(!_0x430a6d||!_0x430a6d[_0x4ecbd6(0x1c1)]&&_0x430a6d[_0x4ecbd6(0x1c1)]!==!![])&&await _0x2faf60['setForeignStateAsync'](_0x2d3dfd['id'],!![]),lastActions[_0x4173e6]=_0x3e3ed9;}}async function findRelatedId(_0x4b5e1a,_0x3a1a0f,_0x319048=a1_0x5e3925(0x1d8)){const _0x4460b1=a1_0x5e3925;if(_0x319048===_0x4460b1(0x1d8)&&_0x4b5e1a[_0x4460b1(0x237)][_0x4460b1(0x1bd)]){let _0x31b990=_0x4b5e1a[_0x4460b1(0x237)]['thermostatMapping'];if(typeof _0x31b990===_0x4460b1(0x1c3))try{_0x31b990=JSON['parse'](_0x31b990);}catch(_0xf297c7){}if(_0x31b990&&_0x31b990[_0x3a1a0f])return _0x31b990[_0x3a1a0f];}if(_0x319048===_0x4460b1(0x1cc)&&_0x4b5e1a[_0x4460b1(0x237)][_0x4460b1(0x1c6)]){let _0x520599=_0x4b5e1a[_0x4460b1(0x237)][_0x4460b1(0x1c6)];if(typeof _0x520599===_0x4460b1(0x1c3))try{_0x520599=JSON['parse'](_0x520599);}catch(_0x45449d){}if(_0x520599&&_0x520599[_0x3a1a0f])return _0x520599[_0x3a1a0f];}let _0x81bc58=[];if(_0x319048===_0x4460b1(0x1d8))_0x81bc58=[{'s':_0x4460b1(0x1fb),'t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x4460b1(0x1ce),'t':_0x4460b1(0x21f)},{'s':_0x4460b1(0x1ce),'t':'.4.SET_TEMPERATURE'},{'s':'ACTUAL_TEMPERATURE','t':_0x4460b1(0x218)},{'s':_0x4460b1(0x211),'t':_0x4460b1(0x219)},{'s':_0x4460b1(0x211),'t':_0x4460b1(0x203)},{'s':_0x4460b1(0x20a),'t':_0x4460b1(0x245)},{'s':'ACTUAL','t':_0x4460b1(0x1a9)},{'s':_0x4460b1(0x1c8),'t':_0x4460b1(0x1eb)},{'s':_0x4460b1(0x20a),'t':_0x4460b1(0x1d8)}];else _0x319048===_0x4460b1(0x1cc)&&(_0x81bc58=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x4460b1(0x249)},{'s':_0x4460b1(0x1ce),'t':_0x4460b1(0x249)},{'s':_0x4460b1(0x1ce),'t':_0x4460b1(0x1d9)},{'s':'local_temperature','t':_0x4460b1(0x214)},{'s':_0x4460b1(0x20a),'t':_0x4460b1(0x1c0)},{'s':_0x4460b1(0x20a),'t':_0x4460b1(0x23e)}]);for(const _0x49c3f8 of _0x81bc58){if(_0x3a1a0f[_0x4460b1(0x1ef)](_0x49c3f8['s'])){const _0xcb5b9=_0x3a1a0f['replace'](_0x49c3f8['s'],_0x49c3f8['t']),_0x91640a=await _0x4b5e1a[_0x4460b1(0x238)](_0xcb5b9);if(_0x91640a)return _0xcb5b9;}}try{const _0x5601d7=_0x3a1a0f['split']('.');if(_0x5601d7['length']>0x2){const _0x1d8133=_0x5601d7[_0x4460b1(0x21c)](0x0,-0x1)[_0x4460b1(0x235)]('.'),_0x5e0d2f=await _0x4b5e1a['getForeignObjectsAsync'](_0x1d8133+'.*'),_0x1552e3=[],_0xe02632=_0x3a1a0f['split'](/[._]+/)[_0x4460b1(0x1aa)](_0x16f97f=>![_0x4460b1(0x244),'0','hm-rpc',_0x4460b1(0x1fe),_0x4460b1(0x1ff),_0x4460b1(0x20a),'actual',_0x4460b1(0x241),_0x4460b1(0x1ea),_0x4460b1(0x1bc)][_0x4460b1(0x1ef)](_0x16f97f[_0x4460b1(0x1d0)]()));for(const [_0x37f2ea,_0x8812f5]of Object[_0x4460b1(0x1d1)](_0x5e0d2f)){if(_0x37f2ea===_0x3a1a0f)continue;if(_0x8812f5&&_0x8812f5[_0x4460b1(0x1e0)]){const _0x1bb3b6=_0x37f2ea['toLowerCase'](),_0x4c75ff=(_0x8812f5[_0x4460b1(0x1e0)][_0x4460b1(0x22a)]||'')['toLowerCase'](),_0x3bed0f=(_0x8812f5[_0x4460b1(0x1e0)][_0x4460b1(0x1f9)]||'')['toLowerCase']();let _0x6b8825=![];if(_0x319048===_0x4460b1(0x1d8)&&_0x8812f5[_0x4460b1(0x1e0)]['write']===!![])_0x6b8825=_0x1bb3b6[_0x4460b1(0x1ef)]('set')||_0x1bb3b6[_0x4460b1(0x1ef)](_0x4460b1(0x1ae))||_0x1bb3b6[_0x4460b1(0x1ef)]('target')||_0x4c75ff['includes'](_0x4460b1(0x20e))||_0x4c75ff[_0x4460b1(0x1ef)]('thermostat.setpoint');else _0x319048==='valve'&&(_0x6b8825=_0x1bb3b6[_0x4460b1(0x1ef)](_0x4460b1(0x23e))||_0x1bb3b6[_0x4460b1(0x1ef)]('valve')||_0x1bb3b6[_0x4460b1(0x1ef)]('stellwert')||_0x1bb3b6[_0x4460b1(0x1ef)](_0x4460b1(0x232))||_0x4c75ff['includes'](_0x4460b1(0x200))||_0x4c75ff['includes'](_0x4460b1(0x1f7))||_0x3bed0f[_0x4460b1(0x1ef)]('%'));if(_0x6b8825){const _0x38cce0=_0x37f2ea[_0x4460b1(0x208)](/[._]+/)[_0x4460b1(0x239)](_0x3f0663=>_0x3f0663[_0x4460b1(0x1d0)]());let _0x3b6e20=0x0;_0xe02632[_0x4460b1(0x217)](_0x20319c=>{const _0xef13a8=_0x4460b1;if(_0x38cce0['includes'](_0x20319c[_0xef13a8(0x1d0)]()))_0x3b6e20++;}),_0x1552e3['push']({'id':_0x37f2ea,'score':_0x3b6e20});}}}if(_0x1552e3[_0x4460b1(0x1d5)]>0x0){_0x1552e3['sort']((_0x80ddcc,_0x3d62bb)=>_0x3d62bb[_0x4460b1(0x226)]-_0x80ddcc[_0x4460b1(0x226)]);if(_0x1552e3[0x0][_0x4460b1(0x226)]>0x0)return _0x1552e3[0x0]['id'];}}}catch(_0x2c5822){}return null;}async function scanThermostats(_0x5481c5){const _0x5ed7fe=a1_0x5e3925,_0x10c984=_0x5481c5[_0x5ed7fe(0x237)][_0x5ed7fe(0x243)]||[],_0xa98cae=[],_0x1dc203=_0x10c984['filter'](_0xe10743=>_0xe10743['id']&&_0xe10743['id'][_0x5ed7fe(0x1ef)](_0x5ed7fe(0x20a))||_0xe10743['type']&&[_0x5ed7fe(0x20a),_0x5ed7fe(0x1db),_0x5ed7fe(0x241)][_0x5ed7fe(0x1ef)](_0xe10743[_0x5ed7fe(0x222)])||_0xe10743['name']&&_0xe10743['name'][_0x5ed7fe(0x1d0)]()['includes'](_0x5ed7fe(0x1b2)));for(const _0x342344 of _0x1dc203){const _0x542305=await findRelatedId(_0x5481c5,_0x342344['id'],_0x5ed7fe(0x1d8)),_0x229129=await findRelatedId(_0x5481c5,_0x342344['id'],_0x5ed7fe(0x1cc));let _0x2f91e4=_0x5ed7fe(0x1a3),_0x34e8b4=![],_0x20eb9f=_0x5481c5['config'][_0x5ed7fe(0x1bd)]||{};if(typeof _0x20eb9f===_0x5ed7fe(0x1c3))try{_0x20eb9f=JSON[_0x5ed7fe(0x1af)](_0x20eb9f);}catch(_0x5d5dc4){}let _0x2c01a9=_0x5481c5['config'][_0x5ed7fe(0x1c6)]||{};if(typeof _0x2c01a9==='string')try{_0x2c01a9=JSON[_0x5ed7fe(0x1af)](_0x2c01a9);}catch(_0x540579){}if(_0x20eb9f[_0x342344['id']]&&_0x20eb9f[_0x342344['id']]===_0x542305||_0x2c01a9[_0x342344['id']]&&_0x2c01a9[_0x342344['id']]===_0x229129)_0x2f91e4=_0x5ed7fe(0x220),_0x34e8b4=!![];else(_0x542305||_0x229129)&&(_0x2f91e4='Auto-Erkennung');_0xa98cae['push']({'room':_0x342344[_0x5ed7fe(0x22e)]||_0x5ed7fe(0x1a7),'sensorId':_0x342344['id'],'setpointId':_0x542305||'-','valveId':_0x229129||'-','source':_0x2f91e4,'isManual':_0x34e8b4,'status':_0x542305&&_0x229129?'PERFECT':_0x542305?'OK':_0x5ed7fe(0x1c7)});}return _0xa98cae[_0x5ed7fe(0x1df)]((_0x42ecf4,_0xe01111)=>_0x42ecf4[_0x5ed7fe(0x1cd)]['localeCompare'](_0xe01111[_0x5ed7fe(0x1cd)]));}async function updateSchedulePreview(_0x116533){const _0x2488f5=a1_0x5e3925;if(!_0x116533[_0x2488f5(0x237)][_0x2488f5(0x223)]||!_0x116533[_0x2488f5(0x237)][_0x2488f5(0x202)])return;let _0x81c3bf={};try{const _0x6d169f=await _0x116533['getStateAsync'](_0x2488f5(0x215));if(_0x6d169f&&_0x6d169f[_0x2488f5(0x1c1)])_0x81c3bf=JSON[_0x2488f5(0x1af)](_0x6d169f['val']);}catch(_0x502246){}const _0x29eb47=[],_0x11208e=Date[_0x2488f5(0x1d6)](),_0x32a7d0=0x30*0x3c*0x3c*0x3e8;try{const _0x5ad19c=await _0x116533['getForeignStateAsync'](_0x116533[_0x2488f5(0x237)][_0x2488f5(0x202)]+'.data.table');if(!_0x5ad19c||!_0x5ad19c[_0x2488f5(0x1c1)])return;const _0x5f3998=JSON[_0x2488f5(0x1af)](_0x5ad19c[_0x2488f5(0x1c1)]),_0x3f4f96=_0x116533[_0x2488f5(0x237)][_0x2488f5(0x1be)]||[],_0x128fde=_0x116533['config'][_0x2488f5(0x243)]||[],_0x488947=new Set();_0x128fde[_0x2488f5(0x217)](_0x596048=>{const _0x11ab84=_0x2488f5;if(_0x596048[_0x11ab84(0x22e)])_0x488947[_0x11ab84(0x1e2)](_0x596048[_0x11ab84(0x22e)]);});for(const _0x5e3559 of _0x5f3998){if(_0x5e3559[_0x2488f5(0x213)]&&_0x3f4f96[_0x2488f5(0x1d5)]>0x0&&!_0x3f4f96[_0x2488f5(0x1ef)](_0x5e3559['_calName']))continue;const _0x54e8f1=_0x5e3559['_date']||_0x5e3559[_0x2488f5(0x1b4)]||_0x5e3559['date'];if(!_0x54e8f1)continue;const _0x4e16e7=new Date(_0x54e8f1),_0x157089=_0x4e16e7[_0x2488f5(0x1ad)]();if(isNaN(_0x157089))continue;if(_0x157089<_0x11208e)continue;if(_0x157089>_0x11208e+_0x32a7d0)continue;const _0x5f2290=(_0x5e3559[_0x2488f5(0x205)]||_0x5e3559[_0x2488f5(0x248)]||'')[_0x2488f5(0x1d0)]();let _0x32dfe0=![],_0x3cee5d=[],_0x13effb=_0x5e3559[_0x2488f5(0x205)]||_0x5e3559['summary']||_0x2488f5(0x1a7);if(_0x5f2290[_0x2488f5(0x1ef)](_0x2488f5(0x23c))||_0x5f2290[_0x2488f5(0x1ef)](_0x2488f5(0x1a6))||_0x5f2290[_0x2488f5(0x1ef)]('ankunft'))_0x32dfe0=!![],_0x3cee5d=Array[_0x2488f5(0x20f)](_0x488947);else for(const _0x515ad4 of _0x488947){if(_0x5f2290[_0x2488f5(0x1ef)](_0x515ad4[_0x2488f5(0x1d0)]()))_0x3cee5d[_0x2488f5(0x1f6)](_0x515ad4);}_0x3cee5d[_0x2488f5(0x1d5)]>0x0&&_0x3cee5d[_0x2488f5(0x217)](_0x3dd932=>{const _0x3ce256=_0x2488f5;let _0x1c43dc=0x3c;if(_0x32dfe0){let _0x10dd56=0x0;Object[_0x3ce256(0x1fd)](_0x81c3bf)['forEach'](_0x2b186e=>{if(_0x2b186e>_0x10dd56)_0x10dd56=_0x2b186e;}),_0x1c43dc=_0x10dd56>0x0?_0x10dd56:0x78;}else _0x1c43dc=_0x81c3bf[_0x3dd932]||0x3c;const _0x50e53e=new Date(_0x157089-_0x1c43dc*0xea60);_0x29eb47['push']({'eventTime':_0x157089,'triggerTime':_0x50e53e[_0x3ce256(0x1ad)](),'room':_0x3dd932,'minutes':_0x1c43dc,'reason':_0x13effb,'isGlobal':_0x32dfe0});});}}catch(_0x4563d1){}_0x29eb47[_0x2488f5(0x1df)]((_0x280363,_0x4256b3)=>_0x280363[_0x2488f5(0x22d)]-_0x4256b3[_0x2488f5(0x22d)]);const _0x23a11a=_0x29eb47[_0x2488f5(0x21c)](0x0,0x5);await _0x116533[_0x2488f5(0x23d)](_0x2488f5(0x1ed),{'val':JSON[_0x2488f5(0x1b3)](_0x23a11a),'ack':!![]});}async function checkCalendarTriggers(_0x2777e7){const _0x1d0f8d=a1_0x5e3925;if(!_0x2777e7['config'][_0x1d0f8d(0x223)]||!_0x2777e7[_0x1d0f8d(0x237)][_0x1d0f8d(0x202)])return;await updateSchedulePreview(_0x2777e7);let _0x39f4b={},_0x5d47a9={};try{const _0xaa3344=await _0x2777e7[_0x1d0f8d(0x1dc)]('analysis.energy.warmupTimes');if(_0xaa3344&&_0xaa3344[_0x1d0f8d(0x1c1)])_0x39f4b=JSON['parse'](_0xaa3344[_0x1d0f8d(0x1c1)]);const _0x1db544=await _0x2777e7['getStateAsync'](_0x1d0f8d(0x1e5));if(_0x1db544&&_0x1db544[_0x1d0f8d(0x1c1)])_0x5d47a9=JSON['parse'](_0x1db544['val']);}catch(_0x2260c9){}let _0xf8bce6={'default':0x15};try{const _0x3fc69a=await _0x2777e7[_0x1d0f8d(0x1dc)](_0x1d0f8d(0x246));if(_0x3fc69a&&_0x3fc69a[_0x1d0f8d(0x1c1)])_0xf8bce6=JSON[_0x1d0f8d(0x1af)](_0x3fc69a[_0x1d0f8d(0x1c1)]);}catch(_0x231d18){}try{const _0xf95e5b=await _0x2777e7[_0x1d0f8d(0x227)](_0x2777e7[_0x1d0f8d(0x237)]['calendarInstance']+_0x1d0f8d(0x1e8));if(!_0xf95e5b||!_0xf95e5b[_0x1d0f8d(0x1c1)])return;const _0x42e5cd=JSON[_0x1d0f8d(0x1af)](_0xf95e5b[_0x1d0f8d(0x1c1)]),_0x2bbd0f=Date[_0x1d0f8d(0x1d6)](),_0x4c5571=_0x2777e7[_0x1d0f8d(0x237)][_0x1d0f8d(0x243)]||[],_0x33e1d3=_0x2777e7['config'][_0x1d0f8d(0x1be)]||[];for(const _0x581af of _0x42e5cd){if(_0x581af[_0x1d0f8d(0x213)]&&_0x33e1d3['length']>0x0&&!_0x33e1d3[_0x1d0f8d(0x1ef)](_0x581af[_0x1d0f8d(0x213)]))continue;const _0x15a445=_0x581af[_0x1d0f8d(0x231)]||_0x581af[_0x1d0f8d(0x1b4)]||_0x581af[_0x1d0f8d(0x242)];if(!_0x15a445)continue;const _0x41c565=new Date(_0x15a445);if(isNaN(_0x41c565[_0x1d0f8d(0x1ad)]()))continue;const _0x111da5=(_0x581af[_0x1d0f8d(0x205)]||_0x581af[_0x1d0f8d(0x248)]||'')['toLowerCase']();if(_0x111da5[_0x1d0f8d(0x1ef)](_0x1d0f8d(0x23c))||_0x111da5[_0x1d0f8d(0x1ef)](_0x1d0f8d(0x1a6))||_0x111da5[_0x1d0f8d(0x1ef)](_0x1d0f8d(0x1e7))){let _0x399386=0x0;Object[_0x1d0f8d(0x1fd)](_0x39f4b)[_0x1d0f8d(0x217)](_0x49e1ec=>{if(_0x49e1ec>_0x399386)_0x399386=_0x49e1ec;});if(_0x399386===0x0)_0x399386=0x78;const _0x41a4fb=_0x41c565[_0x1d0f8d(0x1ad)]()-_0x399386*0xea60;_0x2bbd0f>=_0x41a4fb&&_0x2bbd0f<_0x41c565['getTime']()&&(_0x2777e7[_0x1d0f8d(0x221)]!==_0x1d0f8d(0x1e6)&&(_0x2777e7[_0x1d0f8d(0x23a)][_0x1d0f8d(0x1e4)]('ðŸ“…\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20'+_0x399386+_0x1d0f8d(0x233)),await _0x2777e7[_0x1d0f8d(0x23d)]('system.mode',{'val':_0x1d0f8d(0x1e6),'ack':![]})));}for(const _0x207414 of _0x4c5571){if(_0x207414[_0x1d0f8d(0x22e)]){const _0x52fa01=_0x207414[_0x1d0f8d(0x22e)][_0x1d0f8d(0x1d0)]();if(_0x111da5[_0x1d0f8d(0x1ef)](_0x52fa01)){const _0x4d4940=_0x39f4b[_0x207414['location']]||0x3c,_0x180622=_0x5d47a9[_0x207414[_0x1d0f8d(0x22e)]]||_0x1d0f8d(0x1fa),_0x1ccaf7=_0x41c565[_0x1d0f8d(0x1ad)]()-_0x4d4940*0xea60;if(_0x2bbd0f>=_0x1ccaf7&&_0x2bbd0f<_0x41c565[_0x1d0f8d(0x1ad)]()){const _0x55a21b=lastActions['cal_'+_0x207414[_0x1d0f8d(0x22e)]];if(_0x55a21b&&_0x2bbd0f-_0x55a21b<CAL_COOLDOWN_MS)continue;const _0x1b540b=await findRelatedId(_0x2777e7,_0x207414['id'],'setpoint');if(_0x1b540b){let _0x5996f5=_0xf8bce6[_0x207414[_0x1d0f8d(0x22e)]];if(_0x5996f5===undefined)_0x5996f5=_0xf8bce6[_0x1d0f8d(0x1ba)];if(_0x5996f5===undefined)_0x5996f5=0x15;const _0x4b7a2a=await _0x2777e7[_0x1d0f8d(0x227)](_0x1b540b);_0x4b7a2a&&typeof _0x4b7a2a[_0x1d0f8d(0x1c1)]===_0x1d0f8d(0x1c2)&&_0x4b7a2a[_0x1d0f8d(0x1c1)]<_0x5996f5-0.5&&(_0x2777e7[_0x1d0f8d(0x23a)][_0x1d0f8d(0x1e4)](_0x1d0f8d(0x1d3)+_0x180622+_0x1d0f8d(0x1b1)+_0x207414['location']+_0x1d0f8d(0x210)+_0x5996f5+_0x1d0f8d(0x1b0)+_0x4d4940+_0x1d0f8d(0x233)),await _0x2777e7[_0x1d0f8d(0x20d)](_0x1b540b,_0x5996f5),await logAutomationAction(_0x2777e7,_0x1d0f8d(0x1da)+_0x207414[_0x1d0f8d(0x22e)]+'\x20->\x20'+_0x5996f5+_0x1d0f8d(0x23b)+_0x180622+')'),lastActions['cal_'+_0x207414['location']]=_0x2bbd0f);}}}}}}}catch(_0x579e48){_0x2777e7[_0x1d0f8d(0x23a)][_0x1d0f8d(0x212)](_0x1d0f8d(0x1de)+_0x579e48[_0x1d0f8d(0x1b5)]);}}async function manageMpcIntervention(_0x3c315d,_0x592912,_0x32a0f8){const _0x328fc3=a1_0x5e3925;try{const _0xc757f1=_0x328fc3(0x224),_0x33015e=await _0x3c315d['getStateAsync'](_0xc757f1);let _0x13c2ef=[];if(_0x33015e&&_0x33015e[_0x328fc3(0x1c1)])try{_0x13c2ef=JSON[_0x328fc3(0x1af)](_0x33015e['val']);}catch(_0x24efab){}const _0x87bdad=_0x13c2ef['indexOf'](_0x592912);if(_0x32a0f8===_0x328fc3(0x1e2))_0x87bdad===-0x1&&(_0x13c2ef[_0x328fc3(0x1f6)](_0x592912),await _0x3c315d['setStateAsync'](_0xc757f1,{'val':JSON[_0x328fc3(0x1b3)](_0x13c2ef),'ack':!![]}));else _0x32a0f8==='remove'&&(_0x87bdad!==-0x1&&(_0x13c2ef[_0x328fc3(0x1a4)](_0x87bdad,0x1),await _0x3c315d[_0x328fc3(0x23d)](_0xc757f1,{'val':JSON['stringify'](_0x13c2ef),'ack':!![]})));}catch(_0x26c152){}}async function cleanupGhostInterventions(_0x24cabc){const _0x2e2de7=a1_0x5e3925;try{const _0x148a13=_0x2e2de7(0x224),_0x3e7be9=await _0x24cabc[_0x2e2de7(0x1dc)](_0x148a13);if(!_0x3e7be9||!_0x3e7be9[_0x2e2de7(0x1c1)])return;const _0x513a6d=JSON[_0x2e2de7(0x1af)](_0x3e7be9['val']);if(!Array[_0x2e2de7(0x1e9)](_0x513a6d)||_0x513a6d['length']===0x0)return;const _0x306e55=_0x24cabc[_0x2e2de7(0x237)][_0x2e2de7(0x243)]||[];let _0x86cdec=![];for(let _0x1a4089=_0x513a6d[_0x2e2de7(0x1d5)]-0x1;_0x1a4089>=0x0;_0x1a4089--){const _0x38bfb7=_0x513a6d[_0x1a4089],_0x1737c7=_0x306e55[_0x2e2de7(0x1cf)](_0xd1fcf5=>normalize(_0xd1fcf5['location'])===normalize(_0x38bfb7)&&(_0xd1fcf5[_0x2e2de7(0x222)]===_0x2e2de7(0x20a)||_0xd1fcf5[_0x2e2de7(0x222)]==='thermostat'));if(_0x1737c7){const _0x204dd0=await findRelatedId(_0x24cabc,_0x1737c7['id'],_0x2e2de7(0x1d8));if(_0x204dd0){const _0x4d7150=await _0x24cabc[_0x2e2de7(0x227)](_0x204dd0);_0x4d7150&&typeof _0x4d7150[_0x2e2de7(0x1c1)]===_0x2e2de7(0x1c2)&&(Math['abs'](_0x4d7150[_0x2e2de7(0x1c1)]-ECO_TEMP)>0.5&&(_0x24cabc[_0x2e2de7(0x23a)][_0x2e2de7(0x1e4)]('ðŸ§¹\x20[MPC\x20CLEANUP]\x20'+_0x38bfb7+_0x2e2de7(0x1f4)+_0x4d7150[_0x2e2de7(0x1c1)]+_0x2e2de7(0x247)+ECO_TEMP+'Â°C).\x20Entferne\x20Status.'),_0x24cabc[_0x2e2de7(0x21a)]&&(_0x24cabc['log'][_0x2e2de7(0x1e4)](_0x2e2de7(0x1bf)+_0x38bfb7+_0x2e2de7(0x1d2)+ECO_TEMP+'Â°C\x20um\x20diese\x20Zeit.'),_0x24cabc[_0x2e2de7(0x21a)]('TRAIN_RL_PENALTY',{'room':_0x38bfb7})),_0x513a6d[_0x2e2de7(0x1a4)](_0x1a4089,0x1),_0x86cdec=!![]));}}}_0x86cdec&&await _0x24cabc[_0x2e2de7(0x23d)](_0x148a13,{'val':JSON[_0x2e2de7(0x1b3)](_0x513a6d),'ack':!![]});}catch(_0x55e462){}}async function applyEnergySavings(_0x1468e1,_0x20a505){const _0x5bd94d=a1_0x5e3925;await cleanupGhostInterventions(_0x1468e1);if(!_0x20a505||_0x20a505['length']===0x0)return;const _0x37491d=_0x1468e1[_0x5bd94d(0x237)][_0x5bd94d(0x243)]||[],_0x13e403=Date[_0x5bd94d(0x1d6)]();for(const _0x4c883c of _0x20a505){const _0x35b126=_0x4c883c['room'],_0x4b5408=_0x4c883c[_0x5bd94d(0x1f1)],_0x25a34a=_0x4c883c[_0x5bd94d(0x1d4)]||0x15,_0x1b7eb8=_0x37491d[_0x5bd94d(0x1cf)](_0x9bec49=>normalize(_0x9bec49['location'])===normalize(_0x35b126)&&(_0x9bec49[_0x5bd94d(0x222)]==='temperature'||_0x9bec49[_0x5bd94d(0x222)]===_0x5bd94d(0x1db)));if(!_0x1b7eb8)continue;const _0xe24a77=await findRelatedId(_0x1468e1,_0x1b7eb8['id'],_0x5bd94d(0x1d8));if(_0xe24a77){if(lastActions[_0x5bd94d(0x1bb)+_0x35b126]&&_0x13e403-lastActions['mpc_'+_0x35b126]<0x1e*0x3c*0x3e8)continue;const _0x57b93b=await _0x1468e1[_0x5bd94d(0x227)](_0xe24a77);if(_0x57b93b&&typeof _0x57b93b['val']===_0x5bd94d(0x1c2)){const _0x4ceef2=_0x57b93b[_0x5bd94d(0x1c1)];_0x4ceef2!==ECO_TEMP&&await manageMpcIntervention(_0x1468e1,_0x35b126,'remove');if(_0x4b5408>0x1e)_0x4ceef2>ECO_TEMP+0.5&&(_0x1468e1[_0x5bd94d(0x23a)][_0x5bd94d(0x1e4)](_0x5bd94d(0x234)+_0x35b126+'\x20auf\x20'+ECO_TEMP+'Â°C!\x20(Puffer:\x20'+_0x4b5408+_0x5bd94d(0x225)),await _0x1468e1[_0x5bd94d(0x20d)](_0xe24a77,ECO_TEMP),await manageMpcIntervention(_0x1468e1,_0x35b126,_0x5bd94d(0x1e2)),lastActions[_0x5bd94d(0x1bb)+_0x35b126]=_0x13e403,await logAutomationAction(_0x1468e1,'[MPC]\x20'+_0x35b126+':\x20Absenkung\x20auf\x20'+ECO_TEMP+'Â°C'));else _0x4b5408<=0xf&&(_0x4ceef2<_0x25a34a&&(_0x1468e1[_0x5bd94d(0x23a)][_0x5bd94d(0x1e4)]('ðŸ”¥\x20[MPC\x20ACTION]\x20Heize\x20'+_0x35b126+'\x20wieder\x20auf\x20'+_0x25a34a+_0x5bd94d(0x228)),await _0x1468e1[_0x5bd94d(0x20d)](_0xe24a77,_0x25a34a),await manageMpcIntervention(_0x1468e1,_0x35b126,_0x5bd94d(0x1f3)),lastActions['mpc_'+_0x35b126]=_0x13e403,await logAutomationAction(_0x1468e1,_0x5bd94d(0x20c)+_0x35b126+_0x5bd94d(0x22b)+_0x25a34a+'Â°C')));}}else _0x1468e1[_0x5bd94d(0x23a)]['warn']('[MPC\x20WARNING]\x20Kein\x20Setpoint\x20fÃ¼r\x20'+_0x35b126+_0x5bd94d(0x1a8));}}async function debugMpcCleanup(_0x1dbfb3){const _0x4729d8=a1_0x5e3925,_0xb36c93='analysis.energy.mpcActiveInterventions',_0x488085=await _0x1dbfb3[_0x4729d8(0x1dc)](_0xb36c93);if(!_0x488085||!_0x488085[_0x4729d8(0x1c1)]){_0x1dbfb3[_0x4729d8(0x23a)][_0x4729d8(0x212)](_0x4729d8(0x240));return;}const _0x26e67a=JSON[_0x4729d8(0x1af)](_0x488085[_0x4729d8(0x1c1)]);_0x1dbfb3[_0x4729d8(0x23a)][_0x4729d8(0x212)](_0x4729d8(0x1cb)+JSON[_0x4729d8(0x1b3)](_0x26e67a));const _0x2cab7c=_0x1dbfb3[_0x4729d8(0x237)]['devices']||[];for(const _0x4ff1a0 of _0x26e67a){const _0x475d3e=_0x2cab7c[_0x4729d8(0x1cf)](_0x1f05e5=>{const _0x9540f6=_0x4729d8,_0x499810=normalize(_0x1f05e5[_0x9540f6(0x22e)])===normalize(_0x4ff1a0)&&(_0x1f05e5[_0x9540f6(0x222)]==='temperature'||_0x1f05e5[_0x9540f6(0x222)]===_0x9540f6(0x1db));if(normalize(_0x1f05e5[_0x9540f6(0x22e)])===normalize(_0x4ff1a0))_0x1dbfb3[_0x9540f6(0x23a)][_0x9540f6(0x230)](_0x9540f6(0x1b9)+_0x4ff1a0+_0x9540f6(0x1dd)+_0x1f05e5['type']);return _0x499810;});if(!_0x475d3e){_0x1dbfb3[_0x4729d8(0x23a)][_0x4729d8(0x212)]('DEBUG:\x20Kein\x20Thermostat\x20fÃ¼r\x20Raum\x20\x27'+_0x4ff1a0+_0x4729d8(0x206));continue;}const _0x1ba94a=await findRelatedId(_0x1dbfb3,_0x475d3e['id'],_0x4729d8(0x1d8));if(!_0x1ba94a){_0x1dbfb3[_0x4729d8(0x23a)]['warn'](_0x4729d8(0x21d)+_0x4ff1a0+_0x4729d8(0x1c4)+_0x475d3e['id']+_0x4729d8(0x204));continue;}const _0x4175b2=await _0x1dbfb3['getForeignStateAsync'](_0x1ba94a);_0x1dbfb3[_0x4729d8(0x23a)]['warn'](_0x4729d8(0x1e1)+_0x4ff1a0+'\x20->\x20Setpoint\x20ID:\x20'+_0x1ba94a+',\x20Wert:\x20'+(_0x4175b2?_0x4175b2[_0x4729d8(0x1c1)]:_0x4729d8(0x1e3)));}}module[a1_0x5e3925(0x22c)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'updateSchedulePreview':updateSchedulePreview};