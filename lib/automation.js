const a1_0x583839=a1_0x5679;(function(_0x2058cb,_0x466e61){const _0x22876a=a1_0x5679,_0x21c725=_0x2058cb();while(!![]){try{const _0x297d77=-parseInt(_0x22876a(0x12a))/0x1*(-parseInt(_0x22876a(0xd6))/0x2)+-parseInt(_0x22876a(0xdc))/0x3+parseInt(_0x22876a(0x11c))/0x4+-parseInt(_0x22876a(0xd3))/0x5+-parseInt(_0x22876a(0x102))/0x6*(-parseInt(_0x22876a(0x10a))/0x7)+-parseInt(_0x22876a(0x12c))/0x8+-parseInt(_0x22876a(0x137))/0x9*(parseInt(_0x22876a(0x144))/0xa);if(_0x297d77===_0x466e61)break;else _0x21c725['push'](_0x21c725['shift']());}catch(_0x487116){_0x21c725['push'](_0x21c725['shift']());}}}(a1_0x50c7,0xc45c7));const a1_0x3b8f6b=(function(){let _0x5a6fe5=!![];return function(_0x5b8985,_0x53b565){const _0x56c800=_0x5a6fe5?function(){const _0x48b605=a1_0x5679;if(_0x53b565){const _0x579f7a=_0x53b565[_0x48b605(0x138)](_0x5b8985,arguments);return _0x53b565=null,_0x579f7a;}}:function(){};return _0x5a6fe5=![],_0x56c800;};}()),a1_0xadc725=a1_0x3b8f6b(this,function(){const _0x6de0af=a1_0x5679;return a1_0xadc725[_0x6de0af(0x13a)]()['search'](_0x6de0af(0x122))[_0x6de0af(0x13a)]()[_0x6de0af(0x141)](a1_0xadc725)['search'](_0x6de0af(0x122));});function a1_0x5679(_0x38187f,_0x4e93a4){const _0x10ddf8=a1_0x50c7();return a1_0x5679=function(_0xadc725,_0x3b8f6b){_0xadc725=_0xadc725-0xcf;let _0x50c7a4=_0x10ddf8[_0xadc725];return _0x50c7a4;},a1_0x5679(_0x38187f,_0x4e93a4);}a1_0xadc725();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x4320a8){const _0x466923=a1_0x5679;if(!_0x4320a8)return'';return _0x4320a8['toLowerCase']()[_0x466923(0xe9)](/\s+/g,'')[_0x466923(0xde)]();}async function handlePrediction(_0x2d75b3,_0x105867,_0x2ea47b){const _0x17a689=a1_0x5679;if(!_0x105867||_0x105867===_0x17a689(0x11f))return;let _0x455449=_0x17a689(0xd5),_0x5f4cec=0.6;try{const _0x10be94=await _0x2d75b3['getStateAsync'](_0x17a689(0x150));if(_0x10be94&&_0x10be94['val'])_0x455449=_0x10be94['val'];const _0x45b91c=await _0x2d75b3[_0x17a689(0x14b)](_0x17a689(0x11e));if(_0x45b91c&&_0x45b91c[_0x17a689(0x10b)])_0x5f4cec=_0x45b91c[_0x17a689(0x10b)];}catch(_0x4e74f1){}if(_0x455449==='off'||_0x2ea47b<_0x5f4cec)return;const _0x495406=Date[_0x17a689(0x12f)]();if(lastActions[_0x105867]&&_0x495406-lastActions[_0x105867]<COOLDOWN_MS)return;const _0x831b81=_0x2d75b3['config']['devices']||[],_0x276e82=normalize(_0x105867),_0x5aea1e=_0x831b81['find'](_0x3a839d=>normalize(_0x3a839d[_0x17a689(0xd4)])===_0x276e82&&(_0x3a839d[_0x17a689(0x143)]===_0x17a689(0x123)||_0x3a839d[_0x17a689(0x143)]===_0x17a689(0xf1)||_0x3a839d[_0x17a689(0x143)]===_0x17a689(0x14d)));if(!_0x5aea1e){_0x2d75b3[_0x17a689(0x136)][_0x17a689(0xd1)](_0x17a689(0x14e)+_0x105867+'\x27.');return;}const _0x2ccf98=await aiAgent['consultButler'](_0x2d75b3,_0x105867,_0x5aea1e[_0x17a689(0xd8)],_0x2ea47b);if(!_0x2ccf98[_0x17a689(0x149)])return;const _0x3ecd7c=_0x17a689(0x109)+_0x105867+_0x17a689(0x14c)+_0x5aea1e[_0x17a689(0xd8)]+'\x20('+_0x2ccf98['reason']+')';await _0x2d75b3[_0x17a689(0x118)]('analysis.automation.lastAction',{'val':'['+_0x455449[_0x17a689(0xfa)]()+']\x20'+_0x3ecd7c,'ack':!![]});if(_0x455449==='active'){const _0x7edb31=await _0x2d75b3[_0x17a689(0xed)](_0x5aea1e['id']);(!_0x7edb31||!_0x7edb31[_0x17a689(0x10b)]&&_0x7edb31[_0x17a689(0x10b)]!==!![])&&await _0x2d75b3[_0x17a689(0x132)](_0x5aea1e['id'],!![]),lastActions[_0x105867]=_0x495406;}}async function findRelatedId(_0x8c2aa7,_0x324d39,_0x59fa33=a1_0x583839(0xf2)){const _0xc4272b=a1_0x583839;if(_0x59fa33===_0xc4272b(0xf2)&&_0x8c2aa7[_0xc4272b(0x151)][_0xc4272b(0x108)]){let _0x16ef81=_0x8c2aa7['config'][_0xc4272b(0x108)];if(typeof _0x16ef81===_0xc4272b(0x12d))try{_0x16ef81=JSON['parse'](_0x16ef81);}catch(_0x551c96){}if(_0x16ef81&&_0x16ef81[_0x324d39])return _0x16ef81[_0x324d39];}if(_0x59fa33===_0xc4272b(0x114)&&_0x8c2aa7[_0xc4272b(0x151)][_0xc4272b(0x11d)]){let _0x10bb4e=_0x8c2aa7[_0xc4272b(0x151)]['valveMapping'];if(typeof _0x10bb4e===_0xc4272b(0x12d))try{_0x10bb4e=JSON[_0xc4272b(0x10e)](_0x10bb4e);}catch(_0x12f4a4){}if(_0x10bb4e&&_0x10bb4e[_0x324d39])return _0x10bb4e[_0x324d39];}let _0x46a210=[];if(_0x59fa33===_0xc4272b(0xf2))_0x46a210=[{'s':_0xc4272b(0xec),'t':'.1.SET_POINT_TEMPERATURE'},{'s':'.1.TEMPERATURE','t':'.1.SET_POINT_TEMPERATURE'},{'s':_0xc4272b(0xdf),'t':'.4.SET_TEMPERATURE'},{'s':'ACTUAL_TEMPERATURE','t':_0xc4272b(0xdd)},{'s':_0xc4272b(0xdb),'t':_0xc4272b(0xcf)},{'s':_0xc4272b(0xdb),'t':_0xc4272b(0x128)},{'s':_0xc4272b(0xda),'t':_0xc4272b(0x107)},{'s':'ACTUAL','t':'SET'},{'s':'Ist','t':_0xc4272b(0x112)},{'s':_0xc4272b(0xda),'t':_0xc4272b(0xf2)}];else _0x59fa33===_0xc4272b(0x114)&&(_0x46a210=[{'s':'.1.ACTUAL_TEMPERATURE','t':'.1.LEVEL'},{'s':_0xc4272b(0xdf),'t':_0xc4272b(0x103)},{'s':_0xc4272b(0xdf),'t':_0xc4272b(0xff)},{'s':'local_temperature','t':_0xc4272b(0xe4)},{'s':'temperature','t':_0xc4272b(0xf5)},{'s':'temperature','t':_0xc4272b(0x134)}]);for(const _0x29c7d8 of _0x46a210){if(_0x324d39[_0xc4272b(0x119)](_0x29c7d8['s'])){const _0x3238b4=_0x324d39[_0xc4272b(0xe9)](_0x29c7d8['s'],_0x29c7d8['t']),_0x41c7ef=await _0x8c2aa7[_0xc4272b(0xef)](_0x3238b4);if(_0x41c7ef)return _0x3238b4;}}try{const _0x5aa7e3=_0x324d39[_0xc4272b(0xf9)]('.');if(_0x5aa7e3[_0xc4272b(0xe2)]>0x2){const _0xa1269=_0x5aa7e3[_0xc4272b(0x142)](0x0,-0x1)['join']('.'),_0x1ba813=await _0x8c2aa7[_0xc4272b(0xd2)](_0xa1269+'.*'),_0x265768=[],_0x43276d=_0x324d39[_0xc4272b(0xf9)](/[._]+/)[_0xc4272b(0x10c)](_0x2d0d42=>![_0xc4272b(0x10d),'0',_0xc4272b(0x13b),'ist','wert',_0xc4272b(0xda),'actual',_0xc4272b(0x14a),_0xc4272b(0x135),_0xc4272b(0x100)]['includes'](_0x2d0d42[_0xc4272b(0x11a)]()));for(const [_0x5983e3,_0x1706ca]of Object[_0xc4272b(0xe5)](_0x1ba813)){if(_0x5983e3===_0x324d39)continue;if(_0x1706ca&&_0x1706ca[_0xc4272b(0x13f)]){const _0x4a6e1a=_0x5983e3['toLowerCase'](),_0x5c9b6a=(_0x1706ca[_0xc4272b(0x13f)][_0xc4272b(0x124)]||'')[_0xc4272b(0x11a)](),_0x364fae=(_0x1706ca[_0xc4272b(0x13f)][_0xc4272b(0x152)]||'')[_0xc4272b(0x11a)]();let _0x27cc98=![];if(_0x59fa33==='setpoint'&&_0x1706ca['common'][_0xc4272b(0xf7)]===!![])_0x27cc98=_0x4a6e1a['includes']('set')||_0x4a6e1a[_0xc4272b(0x119)](_0xc4272b(0xd9))||_0x4a6e1a[_0xc4272b(0x119)](_0xc4272b(0x14f))||_0x5c9b6a[_0xc4272b(0x119)](_0xc4272b(0x116))||_0x5c9b6a[_0xc4272b(0x119)](_0xc4272b(0xe0));else _0x59fa33==='valve'&&(_0x27cc98=_0x4a6e1a[_0xc4272b(0x119)]('level')||_0x4a6e1a[_0xc4272b(0x119)](_0xc4272b(0x114))||_0x4a6e1a[_0xc4272b(0x119)](_0xc4272b(0x12e))||_0x4a6e1a['includes'](_0xc4272b(0x13d))||_0x5c9b6a['includes'](_0xc4272b(0x101))||_0x5c9b6a['includes'](_0xc4272b(0x120))||_0x364fae[_0xc4272b(0x119)]('%'));if(_0x27cc98){const _0x3ecccf=_0x5983e3[_0xc4272b(0xf9)](/[._]+/)[_0xc4272b(0xeb)](_0x199fa1=>_0x199fa1[_0xc4272b(0x11a)]());let _0x54db60=0x0;_0x43276d['forEach'](_0x11c331=>{const _0x2625cd=_0xc4272b;if(_0x3ecccf[_0x2625cd(0x119)](_0x11c331[_0x2625cd(0x11a)]()))_0x54db60++;}),_0x265768[_0xc4272b(0x147)]({'id':_0x5983e3,'score':_0x54db60});}}}if(_0x265768[_0xc4272b(0xe2)]>0x0){_0x265768[_0xc4272b(0xe6)]((_0x4f388f,_0x184834)=>_0x184834[_0xc4272b(0x129)]-_0x4f388f[_0xc4272b(0x129)]);if(_0x265768[0x0][_0xc4272b(0x129)]>0x0)return _0x265768[0x0]['id'];}}}catch(_0x2c972e){}return null;}function a1_0x50c7(){const _0x2ee6db=['SET_POINT_TEMPERATURE','trim','.1.TEMPERATURE','thermostat.setpoint','values','length','ðŸ“…\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','pi_heating_demand','entries','sort','Fehlt','\x20min)','replace','_calName','map','.1.ACTUAL_TEMPERATURE','getForeignStateAsync','analysis.energy.warmupTimes','getForeignObjectAsync','forEach','dimmer','setpoint','summary','info','valve_position','mpc_','write','Unbekannt','split','toUpperCase','devices','getTime','event',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','.4.VALVE_STATE','state','level.valve','364218ZZHLzY','.1.LEVEL','warn','exports','minutes_safe','target_temperature','thermostatMapping','PrÃ¤diktion:\x20','168PbKVhv','val','filter','openknx','parse','[CAL]\x20','\x20->\x2021Â°C','room','Soll','ðŸƒ\x20MPC\x20Autonomy:\x20Senke\x20','valve',').\x20Heize\x20auf\x2021Â°C\x20(Vorlauf:\x20','level.temperature','eventStart','setStateAsync','includes','toLowerCase','calendarSelection','3675552JfKwzY','valveMapping','analysis.automation.confidenceThreshold','Unknown','value.valve','Â°C\x20(Coasting\x20mÃ¶glich:\x20','(((.+)+)+)+$','light','role','PERFECT','urlaub\x20ende','calendarInstance','current_heating_setpoint','score','678593zcvzUm','Auto-Erkennung','2245984OoaKJt','string','stellwert','now','ankunft','\x20min).','setForeignStateAsync','Calendar\x20Check\x20Error:\x20','level','messwert','log','8717760oRLQbn','apply','normal','toString','hm-rpc','message','position','localeCompare','common','.data.table','constructor','slice','type','10sUUteY','find','Nicht\x20gefunden','push','system.mode','approved','sensor','getStateAsync','\x20->\x20Schalte\x20','switch','ðŸ”\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27','target','analysis.automation.mode','config','unit','occupied_heating_setpoint','analysis.automation.lastAction','debug','getForeignObjectsAsync','7305645zPhjxl','location','off','4JmcTUZ','\x27\x20erkannt\x20(','name','soll','temperature','local_temperature','654402BjCWJx'];a1_0x50c7=function(){return _0x2ee6db;};return a1_0x50c7();}async function scanThermostats(_0x3d88e6){const _0x42e399=a1_0x583839,_0x4cf993=_0x3d88e6['config'][_0x42e399(0xfb)]||[],_0x5d0aa9=[],_0x34da9f=_0x4cf993[_0x42e399(0x10c)](_0x405080=>_0x405080['id']&&_0x405080['id'][_0x42e399(0x119)](_0x42e399(0xda))||_0x405080[_0x42e399(0x143)]&&[_0x42e399(0xda),'thermostat',_0x42e399(0x14a)][_0x42e399(0x119)](_0x405080[_0x42e399(0x143)])||_0x405080[_0x42e399(0xd8)]&&_0x405080[_0x42e399(0xd8)]['toLowerCase']()['includes']('temp'));for(const _0x57e19c of _0x34da9f){const _0x3e264a=await findRelatedId(_0x3d88e6,_0x57e19c['id'],_0x42e399(0xf2)),_0xf2fd7d=await findRelatedId(_0x3d88e6,_0x57e19c['id'],_0x42e399(0x114));let _0x535343=_0x42e399(0x146),_0x2c6c54=![],_0x37f36e=_0x3d88e6[_0x42e399(0x151)][_0x42e399(0x108)]||{};if(typeof _0x37f36e==='string')try{_0x37f36e=JSON[_0x42e399(0x10e)](_0x37f36e);}catch(_0x3ca851){}let _0xa50633=_0x3d88e6[_0x42e399(0x151)]['valveMapping']||{};if(typeof _0xa50633==='string')try{_0xa50633=JSON['parse'](_0xa50633);}catch(_0x436260){}if(_0x37f36e[_0x57e19c['id']]&&_0x37f36e[_0x57e19c['id']]===_0x3e264a||_0xa50633[_0x57e19c['id']]&&_0xa50633[_0x57e19c['id']]===_0xf2fd7d)_0x535343='Manuelles\x20Mapping',_0x2c6c54=!![];else(_0x3e264a||_0xf2fd7d)&&(_0x535343=_0x42e399(0x12b));_0x5d0aa9[_0x42e399(0x147)]({'room':_0x57e19c[_0x42e399(0xd4)]||_0x42e399(0xf8),'sensorId':_0x57e19c['id'],'setpointId':_0x3e264a||'-','valveId':_0xf2fd7d||'-','source':_0x535343,'isManual':_0x2c6c54,'status':_0x3e264a&&_0xf2fd7d?_0x42e399(0x125):_0x3e264a?'OK':_0x42e399(0xe7)});}return _0x5d0aa9[_0x42e399(0xe6)]((_0x252596,_0x5e0cd5)=>_0x252596[_0x42e399(0x111)][_0x42e399(0x13e)](_0x5e0cd5[_0x42e399(0x111)]));}async function checkCalendarTriggers(_0x19f4f3){const _0x544c31=a1_0x583839;if(!_0x19f4f3[_0x544c31(0x151)]['useCalendar']||!_0x19f4f3[_0x544c31(0x151)][_0x544c31(0x127)])return;let _0xfbb588={};try{const _0xaab2d0=await _0x19f4f3['getStateAsync'](_0x544c31(0xee));if(_0xaab2d0&&_0xaab2d0[_0x544c31(0x10b)])_0xfbb588=JSON[_0x544c31(0x10e)](_0xaab2d0[_0x544c31(0x10b)]);}catch(_0xdded5a){}try{const _0x18f195=await _0x19f4f3[_0x544c31(0xed)](_0x19f4f3[_0x544c31(0x151)][_0x544c31(0x127)]+_0x544c31(0x140));if(!_0x18f195||!_0x18f195[_0x544c31(0x10b)])return;const _0xbb056b=JSON[_0x544c31(0x10e)](_0x18f195[_0x544c31(0x10b)]),_0x4c5227=new Date(),_0x5d1b4b=_0x19f4f3[_0x544c31(0x151)]['devices']||[],_0x3ec0b3=_0x19f4f3[_0x544c31(0x151)][_0x544c31(0x11b)]||[];for(const _0x30c0e6 of _0xbb056b){if(_0x30c0e6[_0x544c31(0xea)]&&_0x3ec0b3['length']>0x0&&!_0x3ec0b3[_0x544c31(0x119)](_0x30c0e6[_0x544c31(0xea)]))continue;const _0x5e238c=new Date(_0x30c0e6[_0x544c31(0x117)]),_0x2ffd04=(_0x30c0e6[_0x544c31(0xfd)]||_0x30c0e6[_0x544c31(0xf3)]||'')[_0x544c31(0x11a)]();if(_0x2ffd04[_0x544c31(0x119)](_0x544c31(0x126))||_0x2ffd04[_0x544c31(0x119)]('rÃ¼ckkehr')||_0x2ffd04[_0x544c31(0x119)](_0x544c31(0x130))){let _0x25a5ca=0x0;Object[_0x544c31(0xe1)](_0xfbb588)[_0x544c31(0xf0)](_0x383c8f=>{if(_0x383c8f>_0x25a5ca)_0x25a5ca=_0x383c8f;});if(_0x25a5ca===0x0)_0x25a5ca=0x78;const _0xa18d52=new Date(_0x5e238c['getTime']()-_0x25a5ca*0xea60),_0x11ca5c=_0x4c5227[_0x544c31(0xfc)]()-_0xa18d52[_0x544c31(0xfc)]();_0x11ca5c>=0x0&&_0x11ca5c<0xf*0xea60&&(_0x19f4f3[_0x544c31(0x136)]['info'](_0x544c31(0xe3)+_0x30c0e6[_0x544c31(0xfd)]+_0x544c31(0xfe)+_0x25a5ca+_0x544c31(0x131)),await _0x19f4f3[_0x544c31(0x118)](_0x544c31(0x148),{'val':_0x544c31(0x139),'ack':![]}));}for(const _0x47f91d of _0x5d1b4b){if(_0x47f91d[_0x544c31(0xd4)]){const _0x2833fc=_0x47f91d['location']['toLowerCase']();if(_0x2ffd04['includes'](_0x2833fc)){const _0x4ccde2=_0xfbb588[_0x47f91d['location']]||0x3c,_0x53f8f5=new Date(_0x5e238c[_0x544c31(0xfc)]()-_0x4ccde2*0xea60),_0x53d8db=_0x4c5227[_0x544c31(0xfc)]()-_0x53f8f5[_0x544c31(0xfc)]();if(_0x53d8db>=0x0&&_0x53d8db<0xf*0xea60){const _0x4d63af=await findRelatedId(_0x19f4f3,_0x47f91d['id'],'setpoint');_0x4d63af&&(_0x19f4f3[_0x544c31(0x136)]['info']('ðŸ“…\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27'+_0x47f91d['location']+_0x544c31(0xd7)+_0x30c0e6[_0x544c31(0xfd)]+_0x544c31(0x115)+_0x4ccde2+_0x544c31(0x131)),await _0x19f4f3[_0x544c31(0x132)](_0x4d63af,0x15),await _0x19f4f3[_0x544c31(0x118)](_0x544c31(0xd0),{'val':_0x544c31(0x10f)+_0x47f91d[_0x544c31(0xd4)]+_0x544c31(0x110),'ack':!![]}));}}}}}}catch(_0x3acdf2){_0x19f4f3['log'][_0x544c31(0x104)](_0x544c31(0x133)+_0x3acdf2[_0x544c31(0x13c)]);}}async function applyEnergySavings(_0x5ad320,_0x3c70bd){const _0x9b9550=a1_0x583839,_0x50f509=_0x5ad320['config'][_0x9b9550(0xfb)]||[];for(const _0x46eb1b of _0x3c70bd){const _0x392ae5=_0x46eb1b[_0x9b9550(0x111)],_0x5b2dc1=_0x46eb1b[_0x9b9550(0x106)],_0x1ba9d5=Date['now']();if(lastActions['mpc_'+_0x392ae5]&&_0x1ba9d5-lastActions[_0x9b9550(0xf6)+_0x392ae5]<0x1e*0x3c*0x3e8)continue;const _0x3acdbb=_0x50f509[_0x9b9550(0x145)](_0x2c4b3f=>normalize(_0x2c4b3f[_0x9b9550(0xd4)])===normalize(_0x392ae5));if(!_0x3acdbb)continue;const _0x85d144=await findRelatedId(_0x5ad320,_0x3acdbb['id'],'setpoint');if(_0x85d144){const _0x3ae1a2=await _0x5ad320[_0x9b9550(0xed)](_0x85d144);if(_0x3ae1a2&&typeof _0x3ae1a2[_0x9b9550(0x10b)]==='number'){const _0x454011=_0x3ae1a2[_0x9b9550(0x10b)];if(_0x5b2dc1>0x1e&&_0x454011>0x11){const _0x45bb71=_0x454011-0x1;_0x5ad320['log'][_0x9b9550(0xf4)](_0x9b9550(0x113)+_0x392ae5+'\x20('+_0x85d144+')\x20auf\x20'+_0x45bb71+_0x9b9550(0x121)+_0x5b2dc1+_0x9b9550(0xe8)),await _0x5ad320[_0x9b9550(0x132)](_0x85d144,_0x45bb71),lastActions[_0x9b9550(0xf6)+_0x392ae5]=_0x1ba9d5,await _0x5ad320[_0x9b9550(0x118)](_0x9b9550(0xd0),{'val':'[MPC]\x20'+_0x392ae5+':\x20-1Â°C\x20(Sparpotenzial\x20genutzt)','ack':!![]});}}}}}module[a1_0x583839(0x105)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};