(function(_0x61de24,_0x1392c6){const _0x874cc0=a1_0x2d90,_0xa019fc=_0x61de24();while(!![]){try{const _0x5b47de=parseInt(_0x874cc0(0x97))/0x1*(parseInt(_0x874cc0(0x11c))/0x2)+-parseInt(_0x874cc0(0x10f))/0x3*(-parseInt(_0x874cc0(0xd8))/0x4)+parseInt(_0x874cc0(0xe7))/0x5*(parseInt(_0x874cc0(0xaf))/0x6)+-parseInt(_0x874cc0(0xf5))/0x7*(-parseInt(_0x874cc0(0x95))/0x8)+-parseInt(_0x874cc0(0x142))/0x9+-parseInt(_0x874cc0(0x107))/0xa*(-parseInt(_0x874cc0(0xce))/0xb)+-parseInt(_0x874cc0(0xe1))/0xc*(parseInt(_0x874cc0(0xaa))/0xd);if(_0x5b47de===_0x1392c6)break;else _0xa019fc['push'](_0xa019fc['shift']());}catch(_0x15aefd){_0xa019fc['push'](_0xa019fc['shift']());}}}(a1_0x34df,0xd1f33));const a1_0x45bfea=(function(){let _0xb1c6b5=!![];return function(_0x1a14e7,_0x6d64e1){const _0x2e66d9=_0xb1c6b5?function(){const _0x1e09c1=a1_0x2d90;if(_0x6d64e1){const _0x5dbaf0=_0x6d64e1[_0x1e09c1(0xd9)](_0x1a14e7,arguments);return _0x6d64e1=null,_0x5dbaf0;}}:function(){};return _0xb1c6b5=![],_0x2e66d9;};}()),a1_0x165ff2=a1_0x45bfea(this,function(){const _0x16e4e7=a1_0x2d90;return a1_0x165ff2[_0x16e4e7(0xe3)]()[_0x16e4e7(0x116)](_0x16e4e7(0xa6))['toString']()[_0x16e4e7(0x11f)](a1_0x165ff2)[_0x16e4e7(0x116)](_0x16e4e7(0xa6));});function a1_0x2d90(_0x5ce19c,_0x5a4e45){const _0x4cd90f=a1_0x34df();return a1_0x2d90=function(_0x165ff2,_0x45bfea){_0x165ff2=_0x165ff2-0x94;let _0x34df62=_0x4cd90f[_0x165ff2];return _0x34df62;},a1_0x2d90(_0x5ce19c,_0x5a4e45);}a1_0x165ff2();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,RESCUE_LOCK_MS=0x78*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x42260e){const _0x3b90ce=a1_0x2d90;if(!_0x42260e)return'';return _0x42260e[_0x3b90ce(0x123)]()[_0x3b90ce(0xac)](/\s+/g,'')[_0x3b90ce(0x12f)]();}async function logAutomationAction(_0x5e12a9,_0x954215){const _0x2a8147=a1_0x2d90;await _0x5e12a9[_0x2a8147(0x11b)](_0x2a8147(0x119),{'val':_0x954215,'ack':!![]});try{const _0x1d3d8d=_0x2a8147(0x109),_0x1727da=await _0x5e12a9[_0x2a8147(0x10b)](_0x1d3d8d);let _0x3eff8d=[];if(_0x1727da&&_0x1727da[_0x2a8147(0x131)])try{_0x3eff8d=JSON['parse'](_0x1727da['val']);}catch(_0x11f090){}_0x3eff8d['unshift']({'ts':Date['now'](),'msg':_0x954215});if(_0x3eff8d[_0x2a8147(0x124)]>0x32)_0x3eff8d=_0x3eff8d[_0x2a8147(0xde)](0x0,0x32);await _0x5e12a9[_0x2a8147(0x11b)](_0x1d3d8d,{'val':JSON['stringify'](_0x3eff8d),'ack':!![]});}catch(_0x281c31){}}async function handlePrediction(_0x2ee4eb,_0x585d67,_0x962897){const _0x4552b9=a1_0x2d90;if(!_0x585d67||_0x585d67===_0x4552b9(0x149))return;let _0x5e2c91='off',_0x19d361=0.6;try{const _0x31ef94=await _0x2ee4eb[_0x4552b9(0x10b)](_0x4552b9(0x118));if(_0x31ef94&&_0x31ef94['val'])_0x5e2c91=_0x31ef94[_0x4552b9(0x131)];const _0x440fcf=await _0x2ee4eb[_0x4552b9(0x10b)](_0x4552b9(0x9c));if(_0x440fcf&&_0x440fcf[_0x4552b9(0x131)])_0x19d361=_0x440fcf['val'];}catch(_0x38a5ac){}if(_0x5e2c91===_0x4552b9(0x11e)||_0x962897<_0x19d361)return;const _0x46c888=Date['now']();if(lastActions[_0x585d67]&&_0x46c888-lastActions[_0x585d67]<COOLDOWN_MS)return;const _0x50dab4=_0x2ee4eb[_0x4552b9(0xdb)][_0x4552b9(0x13b)]||[],_0x556e58=normalize(_0x585d67),_0x4be6b3=_0x50dab4['find'](_0x471948=>normalize(_0x471948['location'])===_0x556e58&&(_0x471948['type']===_0x4552b9(0xe2)||_0x471948[_0x4552b9(0xed)]===_0x4552b9(0x13a)||_0x471948[_0x4552b9(0xed)]===_0x4552b9(0x120)));if(!_0x4be6b3)return;const _0x3dc284=await aiAgent[_0x4552b9(0x125)](_0x2ee4eb,_0x585d67,_0x4be6b3['name'],_0x962897);if(!_0x3dc284['approved'])return;const _0x5389dc=_0x4552b9(0x98)+_0x585d67+_0x4552b9(0xe6)+_0x4be6b3[_0x4552b9(0xcb)]+'\x20('+_0x3dc284[_0x4552b9(0xab)]+')';await logAutomationAction(_0x2ee4eb,'['+_0x5e2c91[_0x4552b9(0xf7)]()+']\x20'+_0x5389dc);if(_0x5e2c91==='active'){const _0x33a1fd=await _0x2ee4eb[_0x4552b9(0xbf)](_0x4be6b3['id']);(!_0x33a1fd||!_0x33a1fd[_0x4552b9(0x131)]&&_0x33a1fd[_0x4552b9(0x131)]!==!![])&&await _0x2ee4eb[_0x4552b9(0x10e)](_0x4be6b3['id'],!![]),lastActions[_0x585d67]=_0x46c888;}}async function findRelatedId(_0x3098c3,_0x199388,_0x52c29d='setpoint'){const _0xb3fb79=a1_0x2d90;if(_0x52c29d===_0xb3fb79(0x134)&&_0x3098c3[_0xb3fb79(0xdb)]['thermostatMapping']){let _0x3ff711=_0x3098c3['config']['thermostatMapping'];if(typeof _0x3ff711==='string')try{_0x3ff711=JSON[_0xb3fb79(0x146)](_0x3ff711);}catch(_0x30027b){}if(_0x3ff711&&_0x3ff711[_0x199388])return _0x3ff711[_0x199388];}if(_0x52c29d===_0xb3fb79(0xb2)&&_0x3098c3[_0xb3fb79(0xdb)][_0xb3fb79(0x138)]){let _0x17e2e9=_0x3098c3[_0xb3fb79(0xdb)][_0xb3fb79(0x138)];if(typeof _0x17e2e9===_0xb3fb79(0x96))try{_0x17e2e9=JSON[_0xb3fb79(0x146)](_0x17e2e9);}catch(_0xdb6b8d){}if(_0x17e2e9&&_0x17e2e9[_0x199388])return _0x17e2e9[_0x199388];}let _0x13e8a7=[];if(_0x52c29d===_0xb3fb79(0x134))_0x13e8a7=[{'s':_0xb3fb79(0xf0),'t':_0xb3fb79(0xc7)},{'s':_0xb3fb79(0xf3),'t':'.1.SET_POINT_TEMPERATURE'},{'s':'.1.TEMPERATURE','t':_0xb3fb79(0xf6)},{'s':_0xb3fb79(0xbc),'t':'SET_POINT_TEMPERATURE'},{'s':'local_temperature','t':'occupied_heating_setpoint'},{'s':_0xb3fb79(0x12a),'t':_0xb3fb79(0x148)},{'s':_0xb3fb79(0x13e),'t':'target_temperature'},{'s':_0xb3fb79(0xc8),'t':_0xb3fb79(0xfc)},{'s':_0xb3fb79(0xad),'t':_0xb3fb79(0x94)},{'s':'temperature','t':'setpoint'}];else _0x52c29d===_0xb3fb79(0xb2)&&(_0x13e8a7=[{'s':'.1.ACTUAL_TEMPERATURE','t':'.1.LEVEL'},{'s':_0xb3fb79(0xf3),'t':_0xb3fb79(0xa1)},{'s':_0xb3fb79(0xf3),'t':_0xb3fb79(0xb7)},{'s':_0xb3fb79(0x12a),'t':_0xb3fb79(0xcd)},{'s':_0xb3fb79(0x13e),'t':'valve_position'},{'s':_0xb3fb79(0x13e),'t':_0xb3fb79(0xa7)}]);for(const _0x409960 of _0x13e8a7){if(_0x199388['includes'](_0x409960['s'])){const _0x230594=_0x199388[_0xb3fb79(0xac)](_0x409960['s'],_0x409960['t']),_0x2a2031=await _0x3098c3[_0xb3fb79(0x10c)](_0x230594);if(_0x2a2031)return _0x230594;}}try{const _0x50db51=_0x199388[_0xb3fb79(0xa2)]('.');if(_0x50db51[_0xb3fb79(0x124)]>0x2){const _0x22dc5f=_0x50db51['slice'](0x0,-0x1)['join']('.'),_0x64ab37=await _0x3098c3['getForeignObjectsAsync'](_0x22dc5f+'.*'),_0x3e95c0=[],_0x8a57c5=_0x199388[_0xb3fb79(0xa2)](/[._]+/)[_0xb3fb79(0xd1)](_0x2ceee0=>![_0xb3fb79(0xe0),'0',_0xb3fb79(0xe5),'ist',_0xb3fb79(0x121),_0xb3fb79(0x13e),_0xb3fb79(0x141),_0xb3fb79(0x115),_0xb3fb79(0xdc),_0xb3fb79(0xf4)][_0xb3fb79(0x102)](_0x2ceee0[_0xb3fb79(0x123)]()));for(const [_0x2ed9d5,_0x9f8468]of Object[_0xb3fb79(0x14b)](_0x64ab37)){if(_0x2ed9d5===_0x199388)continue;if(_0x9f8468&&_0x9f8468[_0xb3fb79(0xfe)]){const _0xe241dc=_0x2ed9d5[_0xb3fb79(0x123)](),_0x45fe13=(_0x9f8468[_0xb3fb79(0xfe)][_0xb3fb79(0xec)]||'')['toLowerCase'](),_0x624993=(_0x9f8468[_0xb3fb79(0xfe)][_0xb3fb79(0x100)]||'')[_0xb3fb79(0x123)]();let _0x310966=![];if(_0x52c29d===_0xb3fb79(0x134)&&_0x9f8468[_0xb3fb79(0xfe)][_0xb3fb79(0x127)]===!![])_0x310966=_0xe241dc[_0xb3fb79(0x102)](_0xb3fb79(0xa3))||_0xe241dc[_0xb3fb79(0x102)](_0xb3fb79(0x106))||_0xe241dc[_0xb3fb79(0x102)]('target')||_0x45fe13[_0xb3fb79(0x102)](_0xb3fb79(0xd4))||_0x45fe13[_0xb3fb79(0x102)](_0xb3fb79(0xfa));else _0x52c29d===_0xb3fb79(0xb2)&&(_0x310966=_0xe241dc[_0xb3fb79(0x102)]('level')||_0xe241dc['includes'](_0xb3fb79(0xb2))||_0xe241dc[_0xb3fb79(0x102)](_0xb3fb79(0x126))||_0xe241dc[_0xb3fb79(0x102)](_0xb3fb79(0x108))||_0x45fe13[_0xb3fb79(0x102)](_0xb3fb79(0xa4))||_0x45fe13[_0xb3fb79(0x102)](_0xb3fb79(0x137))||_0x624993[_0xb3fb79(0x102)]('%'));if(_0x310966){const _0xffe295=_0x2ed9d5[_0xb3fb79(0xa2)](/[._]+/)['map'](_0x2932a4=>_0x2932a4[_0xb3fb79(0x123)]());let _0x523fe4=0x0;_0x8a57c5[_0xb3fb79(0xc6)](_0xdcff9e=>{if(_0xffe295['includes'](_0xdcff9e['toLowerCase']()))_0x523fe4++;}),_0x3e95c0[_0xb3fb79(0x122)]({'id':_0x2ed9d5,'score':_0x523fe4});}}}if(_0x3e95c0['length']>0x0){_0x3e95c0[_0xb3fb79(0xd5)]((_0x4a7646,_0x4824c9)=>_0x4824c9['score']-_0x4a7646[_0xb3fb79(0x143)]);if(_0x3e95c0[0x0][_0xb3fb79(0x143)]>0x0)return _0x3e95c0[0x0]['id'];}}}catch(_0x173a5e){}return null;}async function scanThermostats(_0x5a6d48){const _0x156385=a1_0x2d90,_0x325eed=_0x5a6d48[_0x156385(0xdb)]['devices']||[],_0x4ca584=[],_0x50e55e=_0x325eed[_0x156385(0xd1)](_0x118938=>_0x118938['id']&&_0x118938['id'][_0x156385(0x102)](_0x156385(0x13e))||_0x118938['type']&&[_0x156385(0x13e),_0x156385(0x111),_0x156385(0x115)][_0x156385(0x102)](_0x118938['type'])||_0x118938[_0x156385(0xcb)]&&_0x118938[_0x156385(0xcb)][_0x156385(0x123)]()[_0x156385(0x102)](_0x156385(0xdd)));for(const _0xb34c14 of _0x50e55e){const _0x3e8d6d=await findRelatedId(_0x5a6d48,_0xb34c14['id'],_0x156385(0x134)),_0x517d41=await findRelatedId(_0x5a6d48,_0xb34c14['id'],'valve');let _0x5c2249=_0x156385(0xb8),_0x276fdf=![],_0x3b96e8=_0x5a6d48[_0x156385(0xdb)][_0x156385(0x10d)]||{};if(typeof _0x3b96e8===_0x156385(0x96))try{_0x3b96e8=JSON[_0x156385(0x146)](_0x3b96e8);}catch(_0x1c4b3d){}let _0x5aa177=_0x5a6d48['config'][_0x156385(0x138)]||{};if(typeof _0x5aa177===_0x156385(0x96))try{_0x5aa177=JSON[_0x156385(0x146)](_0x5aa177);}catch(_0x288d0b){}if(_0x3b96e8[_0xb34c14['id']]&&_0x3b96e8[_0xb34c14['id']]===_0x3e8d6d||_0x5aa177[_0xb34c14['id']]&&_0x5aa177[_0xb34c14['id']]===_0x517d41)_0x5c2249='Manuelles\x20Mapping',_0x276fdf=!![];else(_0x3e8d6d||_0x517d41)&&(_0x5c2249=_0x156385(0x129));_0x4ca584[_0x156385(0x122)]({'room':_0xb34c14[_0x156385(0xa0)]||_0x156385(0xe4),'sensorId':_0xb34c14['id'],'setpointId':_0x3e8d6d||'-','valveId':_0x517d41||'-','source':_0x5c2249,'isManual':_0x276fdf,'status':_0x3e8d6d&&_0x517d41?_0x156385(0x13f):_0x3e8d6d?'OK':_0x156385(0xb6)});}return _0x4ca584[_0x156385(0xd5)]((_0x24f563,_0x5324b4)=>_0x24f563[_0x156385(0x147)][_0x156385(0x12b)](_0x5324b4[_0x156385(0x147)]));}async function updateSchedulePreview(_0x364dc1){const _0x20a63f=a1_0x2d90;if(!_0x364dc1['config'][_0x20a63f(0x13c)]||!_0x364dc1[_0x20a63f(0xdb)]['calendarInstance'])return;let _0x48b8cd={};try{const _0x4fa445=await _0x364dc1['getStateAsync'](_0x20a63f(0x110));if(_0x4fa445&&_0x4fa445['val'])_0x48b8cd=JSON['parse'](_0x4fa445[_0x20a63f(0x131)]);}catch(_0x11d959){}const _0x15ec3c=[],_0x201e9f=Date['now'](),_0x33c06a=0x30*0x3c*0x3c*0x3e8;try{const _0x332267=await _0x364dc1['getForeignStateAsync'](_0x364dc1[_0x20a63f(0xdb)][_0x20a63f(0xbb)]+_0x20a63f(0x99));if(!_0x332267||!_0x332267[_0x20a63f(0x131)])return;const _0x5de1cd=JSON[_0x20a63f(0x146)](_0x332267[_0x20a63f(0x131)]),_0x22873f=_0x364dc1[_0x20a63f(0xdb)]['calendarSelection']||[],_0x4ac21a=_0x364dc1[_0x20a63f(0xdb)][_0x20a63f(0x13b)]||[],_0x1431ab=new Set();_0x4ac21a['forEach'](_0x2833be=>{const _0xa7811f=_0x20a63f;if(_0x2833be[_0xa7811f(0xa0)])_0x1431ab[_0xa7811f(0x113)](_0x2833be['location']);});for(const _0x315f8f of _0x5de1cd){if(_0x315f8f['_calName']&&_0x22873f[_0x20a63f(0x124)]>0x0&&!_0x22873f[_0x20a63f(0x102)](_0x315f8f[_0x20a63f(0x12c)]))continue;const _0x544aa1=_0x315f8f[_0x20a63f(0xea)]||_0x315f8f[_0x20a63f(0xff)]||_0x315f8f[_0x20a63f(0xb4)];if(!_0x544aa1)continue;const _0x2b7d4e=new Date(_0x544aa1),_0x13bc6b=_0x2b7d4e['getTime']();if(isNaN(_0x13bc6b))continue;if(_0x13bc6b<_0x201e9f)continue;if(_0x13bc6b>_0x201e9f+_0x33c06a)continue;const _0x30a523=(_0x315f8f['event']||_0x315f8f[_0x20a63f(0xc1)]||'')['toLowerCase']();let _0x234326=![],_0x56a834=[],_0x15e3cc=_0x315f8f[_0x20a63f(0x12e)]||_0x315f8f['summary']||_0x20a63f(0xe4);if(_0x30a523['includes'](_0x20a63f(0xb3))||_0x30a523[_0x20a63f(0x102)]('r√ºckkehr')||_0x30a523[_0x20a63f(0x102)](_0x20a63f(0xdf)))_0x234326=!![],_0x56a834=Array['from'](_0x1431ab);else for(const _0x5ceb34 of _0x1431ab){if(_0x30a523[_0x20a63f(0x102)](_0x5ceb34[_0x20a63f(0x123)]()))_0x56a834['push'](_0x5ceb34);}_0x56a834[_0x20a63f(0x124)]>0x0&&_0x56a834[_0x20a63f(0xc6)](_0x5aa638=>{const _0x2286ed=_0x20a63f;let _0x25a559=0x3c;if(_0x234326){let _0x47922f=0x0;Object[_0x2286ed(0x117)](_0x48b8cd)[_0x2286ed(0xc6)](_0x54d395=>{if(_0x54d395>_0x47922f)_0x47922f=_0x54d395;}),_0x25a559=_0x47922f>0x0?_0x47922f:0x78;}else _0x25a559=_0x48b8cd[_0x5aa638]||0x3c;const _0x370612=new Date(_0x13bc6b-_0x25a559*0xea60);_0x15ec3c[_0x2286ed(0x122)]({'eventTime':_0x13bc6b,'triggerTime':_0x370612[_0x2286ed(0x103)](),'room':_0x5aa638,'minutes':_0x25a559,'reason':_0x15e3cc,'isGlobal':_0x234326});});}}catch(_0x2b34fb){}_0x15ec3c[_0x20a63f(0xd5)]((_0x4152a9,_0x1aa8f8)=>_0x4152a9['triggerTime']-_0x1aa8f8[_0x20a63f(0xba)]);const _0x1d328e=_0x15ec3c[_0x20a63f(0xde)](0x0,0x5);await _0x364dc1[_0x20a63f(0x11b)](_0x20a63f(0xbe),{'val':JSON[_0x20a63f(0xf9)](_0x1d328e),'ack':!![]});}async function checkCalendarTriggers(_0x243268){const _0x57a265=a1_0x2d90;if(!_0x243268['config'][_0x57a265(0x13c)]||!_0x243268[_0x57a265(0xdb)][_0x57a265(0xbb)])return;await updateSchedulePreview(_0x243268);let _0x1e6be5={},_0x5977f9={};try{const _0x46e68e=await _0x243268[_0x57a265(0x10b)](_0x57a265(0x110));if(_0x46e68e&&_0x46e68e['val'])_0x1e6be5=JSON[_0x57a265(0x146)](_0x46e68e['val']);const _0x4d8899=await _0x243268[_0x57a265(0x10b)](_0x57a265(0x9f));if(_0x4d8899&&_0x4d8899['val'])_0x5977f9=JSON[_0x57a265(0x146)](_0x4d8899['val']);}catch(_0x731d80){}let _0x67ca5f={'default':0x15};try{const _0x21a7e9=await _0x243268[_0x57a265(0x10b)](_0x57a265(0xfb));if(_0x21a7e9&&_0x21a7e9[_0x57a265(0x131)])_0x67ca5f=JSON[_0x57a265(0x146)](_0x21a7e9[_0x57a265(0x131)]);}catch(_0x9f7b03){}try{const _0x2e18c3=await _0x243268[_0x57a265(0xbf)](_0x243268[_0x57a265(0xdb)][_0x57a265(0xbb)]+_0x57a265(0x99));if(!_0x2e18c3||!_0x2e18c3['val'])return;const _0x4ec547=JSON['parse'](_0x2e18c3[_0x57a265(0x131)]),_0x12289c=Date['now'](),_0x16565a=_0x243268[_0x57a265(0xdb)][_0x57a265(0x13b)]||[],_0x25a63c=_0x243268[_0x57a265(0xdb)][_0x57a265(0x128)]||[];for(const _0x5d315b of _0x4ec547){if(_0x5d315b[_0x57a265(0x12c)]&&_0x25a63c[_0x57a265(0x124)]>0x0&&!_0x25a63c[_0x57a265(0x102)](_0x5d315b[_0x57a265(0x12c)]))continue;const _0x3e3b9e=_0x5d315b[_0x57a265(0xea)]||_0x5d315b['eventStart']||_0x5d315b['date'];if(!_0x3e3b9e)continue;const _0x1d6fc5=new Date(_0x3e3b9e);if(isNaN(_0x1d6fc5[_0x57a265(0x103)]()))continue;const _0x27e0fc=(_0x5d315b['event']||_0x5d315b['summary']||'')['toLowerCase']();if(_0x27e0fc[_0x57a265(0x102)](_0x57a265(0xb3))||_0x27e0fc['includes'](_0x57a265(0xc2))||_0x27e0fc[_0x57a265(0x102)](_0x57a265(0xdf))){let _0x24a278=0x0;Object[_0x57a265(0x117)](_0x1e6be5)[_0x57a265(0xc6)](_0x19ce73=>{if(_0x19ce73>_0x24a278)_0x24a278=_0x19ce73;});if(_0x24a278===0x0)_0x24a278=0x78;const _0x5843f4=_0x1d6fc5[_0x57a265(0x103)]()-_0x24a278*0xea60;_0x12289c>=_0x5843f4&&_0x12289c<_0x1d6fc5[_0x57a265(0x103)]()&&(_0x243268[_0x57a265(0xcc)]!=='normal'&&(_0x243268[_0x57a265(0xbd)][_0x57a265(0x105)](_0x57a265(0xb5)+_0x24a278+_0x57a265(0x14c)),await _0x243268[_0x57a265(0x11b)](_0x57a265(0xd3),{'val':_0x57a265(0xef),'ack':![]})));}for(const _0x2e7aad of _0x16565a){if(_0x2e7aad[_0x57a265(0xa0)]){const _0x5d544a=_0x2e7aad['location'][_0x57a265(0x123)]();if(_0x27e0fc[_0x57a265(0x102)](_0x5d544a)){const _0x2cbda5=_0x1e6be5[_0x2e7aad[_0x57a265(0xa0)]]||0x3c,_0x14631a=_0x5977f9[_0x2e7aad[_0x57a265(0xa0)]]||_0x57a265(0x104),_0xafeef=_0x1d6fc5[_0x57a265(0x103)]()-_0x2cbda5*0xea60;if(_0x12289c>=_0xafeef&&_0x12289c<_0x1d6fc5['getTime']()){const _0x1067fb=lastActions[_0x57a265(0xd0)+_0x2e7aad[_0x57a265(0xa0)]];if(_0x1067fb&&_0x12289c-_0x1067fb<CAL_COOLDOWN_MS)continue;const _0x295f69=await findRelatedId(_0x243268,_0x2e7aad['id'],'setpoint');if(_0x295f69){let _0x1a309e=_0x67ca5f[_0x2e7aad[_0x57a265(0xa0)]];if(_0x1a309e===undefined)_0x1a309e=_0x67ca5f[_0x57a265(0xeb)];if(_0x1a309e===undefined)_0x1a309e=0x15;const _0x4aa374=await _0x243268[_0x57a265(0xbf)](_0x295f69);_0x4aa374&&typeof _0x4aa374[_0x57a265(0x131)]===_0x57a265(0xf2)&&_0x4aa374[_0x57a265(0x131)]<_0x1a309e-0.5&&(_0x243268[_0x57a265(0xbd)][_0x57a265(0x105)]('üìÖ\x20SMART\x20SCHEDULE\x20['+_0x14631a+_0x57a265(0x11d)+_0x2e7aad[_0x57a265(0xa0)]+_0x57a265(0xc0)+_0x1a309e+_0x57a265(0xc4)+_0x2cbda5+'\x20min).'),await _0x243268[_0x57a265(0x10e)](_0x295f69,_0x1a309e),await logAutomationAction(_0x243268,_0x57a265(0x139)+_0x2e7aad[_0x57a265(0xa0)]+'\x20->\x20'+_0x1a309e+_0x57a265(0x14e)+_0x14631a+')'),lastActions[_0x57a265(0xd0)+_0x2e7aad[_0x57a265(0xa0)]]=_0x12289c);}}}}}}}catch(_0xd3daf){_0x243268[_0x57a265(0xbd)][_0x57a265(0xd6)](_0x57a265(0x9b)+_0xd3daf[_0x57a265(0x112)]);}}function a1_0x34df(){const _0x30d22f=['level','\x27\x20hat\x20kein\x20Ger√§t\x20mehr.\x20L√∂sche\x20Eintrag.','[MPC\x20WARNING]\x20Kein\x20Setpoint\x20f√ºr\x20','34240011DvfebK','reason','replace','Ist','open','786SxDnDZ','abs','\x20ist\x20zu\x20kalt,\x20ABER\x20Fenster\x20offen/L√ºftung\x20erkannt.\x20Heize\x20NICHT,\x20entferne\x20nur\x20Status.','valve','urlaub\x20ende','date','üìÖ\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20','Fehlt','.4.VALVE_STATE','Nicht\x20gefunden','analysis.energy.ventilationAlerts','triggerTime','calendarInstance','ACTUAL_TEMPERATURE','log','analysis.energy.schedulePreview','getForeignStateAsync','\x27\x20aktiv.\x20Heize\x20auf\x20','summary','r√ºckkehr','splice','¬∞C\x20(Vorlauf:\x20','\x20wieder\x20auf\x20','forEach','.1.SET_POINT_TEMPERATURE','ACTUAL','¬∞C\x20<\x20','\x20erreicht\x20Limit\x20(','name','currentSystemMode','pi_heating_demand','185911uPgxKB','analysis.energy.mpcActiveInterventions','cal_','filter','isArray','system.mode','level.temperature','sort','warn','üìÖ\x20[MPC\x20INFO]\x20','523724YAkqMf','apply','üéì\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20','config','messwert','temp','slice','ankunft','openknx','12DalMdV','light','toString','Unbekannt','hm-rpc','\x20->\x20Schalte\x20','16645IPmjWN','üå¨Ô∏è\x20[MPC\x20WATCHDOG]\x20','sendToPythonWrapper','_date','default','role','type','contact','normal','.1.ACTUAL_TEMPERATURE','üßπ\x20[MPC\x20CLEANUP]\x20','number','.1.TEMPERATURE','state','7sXEKXZ','.4.SET_TEMPERATURE','toUpperCase','üßπ\x20[MPC\x20CLEANUP]\x20Raum\x20\x27','stringify','thermostat.setpoint','analysis.energy.warmupTargets','SET','üö®\x20[MPC\x20WATCHDOG]\x20','common','eventStart','unit','manual','includes','getTime','Classic','info','soll','530carOUP','position','analysis.automation.actionLog','remove','getStateAsync','getForeignObjectAsync','thermostatMapping','setForeignStateAsync','36toqHGs','analysis.energy.warmupTimes','thermostat','message','add','mpc_','sensor','search','values','analysis.automation.mode','analysis.automation.lastAction','indexOf','setStateAsync','1371752tWxmjX',']:\x20Raum-Trigger\x20\x27','off','constructor','switch','wert','push','toLowerCase','length','consultButler','stellwert','write','calendarSelection','Auto-Erkennung','local_temperature','localeCompare','_calName','rescue_','event','trim','¬∞C\x20(nicht\x20','val','too_cold','¬∞C!\x20(Puffer\x20leer).','setpoint','minutes_safe',':\x20Puffer\x20leer\x20->\x20Heizen\x20auf\x20','value.valve','valveMapping','[CAL]\x20','dimmer','devices','useCalendar','¬∞C).\x20Entferne\x20Status.','temperature','PERFECT','find','actual','5472675LrRvZm','score','¬∞C!\x20(Puffer:\x20','now','parse','room','current_heating_setpoint','Unknown','\x20auf\x20','entries','\x20min).','\x20ist\x20auf\x20','¬∞C\x20(via\x20','[MPC]\x20','Soll','4103816jojovn','string','1SEBLpw','Pr√§diktion:\x20','.data.table','\x20durch\x20Kalender\x20ge√§ndert.\x20Keine\x20RL-Strafe.','Calendar\x20Check\x20Error:\x20','analysis.automation.confidenceThreshold','window','üî•\x20[MPC\x20ACTION]\x20Heize\x20','analysis.energy.warmupSources','location','.1.LEVEL','split','set','level.valve','[WATCHDOG]\x20','(((.+)+)+)+$'];a1_0x34df=function(){return _0x30d22f;};return a1_0x34df();}async function manageMpcIntervention(_0x8dea5a,_0x211196,_0x22db18){const _0x59ce03=a1_0x2d90;try{const _0x4e933d=_0x59ce03(0xcf),_0x233c36=await _0x8dea5a[_0x59ce03(0x10b)](_0x4e933d);let _0x43889b=[];if(_0x233c36&&_0x233c36['val'])try{_0x43889b=JSON[_0x59ce03(0x146)](_0x233c36[_0x59ce03(0x131)]);}catch(_0x417ae7){}const _0x5a33eb=_0x43889b[_0x59ce03(0x11a)](_0x211196);if(_0x22db18===_0x59ce03(0x113))_0x5a33eb===-0x1&&(_0x43889b[_0x59ce03(0x122)](_0x211196),await _0x8dea5a['setStateAsync'](_0x4e933d,{'val':JSON['stringify'](_0x43889b),'ack':!![]}));else _0x22db18===_0x59ce03(0x10a)&&(_0x5a33eb!==-0x1&&(_0x43889b[_0x59ce03(0xc3)](_0x5a33eb,0x1),await _0x8dea5a[_0x59ce03(0x11b)](_0x4e933d,{'val':JSON[_0x59ce03(0xf9)](_0x43889b),'ack':!![]})));}catch(_0xd358a9){}}async function cleanupGhostInterventions(_0x1a1151){const _0x566161=a1_0x2d90;try{const _0x350216=_0x566161(0xcf),_0x5a2101=await _0x1a1151[_0x566161(0x10b)](_0x350216);if(!_0x5a2101||!_0x5a2101[_0x566161(0x131)])return;const _0x2a9daf=JSON[_0x566161(0x146)](_0x5a2101[_0x566161(0x131)]);if(!Array[_0x566161(0xd2)](_0x2a9daf)||_0x2a9daf['length']===0x0)return;let _0x43c6f4={'default':0x15};try{const _0x8a5156=await _0x1a1151[_0x566161(0x10b)]('analysis.energy.warmupTargets');if(_0x8a5156&&_0x8a5156['val'])_0x43c6f4=JSON[_0x566161(0x146)](_0x8a5156[_0x566161(0x131)]);}catch(_0x5d572f){}let _0x4cfe61=[];try{const _0x58d8cf=await _0x1a1151[_0x566161(0x10b)](_0x566161(0xb9));if(_0x58d8cf&&_0x58d8cf[_0x566161(0x131)])_0x4cfe61=JSON['parse'](_0x58d8cf['val']);}catch(_0x222e8e){}const _0x2e643d=_0x1a1151[_0x566161(0xdb)][_0x566161(0x13b)]||[];let _0x5e884e=![];for(let _0x5221f5=_0x2a9daf[_0x566161(0x124)]-0x1;_0x5221f5>=0x0;_0x5221f5--){const _0x54ca0d=_0x2a9daf[_0x5221f5],_0x53326b=_0x2e643d['find'](_0xe1f986=>normalize(_0xe1f986[_0x566161(0xa0)])===normalize(_0x54ca0d)&&(_0xe1f986[_0x566161(0xed)]==='temperature'||_0xe1f986[_0x566161(0xed)]===_0x566161(0x111)));if(!_0x53326b){_0x1a1151[_0x566161(0xbd)][_0x566161(0xd6)](_0x566161(0xf8)+_0x54ca0d+_0x566161(0xa8)),_0x2a9daf[_0x566161(0xc3)](_0x5221f5,0x1),_0x5e884e=!![];continue;}if(_0x53326b){const _0x3b204a=await findRelatedId(_0x1a1151,_0x53326b['id'],_0x566161(0x134)),_0x5b5850=await _0x1a1151[_0x566161(0xbf)](_0x53326b['id']);if(_0x3b204a){const _0x129f61=await _0x1a1151['getForeignStateAsync'](_0x3b204a);if(_0x129f61&&typeof _0x129f61['val']==='number'){let _0x53eb52=![],_0x249a59='';Math[_0x566161(0xb0)](_0x129f61['val']-ECO_TEMP)>0.5&&(_0x53eb52=!![],_0x249a59='manual');if(!_0x53eb52&&_0x5b5850&&typeof _0x5b5850[_0x566161(0x131)]===_0x566161(0xf2)){const _0xbb016=_0x43c6f4[_0x54ca0d]||_0x43c6f4[_0x566161(0xeb)]||0x15;_0x5b5850[_0x566161(0x131)]<_0xbb016+0.2&&(_0x53eb52=!![],_0x249a59=_0x566161(0x132));}if(_0x53eb52){if(_0x249a59===_0x566161(0x101)){_0x1a1151[_0x566161(0xbd)][_0x566161(0x105)](_0x566161(0xf1)+_0x54ca0d+_0x566161(0x14d)+_0x129f61[_0x566161(0x131)]+_0x566161(0x130)+ECO_TEMP+_0x566161(0x13d));const _0x1a55f0=lastActions[_0x566161(0xd0)+_0x54ca0d],_0x354078=_0x1a55f0&&Date[_0x566161(0x145)]()-_0x1a55f0<0x2*0x3c*0x3e8;if(!_0x354078&&_0x129f61['val']>ECO_TEMP+0.5)_0x1a1151[_0x566161(0xe9)]&&(_0x1a1151[_0x566161(0xbd)][_0x566161(0x105)](_0x566161(0xda)+_0x54ca0d+'\x20wurde\x20manuell\x20erh√∂ht.'),_0x1a1151[_0x566161(0xe9)]('TRAIN_RL_PENALTY',{'room':_0x54ca0d}));else _0x354078&&_0x1a1151[_0x566161(0xbd)][_0x566161(0x105)](_0x566161(0xd7)+_0x54ca0d+_0x566161(0x9a));}else{if(_0x249a59===_0x566161(0x132)){let _0x543191=![];if(_0x4cfe61['find'](_0x4f99de=>_0x4f99de[_0x566161(0x147)]===_0x54ca0d))_0x543191=!![];const _0x1abd95=_0x2e643d['filter'](_0x2e548c=>normalize(_0x2e548c['location'])===normalize(_0x54ca0d)&&(_0x2e548c[_0x566161(0xed)]===_0x566161(0x9d)||_0x2e548c[_0x566161(0xed)]==='sensor'||_0x2e548c[_0x566161(0xed)]===_0x566161(0xee)));for(const _0xf0764e of _0x1abd95){try{const _0x51ab8b=await _0x1a1151['getForeignStateAsync'](_0xf0764e['id']);if(_0x51ab8b&&(_0x51ab8b[_0x566161(0x131)]===!![]||_0x51ab8b[_0x566161(0x131)]===0x1||String(_0x51ab8b[_0x566161(0x131)])[_0x566161(0x123)]()===_0x566161(0xae)))_0x543191=!![];}catch(_0x50416c){}}if(_0x543191)_0x1a1151[_0x566161(0xbd)][_0x566161(0x105)](_0x566161(0xe8)+_0x54ca0d+_0x566161(0xb1));else{const _0x28f5ce=_0x43c6f4[_0x54ca0d]||_0x43c6f4[_0x566161(0xeb)]||0x15;_0x1a1151[_0x566161(0xbd)][_0x566161(0x105)](_0x566161(0xfd)+_0x54ca0d+_0x566161(0xca)+_0x5b5850['val']+_0x566161(0xc9)+(_0x28f5ce+0.2)+'¬∞C).\x20Sparmodus\x20beendet!'),await _0x1a1151[_0x566161(0x10e)](_0x3b204a,_0x28f5ce),await logAutomationAction(_0x1a1151,_0x566161(0xa5)+_0x54ca0d+_0x566161(0x136)+_0x28f5ce+'¬∞C'),lastActions[_0x566161(0x12d)+_0x54ca0d]=Date[_0x566161(0x145)]();}}}_0x2a9daf[_0x566161(0xc3)](_0x5221f5,0x1),_0x5e884e=!![];}}}}}_0x5e884e&&await _0x1a1151[_0x566161(0x11b)](_0x350216,{'val':JSON[_0x566161(0xf9)](_0x2a9daf),'ack':!![]});}catch(_0x461fbd){}}async function applyEnergySavings(_0x20a20e,_0x2f4a09){const _0x5717af=a1_0x2d90;await cleanupGhostInterventions(_0x20a20e);if(!_0x2f4a09||_0x2f4a09[_0x5717af(0x124)]===0x0)return;const _0x51dd9c=_0x20a20e[_0x5717af(0xdb)]['devices']||[],_0x21b9f3=Date['now']();for(const _0xc63699 of _0x2f4a09){const _0xba220c=_0xc63699[_0x5717af(0x147)],_0x2625e3=_0xc63699[_0x5717af(0x135)],_0x5e0303=_0xc63699['target']||0x15;if(lastActions[_0x5717af(0x12d)+_0xba220c]&&_0x21b9f3-lastActions[_0x5717af(0x12d)+_0xba220c]<RESCUE_LOCK_MS)continue;const _0x3dff2e=_0x51dd9c[_0x5717af(0x140)](_0x11702f=>normalize(_0x11702f[_0x5717af(0xa0)])===normalize(_0xba220c)&&(_0x11702f[_0x5717af(0xed)]===_0x5717af(0x13e)||_0x11702f['type']===_0x5717af(0x111)));if(!_0x3dff2e)continue;const _0x2e4674=await findRelatedId(_0x20a20e,_0x3dff2e['id'],_0x5717af(0x134));if(_0x2e4674){if(lastActions[_0x5717af(0x114)+_0xba220c]&&_0x21b9f3-lastActions[_0x5717af(0x114)+_0xba220c]<0x1e*0x3c*0x3e8)continue;const _0x2cba2c=await _0x20a20e[_0x5717af(0xbf)](_0x2e4674);if(_0x2cba2c&&typeof _0x2cba2c[_0x5717af(0x131)]===_0x5717af(0xf2)){const _0x4a9b9e=_0x2cba2c['val'];_0x4a9b9e!==ECO_TEMP&&await manageMpcIntervention(_0x20a20e,_0xba220c,_0x5717af(0x10a));if(_0x2625e3>0x1e)_0x4a9b9e>ECO_TEMP+0.5&&(_0x20a20e[_0x5717af(0xbd)][_0x5717af(0x105)]('üçÉ\x20[MPC\x20ACTION]\x20Senke\x20'+_0xba220c+_0x5717af(0x14a)+ECO_TEMP+_0x5717af(0x144)+_0x2625e3+'\x20min)'),await _0x20a20e['setForeignStateAsync'](_0x2e4674,ECO_TEMP),await manageMpcIntervention(_0x20a20e,_0xba220c,_0x5717af(0x113)),lastActions[_0x5717af(0x114)+_0xba220c]=_0x21b9f3,await logAutomationAction(_0x20a20e,_0x5717af(0x14f)+_0xba220c+':\x20Absenkung\x20auf\x20'+ECO_TEMP+'¬∞C'));else _0x2625e3<=0xf&&(_0x4a9b9e<_0x5e0303&&(_0x20a20e['log'][_0x5717af(0x105)](_0x5717af(0x9e)+_0xba220c+_0x5717af(0xc5)+_0x5e0303+_0x5717af(0x133)),await _0x20a20e[_0x5717af(0x10e)](_0x2e4674,_0x5e0303),await manageMpcIntervention(_0x20a20e,_0xba220c,_0x5717af(0x10a)),lastActions[_0x5717af(0x114)+_0xba220c]=_0x21b9f3,await logAutomationAction(_0x20a20e,'[MPC]\x20'+_0xba220c+':\x20Aufheizen\x20auf\x20'+_0x5e0303+'¬∞C')));}}else _0x20a20e[_0x5717af(0xbd)][_0x5717af(0xd6)](_0x5717af(0xa9)+_0xba220c+'\x20gefunden!');}}module['exports']={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'updateSchedulePreview':updateSchedulePreview,'cleanupGhostInterventions':cleanupGhostInterventions};