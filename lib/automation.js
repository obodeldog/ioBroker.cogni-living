const a1_0x169d5e=a1_0x54a8;(function(_0x2805bf,_0x4e490d){const _0x1ff35b=a1_0x54a8,_0x55cdbd=_0x2805bf();while(!![]){try{const _0x5c3428=-parseInt(_0x1ff35b(0x14b))/0x1*(parseInt(_0x1ff35b(0x165))/0x2)+parseInt(_0x1ff35b(0x1bd))/0x3*(-parseInt(_0x1ff35b(0x170))/0x4)+-parseInt(_0x1ff35b(0x1b1))/0x5*(parseInt(_0x1ff35b(0x172))/0x6)+parseInt(_0x1ff35b(0x16a))/0x7*(-parseInt(_0x1ff35b(0x15e))/0x8)+-parseInt(_0x1ff35b(0x198))/0x9+-parseInt(_0x1ff35b(0x13a))/0xa*(-parseInt(_0x1ff35b(0x157))/0xb)+-parseInt(_0x1ff35b(0x1c1))/0xc*(-parseInt(_0x1ff35b(0x146))/0xd);if(_0x5c3428===_0x4e490d)break;else _0x55cdbd['push'](_0x55cdbd['shift']());}catch(_0x565cf9){_0x55cdbd['push'](_0x55cdbd['shift']());}}}(a1_0x3f3b,0x9a5c8));const a1_0x2ca1af=(function(){let _0xce3320=!![];return function(_0xb61912,_0x1b456b){const _0x28359e=_0xce3320?function(){const _0x149891=a1_0x54a8;if(_0x1b456b){const _0x29470b=_0x1b456b[_0x149891(0x196)](_0xb61912,arguments);return _0x1b456b=null,_0x29470b;}}:function(){};return _0xce3320=![],_0x28359e;};}()),a1_0x443bf5=a1_0x2ca1af(this,function(){const _0x3aa29c=a1_0x54a8;return a1_0x443bf5['toString']()[_0x3aa29c(0x15a)](_0x3aa29c(0x1bc))[_0x3aa29c(0x11d)]()[_0x3aa29c(0x153)](a1_0x443bf5)[_0x3aa29c(0x15a)](_0x3aa29c(0x1bc));});a1_0x443bf5();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,RESCUE_LOCK_MS=0x78*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x13043e){const _0x8243e=a1_0x54a8;if(!_0x13043e)return'';return _0x13043e[_0x8243e(0x186)]()['replace'](/\s+/g,'')[_0x8243e(0x18a)]();}async function logAutomationAction(_0x3beb02,_0x10f30d){const _0x5b88a0=a1_0x54a8;await _0x3beb02['setStateAsync'](_0x5b88a0(0x13d),{'val':_0x10f30d,'ack':!![]});try{const _0x3d5560='analysis.automation.actionLog',_0x51ae0a=await _0x3beb02[_0x5b88a0(0x1ae)](_0x3d5560);let _0x424a37=[];if(_0x51ae0a&&_0x51ae0a['val'])try{_0x424a37=JSON[_0x5b88a0(0x16b)](_0x51ae0a[_0x5b88a0(0x163)]);}catch(_0x75e2da){}_0x424a37[_0x5b88a0(0x149)]({'ts':Date[_0x5b88a0(0x15c)](),'msg':_0x10f30d});if(_0x424a37['length']>0x32)_0x424a37=_0x424a37['slice'](0x0,0x32);await _0x3beb02[_0x5b88a0(0x12a)](_0x3d5560,{'val':JSON['stringify'](_0x424a37),'ack':!![]});}catch(_0xc48106){}}async function handlePrediction(_0xe4449c,_0x1fe370,_0x49162d){const _0x2d3fe2=a1_0x54a8;if(!_0x1fe370||_0x1fe370==='Unknown')return;let _0xde7f98='off',_0x651866=0.6;try{const _0x2f52cf=await _0xe4449c[_0x2d3fe2(0x1ae)](_0x2d3fe2(0x18f));if(_0x2f52cf&&_0x2f52cf[_0x2d3fe2(0x163)])_0xde7f98=_0x2f52cf[_0x2d3fe2(0x163)];const _0x439c6a=await _0xe4449c['getStateAsync']('analysis.automation.confidenceThreshold');if(_0x439c6a&&_0x439c6a['val'])_0x651866=_0x439c6a[_0x2d3fe2(0x163)];}catch(_0x50e55c){}if(_0xde7f98===_0x2d3fe2(0x187)||_0x49162d<_0x651866)return;const _0x367ad4=Date[_0x2d3fe2(0x15c)]();if(lastActions[_0x1fe370]&&_0x367ad4-lastActions[_0x1fe370]<COOLDOWN_MS)return;const _0x4b8fd3=_0xe4449c[_0x2d3fe2(0x199)][_0x2d3fe2(0x130)]||[],_0x3d3a86=normalize(_0x1fe370),_0x932c8f=_0x4b8fd3[_0x2d3fe2(0x134)](_0x1b2f15=>normalize(_0x1b2f15[_0x2d3fe2(0x189)])===_0x3d3a86&&(_0x1b2f15[_0x2d3fe2(0x1d1)]===_0x2d3fe2(0x137)||_0x1b2f15[_0x2d3fe2(0x1d1)]===_0x2d3fe2(0x175)||_0x1b2f15[_0x2d3fe2(0x1d1)]===_0x2d3fe2(0x1af)));if(!_0x932c8f)return;const _0x1f9757=await aiAgent[_0x2d3fe2(0x18b)](_0xe4449c,_0x1fe370,_0x932c8f['name'],_0x49162d);if(!_0x1f9757['approved'])return;const _0x2aa8ea=_0x2d3fe2(0x19f)+_0x1fe370+_0x2d3fe2(0x1cf)+_0x932c8f[_0x2d3fe2(0x18d)]+'\x20('+_0x1f9757[_0x2d3fe2(0x1d2)]+')';await logAutomationAction(_0xe4449c,'['+_0xde7f98[_0x2d3fe2(0x12b)]()+']\x20'+_0x2aa8ea);if(_0xde7f98===_0x2d3fe2(0x138)){const _0x2637f2=await _0xe4449c[_0x2d3fe2(0x17a)](_0x932c8f['id']);(!_0x2637f2||!_0x2637f2[_0x2d3fe2(0x163)]&&_0x2637f2[_0x2d3fe2(0x163)]!==!![])&&await _0xe4449c[_0x2d3fe2(0x1c6)](_0x932c8f['id'],!![]),lastActions[_0x1fe370]=_0x367ad4;}}function a1_0x54a8(_0x4b37ce,_0x5e9dbf){const _0x44cd99=a1_0x3f3b();return a1_0x54a8=function(_0x443bf5,_0x2ca1af){_0x443bf5=_0x443bf5-0x116;let _0x3f3b0c=_0x44cd99[_0x443bf5];return _0x3f3b0c;},a1_0x54a8(_0x4b37ce,_0x5e9dbf);}function a1_0x3f3b(){const _0x137506=['score','thermostat','üìÖ\x20[MPC\x20INFO]\x20','unit','\x20min).','\x20gestartet/vorbei.\x20Gebe\x20Raum\x20frei.','üßπ\x20[MPC\x20CLEANUP]\x20Raum\x20\x27','Fehlt','Manuelles\x20Mapping','openknx','setStateAsync','toUpperCase','default','common','valve','\x27\x20(Match:\x20','devices','üö®\x20[MPC\x20WATCHDOG]\x20','until','.data.table','find','soll','string','light','active','analysis.energy.activeEnforcements','2670MmQwhk','[WATCHDOG]\x20','setpoint','analysis.automation.lastAction','üìÖ\x20SMART\x20SCHEDULE\x20[','error','room','findIndex','Auto-Erkennung','TRAIN_RL_PENALTY','stringify','log','13pUWNVA','date','triggerTime','unshift','¬∞C!\x20(Puffer\x20leer).','4139iOSeqr','ACTUAL','¬∞C.','role','mpc_','.4.SET_TEMPERATURE','valveMapping','summary','constructor','useCalendar','_calName','\x20->\x20','51843FXVvEz','analysis.energy.warmupTargets','üî•\x20[MPC\x20ACTION]\x20Heize\x20','search','ist','now','analysis.energy.mpcActiveInterventions','241624jOSSMc','\x20erreicht\x20Limit\x20(','_date','position','rescue_','val','SET_POINT_TEMPERATURE','304PqHDYU','window','üçÉ\x20[MPC\x20ACTION]\x20Senke\x20','value.valve','\x27\x20hat\x20kein\x20Ger√§t\x20mehr.\x20L√∂sche\x20Eintrag.','91cuwKsy','parse','level','ankunft','local_temperature','thermostat.setpoint','4LJMhjz','.1.ACTUAL_TEMPERATURE','42PwXwtp','messwert','exports','dimmer','localeCompare','slice','getForeignObjectAsync','system.mode','getForeignStateAsync','cal_','.1.SET_POINT_TEMPERATURE','too_cold',':\x20Puffer\x20leer\x20->\x20Heizen\x20auf\x20','normal','\x20ist\x20zu\x20kalt,\x20ABER\x20Fenster\x20offen/L√ºftung\x20erkannt.\x20Heize\x20NICHT,\x20entferne\x20nur\x20Status.','¬∞C\x20(nicht\x20','forEach','¬∞C\x20(Kalender-Schutz)','\x20min)','values','toLowerCase','off','analysis.energy.warmupTimes','location','trim','consultButler','number','name','SET','analysis.automation.mode','getTime','¬∞C\x20->\x20','replace','sort','target_temperature','set','apply','Soll','9281763DNNDyV','config','splice','analysis.energy.warmupSources','analysis.energy.schedulePreview','thermostatMapping','eventStart','Pr√§diktion:\x20','isArray','analysis.energy.ventilationAlerts','wert','calendarInstance','level.valve','.4.VALVE_STATE','level.temperature','[CAL]\x20',']:\x20Raum-Trigger\x20\x27','join','minutes_safe','üö®\x20[ENFORCEMENT]\x20Hardware-Profil\x20hat\x20','stellwert','manual','getStateAsync','switch','includes','696220wAabwv','indexOf','¬∞C!\x20(Puffer:\x20','[MPC]\x20',')\x20aktiv.\x20Heize\x20auf\x20',':\x20Absenkung\x20auf\x20','pi_heating_demand','remove','.1.TEMPERATURE','PERFECT','üìÖ\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20','(((.+)+)+)+$','576696iRYOzG','sensor','temperature','length','31126884sLWVsC','push','add','open','.1.LEVEL','setForeignStateAsync','sendToPythonWrapper','warn','info','occupied_heating_setpoint','Classic','Calendar\x20Check\x20Error:\x20','[MPC\x20WARNING]\x20Kein\x20Setpoint\x20f√ºr\x20','r√ºckkehr','\x20->\x20Schalte\x20','\x20gefunden!','type','reason','getForeignObjectsAsync','split','event','Unbekannt','Enforcement\x20Monitor\x20Error:\x20','urlaub\x20ende','\x20auf\x20','filter','¬∞C\x20(Vorlauf:\x20','üßπ\x20[MPC\x20CLEANUP]\x20','current_heating_setpoint','¬∞C\x20<\x20','valve_position',':\x20Aufheizen\x20auf\x20','üéì\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20','target','toString','¬∞C).\x20Sparmodus\x20beendet!','message'];a1_0x3f3b=function(){return _0x137506;};return a1_0x3f3b();}async function findRelatedId(_0x3c8cb4,_0x17b1ac,_0x3ad0ae=a1_0x169d5e(0x13c)){const _0x1e17be=a1_0x169d5e;if(_0x3ad0ae===_0x1e17be(0x13c)&&_0x3c8cb4['config'][_0x1e17be(0x19d)]){let _0x735840=_0x3c8cb4[_0x1e17be(0x199)][_0x1e17be(0x19d)];if(typeof _0x735840===_0x1e17be(0x136))try{_0x735840=JSON[_0x1e17be(0x16b)](_0x735840);}catch(_0x14f793){}if(_0x735840&&_0x735840[_0x17b1ac])return _0x735840[_0x17b1ac];}if(_0x3ad0ae==='valve'&&_0x3c8cb4[_0x1e17be(0x199)][_0x1e17be(0x151)]){let _0x24864a=_0x3c8cb4['config']['valveMapping'];if(typeof _0x24864a===_0x1e17be(0x136))try{_0x24864a=JSON[_0x1e17be(0x16b)](_0x24864a);}catch(_0x2dd212){}if(_0x24864a&&_0x24864a[_0x17b1ac])return _0x24864a[_0x17b1ac];}let _0x48bfad=[];if(_0x3ad0ae===_0x1e17be(0x13c))_0x48bfad=[{'s':_0x1e17be(0x171),'t':_0x1e17be(0x17c)},{'s':_0x1e17be(0x1b9),'t':_0x1e17be(0x17c)},{'s':_0x1e17be(0x1b9),'t':_0x1e17be(0x150)},{'s':'ACTUAL_TEMPERATURE','t':_0x1e17be(0x164)},{'s':'local_temperature','t':_0x1e17be(0x1ca)},{'s':_0x1e17be(0x16e),'t':_0x1e17be(0x117)},{'s':_0x1e17be(0x1bf),'t':_0x1e17be(0x194)},{'s':_0x1e17be(0x14c),'t':_0x1e17be(0x18e)},{'s':'Ist','t':_0x1e17be(0x197)},{'s':_0x1e17be(0x1bf),'t':_0x1e17be(0x13c)}];else _0x3ad0ae===_0x1e17be(0x12e)&&(_0x48bfad=[{'s':'.1.ACTUAL_TEMPERATURE','t':'.1.LEVEL'},{'s':_0x1e17be(0x1b9),'t':_0x1e17be(0x1c5)},{'s':_0x1e17be(0x1b9),'t':_0x1e17be(0x1a5)},{'s':_0x1e17be(0x16e),'t':_0x1e17be(0x1b7)},{'s':_0x1e17be(0x1bf),'t':_0x1e17be(0x119)},{'s':'temperature','t':_0x1e17be(0x16c)}]);for(const _0x20a061 of _0x48bfad){if(_0x17b1ac['includes'](_0x20a061['s'])){const _0x255163=_0x17b1ac[_0x1e17be(0x192)](_0x20a061['s'],_0x20a061['t']),_0x400ba7=await _0x3c8cb4[_0x1e17be(0x178)](_0x255163);if(_0x400ba7)return _0x255163;}}try{const _0x23af39=_0x17b1ac['split']('.');if(_0x23af39[_0x1e17be(0x1c0)]>0x2){const _0x33c541=_0x23af39[_0x1e17be(0x177)](0x0,-0x1)[_0x1e17be(0x1a9)]('.'),_0x46c050=await _0x3c8cb4[_0x1e17be(0x1d3)](_0x33c541+'.*'),_0x4ee62d=[],_0x112ec2=_0x17b1ac['split'](/[._]+/)[_0x1e17be(0x1da)](_0x3bf2ea=>![_0x1e17be(0x129),'0','hm-rpc',_0x1e17be(0x15b),_0x1e17be(0x1a2),_0x1e17be(0x1bf),'actual',_0x1e17be(0x1be),_0x1e17be(0x173),'state'][_0x1e17be(0x1b0)](_0x3bf2ea[_0x1e17be(0x186)]()));for(const [_0x21c4eb,_0x1d11f3]of Object['entries'](_0x46c050)){if(_0x21c4eb===_0x17b1ac)continue;if(_0x1d11f3&&_0x1d11f3[_0x1e17be(0x12d)]){const _0x344acc=_0x21c4eb['toLowerCase'](),_0x23f077=(_0x1d11f3[_0x1e17be(0x12d)][_0x1e17be(0x14e)]||'')[_0x1e17be(0x186)](),_0x3e4a9b=(_0x1d11f3['common'][_0x1e17be(0x123)]||'')[_0x1e17be(0x186)]();let _0x423fe2=![];if(_0x3ad0ae===_0x1e17be(0x13c)&&_0x1d11f3[_0x1e17be(0x12d)]['write']===!![])_0x423fe2=_0x344acc['includes'](_0x1e17be(0x195))||_0x344acc[_0x1e17be(0x1b0)](_0x1e17be(0x135))||_0x344acc['includes']('target')||_0x23f077[_0x1e17be(0x1b0)](_0x1e17be(0x1a6))||_0x23f077[_0x1e17be(0x1b0)](_0x1e17be(0x16f));else _0x3ad0ae===_0x1e17be(0x12e)&&(_0x423fe2=_0x344acc['includes'](_0x1e17be(0x16c))||_0x344acc[_0x1e17be(0x1b0)](_0x1e17be(0x12e))||_0x344acc['includes'](_0x1e17be(0x1ac))||_0x344acc[_0x1e17be(0x1b0)](_0x1e17be(0x161))||_0x23f077['includes'](_0x1e17be(0x1a4))||_0x23f077[_0x1e17be(0x1b0)](_0x1e17be(0x168))||_0x3e4a9b[_0x1e17be(0x1b0)]('%'));if(_0x423fe2){const _0x45472b=_0x21c4eb[_0x1e17be(0x1d4)](/[._]+/)['map'](_0x103ee7=>_0x103ee7[_0x1e17be(0x186)]());let _0x19208c=0x0;_0x112ec2['forEach'](_0x5aa771=>{if(_0x45472b['includes'](_0x5aa771['toLowerCase']()))_0x19208c++;}),_0x4ee62d['push']({'id':_0x21c4eb,'score':_0x19208c});}}}if(_0x4ee62d[_0x1e17be(0x1c0)]>0x0){_0x4ee62d[_0x1e17be(0x193)]((_0x166b34,_0x153e27)=>_0x153e27['score']-_0x166b34['score']);if(_0x4ee62d[0x0][_0x1e17be(0x120)]>0x0)return _0x4ee62d[0x0]['id'];}}}catch(_0x31dd01){}return null;}async function scanThermostats(_0x3d620a){const _0x2264f8=a1_0x169d5e,_0x5db5e=_0x3d620a['config'][_0x2264f8(0x130)]||[],_0x15387a=[],_0x53d380=_0x5db5e['filter'](_0xbca8b3=>_0xbca8b3['id']&&_0xbca8b3['id']['includes'](_0x2264f8(0x1bf))||_0xbca8b3[_0x2264f8(0x1d1)]&&[_0x2264f8(0x1bf),'thermostat',_0x2264f8(0x1be)][_0x2264f8(0x1b0)](_0xbca8b3[_0x2264f8(0x1d1)])||_0xbca8b3[_0x2264f8(0x18d)]&&_0xbca8b3[_0x2264f8(0x18d)]['toLowerCase']()[_0x2264f8(0x1b0)]('temp'));for(const _0xfa4e11 of _0x53d380){const _0x77b276=await findRelatedId(_0x3d620a,_0xfa4e11['id'],'setpoint'),_0x5d5157=await findRelatedId(_0x3d620a,_0xfa4e11['id'],_0x2264f8(0x12e));let _0xe8a964='Nicht\x20gefunden',_0x8cdaed=![],_0x27c2ff=_0x3d620a[_0x2264f8(0x199)][_0x2264f8(0x19d)]||{};if(typeof _0x27c2ff===_0x2264f8(0x136))try{_0x27c2ff=JSON[_0x2264f8(0x16b)](_0x27c2ff);}catch(_0x2a121f){}let _0xe21fc=_0x3d620a[_0x2264f8(0x199)][_0x2264f8(0x151)]||{};if(typeof _0xe21fc===_0x2264f8(0x136))try{_0xe21fc=JSON[_0x2264f8(0x16b)](_0xe21fc);}catch(_0x3ada44){}if(_0x27c2ff[_0xfa4e11['id']]&&_0x27c2ff[_0xfa4e11['id']]===_0x77b276||_0xe21fc[_0xfa4e11['id']]&&_0xe21fc[_0xfa4e11['id']]===_0x5d5157)_0xe8a964=_0x2264f8(0x128),_0x8cdaed=!![];else(_0x77b276||_0x5d5157)&&(_0xe8a964=_0x2264f8(0x142));_0x15387a[_0x2264f8(0x1c2)]({'room':_0xfa4e11['location']||_0x2264f8(0x1d6),'sensorId':_0xfa4e11['id'],'setpointId':_0x77b276||'-','valveId':_0x5d5157||'-','source':_0xe8a964,'isManual':_0x8cdaed,'status':_0x77b276&&_0x5d5157?_0x2264f8(0x1ba):_0x77b276?'OK':_0x2264f8(0x127)});}return _0x15387a[_0x2264f8(0x193)]((_0x307e8f,_0x5e84b8)=>_0x307e8f[_0x2264f8(0x140)][_0x2264f8(0x176)](_0x5e84b8[_0x2264f8(0x140)]));}async function updateSchedulePreview(_0x3225ff){const _0x5837ea=a1_0x169d5e;if(!_0x3225ff[_0x5837ea(0x199)][_0x5837ea(0x154)]||!_0x3225ff[_0x5837ea(0x199)][_0x5837ea(0x1a3)])return;let _0x1a0cc5={};try{const _0x308186=await _0x3225ff[_0x5837ea(0x1ae)](_0x5837ea(0x188));if(_0x308186&&_0x308186[_0x5837ea(0x163)])_0x1a0cc5=JSON[_0x5837ea(0x16b)](_0x308186[_0x5837ea(0x163)]);}catch(_0x292177){}const _0x27ca7e=[],_0x4cec97=Date[_0x5837ea(0x15c)](),_0x2d5813=0x30*0x3c*0x3c*0x3e8;try{const _0x1d0885=await _0x3225ff[_0x5837ea(0x17a)](_0x3225ff[_0x5837ea(0x199)][_0x5837ea(0x1a3)]+_0x5837ea(0x133));if(!_0x1d0885||!_0x1d0885[_0x5837ea(0x163)])return;const _0x6c625a=JSON[_0x5837ea(0x16b)](_0x1d0885[_0x5837ea(0x163)]),_0x273a1b=_0x3225ff[_0x5837ea(0x199)]['calendarSelection']||[],_0x2a1da5=_0x3225ff[_0x5837ea(0x199)][_0x5837ea(0x130)]||[],_0x2768d5=new Set();_0x2a1da5[_0x5837ea(0x182)](_0x486abe=>{const _0x16184f=_0x5837ea;if(_0x486abe[_0x16184f(0x189)])_0x2768d5[_0x16184f(0x1c3)](_0x486abe[_0x16184f(0x189)]);});for(const _0x407b47 of _0x6c625a){if(_0x407b47['_calName']&&_0x273a1b[_0x5837ea(0x1c0)]>0x0&&!_0x273a1b['includes'](_0x407b47[_0x5837ea(0x155)]))continue;const _0x12b21e=_0x407b47['_date']||_0x407b47[_0x5837ea(0x19e)]||_0x407b47[_0x5837ea(0x147)];if(!_0x12b21e)continue;const _0x472c58=new Date(_0x12b21e),_0x38439f=_0x472c58['getTime']();if(isNaN(_0x38439f))continue;if(_0x38439f<_0x4cec97)continue;if(_0x38439f>_0x4cec97+_0x2d5813)continue;const _0x342c2b=(_0x407b47[_0x5837ea(0x1d5)]||_0x407b47[_0x5837ea(0x152)]||'')['toLowerCase']();let _0x2634c7=![],_0x2a5f5f=[],_0x437175=_0x407b47[_0x5837ea(0x1d5)]||_0x407b47[_0x5837ea(0x152)]||_0x5837ea(0x1d6);if(_0x342c2b[_0x5837ea(0x1b0)](_0x5837ea(0x1d8))||_0x342c2b[_0x5837ea(0x1b0)](_0x5837ea(0x1ce))||_0x342c2b[_0x5837ea(0x1b0)](_0x5837ea(0x16d)))_0x2634c7=!![],_0x2a5f5f=Array['from'](_0x2768d5);else for(const _0x2a1964 of _0x2768d5){if(_0x342c2b[_0x5837ea(0x1b0)](_0x2a1964[_0x5837ea(0x186)]()))_0x2a5f5f[_0x5837ea(0x1c2)](_0x2a1964);}_0x2a5f5f[_0x5837ea(0x1c0)]>0x0&&_0x2a5f5f[_0x5837ea(0x182)](_0x24103a=>{const _0x4088ba=_0x5837ea;let _0x57a2dd=0x3c;if(_0x2634c7){let _0x1e5e63=0x0;Object[_0x4088ba(0x185)](_0x1a0cc5)['forEach'](_0x476898=>{if(_0x476898>_0x1e5e63)_0x1e5e63=_0x476898;}),_0x57a2dd=_0x1e5e63>0x0?_0x1e5e63:0x78;}else _0x57a2dd=_0x1a0cc5[_0x24103a]||0x3c;const _0x7867b=new Date(_0x38439f-_0x57a2dd*0xea60);_0x27ca7e[_0x4088ba(0x1c2)]({'eventTime':_0x38439f,'triggerTime':_0x7867b['getTime'](),'room':_0x24103a,'minutes':_0x57a2dd,'reason':_0x437175,'isGlobal':_0x2634c7});});}}catch(_0xbbe6eb){}_0x27ca7e[_0x5837ea(0x193)]((_0x4498c8,_0x5b81ea)=>_0x4498c8['triggerTime']-_0x5b81ea[_0x5837ea(0x148)]);const _0x53eed1=_0x27ca7e[_0x5837ea(0x177)](0x0,0x5);await _0x3225ff[_0x5837ea(0x12a)](_0x5837ea(0x19c),{'val':JSON[_0x5837ea(0x144)](_0x53eed1),'ack':!![]});}async function monitorEnforcements(_0x546064){const _0x30edba=a1_0x169d5e;try{const _0x3f6a0f=_0x30edba(0x139),_0x40097e=await _0x546064[_0x30edba(0x1ae)](_0x3f6a0f);if(!_0x40097e||!_0x40097e[_0x30edba(0x163)])return;let _0xfd67b5=[];try{_0xfd67b5=JSON[_0x30edba(0x16b)](_0x40097e[_0x30edba(0x163)]);}catch(_0x17518d){return;}if(!Array[_0x30edba(0x1a0)](_0xfd67b5)||_0xfd67b5[_0x30edba(0x1c0)]===0x0)return;const _0x465ee4=Date[_0x30edba(0x15c)](),_0xc579c2=_0x546064['config']['devices']||[];let _0x347ee6=![];for(let _0x2bda13=_0xfd67b5['length']-0x1;_0x2bda13>=0x0;_0x2bda13--){const _0x295262=_0xfd67b5[_0x2bda13];if(_0x465ee4>=_0x295262[_0x30edba(0x132)]){_0x546064[_0x30edba(0x145)][_0x30edba(0x1c9)]('üìÖ\x20[ENFORCEMENT]\x20Kalender-Event\x20in\x20'+_0x295262['room']+_0x30edba(0x125)),_0xfd67b5[_0x30edba(0x19a)](_0x2bda13,0x1),_0x347ee6=!![];continue;}const _0x4e638f=_0xc579c2['find'](_0x46d57a=>normalize(_0x46d57a['location'])===normalize(_0x295262[_0x30edba(0x140)])&&(_0x46d57a[_0x30edba(0x1d1)]==='temperature'||_0x46d57a[_0x30edba(0x1d1)]===_0x30edba(0x121)));if(_0x4e638f){const _0x5be006=await findRelatedId(_0x546064,_0x4e638f['id'],'setpoint');if(_0x5be006){const _0x3a2e05=await _0x546064[_0x30edba(0x17a)](_0x5be006);_0x3a2e05&&typeof _0x3a2e05[_0x30edba(0x163)]===_0x30edba(0x18c)&&(_0x3a2e05[_0x30edba(0x163)]<0xf&&(_0x546064[_0x30edba(0x145)]['warn'](_0x30edba(0x1ab)+_0x295262['room']+_0x30edba(0x1d9)+_0x3a2e05[_0x30edba(0x163)]+'¬∞C\x20abgesenkt!\x20Zwinge\x20zur√ºck\x20auf\x20'+_0x295262[_0x30edba(0x11c)]+_0x30edba(0x14d)),await _0x546064[_0x30edba(0x1c6)](_0x5be006,_0x295262[_0x30edba(0x11c)]),await logAutomationAction(_0x546064,'[FORCE]\x20'+_0x295262['room']+':\x20'+_0x3a2e05['val']+_0x30edba(0x191)+_0x295262[_0x30edba(0x11c)]+_0x30edba(0x183))));}}}_0x347ee6&&await _0x546064[_0x30edba(0x12a)](_0x3f6a0f,{'val':JSON['stringify'](_0xfd67b5),'ack':!![]});}catch(_0x171cfb){_0x546064['log'][_0x30edba(0x13f)](_0x30edba(0x1d7)+_0x171cfb['message']);}}async function checkCalendarTriggers(_0x459691){const _0x5eaad6=a1_0x169d5e;if(!_0x459691['config'][_0x5eaad6(0x154)]||!_0x459691[_0x5eaad6(0x199)][_0x5eaad6(0x1a3)])return;await updateSchedulePreview(_0x459691);let _0x3a9638={},_0x44c08a={};try{const _0x10ce3b=await _0x459691[_0x5eaad6(0x1ae)](_0x5eaad6(0x188));if(_0x10ce3b&&_0x10ce3b['val'])_0x3a9638=JSON[_0x5eaad6(0x16b)](_0x10ce3b[_0x5eaad6(0x163)]);const _0x29a5f0=await _0x459691[_0x5eaad6(0x1ae)](_0x5eaad6(0x19b));if(_0x29a5f0&&_0x29a5f0['val'])_0x44c08a=JSON[_0x5eaad6(0x16b)](_0x29a5f0[_0x5eaad6(0x163)]);}catch(_0x118730){}let _0x5083d3={'default':0x15};try{const _0x32e88f=await _0x459691[_0x5eaad6(0x1ae)]('analysis.energy.warmupTargets');if(_0x32e88f&&_0x32e88f[_0x5eaad6(0x163)])_0x5083d3=JSON[_0x5eaad6(0x16b)](_0x32e88f[_0x5eaad6(0x163)]);}catch(_0x5d2f32){}let _0x14027b=[];try{const _0xa32e88=await _0x459691[_0x5eaad6(0x1ae)](_0x5eaad6(0x139));if(_0xa32e88&&_0xa32e88[_0x5eaad6(0x163)])_0x14027b=JSON[_0x5eaad6(0x16b)](_0xa32e88['val']);}catch(_0x3a650e){}try{const _0x37a764=await _0x459691['getForeignStateAsync'](_0x459691['config'][_0x5eaad6(0x1a3)]+_0x5eaad6(0x133));if(!_0x37a764||!_0x37a764[_0x5eaad6(0x163)])return;const _0xb6c31c=JSON['parse'](_0x37a764['val']),_0x33df74=Date[_0x5eaad6(0x15c)](),_0x33c71a=_0x459691[_0x5eaad6(0x199)][_0x5eaad6(0x130)]||[],_0x2bb850=_0x459691['config']['calendarSelection']||[];let _0x4b8d6f=![];for(const _0x34a4db of _0xb6c31c){if(_0x34a4db['_calName']&&_0x2bb850[_0x5eaad6(0x1c0)]>0x0&&!_0x2bb850[_0x5eaad6(0x1b0)](_0x34a4db['_calName']))continue;const _0xe475c3=_0x34a4db[_0x5eaad6(0x160)]||_0x34a4db[_0x5eaad6(0x19e)]||_0x34a4db[_0x5eaad6(0x147)];if(!_0xe475c3)continue;const _0x635dc6=new Date(_0xe475c3);if(isNaN(_0x635dc6[_0x5eaad6(0x190)]()))continue;const _0x2e6c39=(_0x34a4db[_0x5eaad6(0x1d5)]||_0x34a4db[_0x5eaad6(0x152)]||'')[_0x5eaad6(0x186)]();if(_0x2e6c39[_0x5eaad6(0x1b0)](_0x5eaad6(0x1d8))||_0x2e6c39[_0x5eaad6(0x1b0)]('r√ºckkehr')||_0x2e6c39[_0x5eaad6(0x1b0)](_0x5eaad6(0x16d))){let _0x3a85be=0x0;Object['values'](_0x3a9638)['forEach'](_0x286b0f=>{if(_0x286b0f>_0x3a85be)_0x3a85be=_0x286b0f;});if(_0x3a85be===0x0)_0x3a85be=0x78;const _0x47162b=_0x635dc6[_0x5eaad6(0x190)]()-_0x3a85be*0xea60;_0x33df74>=_0x47162b&&_0x33df74<_0x635dc6[_0x5eaad6(0x190)]()&&(_0x459691['currentSystemMode']!==_0x5eaad6(0x17f)&&(_0x459691[_0x5eaad6(0x145)]['info'](_0x5eaad6(0x1bb)+_0x3a85be+_0x5eaad6(0x124)),await _0x459691[_0x5eaad6(0x12a)](_0x5eaad6(0x179),{'val':_0x5eaad6(0x17f),'ack':![]})));}for(const _0x34e8f3 of _0x33c71a){if(_0x34e8f3[_0x5eaad6(0x189)]){const _0x1f3c10=_0x34e8f3[_0x5eaad6(0x189)]['toLowerCase'](),_0x2a4c0f=(_0x34e8f3[_0x5eaad6(0x18d)]||'')[_0x5eaad6(0x186)]();let _0x424465=_0x2e6c39[_0x5eaad6(0x1b0)](_0x1f3c10);!_0x424465&&_0x2a4c0f[_0x5eaad6(0x1c0)]>0x3&&_0x2e6c39[_0x5eaad6(0x1b0)](_0x2a4c0f)&&(_0x424465=!![]);if(_0x424465){const _0x15b03b=_0x3a9638[_0x34e8f3['location']]||0x3c,_0x1b722f=_0x44c08a[_0x34e8f3['location']]||_0x5eaad6(0x1cb),_0x3eb64e=_0x635dc6[_0x5eaad6(0x190)]()-_0x15b03b*0xea60;if(_0x33df74>=_0x3eb64e&&_0x33df74<_0x635dc6[_0x5eaad6(0x190)]()){const _0x478e21=lastActions['cal_'+_0x34e8f3[_0x5eaad6(0x189)]];if(_0x478e21&&_0x33df74-_0x478e21<CAL_COOLDOWN_MS)continue;const _0x597db8=await findRelatedId(_0x459691,_0x34e8f3['id'],_0x5eaad6(0x13c));if(_0x597db8){let _0x70d84f=_0x5083d3[_0x34e8f3[_0x5eaad6(0x189)]];if(_0x70d84f===undefined)_0x70d84f=_0x5083d3[_0x5eaad6(0x12c)];if(_0x70d84f===undefined)_0x70d84f=0x15;const _0x33044f=await _0x459691[_0x5eaad6(0x17a)](_0x597db8);if(_0x33044f&&typeof _0x33044f[_0x5eaad6(0x163)]===_0x5eaad6(0x18c)&&_0x33044f[_0x5eaad6(0x163)]<_0x70d84f-0.5){_0x459691['log'][_0x5eaad6(0x1c9)](_0x5eaad6(0x13e)+_0x1b722f+_0x5eaad6(0x1a8)+_0x34e8f3[_0x5eaad6(0x189)]+_0x5eaad6(0x12f)+_0x2e6c39+_0x5eaad6(0x1b5)+_0x70d84f+_0x5eaad6(0x1db)+_0x15b03b+_0x5eaad6(0x124)),await _0x459691[_0x5eaad6(0x1c6)](_0x597db8,_0x70d84f),await logAutomationAction(_0x459691,_0x5eaad6(0x1a7)+_0x34e8f3['location']+_0x5eaad6(0x156)+_0x70d84f+'¬∞C\x20(via\x20'+_0x1b722f+')'),lastActions['cal_'+_0x34e8f3[_0x5eaad6(0x189)]]=_0x33df74;const _0x1b8e0d=_0x14027b[_0x5eaad6(0x141)](_0x4e2be6=>_0x4e2be6[_0x5eaad6(0x140)]===_0x34e8f3[_0x5eaad6(0x189)]);if(_0x1b8e0d!==-0x1)_0x14027b['splice'](_0x1b8e0d,0x1);_0x14027b['push']({'room':_0x34e8f3[_0x5eaad6(0x189)],'target':_0x70d84f,'until':_0x635dc6[_0x5eaad6(0x190)]()}),_0x4b8d6f=!![];}}}}}}}_0x4b8d6f&&await _0x459691[_0x5eaad6(0x12a)](_0x5eaad6(0x139),{'val':JSON[_0x5eaad6(0x144)](_0x14027b),'ack':!![]});}catch(_0x5efb92){_0x459691['log'][_0x5eaad6(0x1c8)](_0x5eaad6(0x1cc)+_0x5efb92[_0x5eaad6(0x11f)]);}}async function manageMpcIntervention(_0x194601,_0xccabe1,_0x23b298){const _0x627bc7=a1_0x169d5e;try{const _0x4271e2=_0x627bc7(0x15d),_0x26e30b=await _0x194601[_0x627bc7(0x1ae)](_0x4271e2);let _0x2e8aea=[];if(_0x26e30b&&_0x26e30b[_0x627bc7(0x163)])try{_0x2e8aea=JSON[_0x627bc7(0x16b)](_0x26e30b[_0x627bc7(0x163)]);}catch(_0x4f6150){}const _0x17c4de=_0x2e8aea[_0x627bc7(0x1b2)](_0xccabe1);if(_0x23b298===_0x627bc7(0x1c3))_0x17c4de===-0x1&&(_0x2e8aea[_0x627bc7(0x1c2)](_0xccabe1),await _0x194601[_0x627bc7(0x12a)](_0x4271e2,{'val':JSON[_0x627bc7(0x144)](_0x2e8aea),'ack':!![]}));else _0x23b298===_0x627bc7(0x1b8)&&(_0x17c4de!==-0x1&&(_0x2e8aea[_0x627bc7(0x19a)](_0x17c4de,0x1),await _0x194601[_0x627bc7(0x12a)](_0x4271e2,{'val':JSON[_0x627bc7(0x144)](_0x2e8aea),'ack':!![]})));}catch(_0x655c4e){}}async function cleanupGhostInterventions(_0x210576){const _0x29f589=a1_0x169d5e;try{const _0x499bfc='analysis.energy.mpcActiveInterventions',_0x5dc3e8=await _0x210576[_0x29f589(0x1ae)](_0x499bfc);if(!_0x5dc3e8||!_0x5dc3e8[_0x29f589(0x163)])return;const _0x2ea9ec=JSON[_0x29f589(0x16b)](_0x5dc3e8[_0x29f589(0x163)]);if(!Array[_0x29f589(0x1a0)](_0x2ea9ec)||_0x2ea9ec[_0x29f589(0x1c0)]===0x0)return;let _0x534c16={'default':0x15};try{const _0xe837b=await _0x210576[_0x29f589(0x1ae)](_0x29f589(0x158));if(_0xe837b&&_0xe837b[_0x29f589(0x163)])_0x534c16=JSON[_0x29f589(0x16b)](_0xe837b[_0x29f589(0x163)]);}catch(_0x1faea5){}let _0x35ea0e=[];try{const _0x12afb9=await _0x210576['getStateAsync'](_0x29f589(0x1a1));if(_0x12afb9&&_0x12afb9['val'])_0x35ea0e=JSON[_0x29f589(0x16b)](_0x12afb9[_0x29f589(0x163)]);}catch(_0x14fd1a){}const _0x278557=_0x210576['config']['devices']||[];let _0x45f347=![];for(let _0x394022=_0x2ea9ec[_0x29f589(0x1c0)]-0x1;_0x394022>=0x0;_0x394022--){const _0x40ed5c=_0x2ea9ec[_0x394022],_0xa04ffd=_0x278557['find'](_0x372f84=>normalize(_0x372f84[_0x29f589(0x189)])===normalize(_0x40ed5c)&&(_0x372f84['type']===_0x29f589(0x1bf)||_0x372f84[_0x29f589(0x1d1)]===_0x29f589(0x121)));if(!_0xa04ffd){_0x210576[_0x29f589(0x145)]['warn'](_0x29f589(0x126)+_0x40ed5c+_0x29f589(0x169)),_0x2ea9ec[_0x29f589(0x19a)](_0x394022,0x1),_0x45f347=!![];continue;}if(_0xa04ffd){const _0x1f16ac=await findRelatedId(_0x210576,_0xa04ffd['id'],_0x29f589(0x13c)),_0x38d263=await _0x210576[_0x29f589(0x17a)](_0xa04ffd['id']);if(_0x1f16ac){const _0x1b5736=await _0x210576[_0x29f589(0x17a)](_0x1f16ac);if(_0x1b5736&&typeof _0x1b5736[_0x29f589(0x163)]===_0x29f589(0x18c)){let _0x3f49e0=![],_0x232804='';Math['abs'](_0x1b5736['val']-ECO_TEMP)>0.5&&(_0x3f49e0=!![],_0x232804=_0x29f589(0x1ad));if(!_0x3f49e0&&_0x38d263&&typeof _0x38d263[_0x29f589(0x163)]===_0x29f589(0x18c)){const _0x2761ec=_0x534c16[_0x40ed5c]||_0x534c16[_0x29f589(0x12c)]||0x15;_0x38d263['val']<_0x2761ec+0.2&&(_0x3f49e0=!![],_0x232804=_0x29f589(0x17d));}if(_0x3f49e0){if(_0x232804==='manual'){_0x210576[_0x29f589(0x145)][_0x29f589(0x1c9)](_0x29f589(0x116)+_0x40ed5c+'\x20ist\x20auf\x20'+_0x1b5736[_0x29f589(0x163)]+_0x29f589(0x181)+ECO_TEMP+'¬∞C).\x20Entferne\x20Status.');const _0x306b8b=lastActions[_0x29f589(0x17b)+_0x40ed5c],_0x6a80a3=_0x306b8b&&Date[_0x29f589(0x15c)]()-_0x306b8b<0x2*0x3c*0x3e8;if(!_0x6a80a3&&_0x1b5736[_0x29f589(0x163)]>ECO_TEMP+0.5)_0x210576[_0x29f589(0x1c7)]&&(_0x210576[_0x29f589(0x145)]['info'](_0x29f589(0x11b)+_0x40ed5c+'\x20wurde\x20manuell\x20erh√∂ht.'),_0x210576[_0x29f589(0x1c7)](_0x29f589(0x143),{'room':_0x40ed5c}));else _0x6a80a3&&_0x210576[_0x29f589(0x145)]['info'](_0x29f589(0x122)+_0x40ed5c+'\x20durch\x20Kalender\x20ge√§ndert.\x20Keine\x20RL-Strafe.');}else{if(_0x232804===_0x29f589(0x17d)){let _0x4d151d=![];if(_0x35ea0e['find'](_0x1ea61f=>_0x1ea61f[_0x29f589(0x140)]===_0x40ed5c))_0x4d151d=!![];const _0x3ced93=_0x278557[_0x29f589(0x1da)](_0x50f1a3=>normalize(_0x50f1a3[_0x29f589(0x189)])===normalize(_0x40ed5c)&&(_0x50f1a3[_0x29f589(0x1d1)]===_0x29f589(0x166)||_0x50f1a3[_0x29f589(0x1d1)]===_0x29f589(0x1be)||_0x50f1a3['type']==='contact'));for(const _0x28b72b of _0x3ced93){try{const _0x477aae=await _0x210576[_0x29f589(0x17a)](_0x28b72b['id']);if(_0x477aae&&(_0x477aae[_0x29f589(0x163)]===!![]||_0x477aae[_0x29f589(0x163)]===0x1||String(_0x477aae['val'])[_0x29f589(0x186)]()===_0x29f589(0x1c4)))_0x4d151d=!![];}catch(_0x2bfa52){}}if(_0x4d151d)_0x210576['log']['info']('üå¨Ô∏è\x20[MPC\x20WATCHDOG]\x20'+_0x40ed5c+_0x29f589(0x180));else{const _0x21cb78=_0x534c16[_0x40ed5c]||_0x534c16[_0x29f589(0x12c)]||0x15;_0x210576['log'][_0x29f589(0x1c9)](_0x29f589(0x131)+_0x40ed5c+_0x29f589(0x15f)+_0x38d263['val']+_0x29f589(0x118)+(_0x21cb78+0.2)+_0x29f589(0x11e)),await _0x210576['setForeignStateAsync'](_0x1f16ac,_0x21cb78),await logAutomationAction(_0x210576,_0x29f589(0x13b)+_0x40ed5c+_0x29f589(0x17e)+_0x21cb78+'¬∞C'),lastActions['rescue_'+_0x40ed5c]=Date[_0x29f589(0x15c)]();}}}_0x2ea9ec[_0x29f589(0x19a)](_0x394022,0x1),_0x45f347=!![];}}}}}_0x45f347&&await _0x210576['setStateAsync'](_0x499bfc,{'val':JSON[_0x29f589(0x144)](_0x2ea9ec),'ack':!![]});}catch(_0x201b3c){}}async function applyEnergySavings(_0x149685,_0x36d1a6){const _0x59eebc=a1_0x169d5e;await cleanupGhostInterventions(_0x149685);if(!_0x36d1a6||_0x36d1a6['length']===0x0)return;const _0x544410=_0x149685[_0x59eebc(0x199)][_0x59eebc(0x130)]||[],_0x325a1b=Date[_0x59eebc(0x15c)]();for(const _0x2690e4 of _0x36d1a6){const _0x29b8e1=_0x2690e4['room'],_0xc17096=_0x2690e4[_0x59eebc(0x1aa)],_0x399d40=_0x2690e4[_0x59eebc(0x11c)]||0x15;if(lastActions['rescue_'+_0x29b8e1]&&_0x325a1b-lastActions[_0x59eebc(0x162)+_0x29b8e1]<RESCUE_LOCK_MS)continue;const _0x4e97f6=_0x544410[_0x59eebc(0x134)](_0x24d0f2=>normalize(_0x24d0f2[_0x59eebc(0x189)])===normalize(_0x29b8e1)&&(_0x24d0f2[_0x59eebc(0x1d1)]==='temperature'||_0x24d0f2['type']==='thermostat'));if(!_0x4e97f6)continue;const _0x430cea=await findRelatedId(_0x149685,_0x4e97f6['id'],_0x59eebc(0x13c));if(_0x430cea){if(lastActions['mpc_'+_0x29b8e1]&&_0x325a1b-lastActions[_0x59eebc(0x14f)+_0x29b8e1]<0x1e*0x3c*0x3e8)continue;const _0x3ea776=await _0x149685[_0x59eebc(0x17a)](_0x430cea);if(_0x3ea776&&typeof _0x3ea776[_0x59eebc(0x163)]===_0x59eebc(0x18c)){const _0x1e2ae6=_0x3ea776[_0x59eebc(0x163)];_0x1e2ae6!==ECO_TEMP&&await manageMpcIntervention(_0x149685,_0x29b8e1,_0x59eebc(0x1b8));if(_0xc17096>0x1e)_0x1e2ae6>ECO_TEMP+0.5&&(_0x149685[_0x59eebc(0x145)][_0x59eebc(0x1c9)](_0x59eebc(0x167)+_0x29b8e1+_0x59eebc(0x1d9)+ECO_TEMP+_0x59eebc(0x1b3)+_0xc17096+_0x59eebc(0x184)),await _0x149685[_0x59eebc(0x1c6)](_0x430cea,ECO_TEMP),await manageMpcIntervention(_0x149685,_0x29b8e1,_0x59eebc(0x1c3)),lastActions[_0x59eebc(0x14f)+_0x29b8e1]=_0x325a1b,await logAutomationAction(_0x149685,'[MPC]\x20'+_0x29b8e1+_0x59eebc(0x1b6)+ECO_TEMP+'¬∞C'));else _0xc17096<=0xf&&(_0x1e2ae6<_0x399d40&&(_0x149685['log'][_0x59eebc(0x1c9)](_0x59eebc(0x159)+_0x29b8e1+'\x20wieder\x20auf\x20'+_0x399d40+_0x59eebc(0x14a)),await _0x149685[_0x59eebc(0x1c6)](_0x430cea,_0x399d40),await manageMpcIntervention(_0x149685,_0x29b8e1,_0x59eebc(0x1b8)),lastActions[_0x59eebc(0x14f)+_0x29b8e1]=_0x325a1b,await logAutomationAction(_0x149685,_0x59eebc(0x1b4)+_0x29b8e1+_0x59eebc(0x11a)+_0x399d40+'¬∞C')));}}else _0x149685['log'][_0x59eebc(0x1c8)](_0x59eebc(0x1cd)+_0x29b8e1+_0x59eebc(0x1d0));}}module[a1_0x169d5e(0x174)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'monitorEnforcements':monitorEnforcements,'updateSchedulePreview':updateSchedulePreview,'cleanupGhostInterventions':cleanupGhostInterventions};