const a1_0x5f4066=a1_0x3151;(function(_0x5c7339,_0x336aab){const _0x183130=a1_0x3151,_0x22d8f2=_0x5c7339();while(!![]){try{const _0x125b83=parseInt(_0x183130(0x253))/0x1*(parseInt(_0x183130(0x1ff))/0x2)+-parseInt(_0x183130(0x256))/0x3+parseInt(_0x183130(0x20d))/0x4*(parseInt(_0x183130(0x250))/0x5)+parseInt(_0x183130(0x221))/0x6+-parseInt(_0x183130(0x1f7))/0x7+-parseInt(_0x183130(0x24a))/0x8+-parseInt(_0x183130(0x1dd))/0x9*(-parseInt(_0x183130(0x20f))/0xa);if(_0x125b83===_0x336aab)break;else _0x22d8f2['push'](_0x22d8f2['shift']());}catch(_0x5256f1){_0x22d8f2['push'](_0x22d8f2['shift']());}}}(a1_0x530c,0x2e0a2));const a1_0x9be296=(function(){let _0x2d9880=!![];return function(_0x35162d,_0xe3f34d){const _0x328ebf=_0x2d9880?function(){const _0x56e6e8=a1_0x3151;if(_0xe3f34d){const _0x55fd57=_0xe3f34d[_0x56e6e8(0x20c)](_0x35162d,arguments);return _0xe3f34d=null,_0x55fd57;}}:function(){};return _0x2d9880=![],_0x328ebf;};}()),a1_0x20ac1d=a1_0x9be296(this,function(){const _0x1a5956=a1_0x3151;return a1_0x20ac1d['toString']()['search']('(((.+)+)+)+$')[_0x1a5956(0x259)]()[_0x1a5956(0x1f5)](a1_0x20ac1d)[_0x1a5956(0x249)](_0x1a5956(0x1db));});a1_0x20ac1d();'use strict';const aiAgent=require(a1_0x5f4066(0x1ee)),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x5fea24){const _0xd6997f=a1_0x5f4066;if(!_0x5fea24)return'';return _0x5fea24[_0xd6997f(0x24c)]()['replace'](/\s+/g,'')[_0xd6997f(0x23c)]();}async function handlePrediction(_0x2e66b1,_0x4bc3a2,_0x5e15a2){const _0x408143=a1_0x5f4066;if(!_0x4bc3a2||_0x4bc3a2==='Unknown')return;let _0x4417c2='off',_0x87b9f1=0.6;try{const _0x4896bb=await _0x2e66b1[_0x408143(0x209)](_0x408143(0x241));if(_0x4896bb&&_0x4896bb[_0x408143(0x1e5)])_0x4417c2=_0x4896bb['val'];const _0x2e15a9=await _0x2e66b1[_0x408143(0x209)](_0x408143(0x21c));if(_0x2e15a9&&_0x2e15a9[_0x408143(0x1e5)])_0x87b9f1=_0x2e15a9['val'];}catch(_0xd53529){}if(_0x4417c2===_0x408143(0x23a)||_0x5e15a2<_0x87b9f1)return;const _0x46365c=Date[_0x408143(0x255)]();if(lastActions[_0x4bc3a2]&&_0x46365c-lastActions[_0x4bc3a2]<COOLDOWN_MS)return;const _0xce674f=_0x2e66b1[_0x408143(0x1fc)][_0x408143(0x242)]||[],_0x52a9fd=normalize(_0x4bc3a2),_0x5396d7=_0xce674f[_0x408143(0x236)](_0x19d4c9=>normalize(_0x19d4c9[_0x408143(0x1ec)])===_0x52a9fd&&(_0x19d4c9[_0x408143(0x202)]===_0x408143(0x1f0)||_0x19d4c9['type']===_0x408143(0x21e)||_0x19d4c9[_0x408143(0x202)]==='switch'));if(!_0x5396d7){_0x2e66b1[_0x408143(0x212)][_0x408143(0x1d6)](_0x408143(0x217)+_0x4bc3a2+'\x27.');return;}const _0x206bc8=await aiAgent[_0x408143(0x213)](_0x2e66b1,_0x4bc3a2,_0x5396d7['name'],_0x5e15a2);if(!_0x206bc8[_0x408143(0x243)])return;const _0x2ec628=_0x408143(0x252)+_0x4bc3a2+'\x20->\x20Schalte\x20'+_0x5396d7[_0x408143(0x1e8)]+'\x20('+_0x206bc8[_0x408143(0x1f6)]+')';await _0x2e66b1[_0x408143(0x23e)]('analysis.automation.lastAction',{'val':'['+_0x4417c2[_0x408143(0x1e0)]()+']\x20'+_0x2ec628,'ack':!![]});if(_0x4417c2==='active'){const _0x144768=await _0x2e66b1[_0x408143(0x1da)](_0x5396d7['id']);(!_0x144768||!_0x144768['val']&&_0x144768['val']!==!![])&&await _0x2e66b1[_0x408143(0x22b)](_0x5396d7['id'],!![]),lastActions[_0x4bc3a2]=_0x46365c;}}async function findRelatedId(_0x53a51b,_0x40d98d,_0x3499e1='setpoint'){const _0x48154b=a1_0x5f4066;if(_0x3499e1===_0x48154b(0x214)&&_0x53a51b[_0x48154b(0x1fc)][_0x48154b(0x218)]){let _0xf8e1aa=_0x53a51b[_0x48154b(0x1fc)]['thermostatMapping'];if(typeof _0xf8e1aa===_0x48154b(0x1f4))try{_0xf8e1aa=JSON[_0x48154b(0x22d)](_0xf8e1aa);}catch(_0x1db058){}if(_0xf8e1aa&&_0xf8e1aa[_0x40d98d])return _0xf8e1aa[_0x40d98d];}if(_0x3499e1===_0x48154b(0x21a)&&_0x53a51b[_0x48154b(0x1fc)][_0x48154b(0x1e7)]){let _0x41b775=_0x53a51b[_0x48154b(0x1fc)][_0x48154b(0x1e7)];if(typeof _0x41b775===_0x48154b(0x1f4))try{_0x41b775=JSON[_0x48154b(0x22d)](_0x41b775);}catch(_0x48b2e4){}if(_0x41b775&&_0x41b775[_0x40d98d])return _0x41b775[_0x40d98d];}let _0xd23644=[];if(_0x3499e1===_0x48154b(0x214))_0xd23644=[{'s':_0x48154b(0x234),'t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x48154b(0x24e),'t':_0x48154b(0x1d9)},{'s':_0x48154b(0x24e),'t':_0x48154b(0x1e2)},{'s':_0x48154b(0x245),'t':_0x48154b(0x226)},{'s':_0x48154b(0x251),'t':'occupied_heating_setpoint'},{'s':_0x48154b(0x251),'t':'current_heating_setpoint'},{'s':'temperature','t':_0x48154b(0x23b)},{'s':_0x48154b(0x248),'t':_0x48154b(0x231)},{'s':_0x48154b(0x25b),'t':_0x48154b(0x1fa)},{'s':_0x48154b(0x233),'t':_0x48154b(0x214)}];else _0x3499e1===_0x48154b(0x21a)&&(_0xd23644=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x48154b(0x1f2)},{'s':'.1.TEMPERATURE','t':_0x48154b(0x1f2)},{'s':'.1.TEMPERATURE','t':'.4.VALVE_STATE'},{'s':_0x48154b(0x251),'t':_0x48154b(0x23f)},{'s':'temperature','t':_0x48154b(0x21b)},{'s':_0x48154b(0x233),'t':_0x48154b(0x24d)}]);for(const _0x357eb8 of _0xd23644){if(_0x40d98d[_0x48154b(0x208)](_0x357eb8['s'])){const _0x3ecd56=_0x40d98d[_0x48154b(0x219)](_0x357eb8['s'],_0x357eb8['t']),_0x2f0b1c=await _0x53a51b[_0x48154b(0x21f)](_0x3ecd56);if(_0x2f0b1c)return _0x3ecd56;}}try{const _0x423286=_0x40d98d[_0x48154b(0x247)]('.');if(_0x423286[_0x48154b(0x1df)]>0x2){const _0x9988cf=_0x423286[_0x48154b(0x1f8)](0x0,-0x1)['join']('.'),_0xb49ef6=await _0x53a51b[_0x48154b(0x258)](_0x9988cf+'.*'),_0x3f6255=[],_0x4a1810=_0x40d98d[_0x48154b(0x247)](/[._]+/)['filter'](_0x1e60e3=>![_0x48154b(0x1ef),'0',_0x48154b(0x1d7),'ist',_0x48154b(0x235),_0x48154b(0x233),_0x48154b(0x240),'sensor',_0x48154b(0x1dc),_0x48154b(0x211)][_0x48154b(0x208)](_0x1e60e3[_0x48154b(0x24c)]()));for(const [_0x846ada,_0xb65f2e]of Object[_0x48154b(0x200)](_0xb49ef6)){if(_0x846ada===_0x40d98d)continue;if(_0xb65f2e&&_0xb65f2e[_0x48154b(0x222)]){const _0xce007b=_0x846ada[_0x48154b(0x24c)](),_0x5b3600=(_0xb65f2e[_0x48154b(0x222)][_0x48154b(0x1f3)]||'')[_0x48154b(0x24c)](),_0x212df2=(_0xb65f2e[_0x48154b(0x222)]['unit']||'')[_0x48154b(0x24c)]();let _0x4cb7fa=![];if(_0x3499e1===_0x48154b(0x214)&&_0xb65f2e['common'][_0x48154b(0x1f1)]===!![])_0x4cb7fa=_0xce007b[_0x48154b(0x208)](_0x48154b(0x22e))||_0xce007b[_0x48154b(0x208)](_0x48154b(0x254))||_0xce007b[_0x48154b(0x208)]('target')||_0x5b3600[_0x48154b(0x208)](_0x48154b(0x225))||_0x5b3600[_0x48154b(0x208)](_0x48154b(0x223));else _0x3499e1==='valve'&&(_0x4cb7fa=_0xce007b[_0x48154b(0x208)]('level')||_0xce007b[_0x48154b(0x208)](_0x48154b(0x21a))||_0xce007b[_0x48154b(0x208)]('stellwert')||_0xce007b[_0x48154b(0x208)](_0x48154b(0x237))||_0x5b3600['includes'](_0x48154b(0x23d))||_0x5b3600['includes'](_0x48154b(0x1eb))||_0x212df2[_0x48154b(0x208)]('%'));if(_0x4cb7fa){const _0x370237=_0x846ada[_0x48154b(0x247)](/[._]+/)[_0x48154b(0x1fe)](_0x107fe1=>_0x107fe1[_0x48154b(0x24c)]());let _0x5be56d=0x0;_0x4a1810[_0x48154b(0x22a)](_0x32f06f=>{const _0xe0d306=_0x48154b;if(_0x370237[_0xe0d306(0x208)](_0x32f06f[_0xe0d306(0x24c)]()))_0x5be56d++;}),_0x3f6255[_0x48154b(0x1ea)]({'id':_0x846ada,'score':_0x5be56d});}}}if(_0x3f6255['length']>0x0){_0x3f6255[_0x48154b(0x1de)]((_0x12b1e1,_0x3c9933)=>_0x3c9933[_0x48154b(0x1ed)]-_0x12b1e1[_0x48154b(0x1ed)]);if(_0x3f6255[0x0][_0x48154b(0x1ed)]>0x0)return _0x3f6255[0x0]['id'];}}}catch(_0x4e7a73){}return null;}async function scanThermostats(_0x3a1a1){const _0x3c9cfb=a1_0x5f4066,_0x3f4f99=_0x3a1a1[_0x3c9cfb(0x1fc)][_0x3c9cfb(0x242)]||[],_0x192b21=[],_0x4d1188=_0x3f4f99[_0x3c9cfb(0x224)](_0x44e291=>_0x44e291['id']&&_0x44e291['id']['includes'](_0x3c9cfb(0x233))||_0x44e291['type']&&[_0x3c9cfb(0x233),_0x3c9cfb(0x1e1),_0x3c9cfb(0x1d8)][_0x3c9cfb(0x208)](_0x44e291[_0x3c9cfb(0x202)])||_0x44e291['name']&&_0x44e291[_0x3c9cfb(0x1e8)]['toLowerCase']()[_0x3c9cfb(0x208)]('temp'));for(const _0x5cf5d1 of _0x4d1188){const _0x50b738=await findRelatedId(_0x3a1a1,_0x5cf5d1['id'],_0x3c9cfb(0x214)),_0x4e5291=await findRelatedId(_0x3a1a1,_0x5cf5d1['id'],_0x3c9cfb(0x21a));let _0x19abfd=_0x3c9cfb(0x207),_0x55c7b0=![],_0x39f041=_0x3a1a1[_0x3c9cfb(0x1fc)][_0x3c9cfb(0x218)]||{};if(typeof _0x39f041===_0x3c9cfb(0x1f4))try{_0x39f041=JSON[_0x3c9cfb(0x22d)](_0x39f041);}catch(_0x252c27){}let _0xb46f4a=_0x3a1a1[_0x3c9cfb(0x1fc)]['valveMapping']||{};if(typeof _0xb46f4a==='string')try{_0xb46f4a=JSON['parse'](_0xb46f4a);}catch(_0x2a3775){}if(_0x39f041[_0x5cf5d1['id']]&&_0x39f041[_0x5cf5d1['id']]===_0x50b738||_0xb46f4a[_0x5cf5d1['id']]&&_0xb46f4a[_0x5cf5d1['id']]===_0x4e5291)_0x19abfd=_0x3c9cfb(0x25a),_0x55c7b0=!![];else(_0x50b738||_0x4e5291)&&(_0x19abfd=_0x3c9cfb(0x215));_0x192b21['push']({'room':_0x5cf5d1[_0x3c9cfb(0x1ec)]||_0x3c9cfb(0x24f),'sensorId':_0x5cf5d1['id'],'setpointId':_0x50b738||'-','valveId':_0x4e5291||'-','source':_0x19abfd,'isManual':_0x55c7b0,'status':_0x50b738&&_0x4e5291?'PERFECT':_0x50b738?'OK':_0x3c9cfb(0x205)});}return _0x192b21['sort']((_0x153be7,_0xa49c23)=>_0x153be7[_0x3c9cfb(0x232)][_0x3c9cfb(0x238)](_0xa49c23['room']));}async function checkCalendarTriggers(_0x36b42d){const _0xc15c06=a1_0x5f4066;if(!_0x36b42d['config']['useCalendar']||!_0x36b42d[_0xc15c06(0x1fc)]['calendarInstance'])return;let _0x210452={};try{const _0x5b95fb=await _0x36b42d[_0xc15c06(0x209)]('analysis.energy.warmupTimes');if(_0x5b95fb&&_0x5b95fb['val'])_0x210452=JSON[_0xc15c06(0x22d)](_0x5b95fb[_0xc15c06(0x1e5)]);}catch(_0x81e845){}try{const _0x45036a=await _0x36b42d[_0xc15c06(0x1da)](_0x36b42d[_0xc15c06(0x1fc)]['calendarInstance']+_0xc15c06(0x201));if(!_0x45036a||!_0x45036a[_0xc15c06(0x1e5)])return;const _0x4169f0=JSON[_0xc15c06(0x22d)](_0x45036a[_0xc15c06(0x1e5)]),_0x29da48=new Date(),_0x10856e=_0x36b42d[_0xc15c06(0x1fc)][_0xc15c06(0x242)]||[],_0x11580c=_0x36b42d['config'][_0xc15c06(0x20b)]||[];for(const _0x25b37c of _0x4169f0){if(_0x25b37c['_calName']&&_0x11580c[_0xc15c06(0x1df)]>0x0&&!_0x11580c[_0xc15c06(0x208)](_0x25b37c[_0xc15c06(0x1fb)]))continue;const _0x20aa6a=new Date(_0x25b37c[_0xc15c06(0x204)]),_0x54443b=(_0x25b37c[_0xc15c06(0x24b)]||_0x25b37c[_0xc15c06(0x22f)]||'')['toLowerCase']();if(_0x54443b[_0xc15c06(0x208)](_0xc15c06(0x1f9))||_0x54443b[_0xc15c06(0x208)](_0xc15c06(0x20e))||_0x54443b[_0xc15c06(0x208)](_0xc15c06(0x1e4))){let _0xe67497=0x0;Object[_0xc15c06(0x228)](_0x210452)[_0xc15c06(0x22a)](_0x49ae1b=>{if(_0x49ae1b>_0xe67497)_0xe67497=_0x49ae1b;});if(_0xe67497===0x0)_0xe67497=0x78;const _0x471994=new Date(_0x20aa6a[_0xc15c06(0x216)]()-_0xe67497*0xea60),_0x2d403d=_0x29da48[_0xc15c06(0x216)]()-_0x471994[_0xc15c06(0x216)]();_0x2d403d>=0x0&&_0x2d403d<0xf*0xea60&&(_0x36b42d['log'][_0xc15c06(0x227)]('üìÖ\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20('+_0x25b37c[_0xc15c06(0x24b)]+_0xc15c06(0x22c)+_0xe67497+_0xc15c06(0x21d)),await _0x36b42d[_0xc15c06(0x23e)](_0xc15c06(0x203),{'val':'normal','ack':![]}));}for(const _0x5001b7 of _0x10856e){if(_0x5001b7['location']){const _0x2ee650=_0x5001b7['location'][_0xc15c06(0x24c)]();if(_0x54443b[_0xc15c06(0x208)](_0x2ee650)){const _0x204955=_0x210452[_0x5001b7[_0xc15c06(0x1ec)]]||0x3c,_0xffcd42=new Date(_0x20aa6a[_0xc15c06(0x216)]()-_0x204955*0xea60),_0x288b17=_0x29da48[_0xc15c06(0x216)]()-_0xffcd42[_0xc15c06(0x216)]();if(_0x288b17>=0x0&&_0x288b17<0xf*0xea60){const _0x1e90e7=await findRelatedId(_0x36b42d,_0x5001b7['id'],_0xc15c06(0x214));_0x1e90e7&&(_0x36b42d[_0xc15c06(0x212)][_0xc15c06(0x227)](_0xc15c06(0x1fd)+_0x5001b7[_0xc15c06(0x1ec)]+_0xc15c06(0x246)+_0x25b37c[_0xc15c06(0x24b)]+_0xc15c06(0x230)+_0x204955+_0xc15c06(0x21d)),await _0x36b42d[_0xc15c06(0x22b)](_0x1e90e7,0x15),await _0x36b42d[_0xc15c06(0x23e)](_0xc15c06(0x244),{'val':_0xc15c06(0x257)+_0x5001b7[_0xc15c06(0x1ec)]+_0xc15c06(0x210),'ack':!![]}));}}}}}}catch(_0xdc62a5){_0x36b42d['log']['warn'](_0xc15c06(0x220)+_0xdc62a5['message']);}}function a1_0x3151(_0x5f6b20,_0x1250de){const _0x53a10b=a1_0x530c();return a1_0x3151=function(_0x20ac1d,_0x9be296){_0x20ac1d=_0x20ac1d-0x1d5;let _0x530cd4=_0x53a10b[_0x20ac1d];return _0x530cd4;},a1_0x3151(_0x5f6b20,_0x1250de);}async function applyEnergySavings(_0x3fc835,_0x124290){const _0xe72e2f=a1_0x5f4066,_0x425249=_0x3fc835['config'][_0xe72e2f(0x242)]||[];for(const _0x32b7b3 of _0x124290){const _0x30629f=_0x32b7b3['room'],_0x867982=_0x32b7b3[_0xe72e2f(0x1e6)],_0xeb2e5=Date[_0xe72e2f(0x255)]();if(lastActions[_0xe72e2f(0x239)+_0x30629f]&&_0xeb2e5-lastActions['mpc_'+_0x30629f]<0x1e*0x3c*0x3e8)continue;const _0x4be1b6=_0x425249['find'](_0x1581b9=>normalize(_0x1581b9[_0xe72e2f(0x1ec)])===normalize(_0x30629f));if(!_0x4be1b6)continue;const _0x25fc51=await findRelatedId(_0x3fc835,_0x4be1b6['id'],'setpoint');if(_0x25fc51){const _0x3b07ad=await _0x3fc835[_0xe72e2f(0x1da)](_0x25fc51);if(_0x3b07ad&&typeof _0x3b07ad[_0xe72e2f(0x1e5)]===_0xe72e2f(0x206)){const _0x3c5eda=_0x3b07ad['val'];if(_0x867982>0x1e&&_0x3c5eda>0x11){const _0x2ad853=_0x3c5eda-0x1;_0x3fc835[_0xe72e2f(0x212)]['info'](_0xe72e2f(0x1e3)+_0x30629f+'\x20('+_0x25fc51+_0xe72e2f(0x1e9)+_0x2ad853+'¬∞C\x20(Coasting\x20m√∂glich:\x20'+_0x867982+_0xe72e2f(0x1d5)),await _0x3fc835[_0xe72e2f(0x22b)](_0x25fc51,_0x2ad853),lastActions[_0xe72e2f(0x239)+_0x30629f]=_0xeb2e5,await _0x3fc835['setStateAsync'](_0xe72e2f(0x244),{'val':_0xe72e2f(0x20a)+_0x30629f+_0xe72e2f(0x229),'ack':!![]});}}}}}function a1_0x530c(){const _0x985db8=['slice','urlaub\x20ende','Soll','_calName','config','üìÖ\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27','map','6FfkBmK','entries','.data.table','type','system.mode','eventStart','Fehlt','number','Nicht\x20gefunden','includes','getStateAsync','[MPC]\x20','calendarSelection','apply','8fUjLFj','r√ºckkehr','3210XNRwJi','\x20->\x2021¬∞C','state','log','consultButler','setpoint','Auto-Erkennung','getTime','üîç\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27','thermostatMapping','replace','valve','valve_position','analysis.automation.confidenceThreshold','\x20min).','dimmer','getForeignObjectAsync','Calendar\x20Check\x20Error:\x20','403506DwmTrs','common','thermostat.setpoint','filter','level.temperature','SET_POINT_TEMPERATURE','info','values',':\x20-1¬∞C\x20(Sparpotenzial\x20genutzt)','forEach','setForeignStateAsync',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','parse','set','summary',').\x20Heize\x20auf\x2021¬∞C\x20(Vorlauf:\x20','SET','room','temperature','.1.ACTUAL_TEMPERATURE','wert','find','position','localeCompare','mpc_','off','target_temperature','trim','level.valve','setStateAsync','pi_heating_demand','actual','analysis.automation.mode','devices','approved','analysis.automation.lastAction','ACTUAL_TEMPERATURE','\x27\x20erkannt\x20(','split','ACTUAL','search','2791784YibVlV','event','toLowerCase','level','.1.TEMPERATURE','Unbekannt','55680nYXxcl','local_temperature','Pr√§diktion:\x20','58651voqLQp','soll','now','455682EHaLfr','[CAL]\x20','getForeignObjectsAsync','toString','Manuelles\x20Mapping','Ist','\x20min)','debug','hm-rpc','sensor','.1.SET_POINT_TEMPERATURE','getForeignStateAsync','(((.+)+)+)+$','messwert','12429UHDtGK','sort','length','toUpperCase','thermostat','.4.SET_TEMPERATURE','üçÉ\x20MPC\x20Autonomy:\x20Senke\x20','ankunft','val','minutes_safe','valveMapping','name',')\x20auf\x20','push','value.valve','location','score','./ai_agent','openknx','light','write','.1.LEVEL','role','string','constructor','reason','135324qUAkOw'];a1_0x530c=function(){return _0x985db8;};return a1_0x530c();}module['exports']={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};