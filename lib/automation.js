const a1_0x497f6d=a1_0x5d96;(function(_0x6c15ec,_0xf90feb){const _0x2330b7=a1_0x5d96,_0xe9c43e=_0x6c15ec();while(!![]){try{const _0x28697e=-parseInt(_0x2330b7(0x24f))/0x1+parseInt(_0x2330b7(0x215))/0x2*(parseInt(_0x2330b7(0x25c))/0x3)+-parseInt(_0x2330b7(0x266))/0x4+-parseInt(_0x2330b7(0x1f4))/0x5+-parseInt(_0x2330b7(0x1fe))/0x6*(-parseInt(_0x2330b7(0x23b))/0x7)+parseInt(_0x2330b7(0x24b))/0x8+-parseInt(_0x2330b7(0x20f))/0x9;if(_0x28697e===_0xf90feb)break;else _0xe9c43e['push'](_0xe9c43e['shift']());}catch(_0xeff411){_0xe9c43e['push'](_0xe9c43e['shift']());}}}(a1_0x2c02,0x9b19b));function a1_0x5d96(_0x1e1dd9,_0x21386f){const _0x314057=a1_0x2c02();return a1_0x5d96=function(_0x576384,_0x286c1e){_0x576384=_0x576384-0x1d7;let _0x2c0296=_0x314057[_0x576384];return _0x2c0296;},a1_0x5d96(_0x1e1dd9,_0x21386f);}const a1_0x286c1e=(function(){let _0x37fac0=!![];return function(_0x48a084,_0x27abbd){const _0x10e268=_0x37fac0?function(){const _0x17faf1=a1_0x5d96;if(_0x27abbd){const _0x116c06=_0x27abbd[_0x17faf1(0x205)](_0x48a084,arguments);return _0x27abbd=null,_0x116c06;}}:function(){};return _0x37fac0=![],_0x10e268;};}()),a1_0x576384=a1_0x286c1e(this,function(){const _0x4a27df=a1_0x5d96;return a1_0x576384[_0x4a27df(0x21b)]()['search']('(((.+)+)+)+$')['toString']()[_0x4a27df(0x276)](a1_0x576384)[_0x4a27df(0x216)]('(((.+)+)+)+$');});a1_0x576384();function a1_0x2c02(){const _0x1fe52f=['indexOf','unit','apply','¬∞C\x20(nicht\x20','local_temperature','score','localeCompare','consultButler','eventStart','thermostat.setpoint','unshift','parse','465381vELyVf','getForeignObjectsAsync','mpc_','stringify','state','trim','38wrUsju','search','ACTUAL','number','üìÖ\x20[MPC\x20INFO]\x20','\x20wurde\x20manuell\x20erh√∂ht.','toString','info','ist','toLowerCase','active','.1.SET_POINT_TEMPERATURE','add','forEach','\x20ist\x20auf\x20','level','room','values','role','üßπ\x20[MPC\x20CLEANUP]\x20Raum\x20\x27','useCalendar','reason','location','temp','Fehlt','¬∞C\x20<\x20','üéì\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20','analysis.energy.warmupTimes','_date','messwert','value.valve','log','\x20->\x20Schalte\x20','analysis.energy.ventilationAlerts','warn','message','Soll','abs','9149aEQQSw','rescue_','analysis.energy.warmupSources','includes','remove','¬∞C\x20(Vorlauf:\x20','TRAIN_RL_PENALTY','.data.table','Unknown','from','üå¨Ô∏è\x20[MPC\x20WATCHDOG]\x20','setStateAsync','.4.SET_TEMPERATURE','analysis.energy.mpcActiveInterventions','sort','sendToPythonWrapper','8744240UDiFLD','getStateAsync','manual','type','1189753OsaPfR','length','\x20min).','.1.TEMPERATURE','summary','setpoint','üö®\x20[MPC\x20WATCHDOG]\x20','SET_POINT_TEMPERATURE','.1.ACTUAL_TEMPERATURE','filter','PERFECT','devices','target_temperature','70878rtqtwh','valveMapping','minutes_safe','analysis.automation.confidenceThreshold','./ai_agent','now','cal_','r√ºckkehr','split','Ist','1952608TthbqJ','calendarInstance','too_cold','string','ankunft','date','replace','normal','target','position','val','analysis.automation.actionLog','openknx','_calName','setForeignStateAsync','Unbekannt','constructor','.4.VALVE_STATE','¬∞C).\x20Sparmodus\x20beendet!','temperature','getForeignStateAsync','[CAL]\x20','valve_position','config','[MPC\x20WARNING]\x20Kein\x20Setpoint\x20f√ºr\x20',':\x20Puffer\x20leer\x20->\x20Heizen\x20auf\x20','analysis.automation.lastAction',']:\x20Raum-Trigger\x20\x27','triggerTime','valve','toUpperCase','getForeignObjectAsync','name','urlaub\x20ende','Classic','entries','Nicht\x20gefunden','stellwert','üìÖ\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20','üìÖ\x20SMART\x20SCHEDULE\x20[','event',':\x20Absenkung\x20auf\x20','open','pi_heating_demand','\x20durch\x20Kalender\x20ge√§ndert.\x20Keine\x20RL-Strafe.','Pr√§diktion:\x20','push','actual','approved','join','light','switch','slice','off','Manuelles\x20Mapping','find',':\x20Aufheizen\x20auf\x20','common','current_heating_setpoint','thermostat','hm-rpc','1178445bhMEFL','getTime','analysis.energy.warmupTargets','üî•\x20[MPC\x20ACTION]\x20Heize\x20','¬∞C!\x20(Puffer:\x20','set','\x20min)','[WATCHDOG]\x20','default','splice','4860hgnfWa','sensor','\x20gefunden!','analysis.energy.schedulePreview','calendarSelection'];a1_0x2c02=function(){return _0x1fe52f;};return a1_0x2c02();}'use strict';const aiAgent=require(a1_0x497f6d(0x260)),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,RESCUE_LOCK_MS=0x78*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x238baa){const _0xbec0aa=a1_0x497f6d;if(!_0x238baa)return'';return _0x238baa[_0xbec0aa(0x21e)]()['replace'](/\s+/g,'')[_0xbec0aa(0x214)]();}async function logAutomationAction(_0x23b7fd,_0x244911){const _0xc70d0f=a1_0x497f6d;await _0x23b7fd[_0xc70d0f(0x246)](_0xc70d0f(0x280),{'val':_0x244911,'ack':!![]});try{const _0x5932af=_0xc70d0f(0x271),_0x2db6e7=await _0x23b7fd['getStateAsync'](_0x5932af);let _0x2405ed=[];if(_0x2db6e7&&_0x2db6e7[_0xc70d0f(0x270)])try{_0x2405ed=JSON[_0xc70d0f(0x20e)](_0x2db6e7['val']);}catch(_0x23f53b){}_0x2405ed[_0xc70d0f(0x20d)]({'ts':Date['now'](),'msg':_0x244911});if(_0x2405ed[_0xc70d0f(0x250)]>0x32)_0x2405ed=_0x2405ed['slice'](0x0,0x32);await _0x23b7fd[_0xc70d0f(0x246)](_0x5932af,{'val':JSON['stringify'](_0x2405ed),'ack':!![]});}catch(_0x3b170c){}}async function handlePrediction(_0x43b1b0,_0x2cda91,_0x2aaef0){const _0x5f8e34=a1_0x497f6d;if(!_0x2cda91||_0x2cda91===_0x5f8e34(0x243))return;let _0x580eed=_0x5f8e34(0x1ec),_0x5cb3df=0.6;try{const _0x48dd8b=await _0x43b1b0[_0x5f8e34(0x24c)]('analysis.automation.mode');if(_0x48dd8b&&_0x48dd8b['val'])_0x580eed=_0x48dd8b[_0x5f8e34(0x270)];const _0x9bc54=await _0x43b1b0['getStateAsync'](_0x5f8e34(0x25f));if(_0x9bc54&&_0x9bc54[_0x5f8e34(0x270)])_0x5cb3df=_0x9bc54['val'];}catch(_0x530306){}if(_0x580eed===_0x5f8e34(0x1ec)||_0x2aaef0<_0x5cb3df)return;const _0x32c2fe=Date[_0x5f8e34(0x261)]();if(lastActions[_0x2cda91]&&_0x32c2fe-lastActions[_0x2cda91]<COOLDOWN_MS)return;const _0x3c5872=_0x43b1b0[_0x5f8e34(0x27d)][_0x5f8e34(0x25a)]||[],_0x43fbcb=normalize(_0x2cda91),_0x524b62=_0x3c5872[_0x5f8e34(0x1ee)](_0xd23293=>normalize(_0xd23293['location'])===_0x43fbcb&&(_0xd23293[_0x5f8e34(0x24e)]===_0x5f8e34(0x1e9)||_0xd23293[_0x5f8e34(0x24e)]==='dimmer'||_0xd23293[_0x5f8e34(0x24e)]===_0x5f8e34(0x1ea)));if(!_0x524b62)return;const _0x5a380f=await aiAgent[_0x5f8e34(0x20a)](_0x43b1b0,_0x2cda91,_0x524b62['name'],_0x2aaef0);if(!_0x5a380f[_0x5f8e34(0x1e7)])return;const _0x7d69db=_0x5f8e34(0x1e4)+_0x2cda91+_0x5f8e34(0x235)+_0x524b62['name']+'\x20('+_0x5a380f[_0x5f8e34(0x22a)]+')';await logAutomationAction(_0x43b1b0,'['+_0x580eed[_0x5f8e34(0x284)]()+']\x20'+_0x7d69db);if(_0x580eed===_0x5f8e34(0x21f)){const _0x5a4423=await _0x43b1b0[_0x5f8e34(0x27a)](_0x524b62['id']);(!_0x5a4423||!_0x5a4423[_0x5f8e34(0x270)]&&_0x5a4423[_0x5f8e34(0x270)]!==!![])&&await _0x43b1b0['setForeignStateAsync'](_0x524b62['id'],!![]),lastActions[_0x2cda91]=_0x32c2fe;}}async function findRelatedId(_0x3ca229,_0x34b2e5,_0x3f11b4=a1_0x497f6d(0x254)){const _0x3d4b3f=a1_0x497f6d;if(_0x3f11b4===_0x3d4b3f(0x254)&&_0x3ca229[_0x3d4b3f(0x27d)]['thermostatMapping']){let _0x2480d4=_0x3ca229[_0x3d4b3f(0x27d)]['thermostatMapping'];if(typeof _0x2480d4===_0x3d4b3f(0x269))try{_0x2480d4=JSON[_0x3d4b3f(0x20e)](_0x2480d4);}catch(_0x2bb830){}if(_0x2480d4&&_0x2480d4[_0x34b2e5])return _0x2480d4[_0x34b2e5];}if(_0x3f11b4===_0x3d4b3f(0x283)&&_0x3ca229[_0x3d4b3f(0x27d)][_0x3d4b3f(0x25d)]){let _0x330478=_0x3ca229[_0x3d4b3f(0x27d)]['valveMapping'];if(typeof _0x330478==='string')try{_0x330478=JSON['parse'](_0x330478);}catch(_0x11953d){}if(_0x330478&&_0x330478[_0x34b2e5])return _0x330478[_0x34b2e5];}let _0x1536d7=[];if(_0x3f11b4===_0x3d4b3f(0x254))_0x1536d7=[{'s':_0x3d4b3f(0x257),'t':_0x3d4b3f(0x220)},{'s':'.1.TEMPERATURE','t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x3d4b3f(0x252),'t':_0x3d4b3f(0x247)},{'s':'ACTUAL_TEMPERATURE','t':_0x3d4b3f(0x256)},{'s':'local_temperature','t':'occupied_heating_setpoint'},{'s':_0x3d4b3f(0x207),'t':_0x3d4b3f(0x1f1)},{'s':'temperature','t':_0x3d4b3f(0x25b)},{'s':_0x3d4b3f(0x217),'t':'SET'},{'s':_0x3d4b3f(0x265),'t':_0x3d4b3f(0x239)},{'s':_0x3d4b3f(0x279),'t':'setpoint'}];else _0x3f11b4==='valve'&&(_0x1536d7=[{'s':_0x3d4b3f(0x257),'t':'.1.LEVEL'},{'s':_0x3d4b3f(0x252),'t':'.1.LEVEL'},{'s':_0x3d4b3f(0x252),'t':_0x3d4b3f(0x277)},{'s':_0x3d4b3f(0x207),'t':_0x3d4b3f(0x1e2)},{'s':_0x3d4b3f(0x279),'t':_0x3d4b3f(0x27c)},{'s':_0x3d4b3f(0x279),'t':'level'}]);for(const _0x57f72a of _0x1536d7){if(_0x34b2e5[_0x3d4b3f(0x23e)](_0x57f72a['s'])){const _0x3811da=_0x34b2e5[_0x3d4b3f(0x26c)](_0x57f72a['s'],_0x57f72a['t']),_0x409b0b=await _0x3ca229[_0x3d4b3f(0x285)](_0x3811da);if(_0x409b0b)return _0x3811da;}}try{const _0x30442e=_0x34b2e5['split']('.');if(_0x30442e['length']>0x2){const _0x590d5e=_0x30442e[_0x3d4b3f(0x1eb)](0x0,-0x1)[_0x3d4b3f(0x1e8)]('.'),_0x3d5778=await _0x3ca229[_0x3d4b3f(0x210)](_0x590d5e+'.*'),_0x185f68=[],_0x114f2b=_0x34b2e5[_0x3d4b3f(0x264)](/[._]+/)[_0x3d4b3f(0x258)](_0x429f9b=>![_0x3d4b3f(0x272),'0',_0x3d4b3f(0x1f3),_0x3d4b3f(0x21d),'wert',_0x3d4b3f(0x279),_0x3d4b3f(0x1e6),_0x3d4b3f(0x1ff),_0x3d4b3f(0x232),_0x3d4b3f(0x213)][_0x3d4b3f(0x23e)](_0x429f9b[_0x3d4b3f(0x21e)]()));for(const [_0x261513,_0x1d7e8e]of Object[_0x3d4b3f(0x1da)](_0x3d5778)){if(_0x261513===_0x34b2e5)continue;if(_0x1d7e8e&&_0x1d7e8e[_0x3d4b3f(0x1f0)]){const _0x2ae0e7=_0x261513[_0x3d4b3f(0x21e)](),_0x2109db=(_0x1d7e8e[_0x3d4b3f(0x1f0)][_0x3d4b3f(0x227)]||'')['toLowerCase'](),_0x388d0b=(_0x1d7e8e[_0x3d4b3f(0x1f0)][_0x3d4b3f(0x204)]||'')[_0x3d4b3f(0x21e)]();let _0x255235=![];if(_0x3f11b4===_0x3d4b3f(0x254)&&_0x1d7e8e[_0x3d4b3f(0x1f0)]['write']===!![])_0x255235=_0x2ae0e7[_0x3d4b3f(0x23e)](_0x3d4b3f(0x1f9))||_0x2ae0e7[_0x3d4b3f(0x23e)]('soll')||_0x2ae0e7[_0x3d4b3f(0x23e)](_0x3d4b3f(0x26e))||_0x2109db[_0x3d4b3f(0x23e)]('level.temperature')||_0x2109db[_0x3d4b3f(0x23e)](_0x3d4b3f(0x20c));else _0x3f11b4===_0x3d4b3f(0x283)&&(_0x255235=_0x2ae0e7[_0x3d4b3f(0x23e)](_0x3d4b3f(0x224))||_0x2ae0e7[_0x3d4b3f(0x23e)]('valve')||_0x2ae0e7['includes'](_0x3d4b3f(0x1dc))||_0x2ae0e7[_0x3d4b3f(0x23e)](_0x3d4b3f(0x26f))||_0x2109db['includes']('level.valve')||_0x2109db['includes'](_0x3d4b3f(0x233))||_0x388d0b['includes']('%'));if(_0x255235){const _0x1a7032=_0x261513['split'](/[._]+/)['map'](_0x4c6a7c=>_0x4c6a7c[_0x3d4b3f(0x21e)]());let _0xa86bde=0x0;_0x114f2b[_0x3d4b3f(0x222)](_0x381ec5=>{const _0x11abd0=_0x3d4b3f;if(_0x1a7032[_0x11abd0(0x23e)](_0x381ec5[_0x11abd0(0x21e)]()))_0xa86bde++;}),_0x185f68[_0x3d4b3f(0x1e5)]({'id':_0x261513,'score':_0xa86bde});}}}if(_0x185f68['length']>0x0){_0x185f68['sort']((_0x11993b,_0xf35778)=>_0xf35778[_0x3d4b3f(0x208)]-_0x11993b[_0x3d4b3f(0x208)]);if(_0x185f68[0x0][_0x3d4b3f(0x208)]>0x0)return _0x185f68[0x0]['id'];}}}catch(_0x4bc19e){}return null;}async function scanThermostats(_0x2e73b4){const _0x96f2ca=a1_0x497f6d,_0x4cffc5=_0x2e73b4[_0x96f2ca(0x27d)][_0x96f2ca(0x25a)]||[],_0x201bc2=[],_0x48b713=_0x4cffc5['filter'](_0x21ebb4=>_0x21ebb4['id']&&_0x21ebb4['id']['includes'](_0x96f2ca(0x279))||_0x21ebb4[_0x96f2ca(0x24e)]&&[_0x96f2ca(0x279),_0x96f2ca(0x1f2),_0x96f2ca(0x1ff)]['includes'](_0x21ebb4['type'])||_0x21ebb4[_0x96f2ca(0x1d7)]&&_0x21ebb4[_0x96f2ca(0x1d7)][_0x96f2ca(0x21e)]()['includes'](_0x96f2ca(0x22c)));for(const _0x39746d of _0x48b713){const _0x13cec4=await findRelatedId(_0x2e73b4,_0x39746d['id'],_0x96f2ca(0x254)),_0x4a2468=await findRelatedId(_0x2e73b4,_0x39746d['id'],_0x96f2ca(0x283));let _0x1b8005=_0x96f2ca(0x1db),_0x330887=![],_0x47aeea=_0x2e73b4[_0x96f2ca(0x27d)]['thermostatMapping']||{};if(typeof _0x47aeea===_0x96f2ca(0x269))try{_0x47aeea=JSON['parse'](_0x47aeea);}catch(_0x22c01a){}let _0x352719=_0x2e73b4[_0x96f2ca(0x27d)][_0x96f2ca(0x25d)]||{};if(typeof _0x352719===_0x96f2ca(0x269))try{_0x352719=JSON[_0x96f2ca(0x20e)](_0x352719);}catch(_0x241adb){}if(_0x47aeea[_0x39746d['id']]&&_0x47aeea[_0x39746d['id']]===_0x13cec4||_0x352719[_0x39746d['id']]&&_0x352719[_0x39746d['id']]===_0x4a2468)_0x1b8005=_0x96f2ca(0x1ed),_0x330887=!![];else(_0x13cec4||_0x4a2468)&&(_0x1b8005='Auto-Erkennung');_0x201bc2[_0x96f2ca(0x1e5)]({'room':_0x39746d[_0x96f2ca(0x22b)]||_0x96f2ca(0x275),'sensorId':_0x39746d['id'],'setpointId':_0x13cec4||'-','valveId':_0x4a2468||'-','source':_0x1b8005,'isManual':_0x330887,'status':_0x13cec4&&_0x4a2468?_0x96f2ca(0x259):_0x13cec4?'OK':_0x96f2ca(0x22d)});}return _0x201bc2[_0x96f2ca(0x249)]((_0x597a14,_0x6b22e4)=>_0x597a14['room'][_0x96f2ca(0x209)](_0x6b22e4['room']));}async function updateSchedulePreview(_0x57eafc){const _0xa53e7f=a1_0x497f6d;if(!_0x57eafc[_0xa53e7f(0x27d)][_0xa53e7f(0x229)]||!_0x57eafc[_0xa53e7f(0x27d)][_0xa53e7f(0x267)])return;let _0x5442ef={};try{const _0x30b3cf=await _0x57eafc[_0xa53e7f(0x24c)](_0xa53e7f(0x230));if(_0x30b3cf&&_0x30b3cf[_0xa53e7f(0x270)])_0x5442ef=JSON[_0xa53e7f(0x20e)](_0x30b3cf['val']);}catch(_0x221bc2){}const _0x2e37bf=[],_0x78c958=Date[_0xa53e7f(0x261)](),_0x4cd6c2=0x30*0x3c*0x3c*0x3e8;try{const _0x572b65=await _0x57eafc[_0xa53e7f(0x27a)](_0x57eafc[_0xa53e7f(0x27d)]['calendarInstance']+_0xa53e7f(0x242));if(!_0x572b65||!_0x572b65['val'])return;const _0x2b84a7=JSON[_0xa53e7f(0x20e)](_0x572b65[_0xa53e7f(0x270)]),_0x5001d0=_0x57eafc['config'][_0xa53e7f(0x202)]||[],_0xa2f379=_0x57eafc[_0xa53e7f(0x27d)][_0xa53e7f(0x25a)]||[],_0x100bb7=new Set();_0xa2f379[_0xa53e7f(0x222)](_0x33ebff=>{const _0x4e6396=_0xa53e7f;if(_0x33ebff[_0x4e6396(0x22b)])_0x100bb7[_0x4e6396(0x221)](_0x33ebff[_0x4e6396(0x22b)]);});for(const _0x3413cc of _0x2b84a7){if(_0x3413cc[_0xa53e7f(0x273)]&&_0x5001d0['length']>0x0&&!_0x5001d0[_0xa53e7f(0x23e)](_0x3413cc[_0xa53e7f(0x273)]))continue;const _0x4547fb=_0x3413cc[_0xa53e7f(0x231)]||_0x3413cc[_0xa53e7f(0x20b)]||_0x3413cc['date'];if(!_0x4547fb)continue;const _0x26aac9=new Date(_0x4547fb),_0xd93ab4=_0x26aac9[_0xa53e7f(0x1f5)]();if(isNaN(_0xd93ab4))continue;if(_0xd93ab4<_0x78c958)continue;if(_0xd93ab4>_0x78c958+_0x4cd6c2)continue;const _0x56da9e=(_0x3413cc[_0xa53e7f(0x1df)]||_0x3413cc[_0xa53e7f(0x253)]||'')[_0xa53e7f(0x21e)]();let _0x29d428=![],_0x531855=[],_0x59b328=_0x3413cc[_0xa53e7f(0x1df)]||_0x3413cc['summary']||_0xa53e7f(0x275);if(_0x56da9e[_0xa53e7f(0x23e)](_0xa53e7f(0x1d8))||_0x56da9e[_0xa53e7f(0x23e)](_0xa53e7f(0x263))||_0x56da9e[_0xa53e7f(0x23e)](_0xa53e7f(0x26a)))_0x29d428=!![],_0x531855=Array[_0xa53e7f(0x244)](_0x100bb7);else for(const _0x17b789 of _0x100bb7){if(_0x56da9e[_0xa53e7f(0x23e)](_0x17b789['toLowerCase']()))_0x531855['push'](_0x17b789);}_0x531855[_0xa53e7f(0x250)]>0x0&&_0x531855[_0xa53e7f(0x222)](_0x5e8420=>{const _0x4f0be3=_0xa53e7f;let _0x5ce5c4=0x3c;if(_0x29d428){let _0x25e178=0x0;Object[_0x4f0be3(0x226)](_0x5442ef)[_0x4f0be3(0x222)](_0x538fce=>{if(_0x538fce>_0x25e178)_0x25e178=_0x538fce;}),_0x5ce5c4=_0x25e178>0x0?_0x25e178:0x78;}else _0x5ce5c4=_0x5442ef[_0x5e8420]||0x3c;const _0x813716=new Date(_0xd93ab4-_0x5ce5c4*0xea60);_0x2e37bf[_0x4f0be3(0x1e5)]({'eventTime':_0xd93ab4,'triggerTime':_0x813716[_0x4f0be3(0x1f5)](),'room':_0x5e8420,'minutes':_0x5ce5c4,'reason':_0x59b328,'isGlobal':_0x29d428});});}}catch(_0x59e9c2){}_0x2e37bf[_0xa53e7f(0x249)]((_0x3f21d7,_0x22e828)=>_0x3f21d7[_0xa53e7f(0x282)]-_0x22e828['triggerTime']);const _0x56d1ec=_0x2e37bf[_0xa53e7f(0x1eb)](0x0,0x5);await _0x57eafc[_0xa53e7f(0x246)](_0xa53e7f(0x201),{'val':JSON[_0xa53e7f(0x212)](_0x56d1ec),'ack':!![]});}async function checkCalendarTriggers(_0x536b6f){const _0x558b5f=a1_0x497f6d;if(!_0x536b6f[_0x558b5f(0x27d)][_0x558b5f(0x229)]||!_0x536b6f[_0x558b5f(0x27d)][_0x558b5f(0x267)])return;await updateSchedulePreview(_0x536b6f);let _0x19305e={},_0x414e8d={};try{const _0x1408db=await _0x536b6f[_0x558b5f(0x24c)](_0x558b5f(0x230));if(_0x1408db&&_0x1408db[_0x558b5f(0x270)])_0x19305e=JSON[_0x558b5f(0x20e)](_0x1408db[_0x558b5f(0x270)]);const _0x240b08=await _0x536b6f['getStateAsync'](_0x558b5f(0x23d));if(_0x240b08&&_0x240b08[_0x558b5f(0x270)])_0x414e8d=JSON['parse'](_0x240b08[_0x558b5f(0x270)]);}catch(_0x3639c2){}let _0x4438fc={'default':0x15};try{const _0x461109=await _0x536b6f[_0x558b5f(0x24c)](_0x558b5f(0x1f6));if(_0x461109&&_0x461109[_0x558b5f(0x270)])_0x4438fc=JSON[_0x558b5f(0x20e)](_0x461109[_0x558b5f(0x270)]);}catch(_0xeee90){}try{const _0x38e1bc=await _0x536b6f['getForeignStateAsync'](_0x536b6f[_0x558b5f(0x27d)]['calendarInstance']+_0x558b5f(0x242));if(!_0x38e1bc||!_0x38e1bc[_0x558b5f(0x270)])return;const _0x3a9087=JSON[_0x558b5f(0x20e)](_0x38e1bc[_0x558b5f(0x270)]),_0x5452a0=Date[_0x558b5f(0x261)](),_0x25aee1=_0x536b6f['config']['devices']||[],_0x1f80ae=_0x536b6f[_0x558b5f(0x27d)]['calendarSelection']||[];for(const _0x2dee0a of _0x3a9087){if(_0x2dee0a[_0x558b5f(0x273)]&&_0x1f80ae[_0x558b5f(0x250)]>0x0&&!_0x1f80ae[_0x558b5f(0x23e)](_0x2dee0a[_0x558b5f(0x273)]))continue;const _0x56badd=_0x2dee0a['_date']||_0x2dee0a[_0x558b5f(0x20b)]||_0x2dee0a[_0x558b5f(0x26b)];if(!_0x56badd)continue;const _0x3d0ede=new Date(_0x56badd);if(isNaN(_0x3d0ede[_0x558b5f(0x1f5)]()))continue;const _0x20940b=(_0x2dee0a[_0x558b5f(0x1df)]||_0x2dee0a[_0x558b5f(0x253)]||'')[_0x558b5f(0x21e)]();if(_0x20940b[_0x558b5f(0x23e)](_0x558b5f(0x1d8))||_0x20940b[_0x558b5f(0x23e)]('r√ºckkehr')||_0x20940b[_0x558b5f(0x23e)](_0x558b5f(0x26a))){let _0x1741ba=0x0;Object[_0x558b5f(0x226)](_0x19305e)[_0x558b5f(0x222)](_0x413851=>{if(_0x413851>_0x1741ba)_0x1741ba=_0x413851;});if(_0x1741ba===0x0)_0x1741ba=0x78;const _0x9e9b52=_0x3d0ede[_0x558b5f(0x1f5)]()-_0x1741ba*0xea60;_0x5452a0>=_0x9e9b52&&_0x5452a0<_0x3d0ede[_0x558b5f(0x1f5)]()&&(_0x536b6f['currentSystemMode']!==_0x558b5f(0x26d)&&(_0x536b6f[_0x558b5f(0x234)][_0x558b5f(0x21c)](_0x558b5f(0x1dd)+_0x1741ba+_0x558b5f(0x251)),await _0x536b6f['setStateAsync']('system.mode',{'val':_0x558b5f(0x26d),'ack':![]})));}for(const _0x16fb6f of _0x25aee1){if(_0x16fb6f[_0x558b5f(0x22b)]){const _0x232c48=_0x16fb6f['location'][_0x558b5f(0x21e)]();if(_0x20940b['includes'](_0x232c48)){const _0x3e1e47=_0x19305e[_0x16fb6f['location']]||0x3c,_0x1f6a7f=_0x414e8d[_0x16fb6f[_0x558b5f(0x22b)]]||_0x558b5f(0x1d9),_0x75f7fc=_0x3d0ede[_0x558b5f(0x1f5)]()-_0x3e1e47*0xea60;if(_0x5452a0>=_0x75f7fc&&_0x5452a0<_0x3d0ede['getTime']()){const _0x4d8af4=lastActions['cal_'+_0x16fb6f['location']];if(_0x4d8af4&&_0x5452a0-_0x4d8af4<CAL_COOLDOWN_MS)continue;const _0x3b6c37=await findRelatedId(_0x536b6f,_0x16fb6f['id'],'setpoint');if(_0x3b6c37){let _0x1ed43c=_0x4438fc[_0x16fb6f['location']];if(_0x1ed43c===undefined)_0x1ed43c=_0x4438fc[_0x558b5f(0x1fc)];if(_0x1ed43c===undefined)_0x1ed43c=0x15;const _0x3a79c3=await _0x536b6f[_0x558b5f(0x27a)](_0x3b6c37);_0x3a79c3&&typeof _0x3a79c3[_0x558b5f(0x270)]===_0x558b5f(0x218)&&_0x3a79c3[_0x558b5f(0x270)]<_0x1ed43c-0.5&&(_0x536b6f[_0x558b5f(0x234)][_0x558b5f(0x21c)](_0x558b5f(0x1de)+_0x1f6a7f+_0x558b5f(0x281)+_0x16fb6f['location']+'\x27\x20aktiv.\x20Heize\x20auf\x20'+_0x1ed43c+_0x558b5f(0x240)+_0x3e1e47+_0x558b5f(0x251)),await _0x536b6f['setForeignStateAsync'](_0x3b6c37,_0x1ed43c),await logAutomationAction(_0x536b6f,_0x558b5f(0x27b)+_0x16fb6f[_0x558b5f(0x22b)]+'\x20->\x20'+_0x1ed43c+'¬∞C\x20(via\x20'+_0x1f6a7f+')'),lastActions[_0x558b5f(0x262)+_0x16fb6f[_0x558b5f(0x22b)]]=_0x5452a0);}}}}}}}catch(_0x37f4a8){_0x536b6f[_0x558b5f(0x234)]['warn']('Calendar\x20Check\x20Error:\x20'+_0x37f4a8[_0x558b5f(0x238)]);}}async function manageMpcIntervention(_0x58fc45,_0x407a04,_0x462457){const _0x1c526e=a1_0x497f6d;try{const _0x788b7f='analysis.energy.mpcActiveInterventions',_0x2fb581=await _0x58fc45[_0x1c526e(0x24c)](_0x788b7f);let _0xed7f28=[];if(_0x2fb581&&_0x2fb581[_0x1c526e(0x270)])try{_0xed7f28=JSON[_0x1c526e(0x20e)](_0x2fb581['val']);}catch(_0x2c4fcb){}const _0x5132e4=_0xed7f28[_0x1c526e(0x203)](_0x407a04);if(_0x462457===_0x1c526e(0x221))_0x5132e4===-0x1&&(_0xed7f28[_0x1c526e(0x1e5)](_0x407a04),await _0x58fc45[_0x1c526e(0x246)](_0x788b7f,{'val':JSON[_0x1c526e(0x212)](_0xed7f28),'ack':!![]}));else _0x462457==='remove'&&(_0x5132e4!==-0x1&&(_0xed7f28[_0x1c526e(0x1fd)](_0x5132e4,0x1),await _0x58fc45[_0x1c526e(0x246)](_0x788b7f,{'val':JSON['stringify'](_0xed7f28),'ack':!![]})));}catch(_0x3a429f){}}async function cleanupGhostInterventions(_0x164e83){const _0x249c43=a1_0x497f6d;try{const _0x261b9d=_0x249c43(0x248),_0x27e45b=await _0x164e83[_0x249c43(0x24c)](_0x261b9d);if(!_0x27e45b||!_0x27e45b[_0x249c43(0x270)])return;const _0x590bd5=JSON['parse'](_0x27e45b[_0x249c43(0x270)]);if(!Array['isArray'](_0x590bd5)||_0x590bd5['length']===0x0)return;let _0xe82d83={'default':0x15};try{const _0x5ad535=await _0x164e83[_0x249c43(0x24c)](_0x249c43(0x1f6));if(_0x5ad535&&_0x5ad535['val'])_0xe82d83=JSON[_0x249c43(0x20e)](_0x5ad535['val']);}catch(_0x46f67b){}let _0x3d0ff8=[];try{const _0x50f683=await _0x164e83[_0x249c43(0x24c)](_0x249c43(0x236));if(_0x50f683&&_0x50f683[_0x249c43(0x270)])_0x3d0ff8=JSON['parse'](_0x50f683[_0x249c43(0x270)]);}catch(_0x4d6b5b){}const _0x574aa9=_0x164e83[_0x249c43(0x27d)][_0x249c43(0x25a)]||[];let _0x3f2a51=![];for(let _0x7ddf3d=_0x590bd5['length']-0x1;_0x7ddf3d>=0x0;_0x7ddf3d--){const _0x34030a=_0x590bd5[_0x7ddf3d],_0x313a94=_0x574aa9[_0x249c43(0x1ee)](_0x449ae7=>normalize(_0x449ae7[_0x249c43(0x22b)])===normalize(_0x34030a)&&(_0x449ae7[_0x249c43(0x24e)]===_0x249c43(0x279)||_0x449ae7[_0x249c43(0x24e)]==='thermostat'));if(!_0x313a94){_0x164e83['log'][_0x249c43(0x237)](_0x249c43(0x228)+_0x34030a+'\x27\x20hat\x20kein\x20Ger√§t\x20mehr.\x20L√∂sche\x20Eintrag.'),_0x590bd5[_0x249c43(0x1fd)](_0x7ddf3d,0x1),_0x3f2a51=!![];continue;}if(_0x313a94){const _0x597769=await findRelatedId(_0x164e83,_0x313a94['id'],_0x249c43(0x254)),_0x4802f2=await _0x164e83[_0x249c43(0x27a)](_0x313a94['id']);if(_0x597769){const _0x161e86=await _0x164e83[_0x249c43(0x27a)](_0x597769);if(_0x161e86&&typeof _0x161e86[_0x249c43(0x270)]===_0x249c43(0x218)){let _0x4ca1f9=![],_0x12dc5f='';Math[_0x249c43(0x23a)](_0x161e86[_0x249c43(0x270)]-ECO_TEMP)>0.5&&(_0x4ca1f9=!![],_0x12dc5f=_0x249c43(0x24d));if(!_0x4ca1f9&&_0x4802f2&&typeof _0x4802f2[_0x249c43(0x270)]===_0x249c43(0x218)){const _0x361053=_0xe82d83[_0x34030a]||_0xe82d83[_0x249c43(0x1fc)]||0x15;_0x4802f2['val']<_0x361053+0.2&&(_0x4ca1f9=!![],_0x12dc5f='too_cold');}if(_0x4ca1f9){if(_0x12dc5f==='manual'){_0x164e83['log'][_0x249c43(0x21c)]('üßπ\x20[MPC\x20CLEANUP]\x20'+_0x34030a+_0x249c43(0x223)+_0x161e86['val']+_0x249c43(0x206)+ECO_TEMP+'¬∞C).\x20Entferne\x20Status.');const _0x578c80=lastActions[_0x249c43(0x262)+_0x34030a],_0x38f74a=_0x578c80&&Date[_0x249c43(0x261)]()-_0x578c80<0x2*0x3c*0x3e8;if(!_0x38f74a&&_0x161e86[_0x249c43(0x270)]>ECO_TEMP+0.5)_0x164e83['sendToPythonWrapper']&&(_0x164e83['log']['info'](_0x249c43(0x22f)+_0x34030a+_0x249c43(0x21a)),_0x164e83[_0x249c43(0x24a)](_0x249c43(0x241),{'room':_0x34030a}));else _0x38f74a&&_0x164e83[_0x249c43(0x234)]['info'](_0x249c43(0x219)+_0x34030a+_0x249c43(0x1e3));}else{if(_0x12dc5f===_0x249c43(0x268)){let _0x463cf1=![];if(_0x3d0ff8[_0x249c43(0x1ee)](_0x540e2f=>_0x540e2f[_0x249c43(0x225)]===_0x34030a))_0x463cf1=!![];const _0x57f5fb=_0x574aa9[_0x249c43(0x258)](_0x2c1b3a=>normalize(_0x2c1b3a[_0x249c43(0x22b)])===normalize(_0x34030a)&&(_0x2c1b3a['type']==='window'||_0x2c1b3a[_0x249c43(0x24e)]==='sensor'||_0x2c1b3a[_0x249c43(0x24e)]==='contact'));for(const _0xc43f02 of _0x57f5fb){try{const _0xaad73c=await _0x164e83[_0x249c43(0x27a)](_0xc43f02['id']);if(_0xaad73c&&(_0xaad73c[_0x249c43(0x270)]===!![]||_0xaad73c[_0x249c43(0x270)]===0x1||String(_0xaad73c[_0x249c43(0x270)])[_0x249c43(0x21e)]()===_0x249c43(0x1e1)))_0x463cf1=!![];}catch(_0x283533){}}if(_0x463cf1)_0x164e83[_0x249c43(0x234)]['info'](_0x249c43(0x245)+_0x34030a+'\x20ist\x20zu\x20kalt,\x20ABER\x20Fenster\x20offen/L√ºftung\x20erkannt.\x20Heize\x20NICHT,\x20entferne\x20nur\x20Status.');else{const _0x25722c=_0xe82d83[_0x34030a]||_0xe82d83[_0x249c43(0x1fc)]||0x15;_0x164e83['log'][_0x249c43(0x21c)](_0x249c43(0x255)+_0x34030a+'\x20erreicht\x20Limit\x20('+_0x4802f2[_0x249c43(0x270)]+_0x249c43(0x22e)+(_0x25722c+0.2)+_0x249c43(0x278)),await _0x164e83[_0x249c43(0x274)](_0x597769,_0x25722c),await logAutomationAction(_0x164e83,_0x249c43(0x1fb)+_0x34030a+_0x249c43(0x27f)+_0x25722c+'¬∞C'),lastActions[_0x249c43(0x23c)+_0x34030a]=Date[_0x249c43(0x261)]();}}}_0x590bd5[_0x249c43(0x1fd)](_0x7ddf3d,0x1),_0x3f2a51=!![];}}}}}_0x3f2a51&&await _0x164e83[_0x249c43(0x246)](_0x261b9d,{'val':JSON[_0x249c43(0x212)](_0x590bd5),'ack':!![]});}catch(_0x4d60ae){}}async function applyEnergySavings(_0x597d62,_0x20b5a9){const _0xb02990=a1_0x497f6d;await cleanupGhostInterventions(_0x597d62);if(!_0x20b5a9||_0x20b5a9[_0xb02990(0x250)]===0x0)return;const _0x148458=_0x597d62[_0xb02990(0x27d)]['devices']||[],_0xcb3bf9=Date['now']();for(const _0x51f218 of _0x20b5a9){const _0x3907c1=_0x51f218[_0xb02990(0x225)],_0x479856=_0x51f218[_0xb02990(0x25e)],_0x25ea4c=_0x51f218[_0xb02990(0x26e)]||0x15;if(lastActions[_0xb02990(0x23c)+_0x3907c1]&&_0xcb3bf9-lastActions['rescue_'+_0x3907c1]<RESCUE_LOCK_MS)continue;const _0x7c5483=_0x148458[_0xb02990(0x1ee)](_0x230ae4=>normalize(_0x230ae4['location'])===normalize(_0x3907c1)&&(_0x230ae4['type']===_0xb02990(0x279)||_0x230ae4['type']===_0xb02990(0x1f2)));if(!_0x7c5483)continue;const _0x3c7d5=await findRelatedId(_0x597d62,_0x7c5483['id'],_0xb02990(0x254));if(_0x3c7d5){if(lastActions[_0xb02990(0x211)+_0x3907c1]&&_0xcb3bf9-lastActions[_0xb02990(0x211)+_0x3907c1]<0x1e*0x3c*0x3e8)continue;const _0x1d9d26=await _0x597d62[_0xb02990(0x27a)](_0x3c7d5);if(_0x1d9d26&&typeof _0x1d9d26[_0xb02990(0x270)]===_0xb02990(0x218)){const _0x84444=_0x1d9d26['val'];_0x84444!==ECO_TEMP&&await manageMpcIntervention(_0x597d62,_0x3907c1,'remove');if(_0x479856>0x1e)_0x84444>ECO_TEMP+0.5&&(_0x597d62['log']['info']('üçÉ\x20[MPC\x20ACTION]\x20Senke\x20'+_0x3907c1+'\x20auf\x20'+ECO_TEMP+_0xb02990(0x1f8)+_0x479856+_0xb02990(0x1fa)),await _0x597d62[_0xb02990(0x274)](_0x3c7d5,ECO_TEMP),await manageMpcIntervention(_0x597d62,_0x3907c1,_0xb02990(0x221)),lastActions[_0xb02990(0x211)+_0x3907c1]=_0xcb3bf9,await logAutomationAction(_0x597d62,'[MPC]\x20'+_0x3907c1+_0xb02990(0x1e0)+ECO_TEMP+'¬∞C'));else _0x479856<=0xf&&(_0x84444<_0x25ea4c&&(_0x597d62['log']['info'](_0xb02990(0x1f7)+_0x3907c1+'\x20wieder\x20auf\x20'+_0x25ea4c+'¬∞C!\x20(Puffer\x20leer).'),await _0x597d62['setForeignStateAsync'](_0x3c7d5,_0x25ea4c),await manageMpcIntervention(_0x597d62,_0x3907c1,_0xb02990(0x23f)),lastActions['mpc_'+_0x3907c1]=_0xcb3bf9,await logAutomationAction(_0x597d62,'[MPC]\x20'+_0x3907c1+_0xb02990(0x1ef)+_0x25ea4c+'¬∞C')));}}else _0x597d62['log'][_0xb02990(0x237)](_0xb02990(0x27e)+_0x3907c1+_0xb02990(0x200));}}module['exports']={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'updateSchedulePreview':updateSchedulePreview,'cleanupGhostInterventions':cleanupGhostInterventions};