const a1_0x2149a4=a1_0x5f1d;(function(_0x136153,_0x318e89){const _0x294ee0=a1_0x5f1d,_0x593341=_0x136153();while(!![]){try{const _0x44a008=parseInt(_0x294ee0(0x11b))/0x1+parseInt(_0x294ee0(0xf1))/0x2+parseInt(_0x294ee0(0x12a))/0x3*(-parseInt(_0x294ee0(0xfa))/0x4)+parseInt(_0x294ee0(0xee))/0x5*(-parseInt(_0x294ee0(0x126))/0x6)+-parseInt(_0x294ee0(0xfb))/0x7+-parseInt(_0x294ee0(0x121))/0x8+-parseInt(_0x294ee0(0xc0))/0x9*(-parseInt(_0x294ee0(0x10f))/0xa);if(_0x44a008===_0x318e89)break;else _0x593341['push'](_0x593341['shift']());}catch(_0x12fde8){_0x593341['push'](_0x593341['shift']());}}}(a1_0x432b,0x923e3));function a1_0x432b(){const _0x14561b=['getForeignStateAsync','urlaub\x20ende','off','.1.SET_POINT_TEMPERATURE','split','91790rhOtlv','now','ankunft','930190tkpIzE','.1.TEMPERATURE','system.mode','thermostat','state','hm-rpc',')\x20auf\x20','common','string','8XswvnW','1139481GcRAxD','\x20->\x2021¬∞C','replace','localeCompare','slice','target','normal','type','length','position','\x20min)','room','filter','[MPC]\x20','calendarInstance','¬∞C\x20(Coasting\x20m√∂glich:\x20','local_temperature','SET','getStateAsync','.4.VALVE_STATE','800ZVnTQO','ACTUAL_TEMPERATURE','sort','actual','Manuelles\x20Mapping','level','values','score','thermostat.setpoint','getForeignObjectsAsync','.data.table','analysis.energy.warmupTimes','26156jNDyjU','toLowerCase','join','set','map','target_temperature','2096744vtiuQl','ist','Soll','push','analysis.automation.confidenceThreshold','246NrcqQt','level.temperature','calendarSelection','SET_POINT_TEMPERATURE','201669KqmYGX','setForeignStateAsync','devices','stellwert','find','.1.LEVEL','event','message','exports','.4.SET_TEMPERATURE','occupied_heating_setpoint','getTime','level.valve','log','role','mpc_','valveMapping','159723PwwPry','includes','Unbekannt','.1.ACTUAL_TEMPERATURE','Auto-Erkennung','openknx','val','setpoint','toString','summary',').\x20Heize\x20auf\x2021¬∞C\x20(Vorlauf:\x20','thermostatMapping','\x20min).','[CAL]\x20','config','location','setStateAsync','temp','apply','minutes_safe','analysis.automation.lastAction','forEach','messwert','unit','warn','value.valve','getForeignObjectAsync',').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20','soll','r√ºckkehr','parse','name','temperature','valve','active','search','useCalendar','switch','info','write','üìÖ\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20('];a1_0x432b=function(){return _0x14561b;};return a1_0x432b();}const a1_0x1ed8c7=(function(){let _0x4e4e47=!![];return function(_0x4d2085,_0x587a62){const _0x2671e2=_0x4e4e47?function(){const _0x4f475c=a1_0x5f1d;if(_0x587a62){const _0x48c38e=_0x587a62[_0x4f475c(0xd2)](_0x4d2085,arguments);return _0x587a62=null,_0x48c38e;}}:function(){};return _0x4e4e47=![],_0x2671e2;};}()),a1_0x2205e9=a1_0x1ed8c7(this,function(){const _0xdf6132=a1_0x5f1d;return a1_0x2205e9[_0xdf6132(0xc8)]()[_0xdf6132(0xe3)]('(((.+)+)+)+$')['toString']()['constructor'](a1_0x2205e9)[_0xdf6132(0xe3)]('(((.+)+)+)+$');});function a1_0x5f1d(_0x89045b,_0xc91461){const _0x2a73cd=a1_0x432b();return a1_0x5f1d=function(_0x2205e9,_0x1ed8c7){_0x2205e9=_0x2205e9-0xbe;let _0x432b01=_0x2a73cd[_0x2205e9];return _0x432b01;},a1_0x5f1d(_0x89045b,_0xc91461);}a1_0x2205e9();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x2e274e){const _0x10455f=a1_0x5f1d;if(!_0x2e274e)return'';return _0x2e274e[_0x10455f(0x11c)]()[_0x10455f(0xfd)](/\s+/g,'')['trim']();}async function handlePrediction(_0x53b197,_0x4a1a4f,_0x1810e3){const _0x27e91c=a1_0x5f1d;if(!_0x4a1a4f||_0x4a1a4f==='Unknown')return;let _0x230955=_0x27e91c(0xeb),_0x597c26=0.6;try{const _0x2b1eb1=await _0x53b197['getStateAsync']('analysis.automation.mode');if(_0x2b1eb1&&_0x2b1eb1[_0x27e91c(0xc6)])_0x230955=_0x2b1eb1[_0x27e91c(0xc6)];const _0x2cc8f7=await _0x53b197[_0x27e91c(0x10d)](_0x27e91c(0x125));if(_0x2cc8f7&&_0x2cc8f7[_0x27e91c(0xc6)])_0x597c26=_0x2cc8f7['val'];}catch(_0x3f0602){}if(_0x230955===_0x27e91c(0xeb)||_0x1810e3<_0x597c26)return;const _0x41c6d8=Date[_0x27e91c(0xef)]();if(lastActions[_0x4a1a4f]&&_0x41c6d8-lastActions[_0x4a1a4f]<COOLDOWN_MS)return;const _0x344202=_0x53b197[_0x27e91c(0xce)][_0x27e91c(0x12c)]||[],_0x7ab431=normalize(_0x4a1a4f),_0x468d6e=_0x344202[_0x27e91c(0x12e)](_0x4f7061=>normalize(_0x4f7061[_0x27e91c(0xcf)])===_0x7ab431&&(_0x4f7061[_0x27e91c(0x102)]==='light'||_0x4f7061['type']==='dimmer'||_0x4f7061[_0x27e91c(0x102)]===_0x27e91c(0xe5)));if(!_0x468d6e){_0x53b197[_0x27e91c(0x137)]['debug']('üîç\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27'+_0x4a1a4f+'\x27.');return;}const _0x5d68d8=await aiAgent['consultButler'](_0x53b197,_0x4a1a4f,_0x468d6e['name'],_0x1810e3);if(!_0x5d68d8['approved'])return;const _0x3e7841='Pr√§diktion:\x20'+_0x4a1a4f+'\x20->\x20Schalte\x20'+_0x468d6e[_0x27e91c(0xdf)]+'\x20('+_0x5d68d8['reason']+')';await _0x53b197[_0x27e91c(0xd0)](_0x27e91c(0xd4),{'val':'['+_0x230955['toUpperCase']()+']\x20'+_0x3e7841,'ack':!![]});if(_0x230955===_0x27e91c(0xe2)){const _0x42046e=await _0x53b197[_0x27e91c(0xe9)](_0x468d6e['id']);(!_0x42046e||!_0x42046e[_0x27e91c(0xc6)]&&_0x42046e[_0x27e91c(0xc6)]!==!![])&&await _0x53b197[_0x27e91c(0x12b)](_0x468d6e['id'],!![]),lastActions[_0x4a1a4f]=_0x41c6d8;}}async function findRelatedId(_0x409f45,_0x21716d,_0x1bf901=a1_0x2149a4(0xc7)){const _0x2bbafe=a1_0x2149a4;if(_0x1bf901===_0x2bbafe(0xc7)&&_0x409f45[_0x2bbafe(0xce)][_0x2bbafe(0xcb)]){let _0x5d6ce4=_0x409f45['config'][_0x2bbafe(0xcb)];if(typeof _0x5d6ce4==='string')try{_0x5d6ce4=JSON[_0x2bbafe(0xde)](_0x5d6ce4);}catch(_0x2cdc59){}if(_0x5d6ce4&&_0x5d6ce4[_0x21716d])return _0x5d6ce4[_0x21716d];}if(_0x1bf901===_0x2bbafe(0xe1)&&_0x409f45[_0x2bbafe(0xce)][_0x2bbafe(0xbf)]){let _0x2c1032=_0x409f45[_0x2bbafe(0xce)][_0x2bbafe(0xbf)];if(typeof _0x2c1032===_0x2bbafe(0xf9))try{_0x2c1032=JSON[_0x2bbafe(0xde)](_0x2c1032);}catch(_0x4bf492){}if(_0x2c1032&&_0x2c1032[_0x21716d])return _0x2c1032[_0x21716d];}let _0x2cd3de=[];if(_0x1bf901===_0x2bbafe(0xc7))_0x2cd3de=[{'s':_0x2bbafe(0xc3),'t':_0x2bbafe(0xec)},{'s':'.1.TEMPERATURE','t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x2bbafe(0xf2),'t':_0x2bbafe(0x133)},{'s':_0x2bbafe(0x110),'t':_0x2bbafe(0x129)},{'s':'local_temperature','t':_0x2bbafe(0x134)},{'s':_0x2bbafe(0x10b),'t':'current_heating_setpoint'},{'s':_0x2bbafe(0xe0),'t':_0x2bbafe(0x120)},{'s':'ACTUAL','t':_0x2bbafe(0x10c)},{'s':'Ist','t':_0x2bbafe(0x123)},{'s':_0x2bbafe(0xe0),'t':_0x2bbafe(0xc7)}];else _0x1bf901===_0x2bbafe(0xe1)&&(_0x2cd3de=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x2bbafe(0x12f)},{'s':_0x2bbafe(0xf2),'t':'.1.LEVEL'},{'s':'.1.TEMPERATURE','t':_0x2bbafe(0x10e)},{'s':_0x2bbafe(0x10b),'t':'pi_heating_demand'},{'s':_0x2bbafe(0xe0),'t':'valve_position'},{'s':_0x2bbafe(0xe0),'t':_0x2bbafe(0x114)}]);for(const _0x801e77 of _0x2cd3de){if(_0x21716d['includes'](_0x801e77['s'])){const _0x4711e6=_0x21716d[_0x2bbafe(0xfd)](_0x801e77['s'],_0x801e77['t']),_0x579c8a=await _0x409f45[_0x2bbafe(0xda)](_0x4711e6);if(_0x579c8a)return _0x4711e6;}}try{const _0x12d191=_0x21716d[_0x2bbafe(0xed)]('.');if(_0x12d191[_0x2bbafe(0x103)]>0x2){const _0x5d9e47=_0x12d191[_0x2bbafe(0xff)](0x0,-0x1)[_0x2bbafe(0x11d)]('.'),_0x73a637=await _0x409f45[_0x2bbafe(0x118)](_0x5d9e47+'.*'),_0x3dc52e=[],_0x2c127b=_0x21716d[_0x2bbafe(0xed)](/[._]+/)[_0x2bbafe(0x107)](_0x4d613d=>![_0x2bbafe(0xc5),'0',_0x2bbafe(0xf6),_0x2bbafe(0x122),'wert','temperature',_0x2bbafe(0x112),'sensor',_0x2bbafe(0xd6),_0x2bbafe(0xf5)]['includes'](_0x4d613d[_0x2bbafe(0x11c)]()));for(const [_0x1f998b,_0x41e7b1]of Object['entries'](_0x73a637)){if(_0x1f998b===_0x21716d)continue;if(_0x41e7b1&&_0x41e7b1['common']){const _0xf8efee=_0x1f998b['toLowerCase'](),_0x25f83d=(_0x41e7b1[_0x2bbafe(0xf8)][_0x2bbafe(0x138)]||'')['toLowerCase'](),_0x9fab3=(_0x41e7b1[_0x2bbafe(0xf8)][_0x2bbafe(0xd7)]||'')['toLowerCase']();let _0x48fb52=![];if(_0x1bf901===_0x2bbafe(0xc7)&&_0x41e7b1[_0x2bbafe(0xf8)][_0x2bbafe(0xe7)]===!![])_0x48fb52=_0xf8efee[_0x2bbafe(0xc1)](_0x2bbafe(0x11e))||_0xf8efee[_0x2bbafe(0xc1)](_0x2bbafe(0xdc))||_0xf8efee[_0x2bbafe(0xc1)](_0x2bbafe(0x100))||_0x25f83d[_0x2bbafe(0xc1)](_0x2bbafe(0x127))||_0x25f83d[_0x2bbafe(0xc1)](_0x2bbafe(0x117));else _0x1bf901===_0x2bbafe(0xe1)&&(_0x48fb52=_0xf8efee[_0x2bbafe(0xc1)](_0x2bbafe(0x114))||_0xf8efee[_0x2bbafe(0xc1)]('valve')||_0xf8efee[_0x2bbafe(0xc1)](_0x2bbafe(0x12d))||_0xf8efee[_0x2bbafe(0xc1)](_0x2bbafe(0x104))||_0x25f83d[_0x2bbafe(0xc1)](_0x2bbafe(0x136))||_0x25f83d[_0x2bbafe(0xc1)](_0x2bbafe(0xd9))||_0x9fab3[_0x2bbafe(0xc1)]('%'));if(_0x48fb52){const _0x5bfc4b=_0x1f998b[_0x2bbafe(0xed)](/[._]+/)[_0x2bbafe(0x11f)](_0x2a9344=>_0x2a9344[_0x2bbafe(0x11c)]());let _0x3fe091=0x0;_0x2c127b['forEach'](_0x3aae96=>{const _0x2592c1=_0x2bbafe;if(_0x5bfc4b[_0x2592c1(0xc1)](_0x3aae96[_0x2592c1(0x11c)]()))_0x3fe091++;}),_0x3dc52e['push']({'id':_0x1f998b,'score':_0x3fe091});}}}if(_0x3dc52e['length']>0x0){_0x3dc52e[_0x2bbafe(0x111)]((_0x152844,_0x2d3001)=>_0x2d3001['score']-_0x152844['score']);if(_0x3dc52e[0x0][_0x2bbafe(0x116)]>0x0)return _0x3dc52e[0x0]['id'];}}}catch(_0x1219d5){}return null;}async function scanThermostats(_0x221804){const _0x14a8e5=a1_0x2149a4,_0x321054=_0x221804[_0x14a8e5(0xce)][_0x14a8e5(0x12c)]||[],_0x1f448f=[],_0x1a29d5=_0x321054[_0x14a8e5(0x107)](_0xdabd7e=>_0xdabd7e['id']&&_0xdabd7e['id'][_0x14a8e5(0xc1)]('temperature')||_0xdabd7e[_0x14a8e5(0x102)]&&[_0x14a8e5(0xe0),_0x14a8e5(0xf4),'sensor'][_0x14a8e5(0xc1)](_0xdabd7e[_0x14a8e5(0x102)])||_0xdabd7e[_0x14a8e5(0xdf)]&&_0xdabd7e[_0x14a8e5(0xdf)][_0x14a8e5(0x11c)]()['includes'](_0x14a8e5(0xd1)));for(const _0x2fb6b3 of _0x1a29d5){const _0x5c34ad=await findRelatedId(_0x221804,_0x2fb6b3['id'],_0x14a8e5(0xc7)),_0x51c226=await findRelatedId(_0x221804,_0x2fb6b3['id'],'valve');let _0x20ef5c='Nicht\x20gefunden',_0x291acc=![],_0x584751=_0x221804[_0x14a8e5(0xce)][_0x14a8e5(0xcb)]||{};if(typeof _0x584751===_0x14a8e5(0xf9))try{_0x584751=JSON[_0x14a8e5(0xde)](_0x584751);}catch(_0x1c09fe){}let _0x49ae13=_0x221804[_0x14a8e5(0xce)][_0x14a8e5(0xbf)]||{};if(typeof _0x49ae13===_0x14a8e5(0xf9))try{_0x49ae13=JSON[_0x14a8e5(0xde)](_0x49ae13);}catch(_0x5b7f4b){}if(_0x584751[_0x2fb6b3['id']]&&_0x584751[_0x2fb6b3['id']]===_0x5c34ad||_0x49ae13[_0x2fb6b3['id']]&&_0x49ae13[_0x2fb6b3['id']]===_0x51c226)_0x20ef5c=_0x14a8e5(0x113),_0x291acc=!![];else(_0x5c34ad||_0x51c226)&&(_0x20ef5c=_0x14a8e5(0xc4));_0x1f448f[_0x14a8e5(0x124)]({'room':_0x2fb6b3['location']||_0x14a8e5(0xc2),'sensorId':_0x2fb6b3['id'],'setpointId':_0x5c34ad||'-','valveId':_0x51c226||'-','source':_0x20ef5c,'isManual':_0x291acc,'status':_0x5c34ad&&_0x51c226?'PERFECT':_0x5c34ad?'OK':'Fehlt'});}return _0x1f448f[_0x14a8e5(0x111)]((_0x215eb5,_0x22b09f)=>_0x215eb5[_0x14a8e5(0x106)][_0x14a8e5(0xfe)](_0x22b09f[_0x14a8e5(0x106)]));}async function checkCalendarTriggers(_0x59631a){const _0x21c0ac=a1_0x2149a4;if(!_0x59631a[_0x21c0ac(0xce)][_0x21c0ac(0xe4)]||!_0x59631a['config'][_0x21c0ac(0x109)])return;let _0x131261={};try{const _0x32dabc=await _0x59631a['getStateAsync'](_0x21c0ac(0x11a));if(_0x32dabc&&_0x32dabc[_0x21c0ac(0xc6)])_0x131261=JSON[_0x21c0ac(0xde)](_0x32dabc[_0x21c0ac(0xc6)]);}catch(_0x1277b2){}try{const _0xb2cfc3=await _0x59631a['getForeignStateAsync'](_0x59631a[_0x21c0ac(0xce)]['calendarInstance']+_0x21c0ac(0x119));if(!_0xb2cfc3||!_0xb2cfc3[_0x21c0ac(0xc6)])return;const _0x56520b=JSON[_0x21c0ac(0xde)](_0xb2cfc3['val']),_0x57c8c4=new Date(),_0x91d587=_0x59631a['config'][_0x21c0ac(0x12c)]||[],_0x547c59=_0x59631a[_0x21c0ac(0xce)][_0x21c0ac(0x128)]||[];for(const _0x96739d of _0x56520b){if(_0x96739d['_calName']&&_0x547c59[_0x21c0ac(0x103)]>0x0&&!_0x547c59['includes'](_0x96739d['_calName']))continue;const _0x9c047b=new Date(_0x96739d['eventStart']),_0x49583c=(_0x96739d[_0x21c0ac(0x130)]||_0x96739d[_0x21c0ac(0xc9)]||'')['toLowerCase']();if(_0x49583c[_0x21c0ac(0xc1)](_0x21c0ac(0xea))||_0x49583c[_0x21c0ac(0xc1)](_0x21c0ac(0xdd))||_0x49583c['includes'](_0x21c0ac(0xf0))){let _0xc03ea5=0x0;Object[_0x21c0ac(0x115)](_0x131261)[_0x21c0ac(0xd5)](_0x57ed1f=>{if(_0x57ed1f>_0xc03ea5)_0xc03ea5=_0x57ed1f;});if(_0xc03ea5===0x0)_0xc03ea5=0x78;const _0x205512=new Date(_0x9c047b[_0x21c0ac(0x135)]()-_0xc03ea5*0xea60),_0x57d994=_0x57c8c4['getTime']()-_0x205512['getTime']();_0x57d994>=0x0&&_0x57d994<0xf*0xea60&&(_0x59631a[_0x21c0ac(0x137)]['info'](_0x21c0ac(0xe8)+_0x96739d[_0x21c0ac(0x130)]+_0x21c0ac(0xdb)+_0xc03ea5+_0x21c0ac(0xcc)),await _0x59631a[_0x21c0ac(0xd0)](_0x21c0ac(0xf3),{'val':_0x21c0ac(0x101),'ack':![]}));}for(const _0x143dc0 of _0x91d587){if(_0x143dc0['location']){const _0x221e29=_0x143dc0[_0x21c0ac(0xcf)][_0x21c0ac(0x11c)]();if(_0x49583c[_0x21c0ac(0xc1)](_0x221e29)){const _0x1ef095=_0x131261[_0x143dc0[_0x21c0ac(0xcf)]]||0x3c,_0x82a255=new Date(_0x9c047b[_0x21c0ac(0x135)]()-_0x1ef095*0xea60),_0x57fc47=_0x57c8c4[_0x21c0ac(0x135)]()-_0x82a255[_0x21c0ac(0x135)]();if(_0x57fc47>=0x0&&_0x57fc47<0xf*0xea60){const _0x561940=await findRelatedId(_0x59631a,_0x143dc0['id'],'setpoint');_0x561940&&(_0x59631a['log'][_0x21c0ac(0xe6)]('üìÖ\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27'+_0x143dc0[_0x21c0ac(0xcf)]+'\x27\x20erkannt\x20('+_0x96739d['event']+_0x21c0ac(0xca)+_0x1ef095+_0x21c0ac(0xcc)),await _0x59631a[_0x21c0ac(0x12b)](_0x561940,0x15),await _0x59631a[_0x21c0ac(0xd0)](_0x21c0ac(0xd4),{'val':_0x21c0ac(0xcd)+_0x143dc0['location']+_0x21c0ac(0xfc),'ack':!![]}));}}}}}}catch(_0x28ca70){_0x59631a[_0x21c0ac(0x137)][_0x21c0ac(0xd8)]('Calendar\x20Check\x20Error:\x20'+_0x28ca70[_0x21c0ac(0x131)]);}}async function applyEnergySavings(_0x5dc801,_0x5121fd){const _0x40079a=a1_0x2149a4,_0x453176=_0x5dc801[_0x40079a(0xce)]['devices']||[];for(const _0x1b0dcb of _0x5121fd){const _0x35a5bc=_0x1b0dcb['room'],_0x3e6504=_0x1b0dcb[_0x40079a(0xd3)],_0x3a0490=Date[_0x40079a(0xef)]();if(lastActions[_0x40079a(0xbe)+_0x35a5bc]&&_0x3a0490-lastActions[_0x40079a(0xbe)+_0x35a5bc]<0x1e*0x3c*0x3e8)continue;const _0x1eb119=_0x453176[_0x40079a(0x12e)](_0x2e5279=>normalize(_0x2e5279['location'])===normalize(_0x35a5bc));if(!_0x1eb119)continue;const _0x2bfc09=await findRelatedId(_0x5dc801,_0x1eb119['id'],_0x40079a(0xc7));if(_0x2bfc09){const _0x6f851f=await _0x5dc801[_0x40079a(0xe9)](_0x2bfc09);if(_0x6f851f&&typeof _0x6f851f[_0x40079a(0xc6)]==='number'){const _0x30c491=_0x6f851f[_0x40079a(0xc6)];if(_0x3e6504>0x1e&&_0x30c491>0x11){const _0x4661b0=_0x30c491-0x1;_0x5dc801[_0x40079a(0x137)]['info']('üçÉ\x20MPC\x20Autonomy:\x20Senke\x20'+_0x35a5bc+'\x20('+_0x2bfc09+_0x40079a(0xf7)+_0x4661b0+_0x40079a(0x10a)+_0x3e6504+_0x40079a(0x105)),await _0x5dc801[_0x40079a(0x12b)](_0x2bfc09,_0x4661b0),lastActions[_0x40079a(0xbe)+_0x35a5bc]=_0x3a0490,await _0x5dc801[_0x40079a(0xd0)]('analysis.automation.lastAction',{'val':_0x40079a(0x108)+_0x35a5bc+':\x20-1¬∞C\x20(Sparpotenzial\x20genutzt)','ack':!![]});}}}}}module[a1_0x2149a4(0x132)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};