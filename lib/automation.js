const a1_0x4724f1=a1_0x35ef;function a1_0x35ef(_0x15ee01,_0x4a6781){const _0x2dabec=a1_0x447e();return a1_0x35ef=function(_0x2d1ca7,_0x56edd8){_0x2d1ca7=_0x2d1ca7-0x190;let _0x447e2c=_0x2dabec[_0x2d1ca7];return _0x447e2c;},a1_0x35ef(_0x15ee01,_0x4a6781);}(function(_0x32279b,_0x441ef8){const _0x261a06=a1_0x35ef,_0x58c089=_0x32279b();while(!![]){try{const _0x3cd086=-parseInt(_0x261a06(0x1a5))/0x1+-parseInt(_0x261a06(0x1dc))/0x2+parseInt(_0x261a06(0x195))/0x3+-parseInt(_0x261a06(0x209))/0x4+parseInt(_0x261a06(0x192))/0x5*(-parseInt(_0x261a06(0x1c4))/0x6)+parseInt(_0x261a06(0x1b8))/0x7+parseInt(_0x261a06(0x19b))/0x8*(parseInt(_0x261a06(0x1ff))/0x9);if(_0x3cd086===_0x441ef8)break;else _0x58c089['push'](_0x58c089['shift']());}catch(_0x5b0f7b){_0x58c089['push'](_0x58c089['shift']());}}}(a1_0x447e,0x6cc1d));const a1_0x56edd8=(function(){let _0x330b59=!![];return function(_0x1dee8e,_0x1f7a31){const _0x1c2b29=_0x330b59?function(){const _0xfdc68f=a1_0x35ef;if(_0x1f7a31){const _0x328967=_0x1f7a31[_0xfdc68f(0x1ca)](_0x1dee8e,arguments);return _0x1f7a31=null,_0x328967;}}:function(){};return _0x330b59=![],_0x1c2b29;};}()),a1_0x2d1ca7=a1_0x56edd8(this,function(){const _0x7d2ab6=a1_0x35ef;return a1_0x2d1ca7[_0x7d2ab6(0x1fb)]()['search']('(((.+)+)+)+$')[_0x7d2ab6(0x1fb)]()[_0x7d2ab6(0x211)](a1_0x2d1ca7)[_0x7d2ab6(0x1f7)](_0x7d2ab6(0x1ef));});function a1_0x447e(){const _0x13ad13=['forEach','approved','soll','length','split','active','Â°C\x20(Coasting\x20mÃ¶glich:\x20','(((.+)+)+)+$','getForeignObjectsAsync','debug','devices','entries','actual','value.valve','wert','search','\x20min)','exports','light','toString','type','Unbekannt','toUpperCase','342cLNlAr','score','valveMapping','setForeignStateAsync','string','Ist','unit','minutes_safe','Calendar\x20Check\x20Error:\x20','\x20min).','2508800KcBkio','set','openknx','target','.4.VALVE_STATE','ankunft','val','warn','constructor','summary','thermostat.setpoint','reason','2843335ROHgfH','.1.SET_POINT_TEMPERATURE','analysis.automation.lastAction','1916649OxyFhp','temp','replace','role','info','ðŸƒ\x20MPC\x20Autonomy:\x20Senke\x20','233432gdjMYt','PERFECT','setpoint','.1.LEVEL','.data.table','\x27\x20erkannt\x20(','getForeignStateAsync','level.temperature','trim','analysis.automation.mode','549444vTnLZf','calendarSelection','Unknown','analysis.automation.confidenceThreshold','urlaub\x20ende','dimmer','log','\x20->\x2021Â°C','config','parse','toLowerCase','now','valve_position','event','.1.TEMPERATURE','location','system.mode','localeCompare','push','5450683tOdAKt','temperature','getStateAsync','filter','hm-rpc','[CAL]\x20','Soll','useCalendar','ist','analysis.energy.warmupTimes','Auto-Erkennung','sensor','6AYrTvs','sort','switch','_calName','ðŸ“…\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','mpc_','apply','thermostatMapping','find','level.valve','local_temperature','.4.SET_TEMPERATURE','target_temperature','setStateAsync','position','message','level','common','name','write','join','pi_heating_demand','number','messwert','671148oUxyBV','valve','Nicht\x20gefunden','.1.ACTUAL_TEMPERATURE','room','off','getTime','map','current_heating_setpoint','thermostat','normal','includes'];a1_0x447e=function(){return _0x13ad13;};return a1_0x447e();}a1_0x2d1ca7();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0x4a0302){const _0x3630e3=a1_0x35ef;if(!_0x4a0302)return'';return _0x4a0302['toLowerCase']()[_0x3630e3(0x197)](/\s+/g,'')[_0x3630e3(0x1a3)]();}async function handlePrediction(_0xccd2a7,_0x5d248a,_0x37f52c){const _0x1353a2=a1_0x35ef;if(!_0x5d248a||_0x5d248a===_0x1353a2(0x1a7))return;let _0x352a03='off',_0x16e700=0.6;try{const _0x5bcad3=await _0xccd2a7[_0x1353a2(0x1ba)](_0x1353a2(0x1a4));if(_0x5bcad3&&_0x5bcad3[_0x1353a2(0x20f)])_0x352a03=_0x5bcad3[_0x1353a2(0x20f)];const _0x48f42d=await _0xccd2a7[_0x1353a2(0x1ba)](_0x1353a2(0x1a8));if(_0x48f42d&&_0x48f42d['val'])_0x16e700=_0x48f42d[_0x1353a2(0x20f)];}catch(_0x49bfe9){}if(_0x352a03===_0x1353a2(0x1e1)||_0x37f52c<_0x16e700)return;const _0x402f2b=Date[_0x1353a2(0x1b0)]();if(lastActions[_0x5d248a]&&_0x402f2b-lastActions[_0x5d248a]<COOLDOWN_MS)return;const _0x3931a6=_0xccd2a7[_0x1353a2(0x1ad)]['devices']||[],_0x277b3e=normalize(_0x5d248a),_0x585a90=_0x3931a6['find'](_0x1e176c=>normalize(_0x1e176c['location'])===_0x277b3e&&(_0x1e176c['type']===_0x1353a2(0x1fa)||_0x1e176c[_0x1353a2(0x1fc)]===_0x1353a2(0x1aa)||_0x1e176c[_0x1353a2(0x1fc)]===_0x1353a2(0x1c6)));if(!_0x585a90){_0xccd2a7[_0x1353a2(0x1ab)][_0x1353a2(0x1f1)]('ðŸ”\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27'+_0x5d248a+'\x27.');return;}const _0x423b72=await aiAgent['consultButler'](_0xccd2a7,_0x5d248a,_0x585a90['name'],_0x37f52c);if(!_0x423b72[_0x1353a2(0x1e9)])return;const _0x24a192='PrÃ¤diktion:\x20'+_0x5d248a+'\x20->\x20Schalte\x20'+_0x585a90[_0x1353a2(0x1d6)]+'\x20('+_0x423b72[_0x1353a2(0x191)]+')';await _0xccd2a7[_0x1353a2(0x1d1)](_0x1353a2(0x194),{'val':'['+_0x352a03[_0x1353a2(0x1fe)]()+']\x20'+_0x24a192,'ack':!![]});if(_0x352a03===_0x1353a2(0x1ed)){const _0x205462=await _0xccd2a7[_0x1353a2(0x1a1)](_0x585a90['id']);(!_0x205462||!_0x205462['val']&&_0x205462[_0x1353a2(0x20f)]!==!![])&&await _0xccd2a7[_0x1353a2(0x202)](_0x585a90['id'],!![]),lastActions[_0x5d248a]=_0x402f2b;}}async function findRelatedId(_0x2ed4e4,_0x1df14d,_0x40bc8d=a1_0x4724f1(0x19d)){const _0x4485ec=a1_0x4724f1;if(_0x40bc8d===_0x4485ec(0x19d)&&_0x2ed4e4[_0x4485ec(0x1ad)][_0x4485ec(0x1cb)]){let _0x51370c=_0x2ed4e4[_0x4485ec(0x1ad)][_0x4485ec(0x1cb)];if(typeof _0x51370c===_0x4485ec(0x203))try{_0x51370c=JSON[_0x4485ec(0x1ae)](_0x51370c);}catch(_0x2486d9){}if(_0x51370c&&_0x51370c[_0x1df14d])return _0x51370c[_0x1df14d];}if(_0x40bc8d===_0x4485ec(0x1dd)&&_0x2ed4e4[_0x4485ec(0x1ad)][_0x4485ec(0x201)]){let _0x42d17e=_0x2ed4e4[_0x4485ec(0x1ad)][_0x4485ec(0x201)];if(typeof _0x42d17e===_0x4485ec(0x203))try{_0x42d17e=JSON[_0x4485ec(0x1ae)](_0x42d17e);}catch(_0xc7c8c8){}if(_0x42d17e&&_0x42d17e[_0x1df14d])return _0x42d17e[_0x1df14d];}let _0xb11979=[];if(_0x40bc8d==='setpoint')_0xb11979=[{'s':'.1.ACTUAL_TEMPERATURE','t':_0x4485ec(0x193)},{'s':'.1.TEMPERATURE','t':_0x4485ec(0x193)},{'s':_0x4485ec(0x1b3),'t':_0x4485ec(0x1cf)},{'s':'ACTUAL_TEMPERATURE','t':'SET_POINT_TEMPERATURE'},{'s':_0x4485ec(0x1ce),'t':'occupied_heating_setpoint'},{'s':'local_temperature','t':_0x4485ec(0x1e4)},{'s':_0x4485ec(0x1b9),'t':_0x4485ec(0x1d0)},{'s':'ACTUAL','t':'SET'},{'s':_0x4485ec(0x204),'t':_0x4485ec(0x1be)},{'s':_0x4485ec(0x1b9),'t':'setpoint'}];else _0x40bc8d===_0x4485ec(0x1dd)&&(_0xb11979=[{'s':_0x4485ec(0x1df),'t':_0x4485ec(0x19e)},{'s':_0x4485ec(0x1b3),'t':'.1.LEVEL'},{'s':_0x4485ec(0x1b3),'t':_0x4485ec(0x20d)},{'s':_0x4485ec(0x1ce),'t':_0x4485ec(0x1d9)},{'s':_0x4485ec(0x1b9),'t':_0x4485ec(0x1b1)},{'s':'temperature','t':'level'}]);for(const _0x2580dc of _0xb11979){if(_0x1df14d[_0x4485ec(0x1e7)](_0x2580dc['s'])){const _0x2a8725=_0x1df14d[_0x4485ec(0x197)](_0x2580dc['s'],_0x2580dc['t']),_0x449a87=await _0x2ed4e4['getForeignObjectAsync'](_0x2a8725);if(_0x449a87)return _0x2a8725;}}try{const _0x46fb75=_0x1df14d[_0x4485ec(0x1ec)]('.');if(_0x46fb75['length']>0x2){const _0x4c09ed=_0x46fb75['slice'](0x0,-0x1)[_0x4485ec(0x1d8)]('.'),_0x125302=await _0x2ed4e4[_0x4485ec(0x1f0)](_0x4c09ed+'.*'),_0x2e99b8=[],_0x4be355=_0x1df14d['split'](/[._]+/)[_0x4485ec(0x1bb)](_0x4d176d=>![_0x4485ec(0x20b),'0',_0x4485ec(0x1bc),_0x4485ec(0x1c0),_0x4485ec(0x1f6),_0x4485ec(0x1b9),_0x4485ec(0x1f4),_0x4485ec(0x1c3),_0x4485ec(0x1db),'state'][_0x4485ec(0x1e7)](_0x4d176d[_0x4485ec(0x1af)]()));for(const [_0x291f60,_0x296d81]of Object[_0x4485ec(0x1f3)](_0x125302)){if(_0x291f60===_0x1df14d)continue;if(_0x296d81&&_0x296d81[_0x4485ec(0x1d5)]){const _0x34cf52=_0x291f60['toLowerCase'](),_0x2f1099=(_0x296d81[_0x4485ec(0x1d5)][_0x4485ec(0x198)]||'')[_0x4485ec(0x1af)](),_0x3aa3d6=(_0x296d81[_0x4485ec(0x1d5)][_0x4485ec(0x205)]||'')[_0x4485ec(0x1af)]();let _0x4b0668=![];if(_0x40bc8d===_0x4485ec(0x19d)&&_0x296d81[_0x4485ec(0x1d5)][_0x4485ec(0x1d7)]===!![])_0x4b0668=_0x34cf52[_0x4485ec(0x1e7)](_0x4485ec(0x20a))||_0x34cf52[_0x4485ec(0x1e7)](_0x4485ec(0x1ea))||_0x34cf52[_0x4485ec(0x1e7)](_0x4485ec(0x20c))||_0x2f1099['includes'](_0x4485ec(0x1a2))||_0x2f1099['includes'](_0x4485ec(0x190));else _0x40bc8d===_0x4485ec(0x1dd)&&(_0x4b0668=_0x34cf52[_0x4485ec(0x1e7)](_0x4485ec(0x1d4))||_0x34cf52[_0x4485ec(0x1e7)](_0x4485ec(0x1dd))||_0x34cf52[_0x4485ec(0x1e7)]('stellwert')||_0x34cf52[_0x4485ec(0x1e7)](_0x4485ec(0x1d2))||_0x2f1099[_0x4485ec(0x1e7)](_0x4485ec(0x1cd))||_0x2f1099[_0x4485ec(0x1e7)](_0x4485ec(0x1f5))||_0x3aa3d6['includes']('%'));if(_0x4b0668){const _0x510c46=_0x291f60['split'](/[._]+/)[_0x4485ec(0x1e3)](_0x28db5b=>_0x28db5b[_0x4485ec(0x1af)]());let _0x274192=0x0;_0x4be355['forEach'](_0x5425a8=>{const _0x39c2d4=_0x4485ec;if(_0x510c46['includes'](_0x5425a8[_0x39c2d4(0x1af)]()))_0x274192++;}),_0x2e99b8[_0x4485ec(0x1b7)]({'id':_0x291f60,'score':_0x274192});}}}if(_0x2e99b8[_0x4485ec(0x1eb)]>0x0){_0x2e99b8[_0x4485ec(0x1c5)]((_0x3515e2,_0x36bddc)=>_0x36bddc[_0x4485ec(0x200)]-_0x3515e2[_0x4485ec(0x200)]);if(_0x2e99b8[0x0][_0x4485ec(0x200)]>0x0)return _0x2e99b8[0x0]['id'];}}}catch(_0xd62f04){}return null;}async function scanThermostats(_0x4195c1){const _0x5eff9d=a1_0x4724f1,_0x2c49d2=_0x4195c1['config']['devices']||[],_0x5534ec=[],_0x36b6cd=_0x2c49d2['filter'](_0x324c9f=>_0x324c9f['id']&&_0x324c9f['id'][_0x5eff9d(0x1e7)](_0x5eff9d(0x1b9))||_0x324c9f['type']&&['temperature',_0x5eff9d(0x1e5),_0x5eff9d(0x1c3)][_0x5eff9d(0x1e7)](_0x324c9f[_0x5eff9d(0x1fc)])||_0x324c9f[_0x5eff9d(0x1d6)]&&_0x324c9f[_0x5eff9d(0x1d6)][_0x5eff9d(0x1af)]()['includes'](_0x5eff9d(0x196)));for(const _0x32b812 of _0x36b6cd){const _0x3a3017=await findRelatedId(_0x4195c1,_0x32b812['id'],'setpoint'),_0x33d482=await findRelatedId(_0x4195c1,_0x32b812['id'],_0x5eff9d(0x1dd));let _0xccf6a0=_0x5eff9d(0x1de),_0x98f395=![],_0x3da4c3=_0x4195c1['config'][_0x5eff9d(0x1cb)]||{};if(typeof _0x3da4c3===_0x5eff9d(0x203))try{_0x3da4c3=JSON['parse'](_0x3da4c3);}catch(_0x3ef5e8){}let _0x545657=_0x4195c1[_0x5eff9d(0x1ad)][_0x5eff9d(0x201)]||{};if(typeof _0x545657===_0x5eff9d(0x203))try{_0x545657=JSON['parse'](_0x545657);}catch(_0x4ac443){}if(_0x3da4c3[_0x32b812['id']]&&_0x3da4c3[_0x32b812['id']]===_0x3a3017||_0x545657[_0x32b812['id']]&&_0x545657[_0x32b812['id']]===_0x33d482)_0xccf6a0='Manuelles\x20Mapping',_0x98f395=!![];else(_0x3a3017||_0x33d482)&&(_0xccf6a0=_0x5eff9d(0x1c2));_0x5534ec[_0x5eff9d(0x1b7)]({'room':_0x32b812[_0x5eff9d(0x1b4)]||_0x5eff9d(0x1fd),'sensorId':_0x32b812['id'],'setpointId':_0x3a3017||'-','valveId':_0x33d482||'-','source':_0xccf6a0,'isManual':_0x98f395,'status':_0x3a3017&&_0x33d482?_0x5eff9d(0x19c):_0x3a3017?'OK':'Fehlt'});}return _0x5534ec[_0x5eff9d(0x1c5)]((_0x279796,_0x1f03ba)=>_0x279796['room'][_0x5eff9d(0x1b6)](_0x1f03ba[_0x5eff9d(0x1e0)]));}async function checkCalendarTriggers(_0x3b6fa3){const _0x1d9911=a1_0x4724f1;if(!_0x3b6fa3[_0x1d9911(0x1ad)][_0x1d9911(0x1bf)]||!_0x3b6fa3[_0x1d9911(0x1ad)]['calendarInstance'])return;let _0x58924f={};try{const _0x2133ed=await _0x3b6fa3['getStateAsync'](_0x1d9911(0x1c1));if(_0x2133ed&&_0x2133ed['val'])_0x58924f=JSON[_0x1d9911(0x1ae)](_0x2133ed['val']);}catch(_0x297eb4){}try{const _0x15f607=await _0x3b6fa3[_0x1d9911(0x1a1)](_0x3b6fa3[_0x1d9911(0x1ad)]['calendarInstance']+_0x1d9911(0x19f));if(!_0x15f607||!_0x15f607[_0x1d9911(0x20f)])return;const _0x502938=JSON[_0x1d9911(0x1ae)](_0x15f607[_0x1d9911(0x20f)]),_0x194512=new Date(),_0x375d8d=_0x3b6fa3['config'][_0x1d9911(0x1f2)]||[],_0x15fca3=_0x3b6fa3[_0x1d9911(0x1ad)][_0x1d9911(0x1a6)]||[];for(const _0x31c2d6 of _0x502938){if(_0x31c2d6[_0x1d9911(0x1c7)]&&_0x15fca3[_0x1d9911(0x1eb)]>0x0&&!_0x15fca3[_0x1d9911(0x1e7)](_0x31c2d6[_0x1d9911(0x1c7)]))continue;const _0x235702=new Date(_0x31c2d6['eventStart']),_0x2d4f22=(_0x31c2d6[_0x1d9911(0x1b2)]||_0x31c2d6[_0x1d9911(0x212)]||'')[_0x1d9911(0x1af)]();if(_0x2d4f22[_0x1d9911(0x1e7)](_0x1d9911(0x1a9))||_0x2d4f22[_0x1d9911(0x1e7)]('rÃ¼ckkehr')||_0x2d4f22[_0x1d9911(0x1e7)](_0x1d9911(0x20e))){let _0x5628f2=0x0;Object['values'](_0x58924f)[_0x1d9911(0x1e8)](_0x7d796e=>{if(_0x7d796e>_0x5628f2)_0x5628f2=_0x7d796e;});if(_0x5628f2===0x0)_0x5628f2=0x78;const _0x45737a=new Date(_0x235702[_0x1d9911(0x1e2)]()-_0x5628f2*0xea60),_0x44660b=_0x194512[_0x1d9911(0x1e2)]()-_0x45737a[_0x1d9911(0x1e2)]();_0x44660b>=0x0&&_0x44660b<0xf*0xea60&&(_0x3b6fa3[_0x1d9911(0x1ab)][_0x1d9911(0x199)](_0x1d9911(0x1c8)+_0x31c2d6[_0x1d9911(0x1b2)]+').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20'+_0x5628f2+_0x1d9911(0x208)),await _0x3b6fa3[_0x1d9911(0x1d1)](_0x1d9911(0x1b5),{'val':_0x1d9911(0x1e6),'ack':![]}));}for(const _0x4c5e98 of _0x375d8d){if(_0x4c5e98[_0x1d9911(0x1b4)]){const _0x39bd32=_0x4c5e98[_0x1d9911(0x1b4)][_0x1d9911(0x1af)]();if(_0x2d4f22[_0x1d9911(0x1e7)](_0x39bd32)){const _0x1df0e5=_0x58924f[_0x4c5e98[_0x1d9911(0x1b4)]]||0x3c,_0x4e1f3f=new Date(_0x235702[_0x1d9911(0x1e2)]()-_0x1df0e5*0xea60),_0x3161ab=_0x194512[_0x1d9911(0x1e2)]()-_0x4e1f3f[_0x1d9911(0x1e2)]();if(_0x3161ab>=0x0&&_0x3161ab<0xf*0xea60){const _0x4e884d=await findRelatedId(_0x3b6fa3,_0x4c5e98['id'],'setpoint');_0x4e884d&&(_0x3b6fa3['log'][_0x1d9911(0x199)]('ðŸ“…\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27'+_0x4c5e98['location']+_0x1d9911(0x1a0)+_0x31c2d6['event']+').\x20Heize\x20auf\x2021Â°C\x20(Vorlauf:\x20'+_0x1df0e5+_0x1d9911(0x208)),await _0x3b6fa3[_0x1d9911(0x202)](_0x4e884d,0x15),await _0x3b6fa3['setStateAsync'](_0x1d9911(0x194),{'val':_0x1d9911(0x1bd)+_0x4c5e98[_0x1d9911(0x1b4)]+_0x1d9911(0x1ac),'ack':!![]}));}}}}}}catch(_0x5c018d){_0x3b6fa3[_0x1d9911(0x1ab)][_0x1d9911(0x210)](_0x1d9911(0x207)+_0x5c018d[_0x1d9911(0x1d3)]);}}async function applyEnergySavings(_0xfa60f,_0x450552){const _0x15c855=a1_0x4724f1,_0x3acb08=_0xfa60f[_0x15c855(0x1ad)][_0x15c855(0x1f2)]||[];for(const _0x29a0a1 of _0x450552){const _0x2475e8=_0x29a0a1[_0x15c855(0x1e0)],_0x194fc1=_0x29a0a1[_0x15c855(0x206)],_0x324504=Date['now']();if(lastActions[_0x15c855(0x1c9)+_0x2475e8]&&_0x324504-lastActions[_0x15c855(0x1c9)+_0x2475e8]<0x1e*0x3c*0x3e8)continue;const _0x1305a9=_0x3acb08[_0x15c855(0x1cc)](_0x335866=>normalize(_0x335866[_0x15c855(0x1b4)])===normalize(_0x2475e8));if(!_0x1305a9)continue;const _0x216d7f=await findRelatedId(_0xfa60f,_0x1305a9['id'],_0x15c855(0x19d));if(_0x216d7f){const _0x36ae84=await _0xfa60f[_0x15c855(0x1a1)](_0x216d7f);if(_0x36ae84&&typeof _0x36ae84[_0x15c855(0x20f)]===_0x15c855(0x1da)){const _0x4ae32e=_0x36ae84[_0x15c855(0x20f)];if(_0x194fc1>0x1e&&_0x4ae32e>0x11){const _0x1080ea=_0x4ae32e-0x1;_0xfa60f[_0x15c855(0x1ab)]['info'](_0x15c855(0x19a)+_0x2475e8+'\x20('+_0x216d7f+')\x20auf\x20'+_0x1080ea+_0x15c855(0x1ee)+_0x194fc1+_0x15c855(0x1f8)),await _0xfa60f['setForeignStateAsync'](_0x216d7f,_0x1080ea),lastActions['mpc_'+_0x2475e8]=_0x324504,await _0xfa60f['setStateAsync'](_0x15c855(0x194),{'val':'[MPC]\x20'+_0x2475e8+':\x20-1Â°C\x20(Sparpotenzial\x20genutzt)','ack':!![]});}}}}}module[a1_0x4724f1(0x1f9)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};