const a1_0x2eeea0=a1_0x9f78;(function(_0x153f43,_0x15734c){const _0xee16ab=a1_0x9f78,_0x1639de=_0x153f43();while(!![]){try{const _0x5de8f2=-parseInt(_0xee16ab(0x138))/0x1+-parseInt(_0xee16ab(0x16b))/0x2+parseInt(_0xee16ab(0x14f))/0x3*(-parseInt(_0xee16ab(0x16e))/0x4)+-parseInt(_0xee16ab(0x131))/0x5*(parseInt(_0xee16ab(0x142))/0x6)+parseInt(_0xee16ab(0x16f))/0x7+parseInt(_0xee16ab(0x14d))/0x8*(parseInt(_0xee16ab(0x175))/0x9)+parseInt(_0xee16ab(0x174))/0xa;if(_0x5de8f2===_0x15734c)break;else _0x1639de['push'](_0x1639de['shift']());}catch(_0x4b3ab2){_0x1639de['push'](_0x1639de['shift']());}}}(a1_0x5447,0x6e363));const a1_0x3e93fb=(function(){let _0x448a10=!![];return function(_0x41e54f,_0xd7da61){const _0x218f3a=_0x448a10?function(){const _0x5c843a=a1_0x9f78;if(_0xd7da61){const _0x57c102=_0xd7da61[_0x5c843a(0x13b)](_0x41e54f,arguments);return _0xd7da61=null,_0x57c102;}}:function(){};return _0x448a10=![],_0x218f3a;};}()),a1_0x202d77=a1_0x3e93fb(this,function(){const _0x259b0c=a1_0x9f78;return a1_0x202d77[_0x259b0c(0x11d)]()['search']('(((.+)+)+)+$')[_0x259b0c(0x11d)]()[_0x259b0c(0x158)](a1_0x202d77)[_0x259b0c(0x136)](_0x259b0c(0x169));});a1_0x202d77();'use strict';const aiAgent=require(a1_0x2eeea0(0x10d)),COOLDOWN_MS=0x3c*0x3e8,lastActions={};function normalize(_0xcf98b6){const _0x212407=a1_0x2eeea0;if(!_0xcf98b6)return'';return _0xcf98b6[_0x212407(0x10c)]()[_0x212407(0x178)](/\s+/g,'')[_0x212407(0x15b)]();}async function handlePrediction(_0x4bf973,_0x3dcecf,_0x2c61b5){const _0x1ea7d8=a1_0x2eeea0;if(!_0x3dcecf||_0x3dcecf===_0x1ea7d8(0x181))return;let _0x35bc25=_0x1ea7d8(0x13c),_0x22419c=0.6;try{const _0xe61f54=await _0x4bf973['getStateAsync'](_0x1ea7d8(0x147));if(_0xe61f54&&_0xe61f54[_0x1ea7d8(0x10e)])_0x35bc25=_0xe61f54[_0x1ea7d8(0x10e)];const _0x4ca1cd=await _0x4bf973['getStateAsync'](_0x1ea7d8(0x155));if(_0x4ca1cd&&_0x4ca1cd['val'])_0x22419c=_0x4ca1cd[_0x1ea7d8(0x10e)];}catch(_0x2a89ff){}if(_0x35bc25===_0x1ea7d8(0x13c)||_0x2c61b5<_0x22419c)return;const _0x439f49=Date[_0x1ea7d8(0x14e)]();if(lastActions[_0x3dcecf]&&_0x439f49-lastActions[_0x3dcecf]<COOLDOWN_MS)return;const _0x34e960=_0x4bf973[_0x1ea7d8(0x15d)]['devices']||[],_0x40e1e4=normalize(_0x3dcecf),_0x1f3d28=_0x34e960[_0x1ea7d8(0x14a)](_0x4053e0=>normalize(_0x4053e0[_0x1ea7d8(0x14b)])===_0x40e1e4&&(_0x4053e0[_0x1ea7d8(0x139)]===_0x1ea7d8(0x153)||_0x4053e0[_0x1ea7d8(0x139)]===_0x1ea7d8(0x180)||_0x4053e0[_0x1ea7d8(0x139)]==='switch'));if(!_0x1f3d28){_0x4bf973['log'][_0x1ea7d8(0x135)](_0x1ea7d8(0x17a)+_0x3dcecf+'\x27.');return;}const _0x2a0f2e=await aiAgent[_0x1ea7d8(0x12a)](_0x4bf973,_0x3dcecf,_0x1f3d28['name'],_0x2c61b5);if(!_0x2a0f2e[_0x1ea7d8(0x140)])return;const _0xd9e2f8=_0x1ea7d8(0x156)+_0x3dcecf+'\x20->\x20Schalte\x20'+_0x1f3d28[_0x1ea7d8(0x12b)]+'\x20('+_0x2a0f2e[_0x1ea7d8(0x15a)]+')';await _0x4bf973[_0x1ea7d8(0x11b)]('analysis.automation.lastAction',{'val':'['+_0x35bc25[_0x1ea7d8(0x167)]()+']\x20'+_0xd9e2f8,'ack':!![]});if(_0x35bc25===_0x1ea7d8(0x166)){const _0x45a194=await _0x4bf973[_0x1ea7d8(0x120)](_0x1f3d28['id']);(!_0x45a194||!_0x45a194[_0x1ea7d8(0x10e)]&&_0x45a194[_0x1ea7d8(0x10e)]!==!![])&&await _0x4bf973[_0x1ea7d8(0x17e)](_0x1f3d28['id'],!![]),lastActions[_0x3dcecf]=_0x439f49;}}async function findRelatedId(_0x25f314,_0x46071c,_0x399f63=a1_0x2eeea0(0x179)){const _0x411407=a1_0x2eeea0;if(_0x399f63===_0x411407(0x179)&&_0x25f314['config'][_0x411407(0x118)]){let _0x4666df=_0x25f314[_0x411407(0x15d)]['thermostatMapping'];if(typeof _0x4666df===_0x411407(0x11a))try{_0x4666df=JSON[_0x411407(0x127)](_0x4666df);}catch(_0x2e4823){}if(_0x4666df&&_0x4666df[_0x46071c])return _0x4666df[_0x46071c];}if(_0x399f63===_0x411407(0x177)&&_0x25f314[_0x411407(0x15d)]['valveMapping']){let _0x3de9f9=_0x25f314['config'][_0x411407(0x119)];if(typeof _0x3de9f9==='string')try{_0x3de9f9=JSON[_0x411407(0x127)](_0x3de9f9);}catch(_0x32b6be){}if(_0x3de9f9&&_0x3de9f9[_0x46071c])return _0x3de9f9[_0x46071c];}let _0x3b0500=[];if(_0x399f63===_0x411407(0x179))_0x3b0500=[{'s':_0x411407(0x123),'t':'.1.SET_POINT_TEMPERATURE'},{'s':'.1.TEMPERATURE','t':_0x411407(0x11e)},{'s':'.1.TEMPERATURE','t':'.4.SET_TEMPERATURE'},{'s':_0x411407(0x114),'t':'SET_POINT_TEMPERATURE'},{'s':_0x411407(0x12f),'t':_0x411407(0x13a)},{'s':_0x411407(0x12f),'t':_0x411407(0x117)},{'s':'temperature','t':_0x411407(0x16a)},{'s':'ACTUAL','t':_0x411407(0x15e)},{'s':'Ist','t':_0x411407(0x165)},{'s':_0x411407(0x126),'t':_0x411407(0x179)}];else _0x399f63===_0x411407(0x177)&&(_0x3b0500=[{'s':_0x411407(0x123),'t':_0x411407(0x172)},{'s':'.1.TEMPERATURE','t':_0x411407(0x172)},{'s':'.1.TEMPERATURE','t':'.4.VALVE_STATE'},{'s':'local_temperature','t':_0x411407(0x16d)},{'s':_0x411407(0x126),'t':'valve_position'},{'s':_0x411407(0x126),'t':_0x411407(0x17d)}]);for(const _0x3595d6 of _0x3b0500){if(_0x46071c[_0x411407(0x159)](_0x3595d6['s'])){const _0x22ce40=_0x46071c[_0x411407(0x178)](_0x3595d6['s'],_0x3595d6['t']),_0x1276e3=await _0x25f314[_0x411407(0x173)](_0x22ce40);if(_0x1276e3)return _0x22ce40;}}try{const _0x19f8a8=_0x46071c[_0x411407(0x115)]('.');if(_0x19f8a8['length']>0x2){const _0x3cb1d1=_0x19f8a8[_0x411407(0x17b)](0x0,-0x1)[_0x411407(0x112)]('.'),_0x52e36b=await _0x25f314[_0x411407(0x11c)](_0x3cb1d1+'.*'),_0x5edaae=[],_0x20c7f0=_0x46071c[_0x411407(0x115)](/[._]+/)['filter'](_0x205a4b=>![_0x411407(0x14c),'0','hm-rpc',_0x411407(0x141),_0x411407(0x128),_0x411407(0x126),_0x411407(0x16c),_0x411407(0x170),_0x411407(0x164),_0x411407(0x11f)][_0x411407(0x159)](_0x205a4b[_0x411407(0x10c)]()));for(const [_0x3f02fb,_0x492939]of Object['entries'](_0x52e36b)){if(_0x3f02fb===_0x46071c)continue;if(_0x492939&&_0x492939['common']){const _0x9c9163=_0x3f02fb['toLowerCase'](),_0x4dbf9a=(_0x492939['common'][_0x411407(0x10b)]||'')['toLowerCase'](),_0x5a852f=(_0x492939[_0x411407(0x15f)]['unit']||'')[_0x411407(0x10c)]();let _0x2bd7fe=![];if(_0x399f63===_0x411407(0x179)&&_0x492939[_0x411407(0x15f)]['write']===!![])_0x2bd7fe=_0x9c9163[_0x411407(0x159)](_0x411407(0x13f))||_0x9c9163[_0x411407(0x159)](_0x411407(0x116))||_0x9c9163[_0x411407(0x159)](_0x411407(0x12c))||_0x4dbf9a[_0x411407(0x159)]('level.temperature')||_0x4dbf9a['includes'](_0x411407(0x15c));else _0x399f63===_0x411407(0x177)&&(_0x2bd7fe=_0x9c9163[_0x411407(0x159)](_0x411407(0x17d))||_0x9c9163[_0x411407(0x159)]('valve')||_0x9c9163[_0x411407(0x159)]('stellwert')||_0x9c9163[_0x411407(0x159)]('position')||_0x4dbf9a[_0x411407(0x159)](_0x411407(0x13e))||_0x4dbf9a['includes'](_0x411407(0x161))||_0x5a852f['includes']('%'));if(_0x2bd7fe){const _0x40b187=_0x3f02fb[_0x411407(0x115)](/[._]+/)['map'](_0x57d3eb=>_0x57d3eb[_0x411407(0x10c)]());let _0x4eceb1=0x0;_0x20c7f0[_0x411407(0x182)](_0x55a90a=>{const _0x3e7da2=_0x411407;if(_0x40b187[_0x3e7da2(0x159)](_0x55a90a[_0x3e7da2(0x10c)]()))_0x4eceb1++;}),_0x5edaae[_0x411407(0x111)]({'id':_0x3f02fb,'score':_0x4eceb1});}}}if(_0x5edaae['length']>0x0){_0x5edaae[_0x411407(0x144)]((_0xefc8b3,_0x482d79)=>_0x482d79['score']-_0xefc8b3[_0x411407(0x152)]);if(_0x5edaae[0x0][_0x411407(0x152)]>0x0)return _0x5edaae[0x0]['id'];}}}catch(_0x53c350){}return null;}async function scanThermostats(_0x55c072){const _0x57165b=a1_0x2eeea0,_0x2d5b11=_0x55c072['config']['devices']||[],_0xf4eba7=[],_0x146f41=_0x2d5b11[_0x57165b(0x17c)](_0x1032a3=>_0x1032a3['id']&&_0x1032a3['id'][_0x57165b(0x159)](_0x57165b(0x126))||_0x1032a3['type']&&['temperature','thermostat',_0x57165b(0x170)]['includes'](_0x1032a3['type'])||_0x1032a3[_0x57165b(0x12b)]&&_0x1032a3[_0x57165b(0x12b)][_0x57165b(0x10c)]()[_0x57165b(0x159)](_0x57165b(0x151)));for(const _0x4038f0 of _0x146f41){const _0x4afd8b=await findRelatedId(_0x55c072,_0x4038f0['id'],_0x57165b(0x179)),_0xb5183b=await findRelatedId(_0x55c072,_0x4038f0['id'],_0x57165b(0x177));let _0x43564d=_0x57165b(0x110),_0x76a92a=![],_0x2245f3=_0x55c072[_0x57165b(0x15d)]['thermostatMapping']||{};if(typeof _0x2245f3===_0x57165b(0x11a))try{_0x2245f3=JSON[_0x57165b(0x127)](_0x2245f3);}catch(_0x41e49b){}let _0x178a8e=_0x55c072[_0x57165b(0x15d)][_0x57165b(0x119)]||{};if(typeof _0x178a8e===_0x57165b(0x11a))try{_0x178a8e=JSON[_0x57165b(0x127)](_0x178a8e);}catch(_0x1b5155){}if(_0x2245f3[_0x4038f0['id']]&&_0x2245f3[_0x4038f0['id']]===_0x4afd8b||_0x178a8e[_0x4038f0['id']]&&_0x178a8e[_0x4038f0['id']]===_0xb5183b)_0x43564d=_0x57165b(0x162),_0x76a92a=!![];else(_0x4afd8b||_0xb5183b)&&(_0x43564d='Auto-Erkennung');_0xf4eba7[_0x57165b(0x111)]({'room':_0x4038f0[_0x57165b(0x14b)]||_0x57165b(0x12e),'sensorId':_0x4038f0['id'],'setpointId':_0x4afd8b||'-','valveId':_0xb5183b||'-','source':_0x43564d,'isManual':_0x76a92a,'status':_0x4afd8b&&_0xb5183b?_0x57165b(0x171):_0x4afd8b?'OK':_0x57165b(0x125)});}return _0xf4eba7['sort']((_0x27d8a,_0x4c0ba2)=>_0x27d8a['room'][_0x57165b(0x145)](_0x4c0ba2['room']));}function a1_0x5447(){const _0x176c46=['Calendar\x20Check\x20Error:\x20','summary','.1.ACTUAL_TEMPERATURE','devices','Fehlt','temperature','parse','wert','urlaub\x20ende','consultButler','name','target','ðŸ“…\x20SMART\x20SCHEDULE:\x20\x27Globaler\x20Start\x27\x20erkannt\x20(','Unbekannt','local_temperature','minutes_safe','395cflAXp','\x20->\x2021Â°C','analysis.automation.lastAction',':\x20-1Â°C\x20(Sparpotenzial\x20genutzt)','debug','search','getTime','52660avxwOo','type','occupied_heating_setpoint','apply','off','analysis.energy.warmupTimes','level.valve','set','approved','ist','47934xrGOrD','_calName','sort','localeCompare','system.mode','analysis.automation.mode','.data.table','room','find','location','openknx','3064SLjlFr','now','1704930ScKhjm',').\x20Heize\x20auf\x2021Â°C\x20(Vorlauf:\x20','temp','score','light','calendarInstance','analysis.automation.confidenceThreshold','PrÃ¤diktion:\x20','values','constructor','includes','reason','trim','thermostat.setpoint','config','SET','common','info','value.valve','Manuelles\x20Mapping','Â°C\x20(Coasting\x20mÃ¶glich:\x20','messwert','Soll','active','toUpperCase','getStateAsync','(((.+)+)+)+$','target_temperature','1577644nfoDKT','actual','pi_heating_demand','4BhLPcE','4584160nIWtxa','sensor','PERFECT','.1.LEVEL','getForeignObjectAsync','11423250AGEtjb','16335FPdcAH','mpc_','valve','replace','setpoint','ðŸ”\x20Device-Search\x20failed\x20for\x20predicted\x20room\x20\x27','slice','filter','level','setForeignStateAsync','event','dimmer','Unknown','forEach','normal','log','role','toLowerCase','./ai_agent','val','\x20min).','Nicht\x20gefunden','push','join','ðŸƒ\x20MPC\x20Autonomy:\x20Senke\x20','ACTUAL_TEMPERATURE','split','soll','current_heating_setpoint','thermostatMapping','valveMapping','string','setStateAsync','getForeignObjectsAsync','toString','.1.SET_POINT_TEMPERATURE','state','getForeignStateAsync'];a1_0x5447=function(){return _0x176c46;};return a1_0x5447();}async function checkCalendarTriggers(_0x49c122){const _0x3f2ece=a1_0x2eeea0;if(!_0x49c122[_0x3f2ece(0x15d)]['useCalendar']||!_0x49c122[_0x3f2ece(0x15d)][_0x3f2ece(0x154)])return;let _0x18ddd1={};try{const _0x4f6a22=await _0x49c122[_0x3f2ece(0x168)](_0x3f2ece(0x13d));if(_0x4f6a22&&_0x4f6a22['val'])_0x18ddd1=JSON[_0x3f2ece(0x127)](_0x4f6a22[_0x3f2ece(0x10e)]);}catch(_0x321120){}try{const _0x3b54d=await _0x49c122[_0x3f2ece(0x120)](_0x49c122[_0x3f2ece(0x15d)][_0x3f2ece(0x154)]+_0x3f2ece(0x148));if(!_0x3b54d||!_0x3b54d[_0x3f2ece(0x10e)])return;const _0x2213a5=JSON[_0x3f2ece(0x127)](_0x3b54d['val']),_0x309e4a=new Date(),_0x466c2d=_0x49c122[_0x3f2ece(0x15d)][_0x3f2ece(0x124)]||[],_0x448533=_0x49c122[_0x3f2ece(0x15d)]['calendarSelection']||[];for(const _0x34fade of _0x2213a5){if(_0x34fade[_0x3f2ece(0x143)]&&_0x448533['length']>0x0&&!_0x448533[_0x3f2ece(0x159)](_0x34fade[_0x3f2ece(0x143)]))continue;const _0x30d854=new Date(_0x34fade['eventStart']),_0x4a5ab3=(_0x34fade[_0x3f2ece(0x17f)]||_0x34fade[_0x3f2ece(0x122)]||'')[_0x3f2ece(0x10c)]();if(_0x4a5ab3['includes'](_0x3f2ece(0x129))||_0x4a5ab3[_0x3f2ece(0x159)]('rÃ¼ckkehr')||_0x4a5ab3[_0x3f2ece(0x159)]('ankunft')){let _0x573625=0x0;Object[_0x3f2ece(0x157)](_0x18ddd1)[_0x3f2ece(0x182)](_0x3d77cb=>{if(_0x3d77cb>_0x573625)_0x573625=_0x3d77cb;});if(_0x573625===0x0)_0x573625=0x78;const _0x1e4602=new Date(_0x30d854[_0x3f2ece(0x137)]()-_0x573625*0xea60),_0x2763af=_0x309e4a[_0x3f2ece(0x137)]()-_0x1e4602[_0x3f2ece(0x137)]();_0x2763af>=0x0&&_0x2763af<0xf*0xea60&&(_0x49c122['log'][_0x3f2ece(0x160)](_0x3f2ece(0x12d)+_0x34fade[_0x3f2ece(0x17f)]+').\x20Heize\x20ganzes\x20Haus\x20auf\x20(Vorlauf:\x20'+_0x573625+_0x3f2ece(0x10f)),await _0x49c122[_0x3f2ece(0x11b)](_0x3f2ece(0x146),{'val':_0x3f2ece(0x183),'ack':![]}));}for(const _0x3b10ad of _0x466c2d){if(_0x3b10ad[_0x3f2ece(0x14b)]){const _0x324270=_0x3b10ad[_0x3f2ece(0x14b)][_0x3f2ece(0x10c)]();if(_0x4a5ab3['includes'](_0x324270)){const _0x52b5b5=_0x18ddd1[_0x3b10ad[_0x3f2ece(0x14b)]]||0x3c,_0x293620=new Date(_0x30d854['getTime']()-_0x52b5b5*0xea60),_0x3aee10=_0x309e4a[_0x3f2ece(0x137)]()-_0x293620[_0x3f2ece(0x137)]();if(_0x3aee10>=0x0&&_0x3aee10<0xf*0xea60){const _0x443cc0=await findRelatedId(_0x49c122,_0x3b10ad['id'],_0x3f2ece(0x179));_0x443cc0&&(_0x49c122[_0x3f2ece(0x184)]['info']('ðŸ“…\x20SMART\x20SCHEDULE:\x20Raum-Trigger\x20\x27'+_0x3b10ad['location']+'\x27\x20erkannt\x20('+_0x34fade[_0x3f2ece(0x17f)]+_0x3f2ece(0x150)+_0x52b5b5+_0x3f2ece(0x10f)),await _0x49c122[_0x3f2ece(0x17e)](_0x443cc0,0x15),await _0x49c122[_0x3f2ece(0x11b)](_0x3f2ece(0x133),{'val':'[CAL]\x20'+_0x3b10ad[_0x3f2ece(0x14b)]+_0x3f2ece(0x132),'ack':!![]}));}}}}}}catch(_0x58ef95){_0x49c122['log']['warn'](_0x3f2ece(0x121)+_0x58ef95['message']);}}function a1_0x9f78(_0x48f614,_0x2a4280){const _0x4d4da3=a1_0x5447();return a1_0x9f78=function(_0x202d77,_0x3e93fb){_0x202d77=_0x202d77-0x10b;let _0x54475c=_0x4d4da3[_0x202d77];return _0x54475c;},a1_0x9f78(_0x48f614,_0x2a4280);}async function applyEnergySavings(_0x4ba6bf,_0x18a51a){const _0x44c5cc=a1_0x2eeea0,_0x1deb37=_0x4ba6bf[_0x44c5cc(0x15d)][_0x44c5cc(0x124)]||[];for(const _0x325692 of _0x18a51a){const _0x53e08e=_0x325692[_0x44c5cc(0x149)],_0x2bb334=_0x325692[_0x44c5cc(0x130)],_0x214639=Date[_0x44c5cc(0x14e)]();if(lastActions[_0x44c5cc(0x176)+_0x53e08e]&&_0x214639-lastActions[_0x44c5cc(0x176)+_0x53e08e]<0x1e*0x3c*0x3e8)continue;const _0x19e1ec=_0x1deb37['find'](_0x1d3e0a=>normalize(_0x1d3e0a[_0x44c5cc(0x14b)])===normalize(_0x53e08e));if(!_0x19e1ec)continue;const _0x364463=await findRelatedId(_0x4ba6bf,_0x19e1ec['id'],_0x44c5cc(0x179));if(_0x364463){const _0x5ae92c=await _0x4ba6bf[_0x44c5cc(0x120)](_0x364463);if(_0x5ae92c&&typeof _0x5ae92c[_0x44c5cc(0x10e)]==='number'){const _0x285622=_0x5ae92c[_0x44c5cc(0x10e)];if(_0x2bb334>0x1e&&_0x285622>0x11){const _0x47ecb0=_0x285622-0x1;_0x4ba6bf[_0x44c5cc(0x184)][_0x44c5cc(0x160)](_0x44c5cc(0x113)+_0x53e08e+'\x20('+_0x364463+')\x20auf\x20'+_0x47ecb0+_0x44c5cc(0x163)+_0x2bb334+'\x20min)'),await _0x4ba6bf[_0x44c5cc(0x17e)](_0x364463,_0x47ecb0),lastActions[_0x44c5cc(0x176)+_0x53e08e]=_0x214639,await _0x4ba6bf[_0x44c5cc(0x11b)](_0x44c5cc(0x133),{'val':'[MPC]\x20'+_0x53e08e+_0x44c5cc(0x134),'ack':!![]});}}}}}module['exports']={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers};