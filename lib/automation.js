const a1_0xfaead2=a1_0x2766;(function(_0x210d9d,_0x7e2e58){const _0x21acd3=a1_0x2766,_0x4df969=_0x210d9d();while(!![]){try{const _0x2c3369=-parseInt(_0x21acd3(0x145))/0x1+parseInt(_0x21acd3(0x1b9))/0x2*(-parseInt(_0x21acd3(0x132))/0x3)+parseInt(_0x21acd3(0x142))/0x4+parseInt(_0x21acd3(0x1bf))/0x5*(-parseInt(_0x21acd3(0x160))/0x6)+parseInt(_0x21acd3(0x193))/0x7*(parseInt(_0x21acd3(0x1d7))/0x8)+-parseInt(_0x21acd3(0x1dc))/0x9*(-parseInt(_0x21acd3(0x14a))/0xa)+parseInt(_0x21acd3(0x137))/0xb*(parseInt(_0x21acd3(0x1a4))/0xc);if(_0x2c3369===_0x7e2e58)break;else _0x4df969['push'](_0x4df969['shift']());}catch(_0x291f90){_0x4df969['push'](_0x4df969['shift']());}}}(a1_0x2f9a,0x2d16c));const a1_0x3f41d6=(function(){let _0x564242=!![];return function(_0x566b37,_0x41ab33){const _0x1d1eb1=_0x564242?function(){const _0x1f5291=a1_0x2766;if(_0x41ab33){const _0x25c98f=_0x41ab33[_0x1f5291(0x140)](_0x566b37,arguments);return _0x41ab33=null,_0x25c98f;}}:function(){};return _0x564242=![],_0x1d1eb1;};}()),a1_0xb32931=a1_0x3f41d6(this,function(){const _0x2fc3c7=a1_0x2766;return a1_0xb32931[_0x2fc3c7(0x1f3)]()['search'](_0x2fc3c7(0x1b2))['toString']()['constructor'](a1_0xb32931)[_0x2fc3c7(0x173)](_0x2fc3c7(0x1b2));});a1_0xb32931();'use strict';const aiAgent=require('./ai_agent'),COOLDOWN_MS=0x3c*0x3e8,CAL_COOLDOWN_MS=0x5a*0x3c*0x3e8,RESCUE_LOCK_MS=0x78*0x3c*0x3e8,ECO_TEMP=0x11,lastActions={};function normalize(_0x3c87ba){const _0x26cdd9=a1_0x2766;if(!_0x3c87ba)return'';return _0x3c87ba[_0x26cdd9(0x1e2)]()[_0x26cdd9(0x164)](/\s+/g,'')[_0x26cdd9(0x17d)]();}async function logAutomationAction(_0x1dd470,_0x17420c){const _0x22f52a=a1_0x2766;await _0x1dd470['setStateAsync'](_0x22f52a(0x13f),{'val':_0x17420c,'ack':!![]});try{const _0x186bff=_0x22f52a(0x1ef),_0x40f685=await _0x1dd470[_0x22f52a(0x172)](_0x186bff);let _0x3d1d3d=[];if(_0x40f685&&_0x40f685[_0x22f52a(0x1d1)])try{_0x3d1d3d=JSON['parse'](_0x40f685['val']);}catch(_0x38a988){}_0x3d1d3d['unshift']({'ts':Date['now'](),'msg':_0x17420c});if(_0x3d1d3d[_0x22f52a(0x168)]>0x32)_0x3d1d3d=_0x3d1d3d[_0x22f52a(0x16f)](0x0,0x32);await _0x1dd470[_0x22f52a(0x1bd)](_0x186bff,{'val':JSON[_0x22f52a(0x1b7)](_0x3d1d3d),'ack':!![]});}catch(_0x113c01){}}async function handlePrediction(_0x112c6e,_0x279a95,_0x2dc05){const _0x543281=a1_0x2766;if(!_0x279a95||_0x279a95===_0x543281(0x1cf))return;let _0x1277f1='off',_0x439042=0.6;try{const _0x4a5697=await _0x112c6e[_0x543281(0x172)](_0x543281(0x194));if(_0x4a5697&&_0x4a5697[_0x543281(0x1d1)])_0x1277f1=_0x4a5697[_0x543281(0x1d1)];const _0x406a02=await _0x112c6e[_0x543281(0x172)]('analysis.automation.confidenceThreshold');if(_0x406a02&&_0x406a02[_0x543281(0x1d1)])_0x439042=_0x406a02[_0x543281(0x1d1)];}catch(_0x594689){}if(_0x1277f1===_0x543281(0x18d)||_0x2dc05<_0x439042)return;const _0x50abef=Date[_0x543281(0x1b5)]();if(lastActions[_0x279a95]&&_0x50abef-lastActions[_0x279a95]<COOLDOWN_MS)return;const _0x9b9efa=_0x112c6e['config']['devices']||[],_0x13f633=normalize(_0x279a95),_0x480dcc=_0x9b9efa[_0x543281(0x136)](_0x4dbcda=>normalize(_0x4dbcda[_0x543281(0x1e6)])===_0x13f633&&(_0x4dbcda[_0x543281(0x1db)]===_0x543281(0x16d)||_0x4dbcda['type']===_0x543281(0x1e8)||_0x4dbcda[_0x543281(0x1db)]===_0x543281(0x17b)));if(!_0x480dcc)return;const _0x569a0d=await aiAgent['consultButler'](_0x112c6e,_0x279a95,_0x480dcc[_0x543281(0x1b4)],_0x2dc05);if(!_0x569a0d[_0x543281(0x1b6)])return;const _0x3e0b1a=_0x543281(0x1e9)+_0x279a95+'\x20->\x20Schalte\x20'+_0x480dcc[_0x543281(0x1b4)]+'\x20('+_0x569a0d[_0x543281(0x159)]+')';await logAutomationAction(_0x112c6e,'['+_0x1277f1[_0x543281(0x1b8)]()+']\x20'+_0x3e0b1a);if(_0x1277f1===_0x543281(0x1e1)){const _0x1ce601=await _0x112c6e['getForeignStateAsync'](_0x480dcc['id']);(!_0x1ce601||!_0x1ce601[_0x543281(0x1d1)]&&_0x1ce601['val']!==!![])&&await _0x112c6e['setForeignStateAsync'](_0x480dcc['id'],!![]),lastActions[_0x279a95]=_0x50abef;}}async function findRelatedId(_0x5e16ef,_0x74c61,_0x9e84ab=a1_0xfaead2(0x171)){const _0x2420dd=a1_0xfaead2;if(_0x9e84ab==='setpoint'&&_0x5e16ef[_0x2420dd(0x1ab)][_0x2420dd(0x19f)]){let _0xcb9db=_0x5e16ef['config'][_0x2420dd(0x19f)];if(typeof _0xcb9db===_0x2420dd(0x19a))try{_0xcb9db=JSON['parse'](_0xcb9db);}catch(_0x17a1ac){}if(_0xcb9db&&_0xcb9db[_0x74c61])return _0xcb9db[_0x74c61];}if(_0x9e84ab===_0x2420dd(0x1a5)&&_0x5e16ef[_0x2420dd(0x1ab)]['valveMapping']){let _0x1f2e65=_0x5e16ef['config'][_0x2420dd(0x153)];if(typeof _0x1f2e65===_0x2420dd(0x19a))try{_0x1f2e65=JSON[_0x2420dd(0x14f)](_0x1f2e65);}catch(_0x12d4d2){}if(_0x1f2e65&&_0x1f2e65[_0x74c61])return _0x1f2e65[_0x74c61];}let _0x397b02=[];if(_0x9e84ab===_0x2420dd(0x171))_0x397b02=[{'s':'.1.ACTUAL_TEMPERATURE','t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x2420dd(0x141),'t':'.1.SET_POINT_TEMPERATURE'},{'s':_0x2420dd(0x141),'t':_0x2420dd(0x195)},{'s':_0x2420dd(0x1a2),'t':'SET_POINT_TEMPERATURE'},{'s':_0x2420dd(0x167),'t':_0x2420dd(0x144)},{'s':_0x2420dd(0x167),'t':_0x2420dd(0x143)},{'s':_0x2420dd(0x17f),'t':_0x2420dd(0x1df)},{'s':_0x2420dd(0x1d5),'t':_0x2420dd(0x189)},{'s':_0x2420dd(0x178),'t':_0x2420dd(0x1a7)},{'s':_0x2420dd(0x17f),'t':_0x2420dd(0x171)}];else _0x9e84ab===_0x2420dd(0x1a5)&&(_0x397b02=[{'s':_0x2420dd(0x19c),'t':'.1.LEVEL'},{'s':'.1.TEMPERATURE','t':_0x2420dd(0x156)},{'s':_0x2420dd(0x141),'t':_0x2420dd(0x1ee)},{'s':_0x2420dd(0x167),'t':_0x2420dd(0x1b1)},{'s':_0x2420dd(0x17f),'t':_0x2420dd(0x1a6)},{'s':_0x2420dd(0x17f),'t':_0x2420dd(0x13e)}]);for(const _0x388b79 of _0x397b02){if(_0x74c61[_0x2420dd(0x148)](_0x388b79['s'])){const _0x273f62=_0x74c61['replace'](_0x388b79['s'],_0x388b79['t']),_0x59c343=await _0x5e16ef[_0x2420dd(0x1ce)](_0x273f62);if(_0x59c343)return _0x273f62;}}try{const _0x4af5c0=_0x74c61[_0x2420dd(0x1c2)]('.');if(_0x4af5c0['length']>0x2){const _0x2eede1=_0x4af5c0[_0x2420dd(0x16f)](0x0,-0x1)[_0x2420dd(0x154)]('.'),_0x2af78a=await _0x5e16ef[_0x2420dd(0x19d)](_0x2eede1+'.*'),_0x36b9e1=[],_0x176c65=_0x74c61['split'](/[._]+/)[_0x2420dd(0x1cb)](_0x39a3ca=>![_0x2420dd(0x169),'0',_0x2420dd(0x16c),'ist','wert',_0x2420dd(0x17f),'actual',_0x2420dd(0x1b3),'messwert',_0x2420dd(0x14b)][_0x2420dd(0x148)](_0x39a3ca[_0x2420dd(0x1e2)]()));for(const [_0x59d570,_0xf5de7a]of Object[_0x2420dd(0x1c5)](_0x2af78a)){if(_0x59d570===_0x74c61)continue;if(_0xf5de7a&&_0xf5de7a[_0x2420dd(0x182)]){const _0x280198=_0x59d570[_0x2420dd(0x1e2)](),_0x31a391=(_0xf5de7a['common'][_0x2420dd(0x1ec)]||'')['toLowerCase'](),_0x2aa5ad=(_0xf5de7a[_0x2420dd(0x182)][_0x2420dd(0x15a)]||'')[_0x2420dd(0x1e2)]();let _0x2c9b10=![];if(_0x9e84ab==='setpoint'&&_0xf5de7a[_0x2420dd(0x182)][_0x2420dd(0x1f0)]===!![])_0x2c9b10=_0x280198[_0x2420dd(0x148)](_0x2420dd(0x1eb))||_0x280198[_0x2420dd(0x148)](_0x2420dd(0x1a8))||_0x280198['includes'](_0x2420dd(0x1f2))||_0x31a391[_0x2420dd(0x148)](_0x2420dd(0x1a1))||_0x31a391[_0x2420dd(0x148)](_0x2420dd(0x185));else _0x9e84ab==='valve'&&(_0x2c9b10=_0x280198[_0x2420dd(0x148)]('level')||_0x280198[_0x2420dd(0x148)]('valve')||_0x280198[_0x2420dd(0x148)](_0x2420dd(0x1c7))||_0x280198[_0x2420dd(0x148)](_0x2420dd(0x190))||_0x31a391['includes'](_0x2420dd(0x1ea))||_0x31a391['includes'](_0x2420dd(0x170))||_0x2aa5ad[_0x2420dd(0x148)]('%'));if(_0x2c9b10){const _0xe8ace0=_0x59d570[_0x2420dd(0x1c2)](/[._]+/)[_0x2420dd(0x17c)](_0x4a04c0=>_0x4a04c0[_0x2420dd(0x1e2)]());let _0x11dc40=0x0;_0x176c65['forEach'](_0x331300=>{const _0x5b9b05=_0x2420dd;if(_0xe8ace0['includes'](_0x331300[_0x5b9b05(0x1e2)]()))_0x11dc40++;}),_0x36b9e1[_0x2420dd(0x198)]({'id':_0x59d570,'score':_0x11dc40});}}}if(_0x36b9e1[_0x2420dd(0x168)]>0x0){_0x36b9e1[_0x2420dd(0x17e)]((_0x11d129,_0x5b2c7c)=>_0x5b2c7c[_0x2420dd(0x197)]-_0x11d129['score']);if(_0x36b9e1[0x0][_0x2420dd(0x197)]>0x0)return _0x36b9e1[0x0]['id'];}}}catch(_0x23ff03){}return null;}async function scanThermostats(_0x12c0c8){const _0x49622d=a1_0xfaead2,_0x5b6195=_0x12c0c8[_0x49622d(0x1ab)]['devices']||[],_0x2a43fb=[],_0x2eac8c=_0x5b6195[_0x49622d(0x1cb)](_0x2dfef4=>_0x2dfef4['id']&&_0x2dfef4['id']['includes']('temperature')||_0x2dfef4[_0x49622d(0x1db)]&&[_0x49622d(0x17f),_0x49622d(0x184),_0x49622d(0x1b3)]['includes'](_0x2dfef4[_0x49622d(0x1db)])||_0x2dfef4[_0x49622d(0x1b4)]&&_0x2dfef4[_0x49622d(0x1b4)][_0x49622d(0x1e2)]()[_0x49622d(0x148)](_0x49622d(0x134)));for(const _0x4a341b of _0x2eac8c){const _0x55f0da=await findRelatedId(_0x12c0c8,_0x4a341b['id'],_0x49622d(0x171)),_0x54c8bb=await findRelatedId(_0x12c0c8,_0x4a341b['id'],_0x49622d(0x1a5));let _0x16770b=_0x49622d(0x196),_0x42cef4=![],_0x2feae8=_0x12c0c8[_0x49622d(0x1ab)]['thermostatMapping']||{};if(typeof _0x2feae8==='string')try{_0x2feae8=JSON[_0x49622d(0x14f)](_0x2feae8);}catch(_0x5ad6dd){}let _0x586bf8=_0x12c0c8['config'][_0x49622d(0x153)]||{};if(typeof _0x586bf8==='string')try{_0x586bf8=JSON[_0x49622d(0x14f)](_0x586bf8);}catch(_0x21ab2d){}if(_0x2feae8[_0x4a341b['id']]&&_0x2feae8[_0x4a341b['id']]===_0x55f0da||_0x586bf8[_0x4a341b['id']]&&_0x586bf8[_0x4a341b['id']]===_0x54c8bb)_0x16770b='Manuelles\x20Mapping',_0x42cef4=!![];else(_0x55f0da||_0x54c8bb)&&(_0x16770b='Auto-Erkennung');_0x2a43fb['push']({'room':_0x4a341b['location']||'Unbekannt','sensorId':_0x4a341b['id'],'setpointId':_0x55f0da||'-','valveId':_0x54c8bb||'-','source':_0x16770b,'isManual':_0x42cef4,'status':_0x55f0da&&_0x54c8bb?_0x49622d(0x1cd):_0x55f0da?'OK':_0x49622d(0x1e4)});}return _0x2a43fb['sort']((_0x20b1a8,_0x28fed1)=>_0x20b1a8[_0x49622d(0x188)][_0x49622d(0x1a0)](_0x28fed1[_0x49622d(0x188)]));}async function updateSchedulePreview(_0x19f0c5){const _0x1b52ab=a1_0xfaead2;if(!_0x19f0c5[_0x1b52ab(0x1ab)][_0x1b52ab(0x1d2)]||!_0x19f0c5[_0x1b52ab(0x1ab)]['calendarInstance'])return;let _0x38ef8e={};try{const _0x57f822=await _0x19f0c5[_0x1b52ab(0x172)](_0x1b52ab(0x186));if(_0x57f822&&_0x57f822[_0x1b52ab(0x1d1)])_0x38ef8e=JSON[_0x1b52ab(0x14f)](_0x57f822[_0x1b52ab(0x1d1)]);}catch(_0x10082c){}const _0x1e7a18=[],_0x188f98=Date['now'](),_0x205979=0x30*0x3c*0x3c*0x3e8;try{const _0x3271e7=await _0x19f0c5[_0x1b52ab(0x1c0)](_0x19f0c5['config'][_0x1b52ab(0x19e)]+_0x1b52ab(0x1c4));if(!_0x3271e7||!_0x3271e7[_0x1b52ab(0x1d1)])return;const _0x1c5b5f=JSON[_0x1b52ab(0x14f)](_0x3271e7[_0x1b52ab(0x1d1)]),_0x5c5f8a=_0x19f0c5[_0x1b52ab(0x1ab)][_0x1b52ab(0x1d0)]||[],_0x4fdedd=_0x19f0c5[_0x1b52ab(0x1ab)]['devices']||[],_0x38bb7d=new Set();_0x4fdedd[_0x1b52ab(0x1ac)](_0x1ac358=>{const _0xa218d2=_0x1b52ab;if(_0x1ac358[_0xa218d2(0x1e6)])_0x38bb7d[_0xa218d2(0x135)](_0x1ac358[_0xa218d2(0x1e6)]);});for(const _0xfa8c0c of _0x1c5b5f){if(_0xfa8c0c['_calName']&&_0x5c5f8a[_0x1b52ab(0x168)]>0x0&&!_0x5c5f8a['includes'](_0xfa8c0c[_0x1b52ab(0x147)]))continue;const _0x460800=_0xfa8c0c['_date']||_0xfa8c0c[_0x1b52ab(0x1aa)]||_0xfa8c0c['date'];if(!_0x460800)continue;const _0x153619=new Date(_0x460800),_0x3a35b4=_0x153619[_0x1b52ab(0x162)]();if(isNaN(_0x3a35b4))continue;if(_0x3a35b4<_0x188f98)continue;if(_0x3a35b4>_0x188f98+_0x205979)continue;const _0x26870c=(_0xfa8c0c[_0x1b52ab(0x175)]||_0xfa8c0c['summary']||'')[_0x1b52ab(0x1e2)]();let _0x3b679d=![],_0x2e470f=[],_0x366aae=_0xfa8c0c[_0x1b52ab(0x175)]||_0xfa8c0c[_0x1b52ab(0x15d)]||_0x1b52ab(0x1a9);if(_0x26870c['includes'](_0x1b52ab(0x1da))||_0x26870c[_0x1b52ab(0x148)]('rÃ¼ckkehr')||_0x26870c[_0x1b52ab(0x148)](_0x1b52ab(0x14e)))_0x3b679d=!![],_0x2e470f=Array[_0x1b52ab(0x138)](_0x38bb7d);else for(const _0xd839b3 of _0x38bb7d){if(_0x26870c[_0x1b52ab(0x148)](_0xd839b3[_0x1b52ab(0x1e2)]()))_0x2e470f[_0x1b52ab(0x198)](_0xd839b3);}_0x2e470f['length']>0x0&&_0x2e470f['forEach'](_0x57f43d=>{const _0x4e91ae=_0x1b52ab;let _0x35c3ec=0x3c;if(_0x3b679d){let _0x2aba52=0x0;Object['values'](_0x38ef8e)[_0x4e91ae(0x1ac)](_0xfcd386=>{if(_0xfcd386>_0x2aba52)_0x2aba52=_0xfcd386;}),_0x35c3ec=_0x2aba52>0x0?_0x2aba52:0x78;}else _0x35c3ec=_0x38ef8e[_0x57f43d]||0x3c;const _0x26ca41=new Date(_0x3a35b4-_0x35c3ec*0xea60);_0x1e7a18['push']({'eventTime':_0x3a35b4,'triggerTime':_0x26ca41[_0x4e91ae(0x162)](),'room':_0x57f43d,'minutes':_0x35c3ec,'reason':_0x366aae,'isGlobal':_0x3b679d});});}}catch(_0x33bc45){}_0x1e7a18['sort']((_0xebd7e5,_0x401974)=>_0xebd7e5[_0x1b52ab(0x1e3)]-_0x401974['triggerTime']);const _0x3f3782=_0x1e7a18['slice'](0x0,0x5);await _0x19f0c5[_0x1b52ab(0x1bd)]('analysis.energy.schedulePreview',{'val':JSON[_0x1b52ab(0x1b7)](_0x3f3782),'ack':!![]});}async function monitorEnforcements(_0x53bc20){const _0x32690f=a1_0xfaead2;try{const _0x507605=_0x32690f(0x1e5),_0x28c495=await _0x53bc20[_0x32690f(0x172)](_0x507605);if(!_0x28c495||!_0x28c495['val'])return;let _0x6f105a=[];try{_0x6f105a=JSON['parse'](_0x28c495[_0x32690f(0x1d1)]);}catch(_0x361b16){return;}if(!Array[_0x32690f(0x161)](_0x6f105a)||_0x6f105a[_0x32690f(0x168)]===0x0)return;const _0x52bffc=Date[_0x32690f(0x1b5)](),_0x2da341=_0x53bc20['config'][_0x32690f(0x187)]||[];let _0x1e4a92=![];for(let _0x5c041a=_0x6f105a['length']-0x1;_0x5c041a>=0x0;_0x5c041a--){const _0x3f4cc2=_0x6f105a[_0x5c041a];if(_0x52bffc>=_0x3f4cc2[_0x32690f(0x166)]){_0x53bc20[_0x32690f(0x1b0)][_0x32690f(0x191)](_0x32690f(0x16a)+_0x3f4cc2[_0x32690f(0x188)]+'\x20gestartet/vorbei.\x20Gebe\x20Raum\x20frei.'),_0x6f105a[_0x32690f(0x1d6)](_0x5c041a,0x1),_0x1e4a92=!![];continue;}const _0x5a8f24=_0x2da341['find'](_0x2d9eb1=>normalize(_0x2d9eb1[_0x32690f(0x1e6)])===normalize(_0x3f4cc2['room'])&&(_0x2d9eb1[_0x32690f(0x1db)]===_0x32690f(0x17f)||_0x2d9eb1[_0x32690f(0x1db)]===_0x32690f(0x184)));if(_0x5a8f24){const _0x55f58b=await findRelatedId(_0x53bc20,_0x5a8f24['id'],_0x32690f(0x171));if(_0x55f58b){const _0x5dc378=await _0x53bc20['getForeignStateAsync'](_0x55f58b);_0x5dc378&&typeof _0x5dc378['val']===_0x32690f(0x1ca)&&(_0x5dc378['val']<0xf&&(_0x53bc20[_0x32690f(0x1b0)]['warn'](_0x32690f(0x18b)+_0x3f4cc2[_0x32690f(0x188)]+_0x32690f(0x1c9)+_0x5dc378[_0x32690f(0x1d1)]+_0x32690f(0x158)+_0x3f4cc2[_0x32690f(0x1f2)]+_0x32690f(0x1af)),await _0x53bc20[_0x32690f(0x181)](_0x55f58b,_0x3f4cc2[_0x32690f(0x1f2)]),await logAutomationAction(_0x53bc20,_0x32690f(0x13b)+_0x3f4cc2[_0x32690f(0x188)]+':\x20'+_0x5dc378[_0x32690f(0x1d1)]+_0x32690f(0x133)+_0x3f4cc2[_0x32690f(0x1f2)]+_0x32690f(0x1de))));}}}_0x1e4a92&&await _0x53bc20[_0x32690f(0x1bd)](_0x507605,{'val':JSON['stringify'](_0x6f105a),'ack':!![]});}catch(_0x4a4eb2){_0x53bc20['log']['error'](_0x32690f(0x1bb)+_0x4a4eb2['message']);}}async function checkCalendarTriggers(_0x471509){const _0x10b778=a1_0xfaead2;if(!_0x471509[_0x10b778(0x1ab)][_0x10b778(0x1d2)]||!_0x471509['config']['calendarInstance'])return;await updateSchedulePreview(_0x471509);let _0x27f701={},_0x260714={};try{const _0x2419a8=await _0x471509[_0x10b778(0x172)](_0x10b778(0x186));if(_0x2419a8&&_0x2419a8[_0x10b778(0x1d1)])_0x27f701=JSON[_0x10b778(0x14f)](_0x2419a8['val']);const _0x1c47b9=await _0x471509[_0x10b778(0x172)](_0x10b778(0x183));if(_0x1c47b9&&_0x1c47b9[_0x10b778(0x1d1)])_0x260714=JSON[_0x10b778(0x14f)](_0x1c47b9[_0x10b778(0x1d1)]);}catch(_0x5741b8){}let _0x43b10b={'default':0x15};try{const _0x535161=await _0x471509[_0x10b778(0x172)]('analysis.energy.warmupTargets');if(_0x535161&&_0x535161[_0x10b778(0x1d1)])_0x43b10b=JSON[_0x10b778(0x14f)](_0x535161[_0x10b778(0x1d1)]);}catch(_0xf58414){}let _0x18bbe7=[];try{const _0x5a460e=await _0x471509[_0x10b778(0x172)](_0x10b778(0x1e5));if(_0x5a460e&&_0x5a460e['val'])_0x18bbe7=JSON[_0x10b778(0x14f)](_0x5a460e[_0x10b778(0x1d1)]);}catch(_0x5bbfca){}try{const _0x566651=await _0x471509['getForeignStateAsync'](_0x471509[_0x10b778(0x1ab)][_0x10b778(0x19e)]+'.data.table');if(!_0x566651||!_0x566651[_0x10b778(0x1d1)])return;const _0x3f746c=JSON['parse'](_0x566651['val']),_0x10cdd9=Date[_0x10b778(0x1b5)](),_0x1cea61=_0x471509[_0x10b778(0x1ab)]['devices']||[],_0x1e0b83=_0x471509[_0x10b778(0x1ab)][_0x10b778(0x1d0)]||[];let _0x3dc3ae=![];for(const _0x1ed7d1 of _0x3f746c){if(_0x1ed7d1[_0x10b778(0x147)]&&_0x1e0b83[_0x10b778(0x168)]>0x0&&!_0x1e0b83[_0x10b778(0x148)](_0x1ed7d1[_0x10b778(0x147)]))continue;const _0x55f3ed=_0x1ed7d1['_date']||_0x1ed7d1[_0x10b778(0x1aa)]||_0x1ed7d1[_0x10b778(0x146)];if(!_0x55f3ed)continue;const _0x1a6a19=new Date(_0x55f3ed);if(isNaN(_0x1a6a19['getTime']()))continue;const _0x3f418f=(_0x1ed7d1['event']||_0x1ed7d1['summary']||'')[_0x10b778(0x1e2)]();if(_0x3f418f[_0x10b778(0x148)](_0x10b778(0x1da))||_0x3f418f[_0x10b778(0x148)](_0x10b778(0x15e))||_0x3f418f[_0x10b778(0x148)](_0x10b778(0x14e))){let _0x18f29b=0x0;Object['values'](_0x27f701)['forEach'](_0x494203=>{if(_0x494203>_0x18f29b)_0x18f29b=_0x494203;});if(_0x18f29b===0x0)_0x18f29b=0x78;const _0x32bb5e=_0x1a6a19['getTime']()-_0x18f29b*0xea60;_0x10cdd9>=_0x32bb5e&&_0x10cdd9<_0x1a6a19[_0x10b778(0x162)]()&&(_0x471509[_0x10b778(0x1e7)]!==_0x10b778(0x18a)&&(_0x471509[_0x10b778(0x1b0)][_0x10b778(0x191)](_0x10b778(0x165)+_0x18f29b+_0x10b778(0x1d8)),await _0x471509['setStateAsync']('system.mode',{'val':_0x10b778(0x18a),'ack':![]})));}for(const _0x36a3e9 of _0x1cea61){if(_0x36a3e9['location']){const _0x1ab7d1=_0x36a3e9[_0x10b778(0x1e6)][_0x10b778(0x1e2)](),_0x5c6200=(_0x36a3e9[_0x10b778(0x1b4)]||'')['toLowerCase']();let _0x3036d4=_0x3f418f[_0x10b778(0x148)](_0x1ab7d1);!_0x3036d4&&_0x5c6200['length']>0x3&&_0x3f418f[_0x10b778(0x148)](_0x5c6200)&&(_0x3036d4=!![]);if(_0x3036d4){const _0x9133f1=_0x27f701[_0x36a3e9[_0x10b778(0x1e6)]]||0x3c,_0x5342a3=_0x260714[_0x36a3e9[_0x10b778(0x1e6)]]||'Classic',_0x49d163=_0x1a6a19[_0x10b778(0x162)]()-_0x9133f1*0xea60;if(_0x10cdd9>=_0x49d163&&_0x10cdd9<_0x1a6a19[_0x10b778(0x162)]()){const _0xac37ef=lastActions[_0x10b778(0x1e0)+_0x36a3e9[_0x10b778(0x1e6)]];if(_0xac37ef&&_0x10cdd9-_0xac37ef<CAL_COOLDOWN_MS)continue;const _0x55bc09=await findRelatedId(_0x471509,_0x36a3e9['id'],_0x10b778(0x171));if(_0x55bc09){let _0x3f049c=_0x43b10b[_0x36a3e9['location']];if(_0x3f049c===undefined)_0x3f049c=_0x43b10b[_0x10b778(0x15b)];if(_0x3f049c===undefined)_0x3f049c=0x15;const _0x250795=await _0x471509[_0x10b778(0x1c0)](_0x55bc09);if(_0x250795&&typeof _0x250795['val']==='number'&&_0x250795[_0x10b778(0x1d1)]<_0x3f049c-0.5){_0x471509[_0x10b778(0x1b0)][_0x10b778(0x191)](_0x10b778(0x17a)+_0x5342a3+_0x10b778(0x16e)+_0x36a3e9['location']+_0x10b778(0x174)+_0x3f418f+_0x10b778(0x13c)+_0x3f049c+_0x10b778(0x1d9)+_0x9133f1+_0x10b778(0x1d8)),await _0x471509[_0x10b778(0x181)](_0x55bc09,_0x3f049c),await logAutomationAction(_0x471509,'[CAL]\x20'+_0x36a3e9[_0x10b778(0x1e6)]+_0x10b778(0x14d)+_0x3f049c+_0x10b778(0x1ae)+_0x5342a3+')'),lastActions[_0x10b778(0x1e0)+_0x36a3e9['location']]=_0x10cdd9;const _0x1f4928=_0x18bbe7[_0x10b778(0x177)](_0x261cd1=>_0x261cd1[_0x10b778(0x188)]===_0x36a3e9[_0x10b778(0x1e6)]);if(_0x1f4928!==-0x1)_0x18bbe7[_0x10b778(0x1d6)](_0x1f4928,0x1);_0x18bbe7[_0x10b778(0x198)]({'room':_0x36a3e9[_0x10b778(0x1e6)],'target':_0x3f049c,'until':_0x1a6a19[_0x10b778(0x162)]()}),_0x3dc3ae=!![];}}}}}}}_0x3dc3ae&&await _0x471509[_0x10b778(0x1bd)]('analysis.energy.activeEnforcements',{'val':JSON[_0x10b778(0x1b7)](_0x18bbe7),'ack':!![]});}catch(_0x5cc1c8){_0x471509['log']['warn'](_0x10b778(0x157)+_0x5cc1c8['message']);}}function a1_0x2f9a(){const _0x2b1153=['analysis.energy.warmupTimes','devices','room','SET','normal','ðŸš¨\x20[ENFORCEMENT]\x20Hardware-Profil\x20hat\x20','manual','off','Â°C\x20(nicht\x20','Â°C!\x20(Puffer\x20leer).','position','info','Â°C\x20<\x20','1377971uLidUO','analysis.automation.mode','.4.SET_TEMPERATURE','Nicht\x20gefunden','score','push','ðŸ“…\x20[MPC\x20INFO]\x20','string','Â°C!\x20(Puffer:\x20','.1.ACTUAL_TEMPERATURE','getForeignObjectsAsync','calendarInstance','thermostatMapping','localeCompare','level.temperature','ACTUAL_TEMPERATURE','\x20ist\x20zu\x20kalt,\x20ABER\x20Fenster\x20offen/LÃ¼ftung\x20erkannt.\x20Heize\x20NICHT,\x20entferne\x20nur\x20Status.','12nFVhqW','valve','valve_position','Soll','soll','Unbekannt','eventStart','config','forEach','\x20gefunden!','Â°C\x20(via\x20','Â°C.','log','pi_heating_demand','(((.+)+)+)+$','sensor','name','now','approved','stringify','toUpperCase','2FTaCwJ','contact','Enforcement\x20Monitor\x20Error:\x20','open','setStateAsync','ðŸš¨\x20[MPC\x20WATCHDOG]\x20','10DIwUOP','getForeignStateAsync','abs','split','ðŸ§¹\x20[MPC\x20CLEANUP]\x20Raum\x20\x27','.data.table','entries','TRAIN_RL_PENALTY','stellwert','ðŸŒ¬ï¸\x20[MPC\x20WATCHDOG]\x20','\x20auf\x20','number','filter','ðŸ”¥\x20[MPC\x20ACTION]\x20Heize\x20','PERFECT','getForeignObjectAsync','Unknown','calendarSelection','val','useCalendar','Â°C).\x20Sparmodus\x20beendet!','indexOf','ACTUAL','splice','8JAKdWc','\x20min).','Â°C\x20(Vorlauf:\x20','urlaub\x20ende','type','318861qVIxCq','\x20durch\x20Kalender\x20geÃ¤ndert.\x20Keine\x20RL-Strafe.','Â°C\x20(Kalender-Schutz)','target_temperature','cal_','active','toLowerCase','triggerTime','Fehlt','analysis.energy.activeEnforcements','location','currentSystemMode','dimmer','PrÃ¤diktion:\x20','level.valve','set','role','too_cold','.4.VALVE_STATE','analysis.automation.actionLog','write','warn','target','toString','ðŸ§¹\x20[MPC\x20CLEANUP]\x20','analysis.energy.mpcActiveInterventions','617421uBTigf','Â°C\x20->\x20','temp','add','find','6530799osNuME','from','[MPC\x20WARNING]\x20Kein\x20Setpoint\x20fÃ¼r\x20','minutes_safe','[FORCE]\x20',')\x20aktiv.\x20Heize\x20auf\x20',':\x20Aufheizen\x20auf\x20','level','analysis.automation.lastAction','apply','.1.TEMPERATURE','179660ILnAuX','current_heating_setpoint','occupied_heating_setpoint','237756DHGHiP','date','_calName','includes','analysis.energy.warmupTargets','40wOMhGV','state','window','\x20->\x20','ankunft','parse','ðŸƒ\x20[MPC\x20ACTION]\x20Senke\x20','[MPC]\x20','\x20erreicht\x20Limit\x20(','valveMapping','join','mpc_','.1.LEVEL','Calendar\x20Check\x20Error:\x20','Â°C\x20abgesenkt!\x20Zwinge\x20zurÃ¼ck\x20auf\x20','reason','unit','default','rescue_','summary','rÃ¼ckkehr',':\x20Absenkung\x20auf\x20','1046838jvqIqC','isArray','getTime','remove','replace','ðŸ“…\x20SMART\x20SCHEDULE\x20(Phase):\x20\x27Globaler\x20Start\x27\x20erkannt.\x20Heize\x20Haus\x20auf\x20(Vorlauf:\x20','until','local_temperature','length','openknx','ðŸ“…\x20[ENFORCEMENT]\x20Kalender-Event\x20in\x20','sendToPythonWrapper','hm-rpc','light',']:\x20Raum-Trigger\x20\x27','slice','value.valve','setpoint','getStateAsync','search','\x27\x20(Match:\x20','event','exports','findIndex','Ist','analysis.energy.ventilationAlerts','ðŸ“…\x20SMART\x20SCHEDULE\x20[','switch','map','trim','sort','temperature','\x20ist\x20auf\x20','setForeignStateAsync','common','analysis.energy.warmupSources','thermostat','thermostat.setpoint'];a1_0x2f9a=function(){return _0x2b1153;};return a1_0x2f9a();}async function manageMpcIntervention(_0x506048,_0x11eece,_0x2d951a){const _0x21bfad=a1_0xfaead2;try{const _0xf82ccd=_0x21bfad(0x131),_0x37d794=await _0x506048[_0x21bfad(0x172)](_0xf82ccd);let _0x55d91a=[];if(_0x37d794&&_0x37d794[_0x21bfad(0x1d1)])try{_0x55d91a=JSON[_0x21bfad(0x14f)](_0x37d794['val']);}catch(_0x1fa392){}const _0x48fffc=_0x55d91a[_0x21bfad(0x1d4)](_0x11eece);if(_0x2d951a===_0x21bfad(0x135))_0x48fffc===-0x1&&(_0x55d91a['push'](_0x11eece),await _0x506048['setStateAsync'](_0xf82ccd,{'val':JSON[_0x21bfad(0x1b7)](_0x55d91a),'ack':!![]}));else _0x2d951a==='remove'&&(_0x48fffc!==-0x1&&(_0x55d91a[_0x21bfad(0x1d6)](_0x48fffc,0x1),await _0x506048[_0x21bfad(0x1bd)](_0xf82ccd,{'val':JSON[_0x21bfad(0x1b7)](_0x55d91a),'ack':!![]})));}catch(_0x14ede4){}}function a1_0x2766(_0x16278c,_0x2462f7){const _0xfef81=a1_0x2f9a();return a1_0x2766=function(_0xb32931,_0x3f41d6){_0xb32931=_0xb32931-0x131;let _0x2f9a71=_0xfef81[_0xb32931];return _0x2f9a71;},a1_0x2766(_0x16278c,_0x2462f7);}async function cleanupGhostInterventions(_0x5f8137){const _0x16e7be=a1_0xfaead2;try{const _0x102b45=_0x16e7be(0x131),_0x2e7e82=await _0x5f8137[_0x16e7be(0x172)](_0x102b45);if(!_0x2e7e82||!_0x2e7e82['val'])return;const _0x3abba0=JSON[_0x16e7be(0x14f)](_0x2e7e82[_0x16e7be(0x1d1)]);if(!Array['isArray'](_0x3abba0)||_0x3abba0[_0x16e7be(0x168)]===0x0)return;let _0x1f7461={'default':0x15};try{const _0x387339=await _0x5f8137[_0x16e7be(0x172)](_0x16e7be(0x149));if(_0x387339&&_0x387339[_0x16e7be(0x1d1)])_0x1f7461=JSON[_0x16e7be(0x14f)](_0x387339[_0x16e7be(0x1d1)]);}catch(_0x4b1226){}let _0x3ae313=[];try{const _0xa11d97=await _0x5f8137[_0x16e7be(0x172)](_0x16e7be(0x179));if(_0xa11d97&&_0xa11d97[_0x16e7be(0x1d1)])_0x3ae313=JSON['parse'](_0xa11d97['val']);}catch(_0x253c84){}const _0x4d27e9=_0x5f8137[_0x16e7be(0x1ab)][_0x16e7be(0x187)]||[];let _0xa5092f=![];for(let _0x40c502=_0x3abba0[_0x16e7be(0x168)]-0x1;_0x40c502>=0x0;_0x40c502--){const _0x17a93d=_0x3abba0[_0x40c502],_0x56bf80=_0x4d27e9[_0x16e7be(0x136)](_0x29f306=>normalize(_0x29f306[_0x16e7be(0x1e6)])===normalize(_0x17a93d)&&(_0x29f306[_0x16e7be(0x1db)]===_0x16e7be(0x17f)||_0x29f306[_0x16e7be(0x1db)]==='thermostat'));if(!_0x56bf80){_0x5f8137[_0x16e7be(0x1b0)][_0x16e7be(0x1f1)](_0x16e7be(0x1c3)+_0x17a93d+'\x27\x20hat\x20kein\x20GerÃ¤t\x20mehr.\x20LÃ¶sche\x20Eintrag.'),_0x3abba0[_0x16e7be(0x1d6)](_0x40c502,0x1),_0xa5092f=!![];continue;}if(_0x56bf80){const _0x4eb190=await findRelatedId(_0x5f8137,_0x56bf80['id'],_0x16e7be(0x171)),_0x47cbe8=await _0x5f8137[_0x16e7be(0x1c0)](_0x56bf80['id']);if(_0x4eb190){const _0x4afd9a=await _0x5f8137[_0x16e7be(0x1c0)](_0x4eb190);if(_0x4afd9a&&typeof _0x4afd9a[_0x16e7be(0x1d1)]==='number'){let _0x34283f=![],_0x42fe19='';Math[_0x16e7be(0x1c1)](_0x4afd9a[_0x16e7be(0x1d1)]-ECO_TEMP)>0.5&&(_0x34283f=!![],_0x42fe19=_0x16e7be(0x18c));if(!_0x34283f&&_0x47cbe8&&typeof _0x47cbe8[_0x16e7be(0x1d1)]==='number'){const _0x11eb2c=_0x1f7461[_0x17a93d]||_0x1f7461['default']||0x15;_0x47cbe8[_0x16e7be(0x1d1)]<_0x11eb2c+0.2&&(_0x34283f=!![],_0x42fe19=_0x16e7be(0x1ed));}if(_0x34283f){if(_0x42fe19===_0x16e7be(0x18c)){_0x5f8137['log'][_0x16e7be(0x191)](_0x16e7be(0x1f4)+_0x17a93d+_0x16e7be(0x180)+_0x4afd9a[_0x16e7be(0x1d1)]+_0x16e7be(0x18e)+ECO_TEMP+'Â°C).\x20Entferne\x20Status.');const _0x2b9d0b=lastActions['cal_'+_0x17a93d],_0x6a09ba=_0x2b9d0b&&Date[_0x16e7be(0x1b5)]()-_0x2b9d0b<0x2*0x3c*0x3e8;if(!_0x6a09ba&&_0x4afd9a[_0x16e7be(0x1d1)]>ECO_TEMP+0.5)_0x5f8137[_0x16e7be(0x16b)]&&(_0x5f8137['log'][_0x16e7be(0x191)]('ðŸŽ“\x20[RL-FEEDBACK]\x20Lerne\x20aus\x20Fehler:\x20'+_0x17a93d+'\x20wurde\x20manuell\x20erhÃ¶ht.'),_0x5f8137[_0x16e7be(0x16b)](_0x16e7be(0x1c6),{'room':_0x17a93d}));else _0x6a09ba&&_0x5f8137[_0x16e7be(0x1b0)][_0x16e7be(0x191)](_0x16e7be(0x199)+_0x17a93d+_0x16e7be(0x1dd));}else{if(_0x42fe19==='too_cold'){let _0x371b40=![];if(_0x3ae313[_0x16e7be(0x136)](_0x1ef051=>_0x1ef051[_0x16e7be(0x188)]===_0x17a93d))_0x371b40=!![];const _0x16bc28=_0x4d27e9['filter'](_0x1a2bd3=>normalize(_0x1a2bd3[_0x16e7be(0x1e6)])===normalize(_0x17a93d)&&(_0x1a2bd3[_0x16e7be(0x1db)]===_0x16e7be(0x14c)||_0x1a2bd3[_0x16e7be(0x1db)]===_0x16e7be(0x1b3)||_0x1a2bd3['type']===_0x16e7be(0x1ba)));for(const _0x74a505 of _0x16bc28){try{const _0x19aaee=await _0x5f8137[_0x16e7be(0x1c0)](_0x74a505['id']);if(_0x19aaee&&(_0x19aaee['val']===!![]||_0x19aaee[_0x16e7be(0x1d1)]===0x1||String(_0x19aaee[_0x16e7be(0x1d1)])[_0x16e7be(0x1e2)]()===_0x16e7be(0x1bc)))_0x371b40=!![];}catch(_0xb59624){}}if(_0x371b40)_0x5f8137[_0x16e7be(0x1b0)][_0x16e7be(0x191)](_0x16e7be(0x1c8)+_0x17a93d+_0x16e7be(0x1a3));else{const _0x3a893c=_0x1f7461[_0x17a93d]||_0x1f7461[_0x16e7be(0x15b)]||0x15;_0x5f8137['log'][_0x16e7be(0x191)](_0x16e7be(0x1be)+_0x17a93d+_0x16e7be(0x152)+_0x47cbe8[_0x16e7be(0x1d1)]+_0x16e7be(0x192)+(_0x3a893c+0.2)+_0x16e7be(0x1d3)),await _0x5f8137['setForeignStateAsync'](_0x4eb190,_0x3a893c),await logAutomationAction(_0x5f8137,'[WATCHDOG]\x20'+_0x17a93d+':\x20Puffer\x20leer\x20->\x20Heizen\x20auf\x20'+_0x3a893c+'Â°C'),lastActions['rescue_'+_0x17a93d]=Date['now']();}}}_0x3abba0[_0x16e7be(0x1d6)](_0x40c502,0x1),_0xa5092f=!![];}}}}}_0xa5092f&&await _0x5f8137[_0x16e7be(0x1bd)](_0x102b45,{'val':JSON[_0x16e7be(0x1b7)](_0x3abba0),'ack':!![]});}catch(_0x3a0cf3){}}async function applyEnergySavings(_0x12d384,_0x5e9754){const _0x4f8514=a1_0xfaead2;await cleanupGhostInterventions(_0x12d384);if(!_0x5e9754||_0x5e9754[_0x4f8514(0x168)]===0x0)return;const _0x950e04=_0x12d384[_0x4f8514(0x1ab)][_0x4f8514(0x187)]||[],_0x36315b=Date[_0x4f8514(0x1b5)]();for(const _0x4c0b1d of _0x5e9754){const _0x4c9c7a=_0x4c0b1d['room'],_0x1c8e00=_0x4c0b1d[_0x4f8514(0x13a)],_0x49ecd4=_0x4c0b1d[_0x4f8514(0x1f2)]||0x15;if(lastActions[_0x4f8514(0x15c)+_0x4c9c7a]&&_0x36315b-lastActions[_0x4f8514(0x15c)+_0x4c9c7a]<RESCUE_LOCK_MS)continue;const _0x13f216=_0x950e04[_0x4f8514(0x136)](_0x1f9756=>normalize(_0x1f9756['location'])===normalize(_0x4c9c7a)&&(_0x1f9756[_0x4f8514(0x1db)]==='temperature'||_0x1f9756[_0x4f8514(0x1db)]===_0x4f8514(0x184)));if(!_0x13f216)continue;const _0x5014b0=await findRelatedId(_0x12d384,_0x13f216['id'],_0x4f8514(0x171));if(_0x5014b0){if(lastActions[_0x4f8514(0x155)+_0x4c9c7a]&&_0x36315b-lastActions[_0x4f8514(0x155)+_0x4c9c7a]<0x1e*0x3c*0x3e8)continue;const _0x25eba2=await _0x12d384[_0x4f8514(0x1c0)](_0x5014b0);if(_0x25eba2&&typeof _0x25eba2[_0x4f8514(0x1d1)]===_0x4f8514(0x1ca)){const _0xc3636c=_0x25eba2[_0x4f8514(0x1d1)];_0xc3636c!==ECO_TEMP&&await manageMpcIntervention(_0x12d384,_0x4c9c7a,'remove');if(_0x1c8e00>0x1e)_0xc3636c>ECO_TEMP+0.5&&(_0x12d384[_0x4f8514(0x1b0)]['info'](_0x4f8514(0x150)+_0x4c9c7a+_0x4f8514(0x1c9)+ECO_TEMP+_0x4f8514(0x19b)+_0x1c8e00+'\x20min)'),await _0x12d384[_0x4f8514(0x181)](_0x5014b0,ECO_TEMP),await manageMpcIntervention(_0x12d384,_0x4c9c7a,'add'),lastActions['mpc_'+_0x4c9c7a]=_0x36315b,await logAutomationAction(_0x12d384,_0x4f8514(0x151)+_0x4c9c7a+_0x4f8514(0x15f)+ECO_TEMP+'Â°C'));else _0x1c8e00<=0xf&&(_0xc3636c<_0x49ecd4&&(_0x12d384[_0x4f8514(0x1b0)][_0x4f8514(0x191)](_0x4f8514(0x1cc)+_0x4c9c7a+'\x20wieder\x20auf\x20'+_0x49ecd4+_0x4f8514(0x18f)),await _0x12d384[_0x4f8514(0x181)](_0x5014b0,_0x49ecd4),await manageMpcIntervention(_0x12d384,_0x4c9c7a,_0x4f8514(0x163)),lastActions[_0x4f8514(0x155)+_0x4c9c7a]=_0x36315b,await logAutomationAction(_0x12d384,'[MPC]\x20'+_0x4c9c7a+_0x4f8514(0x13d)+_0x49ecd4+'Â°C')));}}else _0x12d384['log'][_0x4f8514(0x1f1)](_0x4f8514(0x139)+_0x4c9c7a+_0x4f8514(0x1ad));}}module[a1_0xfaead2(0x176)]={'handlePrediction':handlePrediction,'applyEnergySavings':applyEnergySavings,'scanThermostats':scanThermostats,'checkCalendarTriggers':checkCalendarTriggers,'monitorEnforcements':monitorEnforcements,'updateSchedulePreview':updateSchedulePreview,'cleanupGhostInterventions':cleanupGhostInterventions};