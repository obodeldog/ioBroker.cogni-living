const a2_0x5cda1d=a2_0x20bb;(function(_0x548867,_0x1d3c22){const _0x319625=a2_0x20bb,_0x49737a=_0x548867();while(!![]){try{const _0x2a5575=-parseInt(_0x319625(0x1a3))/0x1*(-parseInt(_0x319625(0x1c4))/0x2)+parseInt(_0x319625(0x1c2))/0x3*(-parseInt(_0x319625(0x1b8))/0x4)+parseInt(_0x319625(0x1ba))/0x5+parseInt(_0x319625(0x1aa))/0x6*(parseInt(_0x319625(0x1a6))/0x7)+-parseInt(_0x319625(0x198))/0x8+-parseInt(_0x319625(0x1b2))/0x9+parseInt(_0x319625(0x1c5))/0xa;if(_0x2a5575===_0x1d3c22)break;else _0x49737a['push'](_0x49737a['shift']());}catch(_0x118bee){_0x49737a['push'](_0x49737a['shift']());}}}(a2_0x2db5,0x4804d));const a2_0x4fe899=(function(){let _0x2dad1d=!![];return function(_0x2f2b6d,_0x59a055){const _0x51d09b=_0x2dad1d?function(){const _0x37a850=a2_0x20bb;if(_0x59a055){const _0x21f7b5=_0x59a055[_0x37a850(0x1b9)](_0x2f2b6d,arguments);return _0x59a055=null,_0x21f7b5;}}:function(){};return _0x2dad1d=![],_0x51d09b;};}()),a2_0x4b3ba6=a2_0x4fe899(this,function(){const _0x3acd9f=a2_0x20bb;return a2_0x4b3ba6['toString']()[_0x3acd9f(0x1a0)]('(((.+)+)+)+$')[_0x3acd9f(0x19f)]()[_0x3acd9f(0x1a8)](a2_0x4b3ba6)[_0x3acd9f(0x1a0)]('(((.+)+)+)+$');});a2_0x4b3ba6();'use strict';const setup=require('./setup');let activeTimer=null,currentMonitoredRoom=null,timeoutMs=0x0,startTime=0x0,alarmStage=0x0;const DEFAULT_TIMEOUTS={'bad':0x2d,'bath':0x2d,'toilet':0x1e,'wc':0x1e,'keller':0x3c,'schlaf':0x78,'bed':0x78,'guest':0x5a,'gast':0x5a};function getTimeoutRobust(_0x302e9f,_0x4b60d1){const _0x50fba9=a2_0x20bb;if(!_0x302e9f||!_0x4b60d1)return undefined;if(_0x302e9f[_0x4b60d1])return _0x302e9f[_0x4b60d1];const _0x56864b=_0x4b60d1['toLowerCase']()[_0x50fba9(0x1ae)](/[^a-z0-9]/g,'');for(const _0x8f8e6a in _0x302e9f){const _0x1f7ae9=_0x8f8e6a[_0x50fba9(0x1bc)]()[_0x50fba9(0x1ae)](/[^a-z0-9]/g,'');if(_0x1f7ae9===_0x56864b)return _0x302e9f[_0x8f8e6a];}const _0x33c937=_0x4b60d1['toLowerCase']();if(_0x302e9f[_0x33c937])return _0x302e9f[_0x33c937];return undefined;}async function loadConfig(_0x448445){const _0x385de4=a2_0x20bb;try{const _0x3a0de9=await _0x448445['getStateAsync'](_0x385de4(0x1af));if(_0x3a0de9&&_0x3a0de9[_0x385de4(0x1b7)])return JSON[_0x385de4(0x1a1)](_0x3a0de9[_0x385de4(0x1b7)]);}catch(_0x5d7f4a){}return{};}async function isActive(_0x83d9e2){const _0x31d623=a2_0x20bb;try{const _0x3aab34=await _0x83d9e2['getStateAsync'](_0x31d623(0x1be));return _0x3aab34&&_0x3aab34[_0x31d623(0x1b7)];}catch(_0x1dac09){return![];}}async function areRoomsConnected(_0xf43d08,_0x360232,_0x1bb118){const _0x5d22bc=a2_0x20bb;try{const _0x12e42e=await _0xf43d08[_0x5d22bc(0x193)]('analysis.topology.structure');if(!_0x12e42e||!_0x12e42e[_0x5d22bc(0x1b7)])return!![];const _0x5886b6=JSON[_0x5d22bc(0x1a1)](_0x12e42e[_0x5d22bc(0x1b7)]),{rooms:_0x47d53f,matrix:_0x1b5131}=_0x5886b6;if(!_0x47d53f||!_0x1b5131)return!![];const _0x393bf3=_0x47d53f[_0x5d22bc(0x1bb)](_0x360232),_0x416a41=_0x47d53f[_0x5d22bc(0x1bb)](_0x1bb118);if(_0x393bf3===-0x1||_0x416a41===-0x1)return!![];const _0x35479=_0x1b5131[_0x393bf3][_0x416a41]>0x0||_0x1b5131[_0x416a41][_0x393bf3]>0x0;return _0x35479;}catch(_0x3106d5){return _0xf43d08[_0x5d22bc(0x1ab)][_0x5d22bc(0x1ac)](_0x5d22bc(0x1c6)+_0x3106d5[_0x5d22bc(0x1b4)]),!![];}}function calculateSleepProbability(_0x259777){const _0x2eed81=a2_0x20bb,_0x15ce95=new Date(),_0x4f4774=_0x15ce95[_0x2eed81(0x1bd)](),_0x2faf3a=_0x259777['toLowerCase']();let _0x2e9a62=0.1;if(_0x4f4774>=0x17||_0x4f4774<=0x6)_0x2e9a62=0x1;else{if(_0x4f4774>=0xd&&_0x4f4774<=0xf)_0x2e9a62=0.8;else{if(_0x4f4774>=0x14&&_0x4f4774<=0x17)_0x2e9a62=0.4;}}let _0x53745b=0.1;if(_0x2faf3a[_0x2eed81(0x195)](_0x2eed81(0x19c))||_0x2faf3a['includes'](_0x2eed81(0x1a9)))_0x53745b=0x1;else{if(_0x2faf3a[_0x2eed81(0x195)]('wohn')||_0x2faf3a[_0x2eed81(0x195)](_0x2eed81(0x1c0))||_0x2faf3a[_0x2eed81(0x195)](_0x2eed81(0x196)))_0x53745b=0.6;else{if(_0x2faf3a[_0x2eed81(0x195)](_0x2eed81(0x1c3))||_0x2faf3a[_0x2eed81(0x195)]('wc'))_0x53745b=0.05;}}let _0x34bba3=0.5;const _0x2402bd=_0x53745b*0.5+_0x2e9a62*0.3+_0x34bba3*0.2;return parseFloat(_0x2402bd['toFixed'](0x2));}function a2_0x2db5(){const _0xce71cd=['apply','2411390hgsaFq','indexOf','toLowerCase','getHours','analysis.safety.deadMan.active','analysis.safety.deadMan.napProbability','living','alarm','1639563wioeid','bad','21780qiyRyC','6190630FqBpHW','[DeadMan]\x20Topology\x20check\x20failed:\x20','ðŸ‘¼\x20Schutzengel:\x20Ãœberwache\x20','exports','getStateAsync','info','includes','sofa','stringify','352192pvySNF','\x20Min.','\x20um\x2090\x20Min.','sendNotification','schlaf','now','analysis.safety.deadMan.lastIgnored','toString','search','parse','analysis.safety.deadMan.alarmState','5lbDNAD','Ignoriere\x20Bewegung\x20in\x20\x27','ðŸ’¤\x20Smart\x20Sleep\x20erkannt\x20(','791XhiYnX','setStateAsync','constructor','bed','7644iEhuew','log','warn','\x20(Multi-Person\x20Filter)','replace','analysis.safety.deadMan.config','â³\x20ACHTUNG:\x20UngewÃ¶hnlich\x20lange\x20InaktivitÃ¤t\x20in\x20','analysis.safety.deadMan.currentRoom','3727971ETRgBH','ðŸš¨\x20NOTFALL-ALARM:\x20Person\x20reagiert\x20nicht\x20in\x20','message','default','analysis.safety.deadMan.smartSleep','val','4HowejE'];a2_0x2db5=function(){return _0xce71cd;};return a2_0x2db5();}function a2_0x20bb(_0x4ed411,_0x11aff4){const _0xa2bda2=a2_0x2db5();return a2_0x20bb=function(_0x4b3ba6,_0x4fe899){_0x4b3ba6=_0x4b3ba6-0x193;let _0x2db5a1=_0xa2bda2[_0x4b3ba6];return _0x2db5a1;},a2_0x20bb(_0x4ed411,_0x11aff4);}async function updateLocation(_0x4a81d9,_0x62e50b){const _0x144bff=a2_0x20bb;if(!_0x62e50b||_0x62e50b==='Unknown')return;if(!await isActive(_0x4a81d9)){resetTimer(_0x4a81d9);return;}if(currentMonitoredRoom&&currentMonitoredRoom!==_0x62e50b){const _0x13f100=await areRoomsConnected(_0x4a81d9,currentMonitoredRoom,_0x62e50b);if(!_0x13f100){const _0x52382d=_0x144bff(0x1a4)+_0x62e50b+'\x27.\x20Nicht\x20verbunden\x20mit\x20Ã¼berwachtem\x20\x27'+currentMonitoredRoom+'\x27.';_0x4a81d9[_0x144bff(0x1ab)][_0x144bff(0x194)]('[DeadMan]\x20'+_0x52382d+_0x144bff(0x1ad)),await _0x4a81d9[_0x144bff(0x1a7)](_0x144bff(0x19e),{'val':JSON[_0x144bff(0x197)]({'room':_0x62e50b,'reason':_0x52382d,'timestamp':Date['now']()}),'ack':!![]});return;}resetTimer(_0x4a81d9);}if(!currentMonitoredRoom){await _0x4a81d9[_0x144bff(0x1a7)](_0x144bff(0x1b1),{'val':_0x62e50b,'ack':!![]});const _0x5a4944=await loadConfig(_0x4a81d9);let _0x33c61c=getTimeoutRobust(_0x5a4944,_0x62e50b);const _0x1df10e=_0x62e50b[_0x144bff(0x1bc)]();if(!_0x33c61c)for(const _0x4e3b6b in DEFAULT_TIMEOUTS){if(_0x1df10e['includes'](_0x4e3b6b)){_0x33c61c=DEFAULT_TIMEOUTS[_0x4e3b6b];break;}}if(!_0x33c61c&&_0x5a4944[_0x144bff(0x1b5)])_0x33c61c=_0x5a4944['default'];if(!_0x33c61c)return;currentMonitoredRoom=_0x62e50b,startTimer(_0x4a81d9,_0x33c61c,_0x62e50b);}}function startTimer(_0x2508d0,_0x1a391f,_0x42e9e9){const _0x5d1b12=a2_0x20bb;if(activeTimer)clearTimeout(activeTimer);timeoutMs=_0x1a391f*0x3c*0x3e8,startTime=Date[_0x5d1b12(0x19d)](),alarmStage=0x0;const _0x3dfeae=calculateSleepProbability(_0x42e9e9||currentMonitoredRoom),_0x57cf8f=_0x3dfeae>0.65;_0x57cf8f?(timeoutMs+=0x5a*0x3c*0x3e8,_0x2508d0['log'][_0x5d1b12(0x194)](_0x5d1b12(0x1a5)+(_0x3dfeae*0x64)['toFixed'](0x0)+'%).\x20VerlÃ¤ngere\x20Timer\x20fÃ¼r\x20'+currentMonitoredRoom+_0x5d1b12(0x19a)),_0x2508d0[_0x5d1b12(0x1a7)](_0x5d1b12(0x1b6),{'val':!![],'ack':!![]})):_0x2508d0[_0x5d1b12(0x1a7)](_0x5d1b12(0x1b6),{'val':![],'ack':!![]}),_0x2508d0[_0x5d1b12(0x1a7)](_0x5d1b12(0x1bf),{'val':_0x3dfeae,'ack':!![]}),_0x2508d0[_0x5d1b12(0x1ab)][_0x5d1b12(0x194)](_0x5d1b12(0x1c7)+currentMonitoredRoom+'\x20fÃ¼r\x20'+_0x1a391f+_0x5d1b12(0x199)),_0x2508d0['setStateAsync'](_0x5d1b12(0x1a2),{'val':'ok','ack':!![]}),activeTimer=setTimeout(()=>triggerPreWarn(_0x2508d0),timeoutMs);}function resetTimer(_0x4047b5){const _0x11b63d=a2_0x20bb;if(activeTimer)clearTimeout(activeTimer);activeTimer=null,currentMonitoredRoom=null,alarmStage=0x0,_0x4047b5['setStateAsync'](_0x11b63d(0x1a2),{'val':'ok','ack':!![]}),_0x4047b5['setStateAsync'](_0x11b63d(0x1b6),{'val':![],'ack':!![]}),_0x4047b5[_0x11b63d(0x1a7)](_0x11b63d(0x1bf),{'val':0x0,'ack':!![]});}async function triggerPreWarn(_0x31b6ba){const _0x22dc62=a2_0x20bb;alarmStage=0x1,await _0x31b6ba[_0x22dc62(0x1a7)](_0x22dc62(0x1a2),{'val':'pre_warn','ack':!![]});const _0x494d5a=_0x22dc62(0x1b0)+currentMonitoredRoom+'.\x20Alles\x20in\x20Ordnung?';_0x31b6ba[_0x22dc62(0x1ab)][_0x22dc62(0x1ac)]('[DeadMan]\x20'+_0x494d5a),await setup[_0x22dc62(0x19b)](_0x31b6ba,'ðŸ‘¼\x20Schutzengel-Frage:\x20'+_0x494d5a),activeTimer=setTimeout(()=>triggerAlarm(_0x31b6ba),0x5*0x3c*0x3e8);}async function triggerAlarm(_0x466c26){const _0x5d161a=a2_0x20bb;alarmStage=0x2,await _0x466c26[_0x5d161a(0x1a7)]('analysis.safety.deadMan.alarmState',{'val':_0x5d161a(0x1c1),'ack':!![]});const _0x12eaf9=_0x5d161a(0x1b3)+currentMonitoredRoom+'!';_0x466c26[_0x5d161a(0x1ab)]['error']('[DeadMan]\x20'+_0x12eaf9),await setup[_0x5d161a(0x19b)](_0x466c26,_0x12eaf9,![],!![]);}module[a2_0x5cda1d(0x1c8)]={'updateLocation':updateLocation};